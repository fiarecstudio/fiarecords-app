<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, user-scalable=yes" />
    
  <title>Fia Records Estudio de Grabaci√≥n</title>
    
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <link rel="apple-touch-icon" href="icon-192.png">
    
  <link id="dynamic-favicon" rel="icon" type="image/png" href="https://placehold.co/32x32?text=Fia">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Poppins:wght@500;600;700&display=swap" rel="stylesheet">
    
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <style>
    /* --- CSS VARIABLES & RESET --- */
    body { visibility: hidden; opacity: 0; transition: opacity 0.3s ease; }
    :root {
      /* Paleta de Colores (Moderna) */
      --primary-color: #6366f1; 
      --primary-hover: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4338ca 100%);
        
      --danger-color: #ef4444; 
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #b91c1c 100%);
        
      --success-color: #10b981;
      --success-gradient: linear-gradient(135deg, #10b981 0%, #047857 100%);
        
      --warning-color: #f59e0b;
        
      /* Modo Claro (Light) */
      --background-color: #f8fafc;
      --card-background: #ffffff;
      --sidebar-background: rgba(255, 255, 255, 0.95);
      --text-color-dark: #1e293b;
      --text-color-light: #64748b;
      --border-color: #e2e8f0;
      --input-bg: #f1f5f9;
        
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.05);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        
      --secondary-button-bg: #f1f5f9; 
      --secondary-button-text: #475569; 
      --secondary-button-hover-bg: #e2e8f0;

      /* Kanban Tags */
      --proceso-Solicitud: #64748b;
      --proceso-Agendado: #3b82f6; 
      --proceso-Grabacion: #8b5cf6; 
      --proceso-Edicion: #ec4899; 
      --proceso-Mezcla: #f59e0b; 
      --proceso-Mastering: #10b981; 
      --proceso-Completo: #64748b;
    }

    body.dark-mode {
      /* Modo Oscuro (Deep Space) */
      --background-color: #0f172a; 
      --card-background: #1e293b; 
      --sidebar-background: rgba(30, 41, 59, 0.95);
      --text-color-dark: #f1f5f9; 
      --text-color-light: #94a3b8;
      --border-color: #334155; 
      --input-bg: #0f172a;
        
      --secondary-button-bg: #334155; 
      --secondary-button-text: #e2e8f0; 
      --secondary-button-hover-bg: #475569;
        
      --shadow-sm: 0 1px 2px rgba(0,0,0,0.3);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        
      /* FullCalendar Dark Overrides */
      --fc-button-bg-color: var(--secondary-button-bg); 
      --fc-button-text-color: var(--secondary-button-text);
      --fc-button-border-color: var(--border-color);
      --fc-today-bg-color: rgba(99, 102, 241, 0.15);
      --fc-border-color: #334155;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
      
    /* --- MEJORA LAYOUT PC (Sin Scroll Global en App, Con Scroll en Login) --- */
    body { 
        font-family: 'Inter', sans-serif; 
        background-color: var(--background-color); 
        color: var(--text-color-dark); 
        line-height: 1.6; 
        font-size: 15px; 
        height: 100vh; 
        width: 100vw;
        overflow: hidden; /* Oculta scroll del body por defecto */
    }

    /* CORRECCION 3: Permitir scroll cuando estamos en Login/Registro */
    body.auth-visible {
        overflow-y: auto !important; 
        height: auto !important;
        min-height: 100vh;
    }
      
    h1, h2, h3, h4, h5 { font-family: 'Poppins', sans-serif; }

    /* LOGOS - CORRECCION 1: Eliminado filter: invert(1) para que se vea el logo original */
    #app-logo, #login-logo { max-width: 160px; max-height: 70px; object-fit: contain; transition: all 0.3s; }
      
    /* LOADER */
    #loader-overlay { position: fixed; inset: 0; background: rgba(15, 23, 42, 0.6); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(8px); }
    .spinner { width: 50px; height: 50px; border: 4px solid rgba(255,255,255,0.1); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s cubic-bezier(0.68, -0.55, 0.27, 1.55) infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* OFFLINE STATUS */
    .connection-status { padding: 0.4rem 1rem; border-radius: 50px; font-size: 0.8em; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; box-shadow: var(--shadow-sm); transition: all 0.3s; border: 1px solid transparent; }
    .status-online { background-color: rgba(16, 185, 129, 0.1); color: var(--success-color); border-color: rgba(16, 185, 129, 0.2); }
    .status-offline { background-color: rgba(239, 68, 68, 0.1) !important; color: var(--danger-color) !important; border-color: rgba(239, 68, 68, 0.2) !important; }
    .status-syncing { background-color: rgba(245, 158, 11, 0.1); color: var(--warning-color); border-color: rgba(245, 158, 11, 0.2); }
    .status-indicator-dot { width: 8px; height: 8px; border-radius: 50%; background-color: currentColor; box-shadow: 0 0 8px currentColor; }

    /* LAYOUT PRINCIPAL (FLEXBOX) */
    #app-wrapper { display: flex; height: 100vh; overflow: hidden; }
      
    .main-content { 
        flex: 1; 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        overflow: hidden; 
        position: relative; 
    }
      
    .main-header { 
        display: flex; 
        align-items: center; 
        justify-content: space-between; 
        padding: 1rem 2rem; 
        background-color: var(--card-background); 
        border-bottom: 1px solid var(--border-color); 
        position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); 
        flex-shrink: 0; 
    }
      
    .search-box { position: relative; margin: 0 1.5rem; flex: 1; max-width: 500px; }
    .search-box input { width: 100%; padding: 0.7rem 1.4rem; border-radius: 50px; border: 1px solid var(--border-color); background: var(--input-bg); color: var(--text-color-dark); margin-bottom: 0; transition: all 0.2s ease; font-size: 0.95rem; }
    .search-box input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 4px rgba(99, 102, 241, 0.1); background: var(--card-background); }

    /* MAIN CON SCROLL INDEPENDIENTE */
    main { 
        padding: 1.5rem; 
        flex: 1; 
        width: 100%; 
        max-width: 100%; 
        margin: 0 auto; 
        box-sizing: border-box; 
        overflow-y: auto; 
        overflow-x: hidden;
        padding-bottom: 6rem; /* Espacio extra */
    }
    @media (min-width: 768px) { main { padding: 2.5rem; padding-bottom: 6rem; } }
      
    /* Scrollbar Personalizado */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: transparent; }
    ::-webkit-scrollbar-thumb { background: var(--border-color); border-radius: 4px; }
    ::-webkit-scrollbar-thumb:hover { background: var(--text-color-light); }
      
    section { display: none; animation: slideUp 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
    section.active { display: block; }
    @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

    /* SIDEBAR */
    .sidebar { 
        width: 280px; 
        background-color: var(--sidebar-background); 
        border-right: 1px solid var(--border-color); 
        display: flex; 
        flex-direction: column; 
        padding: 1.5rem 1rem; 
        height: 100%; 
        z-index: 1000; 
        transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
        backdrop-filter: blur(10px); 
        overflow-y: auto; 
        flex-shrink: 0;
    }
    .sidebar-header { text-align: center; margin-bottom: 2rem; flex-shrink: 0; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; overflow-y: auto; padding-right: 5px; }
    .sidebar-footer { margin-top: auto; padding-top: 1.5rem; border-top: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; gap: 1rem; }
      
    #btn-nuevo-proyecto-sidebar { background: var(--primary-gradient); color: white; text-align: center; padding: 1rem; border-radius: 12px; margin-bottom: 1.5rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.3); border: none; transition: transform 0.2s, box-shadow 0.2s; display: flex; align-items: center; justify-content: center; gap: 0.5rem; }
    #btn-nuevo-proyecto-sidebar:hover { transform: translateY(-2px); box-shadow: 0 8px 20px rgba(99, 102, 241, 0.4); }
      
    .nav-group summary { list-style: none; padding: 0.75rem 0.8rem; font-weight: 700; color: var(--text-color-light); cursor: pointer; position: relative; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.2px; transition: color 0.2s; }
    .nav-group summary:hover { color: var(--primary-color); }
    .nav-group summary::before { content: '‚Ä∫'; display: inline-block; width: 15px; transition: transform 0.2s; color: var(--primary-color); font-size: 1.2em; line-height: 0; vertical-align: middle; margin-right: 5px; }
    .nav-group[open] > summary::before { transform: rotate(90deg); }
    .nav-group ul { list-style: none; padding-left: 0.5rem; margin-top: 0.2rem; }
      
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; border-radius: 10px; text-decoration: none; color: var(--text-color-light); font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .nav-link:hover { background-color: var(--secondary-button-bg); color: var(--text-color-dark); }
    .nav-link.active-link { background: rgba(99, 102, 241, 0.1); color: var(--primary-color); font-weight: 600; }

    #hamburger-menu, #btn-enviar-datos-bancarios { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; border-radius: 8px; transition: background 0.2s; }
    #hamburger-menu:hover, #btn-enviar-datos-bancarios:hover { background-color: var(--secondary-button-bg); }
    #hamburger-menu svg, #btn-enviar-datos-bancarios svg { width: 24px; height: 24px; stroke: var(--text-color-dark); }
      
    #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.6); z-index: 998; backdrop-filter: blur(4px); transition: opacity 0.3s; }

    /* FAB (Floating Action Button) MOVIL */
    .fab-container { position: fixed; bottom: 20px; right: 20px; z-index: 900; display: none; }
    .fab-btn { width: 56px; height: 56px; border-radius: 50%; background: var(--primary-gradient); color: white; border: none; box-shadow: 0 4px 15px rgba(99, 102, 241, 0.5); display: flex; align-items: center; justify-content: center; font-size: 24px; cursor: pointer; transition: transform 0.2s; }
    .fab-btn:active { transform: scale(0.9); }

    /* OCULTAR FAB EN LOGIN */
    body.auth-visible .fab-container { display: none !important; }

    /* MODO CLIENTE */
    body.client-mode .sidebar { display: none !important; }
    body.client-mode #hamburger-menu { display: none !important; }
    body.client-mode .search-box { display: none !important; }
    body.client-mode .fab-container { display: none !important; }
    body.client-mode .main-header { justify-content: center; }
    
    /* RESPONSIVE */
    @media (max-width: 768px) {
      body { overflow: auto; height: auto; } /* En movil si permitimos scroll del body */
      #app-wrapper { display: block; height: auto; overflow: visible; }
      #hamburger-menu, #btn-enviar-datos-bancarios { display: block; }
      .fab-container { display: block; }
        
      .main-header { position: sticky; top:0; padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.8rem; }
      .search-box { display: block; width: 100%; max-width: none; margin: 0.5rem 0 0 0; order: 99; }
        
      main { overflow: visible; } 

      .sidebar { position: fixed; left: 0; top: 0; bottom: 0; transform: translateX(-100%); width: 85%; max-width: 300px; box-shadow: 10px 0 30px rgba(0,0,0,0.2); overflow-y: auto; }
      .sidebar.sidebar-visible { transform: translateX(0); }
      #sidebar-overlay.overlay-visible { display: block; }
      .connection-status span { display: none; } 
        
      #btn-nuevo-proyecto-sidebar { display: none; }
    }
      
    @media (max-width: 900px) and (orientation: landscape) {
        .sidebar { width: 300px; }
        .main-header { position: relative; } 
        .modal-content { max-height: 85vh; }
    }

    @media (min-width: 769px) {
      #hamburger-menu { display: none; }
      #btn-enviar-datos-bancarios { display: block; }
    }
      
    /* COMPONENTES UI */
    .card { background-color: var(--card-background); border-radius: 16px; padding: 2rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); transition: box-shadow 0.3s ease, transform 0.3s ease; }
    .card:hover { box-shadow: var(--shadow-md); }
      
    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; flex-wrap: wrap; gap: 1rem; }
    .card-header h2 { font-size: 1.4rem; font-weight: 700; color: var(--text-color-dark); margin: 0; }
      
    form label { display: block; margin-bottom: 0.5rem; font-weight: 500; font-size: 0.9rem; color: var(--text-color-light); }
    form input, form select, form textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 12px; margin-bottom: 1.25rem; background-color: var(--input-bg); color: var(--text-color-dark); transition: all 0.3s; font-family: inherit; }
    form input:focus, form select:focus, form textarea:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1); background-color: var(--card-background); }
      
    .password-wrapper { position: relative; }
    #toggle-password, #toggle-password-reg { position: absolute; right: 1rem; top: 35%; cursor: pointer; opacity: 0.6; user-select: none; }
      
    button { cursor: pointer; border-radius: 10px; border: none; padding: 0.75rem 1.5rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; letter-spacing: 0.3px; }
    button:active { transform: scale(0.97); }
      
    button[type="submit"], .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 10px -2px rgba(99, 102, 241, 0.4); }
    button[type="submit"]:hover, .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 6px 15px -2px rgba(99, 102, 241, 0.5); }
      
    .btn-eliminar, .btn-vaciar { background: var(--danger-gradient); color: white !important; }
      
    .btn-secondary { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: var(--secondary-button-hover-bg); border-color: var(--text-color-light); }
    .btn-secondary.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
      
    .btn-restaurar, .btn-aprobar { background: var(--success-gradient); color: white; }
      
    .table-actions button, .list-item-actions button { padding: 0.5rem; width: 36px; height: 36px; border-radius: 8px; margin: 0 2px; }

    /* DASHBOARD KPIS */
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; }
    .kpi-card { display: flex; align-items: center; justify-content: space-between; padding: 1.5rem; border-left: 5px solid var(--primary-color); overflow: hidden; position: relative; }
    .kpi-content { z-index: 1; }
    .kpi-value { font-size: 2rem; font-weight: 800; color: var(--text-color-dark); margin-bottom: 0.2rem; }
    .kpi-label { font-size: 0.85rem; color: var(--text-color-light); text-transform: uppercase; font-weight: 600; letter-spacing: 0.5px; }
    .kpi-icon { font-size: 3rem; opacity: 0.1; color: var(--text-color-dark); position: absolute; right: 1rem; bottom: -0.5rem; transform: rotate(-10deg); }

    /* TABLAS */
    .table-responsive { width: 100%; overflow-x: auto; border-radius: 12px; border: 1px solid var(--border-color); max-height: 65vh; }
    table { width: 100%; border-collapse: collapse; border-spacing: 0; }
    th { position: sticky; top: 0; z-index: 10; padding: 1.2rem 1rem; text-align: left; color: var(--text-color-light); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 1px solid var(--border-color); background: var(--secondary-button-bg); white-space: nowrap; box-shadow: 0 2px 2px -1px rgba(0,0,0,0.1); }
    td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); color: var(--text-color-dark); }
    tbody tr:last-child td { border-bottom: none; }
    tbody tr:hover { background-color: var(--secondary-button-bg); }

    /* KANBAN */
    .kanban-board { display: flex; overflow-x: auto; gap: 1.5rem; padding-bottom: 1rem; align-items: flex-start; scroll-snap-type: x mandatory; }
    .kanban-column { min-width: 300px; max-width: 300px; background-color: var(--secondary-button-bg); border-radius: 16px; padding: 1rem; border: 1px solid var(--border-color); scroll-snap-align: start; }
    .kanban-column h3 { text-align: center; margin: 0 0 1rem 0; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); font-size: 0.9em; text-transform: uppercase; letter-spacing: 1px; color: var(--text-color-light); }
      
    .project-card { background: var(--card-background); padding: 1rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border-left: 4px solid; transition: transform 0.2s, box-shadow 0.2s; cursor: grab; }
    .project-card:hover { box-shadow: var(--shadow-md); transform: translateY(-3px); }
    .project-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.7em; color: white; font-weight: 700; text-transform: uppercase; }
    .proceso-tag { padding: 3px 8px; border-radius: 6px; color: white; font-size: 0.7em; display: inline-block; margin-top: 8px; font-weight: 600; }

    /* M√ìVIL TABLAS CARD VIEW */
    @media (max-width: 768px) {
        .table-responsive { max-height: none; }
        .table-responsive table, .table-responsive thead, .table-responsive tbody, .table-responsive th, .table-responsive td, .table-responsive tr { display: block; width: 100%; }
        .table-responsive thead tr { position: absolute; top: -9999px; left: -9999px; }
        .table-responsive tr { margin-bottom: 1rem; border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; background-color: var(--card-background); box-shadow: var(--shadow-sm); }
        .table-responsive td { border: none; border-bottom: 1px solid var(--border-color); position: relative; padding-left: 40% !important; padding-right: 0; text-align: right; white-space: normal; }
        .table-responsive td:last-child { border-bottom: none; display: flex; justify-content: flex-end; padding-left: 0 !important; gap: 0.5rem; flex-wrap: wrap;}
        .table-responsive td:before { position: absolute; top: 1rem; left: 0; width: 35%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: 700; color: var(--text-color-light); font-size: 0.8em; text-transform: uppercase; }
        
        #tablaCotizacionesBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaCotizacionesBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaCotizacionesBody td:nth-of-type(3):before { content: "Fecha:"; }
        #tablaPagosBody td:nth-of-type(1):before { content: "Fecha:"; }
        #tablaPagosBody td:nth-of-type(2):before { content: "Proyecto:"; }
        #tablaPagosBody td:nth-of-type(3):before { content: "Monto:"; }
        #tablaPagosBody td:nth-of-type(4):before { content: "M√©todo:"; }
          
        #tablaPendientesBody td:nth-of-type(1):before { content: "Proyecto:"; }
        #tablaPendientesBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaPendientesBody td:nth-of-type(3):before { content: "Pagado:"; }
        #tablaPendientesBody td:nth-of-type(4):before { content: "Restante:"; }

        #tablaHistorialBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaHistorialBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaHistorialBody td:nth-of-type(3):before { content: "Pagado:"; }
        #tablaHistorialBody td:nth-of-type(4):before { content: "Fecha:"; }
          
        .kanban-board { flex-direction: column; overflow-x: hidden; }
        .kanban-column { max-width: 100%; width: 100%; }
    }

    /* MODALES */
    .modal-overlay { position: fixed; inset: 0; background-color: rgba(15, 23, 42, 0.7); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(5px); animation: fadeIn 0.2s ease-out; }
    .modal-content { background: var(--card-background); padding: 2rem; border-radius: 20px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.25); border: 1px solid var(--border-color); animation: scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1); }
    @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
      
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
    .modal-close { font-size: 2rem; cursor: pointer; background: none; border: none; color: var(--text-color-light); line-height: 1; padding: 0; transition: color 0.2s; }
    .modal-close:hover { color: var(--danger-color); }

    /* UTILS & LOGIN CORREGIDO (CORRECCION 3) */
    .clickable-artist { cursor: pointer; font-weight: 600; color: var(--primary-color); }
    .clickable-artist:hover { text-decoration: underline; }
      
    .theme-toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 0.9rem; }
    .theme-switch { position: relative; display: inline-block; width: 44px; height: 24px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 34px; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; box-shadow: 0 2px 4px rgba(0,0,0,0.2); }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(20px); }

    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; }
    .info-row { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; background: var(--secondary-button-bg); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; border: 1px solid var(--border-color); }
    #totalAPagar { font-size: 1.6rem; font-weight: 800; color: var(--primary-color); }

    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; background-color: var(--card-background); border: 1px solid var(--border-color); transition: transform 0.2s; }
    .list-item:hover { transform: translateX(5px); border-color: var(--primary-color); }

    /* Ajuste para que login quepa en pantalla peque√±a de laptop */
    #login-container { 
        max-width: 400px; 
        margin: 5vh auto; /* Margen superior reducido */
        padding: 2.5rem; 
        width: 90%;
    }
    .auth-links { margin-top: 1.5rem; text-align: center; font-size: 0.9rem; }
    .auth-links a { color: var(--primary-color); text-decoration: none; font-weight: 500; cursor: pointer; margin: 0 0.5rem; }
    .auth-links a:hover { text-decoration: underline; }

    .permissions-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 0.5rem; margin-bottom: 1rem; background: var(--secondary-button-bg); padding: 1rem; border-radius: 12px; border: 1px solid var(--border-color); }
    .permission-item { display: flex; align-items: center; gap: 0.5rem; font-size: 0.85rem; cursor: pointer; }
    .permission-item input { width: auto; margin: 0; }
  </style>
</head>
<body>
  <div id="loader-overlay"><div class="spinner"></div></div>

  <div id="login-container" class="card">
    <div style="text-align: center; margin-bottom: 2rem;">
      <img id="login-logo" src="https://placehold.co/180x80?text=FiaRecords" alt="Logotipo">
    </div>

    <div id="login-view">
        <h3 style="text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Iniciar Sesi√≥n</h3>
        <form id="login-form">
          <div><label for="username">Usuario</label><input type="text" id="username" required></div>
          <div>
            <label for="password">Contrase√±a</label>
            <div class="password-wrapper">
              <input type="password" id="password" required>
              <span id="toggle-password">üëÅÔ∏è</span>
            </div>
          </div>
          <button type="submit" style="width:100%; margin-top:1rem;">Entrar al Estudio</button>
        </form>
        <div class="auth-links">
            <a onclick="app.toggleAuth('register')">Crear Cuenta</a> | <a onclick="app.toggleAuth('recover')">¬øOlvidaste tu contrase√±a?</a>
        </div>
    </div>

    <div id="register-view" style="display:none;">
        <h3 style="text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Crear Cuenta de Artista</h3>
        <form id="register-form" onsubmit="app.registerUser(event)">
            <div><label>Nombre de Usuario</label><input type="text" id="reg-username" required></div>
            <div><label>Correo Electr√≥nico</label><input type="email" id="reg-email" required></div>
            <div><label>Nombre Art√≠stico (o Real)</label><input type="text" id="reg-artistname" required></div>
            <div>
                <label>Contrase√±a</label>
                <div class="password-wrapper">
                    <input type="password" id="reg-password" required>
                    <span id="toggle-password-reg">üëÅÔ∏è</span>
                </div>
            </div>
            <button type="submit" style="width:100%; margin-top:1rem;">Registrarse</button>
        </form>
        <div class="auth-links">
            <a onclick="app.toggleAuth('login')">‚Üê Volver al Login</a>
        </div>
    </div>

    <div id="recover-view" style="display:none;">
        <h3 style="text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Recuperar Contrase√±a</h3>
        <p style="font-size:0.85em; text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Ingresa tu correo para restablecer tu acceso.</p>
        <form id="recover-form" onsubmit="app.recoverPassword(event)">
            <div><label>Correo Electr√≥nico</label><input type="email" id="rec-email" required></div>
            <button type="submit" style="width:100%; margin-top:1rem;">Enviar Enlace</button>
        </form>
        <div class="auth-links">
            <a onclick="app.toggleAuth('login')">‚Üê Volver al Login</a>
        </div>
    </div>

    <div id="reset-password-view" style="display:none;">
      <h3 style="text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Nueva Contrase√±a</h3>
      <p style="font-size:0.85em; text-align:center; margin-bottom:1rem; color:var(--text-color-light);">Introduce tu nueva contrase√±a.</p>
      <form onsubmit="app.resetPassword(event)">
          <input type="hidden" id="reset-token">
          <div>
              <label>Nueva Contrase√±a</label>
              <div class="password-wrapper">
                <input type="password" id="new-password" required>
              </div>
          </div>
          <button type="submit" style="width:100%; margin-top:1rem;">Guardar Cambios</button>
      </form>
      <div class="auth-links">
          <a onclick="app.toggleAuth('login')">Cancelar</a>
      </div>
    </div>

    <p id="login-error" style="color: var(--danger-color); text-align: center; margin-top: 1rem; font-size: 0.9rem;"></p>
  </div>
    
  <div id="app-wrapper">
    <div id="sidebar-overlay"></div>
      
    <nav class="sidebar">
      <div class="sidebar-header"><img id="app-logo" src="https://placehold.co/180x80?text=FiaRecords" alt="Logotipo"></div>
        
      <a id="btn-nuevo-proyecto-sidebar" class="nav-link" data-seccion="registrar-proyecto">
        <svg width="20" height="20" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15"></path></svg>
        <span>Nuevo Proyecto</span>
      </a>
        
      <div class="sidebar-nav" id="sidebar-nav-container">
        </div>
        
      <div class="sidebar-footer">
        <div id="customization-container" style="display: none;">
          <p style="font-size: 0.8em; text-align: center; margin-bottom: 0.5rem; color: var(--text-color-light);">Clic en logo para cambiar</p>
          <input type="file" id="logo-input" accept="image/*" style="display: none;">
        </div>
        <div class="theme-toggle-container">
          <span style="font-size: 0.9em; font-weight: 500;">Modo Oscuro</span>
          <label class="theme-switch">
            <input type="checkbox" id="theme-switch" />
            <span class="slider"></span>
          </label>
        </div>
        <button id="logout-button" class="btn-eliminar" style="width: 100%;">
          <svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"></path></svg>
          Salir
        </button>
      </div>
    </nav>

    <div class="main-content">
        <header class="main-header">
            <button id="hamburger-menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div id="welcome-user" style="font-weight: 700; font-size: 1.1rem;"></div>
              
            <div class="search-box">
                <input type="text" id="globalSearch" placeholder="üîç Buscar proyecto, artista..." onkeyup="app.filtrarTablas(this.value)">
            </div>
              
            <div class="header-actions">
              <div id="connection-status" class="connection-status status-online" onclick="app.syncNow()">
                  <div class="status-indicator-dot"></div>
                  <span id="connection-text">En L√≠nea</span>
              </div>

              <button id="btn-enviar-datos-bancarios" title="Enviar Datos Bancarios" class="btn-secondary" style="padding: 0.6rem; border-radius: 50%;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                </svg>
              </button>
            </div>
        </header>

        <main>
            <section id="dashboard" class="active">
                <div class="card-header">
                  <h2>Resumen General</h2>
                  <span style="font-size: 0.9em; color: var(--text-color-light);">Vista general del estudio</span>
                </div>
                <div class="grid-container">
                    <div class="card kpi-card" style="border-color: var(--success-color);">
                      <div class="kpi-content">
                        <div class="kpi-value" id="kpi-ingresos-mes">$0.00</div>
                        <div class="kpi-label">Ingresos del Mes</div>
                      </div>
                      <div class="kpi-icon">üí≤</div>
                    </div>
                    <div class="card kpi-card" style="border-color: var(--primary-color);">
                      <div class="kpi-content">
                        <div class="kpi-value" id="kpi-proyectos-activos">0</div>
                        <div class="kpi-label">Proyectos Activos</div>
                      </div>
                      <div class="kpi-icon">üéöÔ∏è</div>
                    </div>
                    <div class="card kpi-card" style="border-color: var(--warning-color);">
                      <div class="kpi-content">
                        <div class="kpi-value" id="kpi-proyectos-por-cobrar">0</div>
                        <div class="kpi-label">Proyectos por Cobrar</div>
                      </div>
                      <div class="kpi-icon">‚è≥</div>
                    </div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <h3>Tendencia de Ingresos</h3>
                    <div style="height: 350px; position: relative;">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="agenda"><div class="card"><div id="calendario"></div></div></section>

            <section id="cotizaciones">
              <div class="card">
                <div class="card-header"><h2>Cotizaciones Pendientes</h2></div>
                <div class="table-responsive">
                  <table>
                    <thead><tr><th>Artista</th><th>Total</th><th>Fecha</th><th>Acciones</th></tr></thead>
                    <tbody id="tablaCotizacionesBody"></tbody>
                  </table>
                </div>
              </div>
            </section>

            <section id="flujo-trabajo">
              <div class="card" style="background: transparent; border: none; box-shadow: none; padding: 0;">
                <div class="card-header" style="background: var(--card-background); padding: 1.5rem; border-radius: 16px; margin-bottom: 1.5rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color);">
                  <h2>Flujo de Trabajo</h2>
                  <div class="filter-buttons" id="filtrosFlujo" style="margin-top: 0.5rem; display: flex; gap: 0.5rem; flex-wrap: wrap;"></div>
                </div>
                <div class="kanban-board" id="kanbanBoard"></div>
              </div>
            </section>

            <section id="pagos">
              <div class="card">
                <div class="card-header">
                    <h2>Gesti√≥n de Pagos</h2>
                    <div class="filter-buttons">
                        <button class="btn-secondary active" onclick="app.mostrarSeccionPagos('pendientes', this)">Pendientes de Cobro</button>
                        <button class="btn-secondary" onclick="app.mostrarSeccionPagos('historial', this)">Historial de Transacciones</button>
                    </div>
                </div>
                  
                <div id="vista-pagos-pendientes">
                    <h3 style="margin-bottom: 1rem; color: var(--warning-color);">Proyectos con Saldo Pendiente</h3>
                    <div class="table-responsive">
                      <table>
                        <thead><tr><th>Proyecto/Artista</th><th>Total</th><th>Pagado</th><th>Restante</th><th>Acciones</th></tr></thead>
                        <tbody id="tablaPendientesBody"></tbody>
                      </table>
                    </div>
                </div>

                <div id="vista-pagos-historial" style="display:none;">
                    <h3 style="margin-bottom: 1rem;">Historial Completo</h3>
                    <div class="table-responsive">
                      <table>
                        <thead><tr><th>Fecha</th><th>Artista / Proyecto</th><th>Monto</th><th>M√©todo</th><th>Acciones</th></tr></thead>
                        <tbody id="tablaPagosBody"></tbody>
                      </table>
                    </div>
                </div>
              </div>
            </section>

            <section id="registrar-proyecto">
              <div class="card" style="max-width: 800px; margin: auto;">
                <div class="card-header"><h2>Nuevo Proyecto / Cotizaci√≥n</h2></div>
                <form id="formProyecto" onsubmit="return false;">
                  <label for="proyectoArtista">Artista/Cliente</label>
                  <div id="artista-selector-container" style="display: flex; gap: 0.5rem;">
                    <select id="proyectoArtista"><option value="publico_general">P√∫blico General</option></select>
                    <button type="button" id="btnNuevoArtista" title="Registrar nuevo artista" class="btn-primary" style="padding: 0.75rem 1rem;">+</button>
                  </div>
                
                  <div id="nuevoArtistaContainer" style="display: none; background: var(--secondary-button-bg); padding: 1rem; border-radius: 10px; margin-bottom: 1rem;">
                    <label>Nombre del Nuevo Artista</label>
                    <div class="form-row" style="align-items: center; gap: 0.5rem;">
                      <input type="text" id="nombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;">
                      <button type="button" id="btnGuardarNuevoArtista" class="btn-secondary" style="margin-bottom: 0; padding: 0.75rem;">Guardar</button>
                    </div>
                  </div>

                  <div class="form-row">
                    <div class="form-group"><label for="nombreProyecto">Nombre del Proyecto (Opcional)</label><input type="text" id="nombreProyecto" /></div>
                  </div>
                    
                  <div style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.5rem;">
                    <input type="checkbox" id="esAlbum" name="esAlbum" style="width: auto; margin-bottom: 0;">
                    <label for="esAlbum" style="margin-bottom: 0; cursor: pointer;">Es un Disco/EP Completo</label>
                  </div>

                  <hr style="margin: 1.5rem 0; border: none; border-top: 1px dashed var(--border-color);">
                  <h3>A√±adir Servicios</h3>
                    
                  <div class="form-row">
                    <div class="form-group" style="flex: 2;"><label for="proyectoServicio">Servicio</label><select id="proyectoServicio"></select></div>
                    <div class="form-group"><label for="proyectoUnidades">Cant.</label><input type="number" id="proyectoUnidades" min="1" value="1"></div>
                  </div>
                  <button type="button" id="btnAgregarAProyecto" class="btn-secondary" style="width:100%; border-style: dashed;">+ Agregar Servicio</button>
                    
                  <ul id="listaProyectoActual" style="list-style: none; padding: 0; margin-top: 1.5rem;"></ul>
                
                  <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                      <div class="form-row" style="justify-content: flex-end; align-items: center; margin-bottom: 0.5rem;">
                          <label style="margin-right: 1rem; margin-bottom: 0;">Descuento ($):</label>
                          <input type="number" id="proyectoDescuento" min="0" step="0.01" placeholder="0.00" style="width: 150px; margin-bottom: 0;">
                      </div>
                      <div class="info-row"><label style="margin:0;">Total a Pagar:</label><span id="totalAPagar">$0.00</span></div>
                        
                      <div class="form-row">
                          <div class="form-group"><label for="fechaProyecto">Fecha de Inicio</label><input type="text" id="fechaProyecto"></div>
                          <div class="form-group"><label for="horaProyecto">Hora</label><input type="time" id="horaProyecto"></div>
                      </div>
                        
                      <div class="form-actions" style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button id="btnGenerarCotizacion" class="btn-secondary" style="flex:1;">Generar PDF Cotizaci√≥n</button>
                        <button id="btnEnviarAFlujo" class="btn-primary" style="flex:1;">Guardar y Agendar</button>
                      </div>
                  </div>
                </form>
              </div>
            </section>

            <section id="registro-manual">
              <div class="card" style="max-width: 800px; margin: auto;">
                <div class="card-header"><h2>Registro Manual R√°pido</h2><p style="font-size: 0.9em; color: var(--text-color-light);">Para proyectos pasados o sin costo.</p></div>
                <form id="formProyectoManual" onsubmit="return false;">
                  <label for="manualProyectoArtista">Artista/Cliente</label>
                  <div id="manual-artista-selector-container" style="display: flex; gap: 0.5rem;">
                    <select id="manualProyectoArtista" required></select>
                    <button type="button" id="manualBtnNuevoArtista" class="btn-primary" style="padding: 0.75rem 1rem;">+</button>
                  </div>
                  <div id="manualNuevoArtistaContainer" style="display: none; background: var(--secondary-button-bg); padding: 1rem; border-radius: 10px; margin: 1rem 0;">
                    <label>Nombre del Nuevo Artista</label>
                    <div class="form-row" style="align-items: center; gap: 0.5rem;">
                      <input type="text" id="manualNombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;">
                      <button type="button" id="btnGuardarManualNuevoArtista" class="btn-secondary" style="margin-bottom: 0; padding: 0.75rem;">Guardar</button>
                    </div>
                  </div>
                  <label for="manualNombreProyecto">Nombre del Proyecto</label><input type="text" id="manualNombreProyecto" required />
                  <label for="manualFechaProyecto">Fecha Original</label><input type="text" id="manualFechaProyecto" required />
                  <label for="manualDescripcion">Descripci√≥n</label><textarea id="manualDescripcion" rows="3"></textarea>
                  <button type="button" onclick="app.guardarProyectoManual()" style="width: 100%;">Guardar Hist√≥rico</button>
                </form>
              </div>
            </section>

            <section id="historial-proyectos">
              <div class="card">
                <div class="card-header"><h2>Proyectos Completados</h2></div>
                <div class="table-responsive">
                  <table>
                    <thead><tr><th>Artista</th><th>Total</th><th>Pagado</th><th>Fecha</th><th>Acciones</th></tr></thead>
                    <tbody id="tablaHistorialBody"></tbody>
                  </table>
                </div>
              </div>
            </section>

            <section id="vista-artista"><div class="card"><div class="card-header"><h2 id="vista-artista-nombre"></h2></div><div id="vista-artista-contenido"></div></div></section>

            <section id="gestion-servicios">
              <div class="card">
                <div class="card-header"><h2>Gesti√≥n de Servicios</h2></div>
                <form id="formServicios">
                  <input type="hidden" id="idServicio">
                  <div class="form-row">
                    <div class="form-group"><input type="text" id="nombreServicio" placeholder="Nombre Servicio" required /></div>
                    <div class="form-group"><input type="number" step="0.01" id="precioServicio" placeholder="Precio ($)" required /></div>
                  </div>
                  <div class="form-actions"><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormServicios">Limpiar</button></div>
                </form>
                <h3 style="margin-top: 2rem;">Listado</h3><ul id="listaServicios"></ul>
              </div>
            </section>

            <section id="gestion-artistas">
              <div class="card">
                <div class="card-header"><h2>Gesti√≥n de Artistas</h2></div>
                <form id="formArtistas">
                  <input type="hidden" id="idArtista">
                  <div class="form-row">
                    <div class="form-group"><label>Nombre Real</label><input type="text" id="nombreArtista" required /></div>
                    <div class="form-group"><label>Nombre Art√≠stico</label><input type="text" id="nombreArtisticoArtista" /></div>
                  </div>
                  <div class="form-row">
                    <div class="form-group"><label>Tel√©fono</label><input type="tel" id="telefonoArtista" /></div>
                    <div class="form-group"><label>Correo</label><input type="email" id="correoArtista" /></div>
                  </div>
                  <div class="form-actions"><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormArtistas">Limpiar</button></div>
                </form>
                <h3 style="margin-top: 2rem;">Directorio</h3><ul id="listaArtistas"></ul>
              </div>
            </section>

            <section id="gestion-usuarios">
              <div class="card">
                <div class="card-header"><h2>Gesti√≥n de Usuarios y Roles</h2></div>
                <form id="formUsuarios">
                  <input type="hidden" id="idUsuario">
                  <div class="form-row">
                    <div class="form-group"><label>Usuario</label><input type="text" id="usernameUsuario" placeholder="Usuario" required /></div>
                    <div class="form-group"><label>Contrase√±a</label><input type="password" id="passwordUsuario" placeholder="Vac√≠o si no cambia" /></div>
                  </div>
                    
                  <label>Nombre del Rol (Escribe el nombre: ej. Dise√±ador, Cliente, Admin)</label>
                  <input type="text" id="roleUsuario" list="roles-sugeridos" placeholder="Escribe el rol..." required style="margin-bottom:0.5rem;">
                  <datalist id="roles-sugeridos">
                      <option value="Admin">Acceso Total</option>
                      <option value="Ingeniero">Estudio</option>
                      <option value="Cliente">Solo sus archivos</option>
                      <option value="Dise√±ador">Archivos y Flujo</option>
                  </datalist>

                  <label style="margin-top:1rem; display:block; font-weight:600;">Permisos de Acceso:</label>
                  <div class="permissions-grid">
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="dashboard"> Dashboard</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="agenda"> Agenda</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="flujo-trabajo"> Flujo Trabajo</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="finanzas"> Finanzas (Cot/Pagos)</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="historial-proyectos"> Historial</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="gestion-artistas"> Artistas</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="gestion-servicios"> Servicios</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="gestion-usuarios"> Usuarios (Admin)</label>
                      <label class="permission-item"><input type="checkbox" name="user_permisos" value="configuracion"> Configuraci√≥n</label>
                  </div>

                  <div class="form-actions"><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormUsuarios">Limpiar</button></div>
                </form>
                <h3 style="margin-top: 2rem;">Equipo</h3><ul id="listaUsuarios"></ul>
              </div>
            </section>

            <section id="papelera-reciclaje">
              <div class="card">
                  <h2>Papelera de Reciclaje</h2>
                  <div class="form-row">
                    <div class="form-group"><h3>Servicios <button class="btn-vaciar" style="padding: 0.3rem 0.6rem; font-size:0.7em;" onclick="app.vaciarPapelera('servicios')">Vaciar</button></h3><ul id="papeleraServicios"></ul></div>
                    <div class="form-group"><h3>Artistas <button class="btn-vaciar" style="padding: 0.3rem 0.6rem; font-size:0.7em;" onclick="app.vaciarPapelera('artistas')">Vaciar</button></h3><ul id="papeleraArtistas"></ul></div>
                  </div>
                  <h3>Proyectos <button class="btn-vaciar" style="padding: 0.3rem 0.6rem; font-size:0.7em;" onclick="app.vaciarPapelera('proyectos')">Vaciar</button></h3><ul id="papeleraProyectos"></ul>
                  <h3 style="margin-top: 1.5rem;">Usuarios <button class="btn-vaciar" style="padding: 0.3rem 0.6rem; font-size:0.7em;" onclick="app.vaciarPapelera('usuarios')">Vaciar</button></h3><ul id="papeleraUsuarios"></ul>
              </div>
            </section>
              
            <section id="configuracion">
              <div class="card">
                <div class="card-header"><h2>Configuraci√≥n del Sistema</h2></div>
                  
                <div class="info-row">
                  <div>
                    <h3>Firma Digital</h3>
                    <p style="font-size: 0.9em; opacity: 0.8;">Esta firma aparecer√° en Cotizaciones y Recibos.</p>
                  </div>
                  <div style="text-align: center;">
                      <img id="firma-preview-img" src="https://placehold.co/150x60?text=Sin+Firma" alt="Firma" style="border: 1px dashed var(--border-color); border-radius: 8px; margin-bottom: 0.5rem; background: white;">
                      <input type="file" id="firma-input" accept="image/png" style="display: none;">
                      <button onclick="document.getElementById('firma-input').click()" class="btn-secondary" style="font-size: 0.8em; padding: 0.4rem 1rem;">Cambiar</button>
                  </div>
                </div>
                  
                <div style="margin: 2rem 0; padding: 1rem; border: 1px dashed var(--border-color); border-radius: 12px; background: var(--secondary-button-bg);">
                    <h4>Prueba de Google Drive</h4>
                    <p style="font-size:0.85em;">Verifica que la API est√© conectada y puedas subir archivos.</p>
                    <button onclick="app.openDeliveryModal('prueba_config', 'Sistema', 'Prueba Conexi√≥n')" class="btn-secondary">Abrir Modal de Subida</button>
                </div>

                <hr style="margin: 2rem 0; border:none; border-top: 1px solid var(--border-color);">

                <h3>Ajuste de Posici√≥n en PDF</h3>
                <div id="config-layout">
                  <label for="doc-type-selector">Documento:</label>
                  <select id="doc-type-selector" onchange="app.cargarAjustesParaDocumento(this.value)" style="margin-bottom: 1.5rem;">
                    <option value="cotizacion">Cotizaci√≥n</option>
                    <option value="recibo">Recibo de Pago</option>
                    <option value="contrato">Contrato</option>
                    <option value="distribucion">Hoja Distribuci√≥n</option>
                  </select>

                  <div class="grid-container">
                    <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 12px;">
                        <h4>Alineaci√≥n</h4>
                        <div style="margin: 1rem 0;">
                            <strong>Vertical:</strong> 
                            <label><input type="radio" name="vAlign" value="top" onchange="app.actualizarPosicionFirma()"> Top</label>
                            <label><input type="radio" name="vAlign" value="middle" onchange="app.actualizarPosicionFirma()"> Mid</label>
                            <label><input type="radio" name="vAlign" value="bottom" onchange="app.actualizarPosicionFirma()"> Bot</label>
                        </div>
                        <div style="margin: 1rem 0;">
                            <strong>Horizontal:</strong>
                            <label><input type="radio" name="hAlign" value="left" onchange="app.actualizarPosicionFirma()"> Izq</label>
                            <label><input type="radio" name="hAlign" value="center" onchange="app.actualizarPosicionFirma()"> Cen</label>
                            <label><input type="radio" name="hAlign" value="right" onchange="app.actualizarPosicionFirma()"> Der</label>
                        </div>
                    </div>
                      
                    <div style="border: 1px solid var(--border-color); padding: 1rem; border-radius: 12px;">
                        <h4>Ajuste Fino (Offset)</h4>
                        <label>Eje X: <span id="val-firma-offsetX">0</span></label>
                        <input type="range" id="slider-firma-offsetX" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()">
                          
                        <label>Eje Y: <span id="val-firma-offsetY">0</span></label>
                        <input type="range" id="slider-firma-offsetY" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()">
                          
                        <label>Tama√±o (Ancho): <span id="val-firma-w">0</span></label>
                        <input type="range" id="slider-firma-w" min="10" max="150" value="50" oninput="app.actualizarPosicionFirma()">
                        <input type="hidden" id="slider-firma-h" value="20"> </div>
                  </div>
                    
                  <div style="margin-top: 1rem; display:flex; gap: 1rem;">
                    <button onclick="app.guardarAjustesFirma()" style="flex:2;">Guardar Ajustes PDF</button>
                    <button onclick="app.revertirADefecto()" class="btn-secondary" style="flex:1;">Reset</button>
                  </div>
                    
                  <div id="firma-preview-container" style="display:none;"><img id="firma-draggable-preview" src=""></div>
                  <div style="display:none;"><span id="val-firma-h"></span><div id="template-cotizacion"></div><div id="template-recibo"></div><div id="template-contrato"><div id="contract-signature-block"><div class="signature-area-rep"></div></div></div><div id="template-distribucion"></div></div>
                </div>

                <hr style="margin: 2rem 0; border:none; border-top: 1px solid var(--border-color);">
                  
                <h3>Datos Bancarios</h3>
                <form id="form-datos-bancarios">
                  <div class="form-row"><div class="form-group"><label>Banco</label><input type="text" id="banco" /></div><div class="form-group"><label>Titular</label><input type="text" id="titular" /></div></div>
                  <div class="form-row"><div class="form-group"><label>Tarjeta</label><input type="text" id="tarjeta" /></div><div class="form-group"><label>CLABE</label><input type="text" id="clabe" /></div></div>
                  <button type="button" onclick="app.guardarDatosBancarios()">Guardar Datos</button>
                </form>
              </div>
            </section>

        </main>
    </div>
  </div>

  <div class="fab-container">
    <button class="fab-btn" onclick="app.mostrarSeccion('registrar-proyecto')">+</button>
  </div>

  <div id="edit-artist-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2>Editar Artista</h2>
            <button class="modal-close" onclick="document.getElementById('edit-artist-modal').style.display='none'">√ó</button>
        </div>
        <form id="formEditArtistFromView" onsubmit="app.guardarEdicionArtista(event)">
            <input type="hidden" id="editArtistId">
            <label>Nombre Real</label><input type="text" id="editArtistNombre" required>
            <label>Nombre Art√≠stico</label><input type="text" id="editArtistNombreArt√≠stico">
            <div class="form-row">
                <div class="form-group"><label>Tel√©fono</label><input type="tel" id="editArtistTelefono"></div>
                <div class="form-group"><label>Correo</label><input type="email" id="editArtistCorreo"></div>
            </div>
            <button type="submit" style="width:100%;">Guardar Cambios</button>
        </form>
    </div>
  </div>

  <div id="request-appointment-modal" class="modal-overlay">
      <div class="modal-content">
          <div class="modal-header">
              <h2>Solicitar Cita / Proyecto</h2>
              <button class="modal-close" onclick="app.cerrarModalSolicitud()">√ó</button>
          </div>
          <p style="font-size:0.9em; margin-bottom:1rem; color:var(--text-color-light);">
              Env√≠a una solicitud al estudio. Te confirmaremos la fecha pronto.
          </p>
          <form onsubmit="app.enviarSolicitud(event)">
              <label>¬øQu√© servicio necesitas?</label>
              <select id="req-service" required></select>

              <label>Fecha deseada (Sugerida)</label>
              <input type="text" id="req-date" required>
              
              <label>Hora deseada (Aprox)</label>
              <input type="time" id="req-time">

              <label>Comentarios adicionales</label>
              <textarea id="req-comments" rows="3" placeholder="Ej: Es para grabar voces de 2 canciones..."></textarea>

              <button type="submit" style="width:100%; margin-top:1rem;">Enviar Solicitud</button>
          </form>
      </div>
  </div>

  <div id="document-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Generar Documentos</h2>
        <button class="modal-close" onclick="app.closeDocumentsModal()">√ó</button>
      </div>
      <input type="hidden" id="modal-project-id">
      <div class="filter-buttons" style="display: flex; gap: 0.5rem; margin-bottom: 1.5rem;">
          <button id="btn-show-contrato" class="btn-secondary active" onclick="app.showDocumentSection('contrato')">Contrato</button>
          <button id="btn-show-distribucion" class="btn-secondary" onclick="app.showDocumentSection('distribucion')">Distribuci√≥n</button>
      </div>
      <div id="section-contrato" class="document-section active" style="display:none;">
        <h3 style="margin-bottom:1rem;">Datos del Contrato</h3>
        <label>Nombre √Ålbum/EP</label><input type="text" id="contrato-nombre-album">
        <div class="form-row">
            <div class="form-group"><label>Canciones</label><input type="number" id="contrato-canciones"></div>
            <div class="form-group"><label>Duraci√≥n</label><input type="text" id="contrato-duracion" placeholder="Ej: 2 Semanas"></div>
        </div>
        <div class="form-row">
            <div class="form-group"><label>Pago Inicial</label><input type="number" id="contrato-pago-inicial" oninput="app.calcularSaldoContrato()"></div>
            <div class="form-group"><label>Saldo Restante</label><input type="number" id="contrato-pago-final" readonly></div>
        </div>
        <button onclick="app.saveAndGenerateContract()" style="width: 100%;">Generar Contrato PDF</button>
      </div>
      <div id="section-distribucion" class="document-section" style="display:none;">
        <h3>Datos de Distribuci√≥n</h3>
        <label>T√≠tulo Lanzamiento</label><input type="text" id="dist-titulo">
        <label>Fecha Lanzamiento</label><input type="text" id="dist-fecha">
        <label>UPC/EAN</label><input type="text" id="dist-upc">
        <hr style="margin: 1rem 0;">
        <h4>Tracks</h4>
        <div id="dist-tracks-container"></div>
        <button onclick="app.addTrackField()" class="btn-secondary" style="width: 100%; margin-bottom: 1rem;">+ A√±adir Track</button>
        <button onclick="app.saveAndGenerateDistribution()" style="width: 100%;">Generar PDF</button>
      </div>
    </div>
  </div>
    
  <div id="event-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-event-title">Detalles</h2>
            <button class="modal-close" onclick="app.closeEventModal()">√ó</button>
        </div>
        <input type="hidden" id="modal-event-id">
        <div style="background: var(--secondary-button-bg); padding: 1rem; border-radius: 12px; margin-bottom: 1rem;">
            <p><strong>Fecha:</strong> <span id="modal-event-date"></span></p>
            <p><strong>Total:</strong> <span id="modal-event-total"></span></p>
            <p><strong>Estado:</strong> <span id="modal-event-status"></span></p>
            <p><strong>Proceso:</strong> <span id="modal-event-process"></span></p>
        </div>
        <h4>Servicios:</h4>
        <ul id="modal-event-services" style="list-style-position: inside; padding-left: 0; color: var(--text-color-light);"></ul>
          
        <div style="margin-top: 1.5rem; border-top: 1px solid var(--border-color); padding-top: 1rem;">
            <h4 style="margin-bottom: 0.5rem;">Reprogramar</h4>
            <div class="form-row">
                <div class="form-group"><input type="text" id="edit-event-date"></div>
                <div class="form-group"><input type="time" id="edit-event-time"></div>
            </div>
            <button onclick="app.actualizarHorarioProyecto()" class="btn-secondary" style="width: 100%;">Actualizar Horario</button>
        </div>

        <div class="form-actions" style="margin-top: 1.5rem; flex-direction: column;">
            <button id="btn-go-to-workflow" class="btn-primary" onclick="">Ir al Tablero</button>
            <button id="btn-go-to-artist" class="btn-secondary" onclick="">Ver Historial Artista</button>
        </div>
    </div>
  </div>
    
  <div id="delivery-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Entrega de Material</h2>
        <button class="modal-close" onclick="app.closeDeliveryModal()">√ó</button>
      </div>
      <input type="hidden" id="delivery-project-id">
      <input type="hidden" id="delivery-artist-name">
      <input type="hidden" id="delivery-project-name">
        
      <div style="margin-bottom: 1.5rem; padding: 1rem; border: 1px dashed var(--border-color); border-radius: 12px; background: var(--secondary-button-bg);">
        <h4 style="margin-bottom:0.5rem;">Subir a Google Drive (Jer√°rquico)</h4>
        <p style="font-size:0.8em; color:var(--text-color-light);">Se crear√°: <strong>/Artista/Proyecto/Archivo</strong></p>
        <input type="file" id="drive-file-input" style="margin-bottom: 0.5rem; width:100%;">
        <button id="btn-upload-drive" onclick="app.subirADrive()" class="btn-primary" style="width:100%; display:flex; justify-content:center; gap:0.5rem;">
           <span id="drive-btn-text">üì§ Subir y Obtener Link</span>
        </button>
        <div id="drive-status" style="font-size: 0.8em; margin-top: 0.5rem; color: var(--text-color-light);"></div>
      </div>
      <div class="form-group">
        <label>Enlace de Descarga (Drive/WeTransfer)</label>
        <input type="url" id="delivery-link-input" placeholder="https://...">
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="app.saveDeliveryLink()">Guardar Enlace</button>
        <button onclick="app.sendDeliveryByWhatsapp()" style="background-color: #25D366; color: white;">Enviar WhatsApp</button>
      </div>
    </div>
  </div>
    
  <script src="https://apis.google.com/js/api.js"></script>
  <script src="https://accounts.google.com/gsi/client"></script>

  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let isInitialized = false; 
      let proyectoActual = {}; 
      let logoBase64 = null;
      let preseleccionArtistaId = null; 

      // --- CONFIGURACI√ìN GOOGLE DRIVE INTEGRADA ---
      const GAP_CONFIG = {
          apiKey: 'AIzaSyDaeTcNohqRxixSsAY58_pSyy62vsyJeXk', 
          clientId: '769041146398-a0iqgdre2lrevbh1ud9i1mrs4v548rdq.apps.googleusercontent.com', 
          discoveryDocs: ["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"],
          scope: 'https://www.googleapis.com/auth/drive.file' 
      };
        
      let tokenClient;
      let gapiInited = false;
      let gisInited = false;

      // 1. INICIALIZAR CACH√â
      let localCache = {
          artistas: (JSON.parse(localStorage.getItem('cache_artistas') || '[]') || []), 
          servicios: JSON.parse(localStorage.getItem('cache_servicios') || '[]'),
          proyectos: JSON.parse(localStorage.getItem('cache_proyectos') || '[]'),
          cotizaciones: [],
          historial: [],        
          pagos: JSON.parse(localStorage.getItem('cache_pagos') || '[]'),
          usuarios: []
      };
        
      let currentCalendar = null; let configCache = null; let chartInstance = null; const API_URL = '';
      const DOMElements = { loginContainer: document.getElementById('login-container'), appWrapper: document.getElementById('app-wrapper'), logoutButton: document.getElementById('logout-button'), welcomeUser: document.getElementById('welcome-user'), appLogo: document.getElementById('app-logo'), loginLogo: document.getElementById('login-logo'), customizationContainer: document.getElementById('customization-container'), logoInput: document.getElementById('logo-input'), connectionStatus: document.getElementById('connection-status'), connectionText: document.getElementById('connection-text') };
        
      const PDF_DIMENSIONS = { WIDTH: 210, HEIGHT: 297, MARGIN: 14 };

      function showToast(message, type = 'success') { 
          let bg = type === 'error' ? "linear-gradient(to right, #ff5f6d, #ffc371)" : "linear-gradient(to right, #00b09b, #96c93d)";
          if(type==='info') bg = "var(--secondary-button-bg)";
          Toastify({ text: message, duration: 3000, gravity: "top", position: "right", style: { background: bg, borderRadius: "10px", boxShadow: "0 4px 12px rgba(0,0,0,0.15)" } }).showToast(); 
      }
      function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;',"'": '&#39;','"': '&quot;'}[tag])); }
      function showLoader() { document.getElementById('loader-overlay').style.display = 'flex'; }
      function hideLoader() { document.getElementById('loader-overlay').style.display = 'none'; }
      async function imageExists(url) { try { const response = await fetch(url, { method: 'HEAD' }); return response.ok; } catch (e) { return false; } }

      async function preloadLogoForPDF() {
          const imgUrl = DOMElements.appLogo.src;
          try {
              const response = await fetch(imgUrl);
              const blob = await response.blob();
              const reader = new FileReader();
              reader.onloadend = () => { logoBase64 = reader.result; };
              reader.readAsDataURL(blob);
          } catch(e) { console.warn("No se pudo precargar logo para PDF offline"); }
      }

      // 2. OFFLINE MANAGER
      const OfflineManager = {
          QUEUE_KEY: 'fia_offline_queue',
          getQueue: () => JSON.parse(localStorage.getItem(OfflineManager.QUEUE_KEY) || '[]'),
          addToQueue: (url, options, tempId = null) => {
              const queue = OfflineManager.getQueue();
              queue.push({ url, options, timestamp: Date.now(), tempId });
              localStorage.setItem(OfflineManager.QUEUE_KEY, JSON.stringify(queue));
              OfflineManager.updateIndicator();
          },
          updateIndicator: () => {
              const queue = OfflineManager.getQueue();
              if (navigator.onLine) {
                  if (queue.length > 0) {
                      DOMElements.connectionStatus.className = 'connection-status status-syncing';
                      DOMElements.connectionText.textContent = `Sincronizando (${queue.length})`;
                      OfflineManager.sync(); 
                  } else {
                      DOMElements.connectionStatus.className = 'connection-status status-online';
                      DOMElements.connectionText.textContent = 'En L√≠nea';
                  }
              } else {
                  DOMElements.connectionStatus.className = 'connection-status status-offline';
                  DOMElements.connectionText.textContent = queue.length > 0 ? `Offline (${queue.length})` : 'Modo Offline';
              }
          },
          sync: async () => {
              const queue = OfflineManager.getQueue();
              if (queue.length === 0) return;
              const token = localStorage.getItem('token');
              const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
              let newQueue = [];
              for (const req of queue) {
                  try {
                      let bodyObj = req.options.body ? JSON.parse(req.options.body) : {};
                      if(bodyObj._id && bodyObj._id.startsWith('temp_')) delete bodyObj._id;
                      const res = await fetch(req.url, { ...req.options, body: JSON.stringify(bodyObj), headers: { ...req.options.headers, ...headers } });
                      if(!res.ok) throw new Error('Failed');
                  } catch (e) { newQueue.push(req); }
              }
              localStorage.setItem(OfflineManager.QUEUE_KEY, JSON.stringify(newQueue));
              if(newQueue.length === 0) { 
                  showToast('Sincronizaci√≥n completada', 'success'); 
                  await Promise.all([fetchAPI('/api/proyectos'), fetchAPI('/api/artistas'), fetchAPI('/api/servicios')]);
                  const currentHash = location.hash.replace('#', '');
                  if (currentHash) window.app.mostrarSeccion(currentHash, false);
              }
              OfflineManager.updateIndicator();
          },
          syncNow: () => { if(navigator.onLine) OfflineManager.sync(); }
      };

      window.app = { syncNow: OfflineManager.syncNow };

      // 3. FETCH API MEJORADO
      async function fetchAPI(url, options = {}) { 
        // CORRECCION: Asegurar que la URL sea absoluta desde la ra√≠z para evitar errores en rutas como /reset-password/
        if (!url.startsWith('/') && !url.startsWith('http')) {
            url = '/' + url;
        }

        const token = localStorage.getItem('token'); 
        if (!token && !url.includes('/auth/')) { showLogin(); throw new Error('No autenticado'); } 
        const headers = { 'Authorization': `Bearer ${token}` }; 
        if (!options.isFormData) { headers['Content-Type'] = 'application/json'; } 
        
        if ((!options.method || options.method === 'GET')) {
             if (!navigator.onLine) {
                 if(url.includes('/artistas')) return localCache.artistas;
                 if(url.includes('/servicios')) return localCache.servicios;
                 if(url.includes('/proyectos')) {
                     if(url.includes('cotizaciones')) return localCache.proyectos.filter(p => p.estatus === 'Cotizacion' && !p.deleted);
                     if(url.includes('completos')) return localCache.proyectos.filter(p => p.proceso === 'Completo' && p.estatus !== 'Cancelado' && !p.deleted);
                     if(url.includes('agenda')) return localCache.proyectos.filter(p => p.estatus !== 'Cancelado' && !p.deleted).map(p => ({ id: p._id, title: p.nombreProyecto || (p.artista ? p.artista.nombre : 'Proyecto'), start: p.fecha, allDay: false, extendedProps: { ...p, servicios: p.items.map(i=>i.nombre).join('\n') } }));
                     if(url.includes('papelera')) return localCache.proyectos.filter(p => p.deleted === true);
                     if(url.includes('/por-artista')) {
                         const artId = url.split('/').pop();
                         return localCache.proyectos.filter(p => !p.deleted && (p.artista && p.artista._id === artId));
                     }
                     return localCache.proyectos.filter(p => !p.deleted);
                 }
                 if(url.includes('/pagos')) return localCache.pagos;
                 if(url.includes('/dashboard/stats')) {
                     const activos = localCache.proyectos.filter(p => p.proceso !== 'Completo' && p.estatus !== 'Cancelado' && !p.deleted).length;
                     const porCobrar = localCache.proyectos.filter(p => (p.total - (p.montoPagado||0)) > 0 && p.estatus !== 'Cancelado' && !p.deleted).length;
                     const now = new Date();
                     const ingresosMes = localCache.pagos.filter(p => { const d = new Date(p.fecha); return d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear(); }).reduce((sum, p) => sum + p.monto, 0);
                     return { ingresosMes, proyectosActivos: activos, proyectosPorCobrar: porCobrar, monthlyIncome: [] };
                 }
             }
        }

        if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
            const body = options.body ? JSON.parse(options.body) : {};
            const tempId = body._id || `temp_${Date.now()}`;
             
            if (url.includes('/proyectos')) {
                if (options.method === 'POST') {
                    const nuevoProyecto = { ...body, _id: tempId, createdAt: new Date().toISOString(), montoPagado: 0, pagos: [], deleted: false };
                    if(nuevoProyecto.artista && typeof nuevoProyecto.artista === 'string') {
                        const art = localCache.artistas.find(a => a._id === nuevoProyecto.artista);
                        if(art) nuevoProyecto.artista = art;
                    }
                    localCache.proyectos.push(nuevoProyecto);
                } else if (options.method === 'PUT') {
                    let idTarget = url.split('/').pop(); 
                    if(['estatus', 'proceso', 'nombre', 'enlace-entrega', 'fecha', 'total'].includes(idTarget)) { const parts = url.split('/'); idTarget = parts[parts.length - 2]; }
                    const idx = localCache.proyectos.findIndex(p => p._id === idTarget);
                    if(idx !== -1) {
                        localCache.proyectos[idx] = { ...localCache.proyectos[idx], ...body };
                        if(url.includes('/restaurar')) localCache.proyectos[idx].deleted = false;
                        if(url.includes('/proceso')) localCache.proyectos[idx].proceso = body.proceso;
                        if(url.includes('/estatus')) localCache.proyectos[idx].estatus = body.estatus;
                        if(url.includes('/total')) localCache.proyectos[idx].total = body.total;
                        if(url.includes('enlace-entrega')) localCache.proyectos[idx].enlaceEntrega = body.enlace;
                    }
                } else if (options.method === 'DELETE') {
                    let idTarget = url.split('/').pop();
                    if(url.includes('/permanente')) {
                        idTarget = url.split('/')[3];
                        localCache.proyectos = localCache.proyectos.filter(p => p._id !== idTarget);
                    } else {
                        const idx = localCache.proyectos.findIndex(p => p._id === idTarget);
                        if(idx !== -1) localCache.proyectos[idx].deleted = true;
                    }
                }
                localStorage.setItem('cache_proyectos', JSON.stringify(localCache.proyectos));
            }
             
            if (url.includes('/pagos') && options.method === 'POST') {
               const idProy = url.split('/')[3]; 
               const proy = localCache.proyectos.find(p => p._id === idProy);
               if(proy) {
                   const nuevoPago = { _id: `temp_pago_${Date.now()}`, monto: body.monto, metodo: body.metodo, fecha: new Date().toISOString(), proyectoId: idProy, artista: proy.artista ? proy.artista.nombre : 'General' };
                   proy.pagos = proy.pagos || [];
                   proy.pagos.push(nuevoPago);
                   proy.montoPagado = (proy.montoPagado || 0) + body.monto;
                   localCache.pagos.push(nuevoPago);
                   localStorage.setItem('cache_pagos', JSON.stringify(localCache.pagos));
                   localStorage.setItem('cache_proyectos', JSON.stringify(localCache.proyectos));
               }
            }

            if (!navigator.onLine) {
                OfflineManager.addToQueue(`${API_URL}${url}`, { ...options, headers }, tempId);
                if (url.includes('/proyectos') && options.method === 'POST') { return { ...body, _id: tempId, offline: true }; }
                return { ok: true, offline: true };
            }
        }

        showLoader();
        try {
            const res = await fetch(`${API_URL}${url}`, { ...options, headers }); 
            
            const contentType = res.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") === -1) {
                const text = await res.text();
                console.error("Respuesta no JSON:", text);
                throw new Error("Error de conexi√≥n con el servidor (Ruta inv√°lida o error 500).");
            }

            if (res.status === 401) { showLogin(); throw new Error('Sesi√≥n expirada.'); } 
            if (res.status === 204 || (options.method === 'DELETE' && res.ok)) return {ok: true}; 
            
            const data = await res.json(); 
            if (!res.ok) throw new Error(data.error || 'Error del servidor'); 
             
            if (!options.method || options.method === 'GET') {
                if(url.includes('/artistas')) { 
                    localCache.artistas = Array.isArray(data) ? data : []; 
                    localStorage.setItem('cache_artistas', JSON.stringify(localCache.artistas)); 
                }
                if(url.includes('/servicios')) { localCache.servicios = data; localStorage.setItem('cache_servicios', JSON.stringify(data)); }
                if(url.includes('/proyectos') && !url.includes('agenda')) { 
                    if(Array.isArray(data) && url === '/api/proyectos') { localCache.proyectos = data; localStorage.setItem('cache_proyectos', JSON.stringify(data)); }
                }
                if(url.includes('/usuarios')) { localCache.usuarios = data; }
                
                if(url.includes('/pagos/todos')) { localCache.pagos = data; localStorage.setItem('cache_pagos', JSON.stringify(data)); }
            }
            return data; 
        } catch(e) {
            if (!navigator.onLine || e.message.includes('Failed to fetch') || e.message.includes('NetworkError') || e.message.includes('404')) {
                OfflineManager.updateIndicator(); 
                if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
                      const tempId = `temp_${Date.now()}`;
                      OfflineManager.addToQueue(`${API_URL}${url}`, { ...options, headers }, tempId);
                      return { ok: true, offline: true, _id: tempId };
                }
                if(url.includes('/artistas')) return localCache.artistas;
                if(url.includes('/servicios')) return localCache.servicios;
                if(url.includes('/proyectos')) {
                    if(url.includes('papelera')) return localCache.proyectos.filter(p => p.deleted === true);
                    return localCache.proyectos;
                }
            }
            throw e;
        } finally { hideLoader(); }
      }

      function filtrarTablas(query) {
          query = query.toLowerCase();
          document.querySelectorAll('section.active tbody tr').forEach(row => { const text = row.innerText.toLowerCase(); row.style.display = text.includes(query) ? '' : 'none'; });
          document.querySelectorAll('section.active .project-card').forEach(card => { const text = card.innerText.toLowerCase(); card.style.display = text.includes(query) ? 'block' : 'none'; });
          document.querySelectorAll('section.active ul li').forEach(li => { const text = li.innerText.toLowerCase(); li.style.display = text.includes(query) ? 'flex' : 'none'; });
      }

      async function loadPublicLogo() {
          try {
              const res = await fetch(`${API_URL}/api/configuracion/public/logo`);
              if (!res.ok) return;
              const data = await res.json();
              if (data && data.filePath) {
                  const logoSrc = data.filePath + `?t=${new Date().getTime()}`;
                  DOMElements.loginLogo.src = logoSrc;
                  DOMElements.appLogo.src = logoSrc;
                  
                  const favicon = document.getElementById('dynamic-favicon');
                  if(favicon) favicon.href = logoSrc;
              }
          } catch (e) { console.warn("Offline: Usando logo cacheado"); }
      }

      async function loadInitialConfig() { 
          try { 
              const config = await fetchAPI('/api/configuracion'); 
              configCache = config; 
              if (config.logoPath) { DOMElements.appLogo.src = config.logoPath + `?t=${new Date().getTime()}`; } 
          } catch (e) { configCache = { firmaPos: { cotizacion: {vAlign:'bottom',hAlign:'right',w:50,h:20,offsetX:0,offsetY:0} } }; } 
      }
      function applyTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); document.getElementById('theme-switch').checked = (theme === 'dark'); localStorage.setItem('theme', theme); }
        
      // --- GOOGLE DRIVE LOGIC ---
      function initializeGapiClient() {
        gapi.load('client', async () => {
          await gapi.client.init({
            apiKey: GAP_CONFIG.apiKey,
            discoveryDocs: GAP_CONFIG.discoveryDocs,
          });
          gapiInited = true;
        });
      }

      function initializeGisClient() {
        tokenClient = google.accounts.oauth2.initTokenClient({
          client_id: GAP_CONFIG.clientId,
          scope: GAP_CONFIG.scope,
          callback: '', 
        });
        gisInited = true;
      }
        
      if(typeof gapi !== 'undefined') initializeGapiClient();
      if(typeof google !== 'undefined') initializeGisClient();

      async function findOrCreateFolder(name, parentId = null) {
          let query = `mimeType='application/vnd.google-apps.folder' and name='${name}' and trashed=false`;
          if(parentId) query += ` and '${parentId}' in parents`;
            
          const res = await gapi.client.drive.files.list({ q: query, fields: 'files(id, name)' });
          if(res.result.files.length > 0) {
              return res.result.files[0].id;
          } else {
              const fileMetadata = {
                  'name': name,
                  'mimeType': 'application/vnd.google-apps.folder'
              };
              if(parentId) fileMetadata.parents = [parentId];
                
              const createRes = await gapi.client.drive.files.create({ resource: fileMetadata, fields: 'id' });
              return createRes.result.id;
          }
      }

      async function subirADrive() {
          if (!gapiInited || !gisInited) {
             await new Promise(r => setTimeout(r, 1000));
             if (!gapiInited || !gisInited) return showToast('Las librer√≠as de Google no han cargado. Revisa tu conexi√≥n.', 'error');
          }

          const fileInput = document.getElementById('drive-file-input');
          if (fileInput.files.length === 0) return showToast('Selecciona un archivo primero.', 'error');
          const file = fileInput.files[0];
            
          const statusDiv = document.getElementById('drive-status');
          const btnText = document.getElementById('drive-btn-text');

          tokenClient.callback = async (resp) => {
            if (resp.error) throw resp;
            
            try {
                btnText.textContent = 'Creando Carpeta...';
                const artistName = document.getElementById('delivery-artist-name').value || 'SinArtista';
                const projName = document.getElementById('delivery-project-name').value || 'SinProyecto';
                
                statusDiv.textContent = `Buscando carpeta: ${artistName}...`;
                let artistFolderId = await findOrCreateFolder(artistName);
                
                statusDiv.textContent = `Buscando carpeta: ${projName}...`;
                let projectFolderId = await findOrCreateFolder(projName, artistFolderId);

                await gapi.client.drive.permissions.create({
                    fileId: projectFolderId,
                    resource: { role: 'reader', type: 'anyone' }
                });

                const folderLinkResp = await gapi.client.drive.files.get({
                    fileId: projectFolderId,
                    fields: 'webViewLink'
                });
                const folderLink = folderLinkResp.result.webViewLink;

                btnText.textContent = 'Subiendo... (Espere)';
                const metadata = {
                    name: file.name,
                    parents: [projectFolderId]
                };
                
                const accessToken = gapi.client.getToken().access_token;
                const form = new FormData();
                form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
                form.append('file', file);

                const uploadUrl = 'https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart&fields=id';
                const uploadResp = await fetch(uploadUrl, {
                    method: 'POST',
                    headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
                    body: form
                });
                
                if (!uploadResp.ok) throw new Error('Fallo en la subida');
                
                document.getElementById('delivery-link-input').value = folderLink;
                statusDiv.textContent = `‚úÖ Subido en ${artistName}/${projName}`;
                statusDiv.style.color = 'var(--success-color)';
                btnText.textContent = 'üì§ Subir Otro';

                const projectId = document.getElementById('delivery-project-id').value;
                await fetchAPI(`/api/proyectos/${projectId}/enlace-entrega`, { 
                    method: 'PUT', 
                    body: JSON.stringify({ enlace: folderLink }) 
                });
                
                const cachedProj = localCache.proyectos.find(p => p._id === projectId);
                if(cachedProj) cachedProj.enlaceEntrega = folderLink;

                showToast('¬°Archivo subido! Link guardado.', 'success');

            } catch (err) {
                console.error(err);
                statusDiv.textContent = `Error: ${err.message || 'Desconocido'}`;
                statusDiv.style.color = 'var(--danger-color)';
                btnText.textContent = 'üì§ Reintentar';
            }
          };

          if (gapi.client.getToken() === null) {
            tokenClient.requestAccessToken({prompt: ''}); 
          } else {
            tokenClient.requestAccessToken({prompt: ''});
          }
      }

      (async function init() { 
        // 1. CARGA INICIAL PRIORITARIA (CORRECCION: Mover antes de la l√≥gica de rutas)
        // Esto asegura que el logo y el tema oscuro funcionen incluso en la pantalla de reset password
        await loadPublicLogo();
        setTimeout(preloadLogoForPDF, 2000); 
        applyTheme(localStorage.getItem('theme') || 'light'); 

        // 2. DETECTAR URL PARA RESET PASSWORD
        const path = window.location.pathname;
        if (path.startsWith('/reset-password/')) {
            // Extraer token de forma segura (tomar el √∫ltimo segmento que no est√© vac√≠o)
            const segments = path.split('/').filter(Boolean);
            const token = segments[segments.length - 1]; 
            
            if (token && token !== 'reset-password') {
                showResetPasswordView(token);
                document.body.style.opacity = '1';
                document.body.style.visibility = 'visible';
                return; 
            }
        }

        const token = localStorage.getItem('token'); 
        if (token) { 
            try { 
                const payload = JSON.parse(atob(token.split('.')[1])); 
                if (navigator.onLine && payload.exp * 1000 < Date.now()) return showLogin(); 
                await showApp(payload); 
            } catch (e) { showLogin(); } 
        } else { showLogin(); } 
      })();

      async function showApp(payload) { 
        document.body.classList.remove('auth-visible');

        if (!configCache) await loadInitialConfig();
        DOMElements.welcomeUser.textContent = `Hola, ${escapeHTML(payload.username)}`; 

        const role = payload.role ? payload.role.toLowerCase() : '';

        // --- MODO CLIENTE ---
        if (role === 'cliente') {
            document.body.classList.add('client-mode');
            
            const headerActions = document.querySelector('.header-actions');
            const existingBtn = document.getElementById('btn-client-logout');
            if(existingBtn) existingBtn.remove();
            
            const logoutBtn = document.createElement('button');
            logoutBtn.id = 'btn-client-logout';
            logoutBtn.className = 'btn-eliminar';
            logoutBtn.innerHTML = '<svg width="18" height="18" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75"></path></svg> Salir';
            logoutBtn.style.display = 'flex';
            logoutBtn.style.alignItems = 'center';
            logoutBtn.style.gap = '0.5rem';
            logoutBtn.style.padding = '0.5rem 1rem';
            logoutBtn.onclick = () => { localStorage.removeItem('token'); location.reload(); };
            
            headerActions.appendChild(logoutBtn);
            
            const artistas = await fetchAPI('/api/artistas');
            const myArtist = artistas.find(a => 
                a.nombre.toLowerCase().trim() === payload.username.toLowerCase().trim() ||
                (a.nombreArtistico && a.nombreArtistico.toLowerCase().trim() === payload.username.toLowerCase().trim())
            );

            DOMElements.loginContainer.style.display = 'none'; 
            DOMElements.appWrapper.style.display = window.innerWidth <= 768 ? 'block' : 'flex'; 
            document.body.style.opacity = '1';
            document.body.style.visibility = 'visible';

            if (myArtist) {
                mostrarVistaArtista(myArtist._id, myArtist.nombre, myArtist.nombreArtistico, true);
            } else {
                document.querySelector('main').innerHTML = `
                    <div class="card" style="border-left: 4px solid var(--warning-color); text-align: center;">
                        <h2>‚ö†Ô∏è Atenci√≥n</h2>
                        <p>No encontramos un perfil de Artista vinculado a tu usuario "<strong>${payload.username}</strong>".</p>
                        <p>Por favor, contacta al estudio para que corrijan el nombre de tu Artista.</p>
                        <button onclick="localStorage.removeItem('token'); location.reload();" class="btn-secondary" style="margin-top:1rem;">Salir</button>
                    </div>`;
            }
            return; 
        }
        
        // --- MODO STAFF NORMAL ---
        renderSidebar(payload);

        if (!isInitialized) { 
            initAppEventListeners(payload); 
            isInitialized = true; 
        } 

        DOMElements.loginContainer.style.display = 'none'; 
        DOMElements.appWrapper.style.display = window.innerWidth <= 768 ? 'block' : 'flex'; 
        
        const hashSection = location.hash.replace('#', '');
        mostrarSeccion(hashSection || 'dashboard', false);
        
        OfflineManager.updateIndicator();
        window.addEventListener('online', () => { OfflineManager.updateIndicator(); });
        window.addEventListener('offline', () => { OfflineManager.updateIndicator(); });

        document.body.style.opacity = '1';
        document.body.style.visibility = 'visible'; 
      }

      function showLogin() { 
          document.body.classList.add('auth-visible');
          
          localStorage.removeItem('token'); 
          DOMElements.loginContainer.style.display = 'block'; 
          DOMElements.appWrapper.style.display = 'none'; 
          document.body.style.opacity = '1'; 
          document.body.style.visibility = 'visible'; 
      }
      
      // --- NUEVAS FUNCIONES DE AUTH ---
      function toggleAuth(view) {
          const login = document.getElementById('login-view');
          const register = document.getElementById('register-view');
          const recover = document.getElementById('recover-view');
          const reset = document.getElementById('reset-password-view');
          
          login.style.display = 'none';
          register.style.display = 'none';
          recover.style.display = 'none';
          reset.style.display = 'none';
          
          if(view === 'register') register.style.display = 'block';
          else if(view === 'recover') recover.style.display = 'block';
          else if(view === 'reset') reset.style.display = 'block';
          else login.style.display = 'block';
          
          document.getElementById('login-error').textContent = '';
      }

      function showResetPasswordView(token) {
          document.body.classList.add('auth-visible');
          DOMElements.appWrapper.style.display = 'none';
          DOMElements.loginContainer.style.display = 'block';
          
          document.getElementById('reset-token').value = token;
          toggleAuth('reset');
      }

      async function resetPassword(e) {
          e.preventDefault();
          const token = document.getElementById('reset-token').value;
          const password = document.getElementById('new-password').value;

          if (!password) return showToast('Ingresa una contrase√±a', 'error');

          showLoader();
          try {
              // CORRECCION: Asegurar que fetchAPI maneje correctamente la URL base
              const res = await fetch(`${API_URL}/api/auth/reset-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ token, newPassword: password }) // Nota: El backend espera 'newPassword' o 'password' dependiendo del middleware, pero el modelo h√≠brido lo soporta
              });

              const data = await res.json();
              if (!res.ok) throw new Error(data.error || 'Error al restablecer');

              showToast('¬°Contrase√±a actualizada!', 'success');
              
              // Limpiar la URL para que no vuelva a cargar la vista de reset
              window.history.replaceState({}, document.title, "/");
              
              toggleAuth('login');
          } catch(err) {
              document.getElementById('login-error').textContent = err.message;
          } finally { hideLoader(); }
      }

      async function registerUser(e) {
          e.preventDefault();
          const username = document.getElementById('reg-username').value;
          const email = document.getElementById('reg-email').value;
          const password = document.getElementById('reg-password').value;
          const nombreArtistico = document.getElementById('reg-artistname').value;
          
          showLoader();
          try {
              const res = await fetch(`${API_URL}/api/auth/register`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ username, email, password, role: 'Cliente', nombre: nombreArtistico, createArtist: true }) 
              });
              
              const data = await res.json();
              if(!res.ok) throw new Error(data.error || 'Error al registrarse');
              
              showToast('¬°Cuenta creada! Inicia sesi√≥n.', 'success');
              toggleAuth('login');
              document.getElementById('username').value = username;
          } catch(err) {
              document.getElementById('login-error').textContent = err.message;
          } finally { hideLoader(); }
      }

      async function recoverPassword(e) {
          e.preventDefault();
          const email = document.getElementById('rec-email').value;
          
          showLoader();
          try {
              const res = await fetch(`${API_URL}/api/auth/forgot-password`, {
                  method: 'POST',
                  headers: { 'Content-Type': 'application/json' },
                  body: JSON.stringify({ email })
              });
              
              const data = await res.json();
              if(!res.ok) throw new Error(data.error || 'Error al solicitar recuperaci√≥n');
              
              showToast('Correo de recuperaci√≥n enviado.', 'success');
              toggleAuth('login');
          } catch(err) {
              document.getElementById('login-error').textContent = err.message;
          } finally { hideLoader(); }
      }

      document.getElementById('login-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        if (!navigator.onLine) { return showToast('Se requiere internet.', 'error'); }
        showLoader();
        try { 
            const res = await fetch(`${API_URL}/api/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username.value, password: password.value }) }); 
            const data = await res.json(); 
            if (!res.ok) throw new Error(data.error); 
            localStorage.setItem('token', data.token); 
            await showApp(JSON.parse(atob(data.token.split('.')[1]))); 
        } catch (error) { document.getElementById('login-error').textContent = error.message; } finally { hideLoader(); }
      });
        
      DOMElements.logoutButton.addEventListener('click', showLogin);
        
      async function mostrarSeccion(id, updateHistory = true) { 
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active')); 
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link')); 
        
        const seccionActiva = document.getElementById(id); 
        const linkActivo = document.querySelector(`.nav-link[data-seccion="${id}"]`); 
        
        if (seccionActiva) { 
            seccionActiva.classList.add('active'); 
            if(linkActivo) {
                linkActivo.classList.add('active-link');
                const parentGroup = linkActivo.closest('.nav-group');
                if (parentGroup) parentGroup.setAttribute('open', '');
            }
            if(updateHistory) history.pushState(null, null, `#${id}`);
            
            const searchInput = document.getElementById('globalSearch');
            if(searchInput) { searchInput.value = ''; }

            const loadDataActions = { 'dashboard': cargarDashboard, 'agenda': cargarAgenda, 'cotizaciones': cargarCotizaciones, 'flujo-trabajo': cargarFlujoDeTrabajo, 'pagos': cargarPagos, 'registrar-proyecto': cargarOpcionesParaProyecto, 'registro-manual': cargarOpcionesParaProyectoManual, 'historial-proyectos': cargarHistorial, 'gestion-servicios': () => renderList('servicios'), 'gestion-artistas': () => renderList('artistas', true), 'gestion-usuarios': () => renderList('usuarios'), 'papelera-reciclaje': cargarPapelera, 'configuracion': cargarConfiguracion, }; 
            await loadDataActions[id]?.(); 
        } 
      }

      async function renderList(endpoint, makeClickable = false) { 
          const listId = `lista${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; 
          try { 
              const data = await fetchAPI(`/api/${endpoint}`); 
              document.getElementById(listId).innerHTML = data.length ? data.map(item => { 
                  let displayName; 
                  if (endpoint === 'artistas') { displayName = `${item.nombreArtistico || item.nombre} ${item.nombreArtistico ? `(${item.nombre})` : ''}`; } 
                  else if (endpoint === 'usuarios') { displayName = `${item.username || 'Usuario'} (${item.role})`; } 
                  else { displayName = `${item.nombre || 'Sin Nombre'} - $${item.precio.toFixed(2)}`; }
                  const clickHandler = makeClickable ? `ondblclick="app.irAVistaArtista('${item._id}', '${escapeHTML(item.nombre)}', '${escapeHTML(item.nombreArtistico || '')}')"` : '';
                  return `<li class="list-item" ${clickHandler} style="${makeClickable ? 'cursor:pointer;' : ''}"><span>${escapeHTML(displayName)}</span><div class="list-item-actions"><button class="btn-secondary" onclick="event.stopPropagation(); app.editarItem('${item._id}', '${endpoint}')">‚úèÔ∏è</button><button class="btn-eliminar" onclick="event.stopPropagation(); app.eliminarItem('${item._id}', '${endpoint}')">üóëÔ∏è</button></div></li>`; 
              }).join('') : `<li>No hay elementos.</li>`; 
          } catch (e) { document.getElementById(listId).innerHTML = `<li>Error al cargar.</li>`; } 
      }
        
      async function cargarPapelera() { 
        const endpoints = ['servicios', 'artistas', 'usuarios', 'proyectos']; 
        for (const endpoint of endpoints) { 
            const listId = `papelera${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; 
            try { 
                const data = await fetchAPI(`/api/${endpoint}/papelera/all`); 
                
                document.getElementById(listId).innerHTML = data.length ? data.map(item => {
                    let displayName = item.nombre || item.username || item.nombreProyecto || 'Item';
                    return `<li class="list-item">
                      <span>${escapeHTML(displayName)}</span>
                      <div class="list-item-actions">
                          <button class="btn-restaurar" onclick="app.restaurarItem('${item._id}', '${endpoint}')">‚Ü©Ô∏è</button>
                          <button class="btn-eliminar" onclick="app.eliminarPermanente('${item._id}', '${endpoint}')">‚ùå</button>
                      </div>
                    </li>`;
                }).join('') : `<li>Vac√≠a.</li>`; 
            } catch (e) { document.getElementById(listId).innerHTML = `<li>Error.</li>`; } 
        } 
      }
        
      function limpiarForm(formId) { const form = document.getElementById(formId); form.reset(); const idInput = form.querySelector('input[type="hidden"]'); if(idInput) idInput.value = ''; form.querySelector('button[type="submit"]').textContent = 'Guardar'; }
        
      async function saveItem(e, type) { 
          e.preventDefault(); 
          const form = e.target; 
          const id = form.querySelector('input[type="hidden"]')?.value; 
          let body; 
            
          if (type === 'servicios') { body = { nombre: form.nombreServicio.value, precio: parseFloat(form.precioServicio.value) }; } 
          else if (type === 'artistas') { body = { nombre: form.nombreArtista.value, nombreArtistico: form.nombreArtisticoArtista.value, telefono: form.telefonoArtista.value, correo: form.correoArtista.value }; } 
          else if (type === 'usuarios') { 
              const userVal = document.getElementById('usernameUsuario').value;
              const roleVal = document.getElementById('roleUsuario').value;
              const passVal = document.getElementById('passwordUsuario').value;

              const checkboxes = document.querySelectorAll('input[name="user_permisos"]:checked');
              const permisos = Array.from(checkboxes).map(c => c.value);
              
              body = { 
                  username: userVal, 
                  role: roleVal, 
                  permisos: permisos 
              }; 
              
              if (!id && !passVal) { showToast('Contrase√±a obligatoria para usuarios nuevos.', 'error'); return; } 
              if (passVal) body.password = passVal; 
          } 
            
          const method = id ? 'PUT' : 'POST'; const url = `/api/${type}/${id || ''}`; 
          try { 
              const res = await fetchAPI(url, { method, body: JSON.stringify(body) }); 
              showToast(res.offline ? 'Guardado local.' : 'Guardado √©xito.', res.offline ? 'warning' : 'success'); 
              limpiarForm(form.id); mostrarSeccion(`gestion-${type}`); 
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }
        
      async function eliminarItem(id, endpoint) { if (!confirm(`¬øMover a la papelera?`)) return; try { await fetchAPI(`/api/${endpoint}/${id}`, { method: 'DELETE' }); showToast('Movido a papelera.', 'info'); mostrarSeccion(`gestion-${endpoint}`); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
        
      async function editarItem(id, endpoint) { 
          try { 
              let item; if (endpoint === 'artistas') item = localCache.artistas.find(i => i._id === id); else if (endpoint === 'servicios') item = localCache.servicios.find(i => i._id === id); else if (endpoint === 'usuarios') item = localCache.usuarios.find(i => i._id === id); 
              
              if(!item) item = await fetchAPI(`/api/${endpoint}/${id}`); 
              
              const form = document.getElementById(`form${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`); 
              if (endpoint === 'servicios') { form.idServicio.value = item._id; form.nombreServicio.value = item.nombre; form.precioServicio.value = item.precio; } 
              else if (endpoint === 'artistas') { form.idArtista.value = item._id; form.nombreArtista.value = item.nombre; form.nombreArtisticoArtista.value = item.nombreArtistico || ''; form.telefonoArtista.value = item.telefono || ''; form.correoArtista.value = item.correo || ''; } 
              else if (endpoint === 'usuarios') { 
                  form.idUsuario.value = item._id; 
                  document.getElementById('usernameUsuario').value = item.username; 
                  document.getElementById('roleUsuario').value = item.role; 
                  document.getElementById('passwordUsuario').value = ''; 
                  
                  document.querySelectorAll('input[name="user_permisos"]').forEach(chk => chk.checked = false);
                  const userPerms = item.permisos || [];
                  if(Array.isArray(userPerms)) {
                      document.querySelectorAll('input[name="user_permisos"]').forEach(chk => {
                          if (userPerms.includes(chk.value)) {
                              chk.checked = true;
                          }
                      });
                  }
              } 
              
              form.querySelector('button[type="submit"]').textContent = 'Actualizar'; 
              mostrarSeccion(`gestion-${endpoint}`);
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }
      async function restaurarItem(id, endpoint) { try { await fetchAPI(`/api/${endpoint}/${id}/restaurar`, { method: 'PUT' }); showToast('Restaurado.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function eliminarPermanente(id, endpoint) { if (!confirm('¬°Irreversible!')) return; try { await fetchAPI(`/api/${endpoint}/${id}/permanente`, { method: 'DELETE' }); showToast('Eliminado.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function vaciarPapelera(endpoint) { if (!confirm(`¬øVaciar ${endpoint}?`)) return; try { await fetchAPI(`/api/${endpoint}/papelera/vaciar`, { method: 'DELETE' }); showToast(`Vaciada.`, 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
        
      async function cargarDashboard() { 
        try { 
            const stats = await fetchAPI('/api/dashboard/stats'); 
            document.getElementById('kpi-ingresos-mes').textContent = `$${(stats.ingresosMes||0).toFixed(2)}`; 
            document.getElementById('kpi-proyectos-activos').textContent = stats.proyectosActivos || 0; 
            document.getElementById('kpi-proyectos-por-cobrar').textContent = stats.proyectosPorCobrar || 0; 
            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const dataValues = stats.monthlyIncome || [0,0,0,0,0,0,0,0,0,0,0,0];
            chartInstance = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: [{ label: 'Ingresos ($)', data: dataValues, borderColor: '#6366f1', fill: true, tension: 0.4 }] }, options: { responsive: true, maintainAspectRatio: false } });
        } catch(e) { console.error("Error dashboard:", e); } 
      }

      async function cargarCotizaciones() { const tablaBody = document.getElementById('tablaCotizacionesBody'); tablaBody.innerHTML = `<tr><td colspan="4">Cargando...</td></tr>`; try { const cotizaciones = await fetchAPI('/api/proyectos/cotizaciones'); tablaBody.innerHTML = cotizaciones.length ? cotizaciones.map(c => { const esArtistaRegistrado = c.artista && c.artista._id; const nombreArtista = esArtistaRegistrado ? c.artista.nombre : 'P√∫blico General'; const claseTd = esArtistaRegistrado ? 'clickable-artist' : ''; const eventoDblClick = esArtistaRegistrado ? `ondblclick="app.irAVistaArtista('${c.artista._id}', '${escapeHTML(c.artista.nombre)}', '')"` : ''; return `<tr><td class="${claseTd}" ${eventoDblClick}>${escapeHTML(nombreArtista)}</td><td>$${c.total.toFixed(2)}</td><td>${new Date(c.createdAt).toLocaleDateString()}</td><td class="table-actions"><button class="btn-aprobar" onclick="app.aprobarCotizacion('${c._id}')">‚úì</button><button class="btn-secondary" title="PDF" onclick="app.generarCotizacionPDF('${c._id}')">üìÑ</button><button class="btn-secondary" title="WhatsApp" onclick="app.compartirPorWhatsApp('${c._id}')">üí¨</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${c._id}', true)">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="4">Sin cotizaciones.</td></tr>`; } catch(e) { tablaBody.innerHTML = `<tr><td colspan="4">Error offline.</td></tr>`; } }
      
      const procesos = ['Solicitud', 'Agendado', 'Grabacion', 'Edicion', 'Mezcla', 'Mastering', 'Completo'];
      
      async function cargarFlujoDeTrabajo(filtroActivo = 'Todos') { const board = document.getElementById('kanbanBoard'); const filtros = document.getElementById('filtrosFlujo'); if(!filtros.innerHTML) { filtros.innerHTML = `<button class="btn-secondary active" onclick="app.filtrarFlujo('Todos')">Todos</button>` + procesos.filter(p=>p!=='Completo').map(p => `<button class="btn-secondary" onclick="app.filtrarFlujo('${p}')">${p}</button>`).join(''); } board.innerHTML = procesos.filter(p => p !== 'Completo').map(p => `<div class="kanban-column" data-columna="${p}"><h3>${p}</h3><div id="columna-${p}"></div></div>`).join(''); try { localCache.proyectos = await fetchAPI('/api/proyectos'); filtrarFlujo(filtroActivo); } catch(e) { console.error("Error flujo:", e); } }
      function filtrarFlujo(filtro) { 
          document.querySelectorAll('#filtrosFlujo button').forEach(b => { b.classList.remove('active'); b.classList.remove('btn-primary'); b.classList.add('btn-secondary'); }); 
          const activeBtn = document.querySelector(`#filtrosFlujo button[onclick="app.filtrarFlujo('${filtro}')"]`);
          if(activeBtn) { activeBtn.classList.add('active'); activeBtn.classList.remove('btn-secondary'); activeBtn.classList.add('btn-primary'); }
          
          document.querySelectorAll('.kanban-column').forEach(c => c.style.display = (filtro === 'Todos' || c.dataset.columna === filtro) ? 'block' : 'none'); 
          procesos.forEach(col => { if(document.getElementById(`columna-${col}`)) document.getElementById(`columna-${col}`).innerHTML = '' }); 
          
          if(localCache.proyectos) {
            localCache.proyectos.filter(p => p.proceso !== 'Completo' && p.estatus !== 'Cancelado').forEach(p => { 
                const card = document.createElement('div'); card.className = `project-card`; card.dataset.id = p._id; card.style.borderColor = `var(--proceso-${p.proceso})`; 
                const serviciosHtml = p.items.length > 0 ? p.items.map(i => `<li>${escapeHTML(i.nombre)}</li>`).join('') : `<li>${escapeHTML(p.nombreProyecto || 'Sin servicios')}</li>`;
                const artistaNombre = p.artista ? (p.artista.nombreArtistico || p.artista.nombre) : 'P√∫blico General'; 
                
                card.innerHTML = `<div class="project-card-header">
                                            <span class="${p.artista?'clickable-artist':''}" ${p.artista?`ondblclick="app.irAVistaArtista('${p.artista._id}', '${escapeHTML(p.artista.nombre)}', '')"`:''}>${escapeHTML(p.nombreProyecto || artistaNombre)}</span>
                                            <div style="display:flex;gap:4px;">
                                                <button class="btn-secondary" style="width:24px;height:24px;padding:0;font-size:0.7em;" title="Editar Info" onclick="app.editarInfoProyecto('${p._id}')">‚úèÔ∏è</button>
                                                <button class="btn-eliminar" style="width:24px;height:24px;padding:0;font-size:0.7em;" title="Eliminar Proyecto" onclick="app.eliminarProyecto('${p._id}')">üóëÔ∏è</button>
                                            </div>
                                        </div>
                                        <div class="project-card-body"><div style="font-weight:600;margin-bottom:8px;font-size:0.9em;">üóìÔ∏è ${new Date(p.fecha).toLocaleDateString()}</div><ul style="padding-left:0;list-style:none;font-size:0.85em;color:var(--text-color-light);">${serviciosHtml}</ul></div>
                                        <div style="display:flex;justify-content:space-between;align-items:center;margin-top:1rem;padding-top:0.5rem;border-top:1px solid var(--border-color);">
                                            <strong style="font-size:0.9em;">$${p.total.toFixed(2)}</strong>
                                            <div style="display:flex;gap:4px;align-items:center;">
                                                <button class="btn-eliminar" title="Cancelar Cita" style="width:auto;padding:0.3rem 0.5rem;font-size:0.7em;" onclick="app.cancelarCita('${p._id}')">üö´</button>
                                                <button class="btn-secondary" style="width:auto;padding:0.3rem 0.5rem;font-size:0.7em;" onclick="app.registrarPago('${p._id}')">$</button>
                                                <select onchange="app.cambiarProceso('${p._id}', this.value)" style="width:20px;padding:0;border:none;background:transparent;margin:0;">${procesos.map(proc => `<option value="${proc}" ${p.proceso === proc ? 'selected' : ''}>${proc}</option>`).join('')}</select>
                                            </div>
                                        </div>`; 
                document.getElementById(`columna-${p.proceso}`)?.appendChild(card); 
            });
          }
      }
      async function cambiarProceso(id, proceso) { try { const data = { proceso }; if (proceso === 'Completo') { const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto.estatus !== 'Pagado') { if (!confirm('Este proyecto no est√° pagado. ¬øCompletar?')) return; } } await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify(data) }); const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto) proyecto.proceso = proceso; const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); if(proceso === 'Completo') { showToast('¬°Proyecto completado!', 'success'); } filtrarFlujo(filtroActual); } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function cargarHistorial() { const tablaBody = document.getElementById('tablaHistorialBody'); tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; try { historialCacheados = await fetchAPI('/api/proyectos/completos'); tablaBody.innerHTML = historialCacheados.length ? historialCacheados.map(p => { const artistaNombre = p.artista ? p.artista.nombre : 'P√∫blico General'; return `<tr><td class="${p.artista?'clickable-artist':''}" ${p.artista?`ondblclick="app.irAVistaArtista('${p.artista._id}', '${escapeHTML(p.artista.nombre)}', '')"`:''}>${escapeHTML(artistaNombre)}</td><td>$${p.total.toFixed(2)}</td><td>$${(p.montoPagado || 0).toFixed(2)}</td><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="table-actions"><button class="btn-secondary" title="Entrega / Drive" onclick="app.openDeliveryModal('${p._id}', '${escapeHTML(artistaNombre)}', '${escapeHTML(p.nombreProyecto || 'Proyecto')}')">‚òÅÔ∏è</button><button class="btn-secondary" onclick="app.openDocumentsModal('${p._id}')">Docs</button><button class="btn-secondary" onclick="app.registrarPago('${p._id}', true)">$</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${p._id}')">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="5">Sin historial.</td></tr>`; } catch(error) { tablaBody.innerHTML = `<tr><td colspan="5">Error.</td></tr>`; } }
      
      async function eliminarProyecto(id, desdeCotizaciones = false) { 
          if (!confirm('¬øMover a papelera? Desaparecer√° del flujo.')) return; 
          try { 
              await fetchAPI(`/api/proyectos/${id}`, { method: 'DELETE' }); 
              showToast('Movido a papelera.', 'info'); 
              if (desdeCotizaciones) { 
                  cargarCotizaciones(); 
              } else if (document.getElementById('historial-proyectos').classList.contains('active')) {
                  cargarHistorial();
              } else if (document.getElementById('vista-artista').classList.contains('active')) {
                    const nombreActual = document.getElementById('vista-artista-nombre').textContent;
                    if (!Array.isArray(localCache.artistas)) {
                        localCache.artistas = await fetchAPI('/api/artistas');
                    }
                    const art = localCache.artistas.find(a => a.nombre === nombreActual);
                    if(art) {
                        mostrarVistaArtista(art._id, nombreActual, '');
                    } else {
                        mostrarSeccion('gestion-artistas');
                    }
              } else {
                  const filtroActual = document.querySelector('#filtrosFlujo button.active')?.textContent.trim() || 'Todos';
                  filtrarFlujo(filtroActual);
              }
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }
        
      async function cargarOpcionesParaSelect(url, selectId, valueField, textFieldFn, addPublicoGeneral = false, currentValue = null) { 
          const select = document.getElementById(selectId); 
          try { 
              const data = await fetchAPI(url); 
              select.innerHTML = ''; 
              if (addPublicoGeneral) { 
                  const op = document.createElement('option'); op.value = 'publico_general'; op.textContent = 'P√∫blico General'; select.appendChild(op); 
              } 
              data.forEach(item => { 
                  const option = document.createElement('option'); option.value = item[valueField]; option.textContent = textFieldFn(item); option.dataset.precio = item.precio || 0; select.appendChild(option); 
              }); 
                
              if (selectId === 'proyectoArtista' && preseleccionArtistaId) {
                  select.value = preseleccionArtistaId;
                  preseleccionArtistaId = null; 
              } else if (currentValue) {
                  select.value = currentValue; 
              }
          } catch (error) { select.innerHTML = `<option value="">Error o Offline</option>`; } 
      }
      const cargarOpcionesParaProyecto = () => { cargarOpcionesParaSelect('/api/artistas', 'proyectoArtista', '_id', item => item.nombreArtistico || item.nombre, true); cargarOpcionesParaSelect('/api/servicios', 'proyectoServicio', '_id', item => `${item.nombre} - $${item.precio.toFixed(2)}`); }
      const cargarOpcionesParaProyectoManual = () => { cargarOpcionesParaSelect('/api/artistas', 'manualProyectoArtista', '_id', item => item.nombreArtistico || item.nombre, false); flatpickr("#manualFechaProyecto", { defaultDate: "today", locale: "es" }); };
      function agregarAProyecto() { const select = document.getElementById('proyectoServicio'); if (!select.value) return; const id = `item-${select.value}-${Date.now()}`; proyectoActual[id] = { id, servicioId: select.value, nombre: select.options[select.selectedIndex].text.split(' - ')[0], unidades: parseInt(document.getElementById('proyectoUnidades').value) || 1, precioUnitario: parseFloat(select.options[select.selectedIndex].dataset.precio) }; mostrarProyectoActual(); }
      function quitarDeProyecto(id) { delete proyectoActual[id]; mostrarProyectoActual(); }
      function mostrarProyectoActual() { const lista = document.getElementById('listaProyectoActual'); let total = 0; lista.innerHTML = Object.values(proyectoActual).map(item => { const subtotal = item.precioUnitario * item.unidades; total += subtotal; return `<li class="list-item"><span>${item.unidades}x ${escapeHTML(item.nombre)}</span><span>$${subtotal.toFixed(2)} <button class="btn-eliminar" style="padding:0.2rem 0.5rem;height:auto;" onclick="app.quitarDeProyecto('${item.id}')">X</button></span></li>`; }).join(''); document.getElementById('totalAPagar').textContent = `$${total.toFixed(2)}`; }
      async function guardarProyecto(procesoDestino) { 
          const artistaSelect = document.getElementById('proyectoArtista'); const artistaId = artistaSelect.value; const fechaInput = document.getElementById('fechaProyecto')._flatpickr.selectedDates[0]; const horaInput = document.getElementById('horaProyecto').value;
          let fechaFinal = new Date(); if(fechaInput) { fechaFinal = fechaInput; if(horaInput) { const [hours, minutes] = horaInput.split(':'); fechaFinal.setHours(hours); fechaFinal.setMinutes(minutes); } }
          if (Object.keys(proyectoActual).length === 0) { showToast('Faltan servicios.', 'error'); return null; } 
          const items = Object.values(proyectoActual).map(i => ({ servicio: i.servicioId, nombre: i.nombre, unidades: i.unidades, precioUnitario: i.precioUnitario }));
          const subtotal = items.reduce((sum, item) => sum + (item.precioUnitario * item.unidades), 0);
          const descuento = parseFloat(document.getElementById('proyectoDescuento').value) || 0;
          const total = Math.max(0, subtotal - descuento);
          const body = { artista: artistaId === 'publico_general' ? null : artistaId, nombreProyecto: document.getElementById('nombreProyecto').value, items: items, total: total, descuento: descuento, estatus: procesoDestino === 'Cotizacion' ? 'Cotizacion' : 'Pendiente de Pago', metodoPago: 'Pendiente', fecha: fechaFinal.toISOString(), prioridad: 'Normal', proceso: procesoDestino, esAlbum: document.getElementById('esAlbum').checked }; 
          try { return await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) }); } catch (error) { showToast(`Error: ${error.message}`, 'error'); return null; } 
      }
      async function guardarProyectoManual() {
        const artistaId = document.getElementById('manualProyectoArtista').value; const nombreProyecto = document.getElementById('manualNombreProyecto').value; const fecha = document.getElementById('manualFechaProyecto')._flatpickr.selectedDates[0]; const descripcion = document.getElementById('manualDescripcion').value;
        if (!artistaId || !nombreProyecto || !fecha) { return showToast('Datos incompletos.', 'error'); }
        const body = { artista: artistaId, nombreProyecto: nombreProyecto, items: [{ nombre: descripcion, unidades: 1, precioUnitario: 0 }], total: 0, estatus: 'Pagado', proceso: 'Agendado', fecha: fecha.toISOString(), };
        try { await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) }); showToast('Guardado.', 'success'); document.getElementById('formProyectoManual').reset(); mostrarSeccion('flujo-trabajo'); } catch(e) { showToast(`Error: ${e.message}`, 'error'); }
      }
      async function generarCotizacion() { const nuevoProyecto = await guardarProyecto('Cotizacion'); if (nuevoProyecto) { showToast(nuevoProyecto.offline?'Guardado offline.':'Cotizaci√≥n guardada.', nuevoProyecto.offline?'warning':'success'); await generarCotizacionPDF(nuevoProyecto._id || nuevoProyecto); proyectoActual = {}; document.getElementById('proyectoDescuento').value = ''; document.getElementById('horaProyecto').value = ''; mostrarProyectoActual(); document.getElementById('formProyecto').reset(); mostrarSeccion('cotizaciones'); } }
      async function enviarAFlujoDirecto() { const nuevoProyecto = await guardarProyecto('Agendado'); if (nuevoProyecto) { showToast('Agendado.', 'success'); proyectoActual = {}; document.getElementById('proyectoDescuento').value = ''; document.getElementById('horaProyecto').value = ''; mostrarProyectoActual(); document.getElementById('formProyecto').reset(); mostrarSeccion('flujo-trabajo'); } }
      async function registrarNuevoArtistaDesdeFormulario(formPrefix) {
          const inputId = formPrefix ? `${formPrefix}NombreNuevoArtista` : 'nombreNuevoArtista';
          const containerId = formPrefix ? `${formPrefix}NuevoArtistaContainer` : 'nuevoArtistaContainer';
          const nombreInput = document.getElementById(inputId); const nombre = nombreInput.value.trim();
          if (!nombre) { showToast('Introduce un nombre.', 'error'); return; }
          try { await fetchAPI('/api/artistas', { method: 'POST', body: JSON.stringify({ nombre }) }); const selectId = formPrefix === 'manual' ? 'manualProyectoArtista' : 'proyectoArtista'; await cargarOpcionesParaSelect('/api/artistas', selectId, '_id', item => item.nombreArtistico || item.nombre, formPrefix !== 'manual'); const select = document.getElementById(selectId); select.selectedIndex = select.options.length - 1; document.getElementById(containerId).style.display = 'none'; nombreInput.value = ''; } catch (error) { showToast(`Error: ${error.message}`, 'error'); }
      }

      function openEventModal(info) { 
        const props = info.event.extendedProps; 
        document.getElementById('modal-event-id').value = info.event.id;
        document.getElementById('modal-event-title').textContent = info.event.title; 
        document.getElementById('modal-event-date').textContent = info.event.start.toLocaleDateString('es-ES', { weekday: 'short', day: 'numeric', month: 'short', hour: '2-digit', minute: '2-digit' }); 
        document.getElementById('modal-event-total').textContent = `$${(props.total||0).toFixed(2)}`; 
        document.getElementById('modal-event-status').textContent = props.estatus; 
        document.getElementById('modal-event-process').textContent = props.proceso; 
        document.getElementById('modal-event-services').innerHTML = (props.servicios || '').split('\n').map(s => `<li>${escapeHTML(s)}</li>`).join(''); 
        flatpickr("#edit-event-date", { defaultDate: info.event.start, locale: "es" });
        const hours = String(info.event.start.getHours()).padStart(2, '0');
        const minutes = String(info.event.start.getMinutes()).padStart(2, '0');
        document.getElementById('edit-event-time').value = `${hours}:${minutes}`;
        document.getElementById('btn-go-to-workflow').onclick = () => app.goToProjectInWorkflow(info.event.id); 
        const btnArtist = document.getElementById('btn-go-to-artist'); 
        if (props.artistaId || props.artista) { btnArtist.style.display = 'block'; btnArtist.onclick = () => app.goToArtistFromModal(props.artistaId || props.artista._id, props.artistaNombre || (props.artista ? props.artista.nombre : '')); } else { btnArtist.style.display = 'none'; } 
        const oldCancelBtn = document.getElementById('btn-cancelar-evento-modal'); if(oldCancelBtn) oldCancelBtn.remove();
        if (props.estatus !== 'Cancelado') { const btnCancelar = document.createElement('button'); btnCancelar.id = 'btn-cancelar-evento-modal'; btnCancelar.textContent = '‚ùå Cancelar Cita'; btnCancelar.className = 'btn-eliminar'; btnCancelar.style.marginTop = '1rem'; btnCancelar.style.width = '100%'; btnCancelar.onclick = () => app.cancelarCita(info.event.id); document.querySelector('#event-modal .modal-content').appendChild(btnCancelar); }
        document.getElementById('event-modal').style.display = 'flex'; 
      }
        
      async function cancelarCita(id) {
          if (!confirm('¬øCancelar cita? Se liberar√° la fecha.')) return;
          try { await fetchAPI(`/api/proyectos/${id}/estatus`, { method: 'PUT', body: JSON.stringify({ estatus: 'Cancelado' }) }); showToast('Cancelada.', 'info'); closeEventModal(); app.cargarAgenda(); if (document.getElementById('flujo-trabajo').classList.contains('active')) app.filtrarFlujo('Todos'); } catch(e) { showToast(`Error: ${e.message}`, 'error'); }
      }

      async function actualizarHorarioProyecto() {
          const id = document.getElementById('modal-event-id').value;
          const newDateInput = document.getElementById('edit-event-date')._flatpickr.selectedDates[0];
          const newTimeInput = document.getElementById('edit-event-time').value;
          if (!newDateInput) return showToast("Selecciona fecha", "error");
          let finalDate = new Date(newDateInput);
          if (newTimeInput) { const [h, m] = newTimeInput.split(':'); finalDate.setHours(h); finalDate.setMinutes(m); }
          try { await app.cambiarAtributo(id, 'fecha', finalDate.toISOString()); showToast("Actualizado", "success"); closeEventModal(); app.cargarAgenda(); } catch(e) { showToast("Error", "error"); }
      }

      function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
      function goToProjectInWorkflow(projectId) { closeEventModal(); mostrarSeccion('flujo-trabajo'); setTimeout(() => { const card = document.querySelector(`.project-card[data-id="${projectId}"]`); if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); }
      function goToArtistFromModal(artistId, artistName) { closeEventModal(); irAVistaArtista(artistId, artistName, ''); }
        
      async function cargarAgenda() {
        const calendarEl = document.getElementById('calendario');
        if (currentCalendar) { currentCalendar.destroy(); }
        try {
            const eventos = await fetchAPI('/api/proyectos/agenda');
            const isMobile = window.innerWidth < 768;
            currentCalendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es', initialView: 'dayGridMonth',
                headerToolbar: { left: 'prev,next today', center: 'title', right: isMobile ? 'dayGridMonth,listMonth' : 'dayGridMonth,timeGridWeek,listWeek' },
                height: 'auto', dayMaxEvents: isMobile ? false : true,
                buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', list: 'Lista' },
                navLinks: true, editable: true, events: eventos,
                dateClick: (info) => { if (info.view.type.includes('Grid')) { mostrarSeccion('registrar-proyecto'); document.getElementById('fechaProyecto')._flatpickr.setDate(info.date); showToast(`Fecha seleccionada: ${info.date.toLocaleDateString()}`, 'info'); } },
                eventClick: openEventModal,
                eventDrop: async (info) => { if (!confirm(`¬øMover proyecto?`)) { info.revert(); return; } try { await app.cambiarAtributo(info.event.id, 'fecha', info.event.start.toISOString()); showToast('Actualizado.', 'success'); cargarFlujoDeTrabajo('Todos'); } catch (error) { info.revert(); } },
                eventContent: (arg) => { if(isMobile && !arg.view.type.includes('list')) { return { html: '' }; } else { return { html: `<div class="fc-event-main-frame"><div class="fc-event-title">${escapeHTML(arg.event.title)}</div></div>` }; } },
                eventDidMount: function(info) { if(isMobile && !info.view.type.includes('list')) { let colorVar = `var(--proceso-${info.event.extendedProps.proceso}, var(--primary-color))`; info.el.style.backgroundColor = colorVar; } }
            });
            currentCalendar.render();
        } catch (error) { calendarEl.innerHTML = '<p>Error agenda.</p>'; }
      }

      async function cambiarAtributo(id, campo, valor) { try { await fetchAPI(`/api/proyectos/${id}/${campo}`, { method: 'PUT', body: JSON.stringify({ [campo]: valor }) }); const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto) proyecto[campo] = valor; if (document.getElementById('flujo-trabajo').classList.contains('active')) { const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); filtrarFlujo(filtroActual); } } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function aprobarCotizacion(id) { if (!confirm('¬øAprobar cotizaci√≥n?')) return; try { await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify({ proceso: 'Agendado' }) }); showToast('¬°Aprobada!', 'success'); mostrarSeccion('flujo-trabajo'); } catch(error) { showToast(`Error`, 'error'); } }
      async function compartirPorWhatsApp(proyectoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const nombreCliente = proyecto.artista ? proyecto.artista.nombre : 'cliente'; const mensaje = `¬°Hola ${nombreCliente}! Resumen FiaRecords:\n\nServicios:\n${proyecto.items.map(i => `- ${i.unidades}x ${i.nombre}`).join('\n')}\n\n*Total: $${proyecto.total.toFixed(2)} MXN*\n\nCont√°ctanos para confirmar.`; window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank'); } catch (error) { showToast('Error.', 'error'); } }
        
      async function registrarPago(proyectoId, desdeHistorial = false) { 
          const cache = desdeHistorial ? historialCacheados : localCache.proyectos; 
          let proyecto = cache.find(p => p._id === proyectoId); 
          if (!proyecto) { try { proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); } catch(e) { return showToast('No encontrado.', 'error'); }} 
          const restante = proyecto.total - (proyecto.montoPagado || 0); 
          const montoStr = prompt(`Registrar pago\nRestante: $${restante.toFixed(2)}\n¬øMonto?`, restante > 0 ? restante.toFixed(2) : '0.00'); 
          if (montoStr === null) return; 
          const monto = parseFloat(montoStr); 
          if (isNaN(monto) || monto <= 0) return showToast('Monto inv√°lido.', 'error'); 
          const metodo = prompt('M√©todo (Efectivo, Transferencia):', 'Efectivo'); if (!metodo) return; 
            
          try { 
              const proyectoActualizado = await fetchAPI(`/api/proyectos/${proyectoId}/pagos`, { method: 'POST', body: JSON.stringify({ monto, metodo }) }); 
              showToast(proyectoActualizado.offline ? 'Offline. Recibo local.' : '¬°Pago registrado!', proyectoActualizado.offline ? 'info' : 'success');
              const ultimoPago = proyectoActualizado.pagos[proyectoActualizado.pagos.length - 1];
              await generarReciboPDF(proyectoActualizado, ultimoPago); 
              if (document.getElementById('pagos').classList.contains('active')) { app.cargarPagos(); } 
              else if (desdeHistorial) { cargarHistorial(); } 
              else { cargarFlujoDeTrabajo(); } 
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }

      /* LOGICA DE PESTA√ëAS Y PAGOS PENDIENTES */
      async function cargarPagos() { 
        mostrarSeccionPagos('pendientes', document.querySelector('.filter-buttons button.active'));
      }
        
      function mostrarSeccionPagos(vista, btn) {
          document.querySelectorAll('#pagos .filter-buttons button').forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          
          if(vista === 'pendientes') {
              document.getElementById('vista-pagos-pendientes').style.display = 'block';
              document.getElementById('vista-pagos-historial').style.display = 'none';
              cargarPagosPendientes();
          } else {
              document.getElementById('vista-pagos-pendientes').style.display = 'none';
              document.getElementById('vista-pagos-historial').style.display = 'block';
              cargarHistorialPagos();
          }
      }

      async function cargarPagosPendientes() {
          const tabla = document.getElementById('tablaPendientesBody');
          tabla.innerHTML = '<tr><td colspan="5">Calculando...</td></tr>';
          
          const pendientes = localCache.proyectos.filter(p => {
              const pagado = p.montoPagado || 0;
              return (p.total > pagado) && p.estatus !== 'Cancelado' && p.estatus !== 'Cotizacion';
          });

          if(pendientes.length === 0) {
              tabla.innerHTML = '<tr><td colspan="5">¬°Todo al d√≠a! No hay pagos pendientes.</td></tr>';
              return;
          }

          tabla.innerHTML = pendientes.map(p => {
              const deuda = p.total - (p.montoPagado || 0);
              const artistaNombre = p.artista ? (p.artista.nombreArtistico || p.artista.nombre) : 'Cliente General';
              const proyectoNombre = p.nombreProyecto || 'Proyecto';
              return `<tr>
                  <td>
                      <div style="font-weight:bold;">${escapeHTML(proyectoNombre)}</div>
                      <div style="font-size:0.85em; color:var(--text-color-light);">${escapeHTML(artistaNombre)}</div>
                  </td>
                  <td>$${p.total.toFixed(2)}</td>
                  <td>$${(p.montoPagado||0).toFixed(2)}</td>
                  <td style="color:var(--danger-color); font-weight:700;">$${deuda.toFixed(2)}</td>
                  <td class="table-actions">
                      <button class="btn-secondary" onclick="app.registrarPago('${p._id}')">Cobrar üíµ</button>
                      <button class="btn-secondary" onclick="app.compartirPorWhatsApp('${p._id}')">Recordar üí¨</button>
                  </td>
              </tr>`;
          }).join('');
      }

      async function cargarHistorialPagos() { 
          const tablaBody = document.getElementById('tablaPagosBody'); 
          tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; 
          try { 
              const pagos = await fetchAPI('/api/proyectos/pagos/todos'); 
              tablaBody.innerHTML = pagos.length ? pagos.map(p => `<tr><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="clickable-artist" ondblclick="app.irAVistaArtista(null, '${escapeHTML(p.artista)}', '')">${escapeHTML(p.artista)}</td><td>$${p.monto.toFixed(2)}</td><td>${escapeHTML(p.metodo)}</td><td class="table-actions"><button class="btn-secondary" title="Recibo" onclick="app.reimprimirRecibo('${p.proyectoId}', '${p.pagoId}')">üìÑ</button><button class="btn-secondary" title="WhatsApp" onclick="app.compartirPagoPorWhatsApp(JSON.stringify(${JSON.stringify(p)}).replace(/'/g, '&apos;'))">üí¨</button><button class="btn-eliminar" title="Eliminar" onclick="app.eliminarPago('${p.proyectoId}', '${p.pagoId}')">üóëÔ∏è</button></td></tr>`).join('') : `<tr><td colspan="5">Sin pagos.</td></tr>`; 
          } catch (e) { tablaBody.innerHTML = `<tr><td colspan="5">Error offline.</td></tr>`; } 
      }

      async function reimprimirRecibo(proyectoId, pagoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const pago = proyecto.pagos.find(p => p._id === pagoId) || proyecto.pagos.find(p => p._id.startsWith('temp')); if (!pago) return showToast('No encontrado.', 'error'); await generarReciboPDF(proyecto, pago); } catch(e) { showToast('Error.', 'error'); } }
      function compartirPagoPorWhatsApp(pagoString) { const pago = JSON.parse(pagoString); const mensaje = `Confirmaci√≥n de pago FiaRecords:\n\n*Fecha:* ${new Date(pago.fecha).toLocaleDateString()}\n*Monto:* $${pago.monto.toFixed(2)} MXN\n*M√©todo:* ${pago.metodo}\n\n¬°Gracias!`; window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank'); }
      async function eliminarPago(proyectoId, pagoId) { if (!confirm('¬øEliminar pago? Afectar√° el saldo.')) return; try { await fetchAPI(`/api/proyectos/${proyectoId}/pagos/${pagoId}`, { method: 'DELETE' }); showToast('Eliminado.', 'success'); cargarPagos(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function openDocumentsModal(proyectoId) { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); if (!proyecto) return showToast('No encontrado.', 'error'); document.getElementById('modal-project-id').value = proyectoId; document.getElementById('modal-project-id').dataset.total = proyecto.total; showDocumentSection('contrato'); const contrato = proyecto.detallesContrato || {}; document.getElementById('contrato-nombre-album').value = contrato.nombreAlbum || ''; document.getElementById('contrato-canciones').value = contrato.cantidadCanciones || ''; document.getElementById('contrato-duracion').value = contrato.duracion || ''; document.getElementById('contrato-pago-inicial').value = contrato.pagoInicial || ''; document.getElementById('contrato-pago-final').value = contrato.pagoFinal || ''; calcularSaldoContrato(); const dist = proyecto.detallesDistribucion || {}; document.getElementById('dist-titulo').value = dist.tituloLanzamiento || ''; document.getElementById('dist-fecha').value = dist.fechaLanzamiento ? new Date(dist.fechaLanzamiento).toISOString().split('T')[0] : ''; document.getElementById('dist-upc').value = dist.upc || ''; const tracksContainer = document.getElementById('dist-tracks-container'); tracksContainer.innerHTML = ''; (dist.tracks && dist.tracks.length > 0 ? dist.tracks : [{titulo: '', isrc: ''}]).forEach(track => addTrackField(track.titulo, track.isrc)); document.getElementById('document-modal').style.display = 'flex'; }
      function closeDocumentsModal() { document.getElementById('document-modal').style.display = 'none'; }
      function showDocumentSection(sectionName) { document.querySelectorAll('.document-section').forEach(s => s.style.display='none'); document.querySelectorAll('#document-modal .filter-buttons button').forEach(b => b.classList.remove('active')); document.getElementById(`section-${sectionName}`).style.display='block'; document.getElementById(`btn-show-${sectionName}`).classList.add('active'); }
      function addTrackField(titulo = '', isrc = '') { const container = document.getElementById('dist-tracks-container'); const trackDiv = document.createElement('div'); trackDiv.className = 'form-row'; trackDiv.innerHTML = `<div class="form-group"><input type="text" class="dist-track-titulo" placeholder="T√≠tulo" value="${escapeHTML(titulo)}"></div><div class="form-group"><input type="text" class="dist-track-isrc" placeholder="ISRC" value="${escapeHTML(isrc)}"></div>`; container.appendChild(trackDiv); }
      function calcularSaldoContrato() { const total = parseFloat(document.getElementById('modal-project-id').dataset.total) || 0; const inicial = parseFloat(document.getElementById('contrato-pago-inicial').value) || 0; const final = total - inicial; document.getElementById('contrato-pago-final').value = final > 0 ? final.toFixed(2) : '0.00'; }
      async function saveAndGenerateContract() { const proyectoId = document.getElementById('modal-project-id').value; const data = { nombreAlbum: document.getElementById('contrato-nombre-album').value, cantidadCanciones: parseInt(document.getElementById('contrato-canciones').value), duracion: document.getElementById('contrato-duracion').value, pagoInicial: parseFloat(document.getElementById('contrato-pago-inicial').value), pagoFinal: parseFloat(document.getElementById('contrato-pago-final').value) }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'contrato', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarContratoPDF(proyectoCompleto); closeDocumentsModal(); }
      async function saveAndGenerateDistribution() { const proyectoId = document.getElementById('modal-project-id').value; const tracks = []; document.querySelectorAll('#dist-tracks-container .form-row').forEach(row => { const titulo = row.querySelector('.dist-track-titulo').value; const isrc = row.querySelector('.dist-track-isrc').value; if (titulo) tracks.push({ titulo, isrc }); }); const data = { tituloLanzamiento: document.getElementById('dist-titulo').value, fechaLanzamiento: document.getElementById('dist-fecha').value, upc: document.getElementById('dist-upc').value, tracks }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'distribucion', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarDistribucionPDF(proyectoCompleto); closeDocumentsModal(); }
        
      function getFinalCoordinates(pos) { let baseX, baseY; switch(pos.vAlign) { case 'top': baseY = PDF_DIMENSIONS.MARGIN; break; case 'middle': baseY = (PDF_DIMENSIONS.HEIGHT / 2) - (pos.h / 2); break; default: baseY = PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN; } switch(pos.hAlign) { case 'left': baseX = PDF_DIMENSIONS.MARGIN; break; case 'center': baseX = (PDF_DIMENSIONS.WIDTH / 2) - (pos.w / 2); break; default: baseX = PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN; } let finalX = baseX + pos.offsetX; let finalY = baseY + pos.offsetY; finalX = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalX, PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN)); finalY = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalY, PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN)); return { x: finalX, y: finalY, w: pos.w, h: pos.h }; }
      async function addFirmaToPdf(pdf, docType, finalFileName, proyecto) { const firmaPath = (configCache && configCache.firmaPath) ? configCache.firmaPath : 'https://placehold.co/150x60?text=Firma'; try { const response = await fetch(firmaPath); if (!response.ok) throw new Error('.'); const firmaImg = await response.blob(); const reader = new FileReader(); reader.readAsDataURL(firmaImg); reader.onloadend = function() { try { const base64data = reader.result; const pos = getFinalCoordinates(configCache.firmaPos[docType]); if (docType === 'contrato') { pdf.line(PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 2, PDF_DIMENSIONS.MARGIN + 70, pos.y + pos.h + 2); pdf.text(proyecto.artista.nombre, PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 7); pdf.text('Firma del Cliente', PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 12); } pdf.addImage(base64data, 'PNG', pos.x, pos.y, pos.w, pos.h); pdf.line(pos.x, pos.y + pos.h + 2, pos.x + pos.w, pos.y + pos.h + 2); pdf.text("Erick Resendiz", pos.x, pos.y + pos.h + 7); pdf.text("Representante FIA Records", pos.x, pos.y + pos.h + 12); } catch (e) { } finally { pdf.save(finalFileName); } } } catch(e) { pdf.save(finalFileName); } }
        
      async function generarCotizacionPDF(proyectoIdOrObject) { 
          try { 
              const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; 
              const { jsPDF } = window.jspdf; const pdf = new jsPDF(); 
                
              pdf.setFillColor(0, 0, 0);
              pdf.rect(14, 15, 40, 15, 'F');
              if (logoBase64) { pdf.addImage(logoBase64, 'PNG', 14, 15, 40, 15); } 

              pdf.setFontSize(9); pdf.text("FiaRecords Studio", 200, 20, { align: 'right' }); pdf.text("Ju√°rez N.L.", 200, 25, { align: 'right' }); 
              pdf.setFontSize(11); pdf.text(`Cliente: ${proyecto.artista ? proyecto.artista.nombre : 'P√∫blico General'}`, 14, 50); pdf.text(`Fecha: ${new Date().toLocaleDateString()}`, 200, 50, { align: 'right' }); 
              const body = proyecto.items.map(item => [`${item.unidades}x ${item.nombre}`, `$${(item.precioUnitario * item.unidades).toFixed(2)}`]); 
              if (proyecto.descuento && proyecto.descuento > 0) { body.push(['Descuento', `-$${proyecto.descuento.toFixed(2)}`]); }
              pdf.autoTable({ startY: 70, head: [['Servicio', 'Subtotal']], body: body, theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [0, 0, 0] } }); let finalY = pdf.lastAutoTable.finalY + 10; pdf.setFontSize(12); pdf.setFont(undefined, 'bold'); pdf.text(`Total: $${proyecto.total.toFixed(2)} MXN`, 200, finalY, { align: 'right' }); 
              const fileName = `Cotizacion-${proyecto.artista ? proyecto.artista.nombre.replace(/\s/g, '_') : 'General'}.pdf`; await addFirmaToPdf(pdf, 'cotizacion', fileName, proyecto); 
          } catch (error) { showToast("Error PDF", 'error'); } 
      }
      async function generarReciboPDF(proyecto, pagoEspecifico) { 
        try { 
          const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const pago = pagoEspecifico || (proyecto.pagos && proyecto.pagos.length > 0 ? proyecto.pagos[proyecto.pagos.length - 1] : null); 
          
          if (!pago) {
               if (proyecto.montoPagado > 0) {
                   const dummyPago = { monto: proyecto.montoPagado };
                   return generarReciboPDF(proyecto, dummyPago);
               }
               return showToast('Sin pagos registrados.', 'error');
          }

          const saldoRestante = proyecto.total - proyecto.montoPagado; 
            
          pdf.setFillColor(0, 0, 0);
          pdf.rect(14, 15, 40, 15, 'F');
          if (logoBase64) { pdf.addImage(logoBase64, 'PNG', 14, 15, 40, 15); } 

          pdf.setFontSize(16); pdf.setFont(undefined, 'bold').text(`RECIBO DE PAGO`, 105, 45, { align: 'center' }); pdf.setFontSize(11); pdf.setFont(undefined, 'normal'); pdf.text(`Cliente: ${proyecto.artista ? proyecto.artista.nombre : 'General'}`, 14, 60); pdf.autoTable({ startY: 70, theme: 'plain', body: [['Total Proyecto:', `$${proyecto.total.toFixed(2)}`], ['Monto Recibo:', `$${pago.monto.toFixed(2)}`], ['Restante Total:', `$${saldoRestante.toFixed(2)}`]] }); const fileName = `Recibo.pdf`; await addFirmaToPdf(pdf, 'recibo', fileName, proyecto); 
        } catch (error) { showToast('Error recibo.', 'error'); }}

      async function generarContratoPDF(proyectoIdOrObject) { 
        try { 
          const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const c = proyecto.detallesContrato; 
            
          pdf.setFillColor(0, 0, 0);
          pdf.rect(14, 15, 40, 15, 'F');
          if (logoBase64) { pdf.addImage(logoBase64, 'PNG', 14, 15, 40, 15); } 

          pdf.setFontSize(18).setFont(undefined, 'bold').text('CONTRATO DE SERVICIOS', 105, 40, { align: 'center' }); pdf.setFontSize(10).setFont(undefined, 'normal'); pdf.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 55); pdf.text(`Cliente: ${proyecto.artista.nombre}`, 14, 65); const terminos = `Servicios para el √°lbum "${c.nombreAlbum}". Pago total: $${proyecto.total}. Anticipo: $${c.pagoInicial}.`; pdf.text(terminos, 14, 80, { maxWidth: 180 }); const fileName = `Contrato.pdf`; await addFirmaToPdf(pdf, 'contrato', fileName, proyecto); 
        } catch (e) { showToast("Error PDF", 'error'); }}
        
      async function generarDistribucionPDF(proyecto) { try { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const d = proyecto.detallesDistribucion; pdf.setFontSize(16).text('DISTRIBUCI√ìN DIGITAL', 105, 20, { align: 'center' }); pdf.autoTable({ startY: 40, body: [ ['Lanzamiento:', d.tituloLanzamiento], ['UPC:', d.upc] ] }); const fileName = `Distribucion.pdf`; await addFirmaToPdf(pdf, 'distribucion', fileName, proyecto); } catch (e) { showToast("Error PDF", 'error'); }}

      async function mostrarVistaArtista(artistaId, nombre, nombreArtistico, isClientView = false) {
          document.getElementById('vista-artista-nombre').textContent = `${escapeHTML(nombre)}`; 
          const contenido = document.getElementById('vista-artista-contenido'); 
          contenido.innerHTML = '<p>Cargando...</p>'; 
          try { 
              const [proyectos, todosPagos, artistaInfo] = await Promise.all([
                  fetchAPI(`/api/proyectos/por-artista/${artistaId}`),
                  fetchAPI('/api/proyectos/pagos/todos'),
                  fetchAPI(`/api/artistas/${artistaId}`)
              ]);
              
              let html = `<div class="card" style="margin-bottom: 2rem; display: flex; justify-content: space-between; align-items: flex-start; flex-wrap: wrap; gap: 1rem;">
                  <div>
                      <p style="font-size: 1.1em;"><strong>Nombre:</strong> ${escapeHTML(artistaInfo.nombre)}</p>
                      <p style="color:var(--text-color-light);"><strong>Art√≠stico:</strong> ${escapeHTML(artistaInfo.nombreArtistico || 'N/A')}</p>
                      <p><strong>Tel:</strong> ${escapeHTML(artistaInfo.telefono || 'N/A')} | <strong>Email:</strong> ${escapeHTML(artistaInfo.correo || 'N/A')}</p>
                  </div>`;

              if(!isClientView) {
                 html += `<div style="display:flex; gap: 0.5rem; flex-wrap: wrap;">
                      <button class="btn-secondary" onclick="app.abrirModalEditarArtista('${artistaInfo._id}', '${escapeHTML(artistaInfo.nombre)}', '${escapeHTML(artistaInfo.nombreArtistico||'')}', '${escapeHTML(artistaInfo.telefono||'')}', '${escapeHTML(artistaInfo.correo||'')}')">‚úèÔ∏è Editar Datos</button>
                      <button class="btn-primary" onclick="app.nuevoProyectoParaArtista('${artistaInfo._id}', '${escapeHTML(artistaInfo.nombre)}')">‚ûï Nuevo Proyecto</button>
                  </div>`;
              } else {
                  html += `<div style="display:flex; gap: 0.5rem; flex-wrap: wrap;">
                      <button class="btn-primary" onclick="app.abrirModalSolicitud('${artistaInfo._id}')">üìÖ Solicitar Cita / Proyecto</button>
                  </div>`;
              }
              html += `</div>`;
              
              html += '<h3>Proyectos</h3>'; 
              if(proyectos.length) { 
                  html += '<div class="table-responsive"><table style="margin-bottom: 2rem; width: 100%;"><thead><tr><th>Fecha</th><th>Proyecto</th><th>Total</th><th>Pagado</th><th>Acciones</th></tr></thead><tbody>'; 
                  proyectos.forEach(p => { 
                      html += `<tr>
                        <td>${new Date(p.fecha).toLocaleDateString()}</td>
                        <td>${escapeHTML(p.nombreProyecto || 'Proyecto')}</td>
                        <td>$${p.total.toFixed(2)}</td>
                        <td>$${(p.montoPagado||0).toFixed(2)}</td>
                        <td class="table-actions">`;
                      
                      if (!isClientView) {
                          html += `<button class="btn-secondary" title="Entrega / Drive" onclick="app.openDeliveryModal('${p._id}', '${escapeHTML(artistaInfo.nombre)}', '${escapeHTML(p.nombreProyecto || 'Proyecto')}')">‚òÅÔ∏è</button>`;
                      } else {
                          if(p.enlaceEntrega) {
                             html += `<a href="${p.enlaceEntrega}" target="_blank" class="btn-primary" style="text-decoration:none; padding: 0.5rem; display:inline-flex; align-items:center; width:auto; height:auto; font-size: 0.8em; margin-right:4px;">üìÇ Descargar</a>`;
                          }
                          if(p.montoPagado > 0) {
                              html += `<button class="btn-secondary" title="Descargar Recibo" onclick="app.generarReciboPDF('${p._id}')">üìÑ Recibo</button>`;
                          }
                      }

                      html += `<button class="btn-secondary" title="PDF" onclick="app.generarCotizacionPDF('${p._id}')">üìÑ</button>`;
                      
                      if(!isClientView) {
                          html += `<button class="btn-secondary" title="Editar" onclick="app.editarInfoProyecto('${p._id}')">‚úèÔ∏è</button>
                                   <button class="btn-eliminar" title="Eliminar" onclick="app.eliminarProyecto('${p._id}')">üóëÔ∏è</button>`;
                      }
                      html += `</td></tr>`; 
                  }); 
                  html += '</tbody></table></div>'; 
              } else { html += '<p>Sin proyectos registrados.</p>'; } 
              
              contenido.innerHTML = html; 
              mostrarSeccion('vista-artista'); 
          } catch(e) { contenido.innerHTML = '<p>Error cargando historial.</p>'; console.error(e); } 
      }

      // --- FUNCIONES NUEVAS PARA SOLICITUD DE CLIENTE ---
      let solicitudArtistaId = null;

      async function abrirModalSolicitud(artistaId) {
          solicitudArtistaId = artistaId;
          const modal = document.getElementById('request-appointment-modal');
          const select = document.getElementById('req-service');
          
          try {
              if (localCache.servicios.length === 0) {
                  const servicios = await fetchAPI('/api/servicios');
                  localCache.servicios = servicios;
              }
              select.innerHTML = localCache.servicios.map(s => `<option value="${s._id}" data-precio="${s.precio}" data-nombre="${s.nombre}">${s.nombre} (Aprox $${s.precio})</option>`).join('');
          } catch(e) { console.error(e); }

          flatpickr("#req-date", { minDate: "today", locale: "es" });
          modal.style.display = 'flex';
      }

      function cerrarModalSolicitud() {
          document.getElementById('request-appointment-modal').style.display = 'none';
      }

      async function enviarSolicitud(e) {
          e.preventDefault();
          const select = document.getElementById('req-service');
          const option = select.options[select.selectedIndex];
          const serviceId = select.value;
          const serviceName = option.dataset.nombre;
          const price = parseFloat(option.dataset.precio);
          
          const dateStr = document.getElementById('req-date')._flatpickr.selectedDates[0];
          const timeStr = document.getElementById('req-time').value;
          const comments = document.getElementById('req-comments').value;

          if(!dateStr) return showToast('Selecciona una fecha', 'error');

          let finalDate = new Date(dateStr);
          if (timeStr) {
              const [h, m] = timeStr.split(':');
              finalDate.setHours(h);
              finalDate.setMinutes(m);
          }

          const nuevoProyecto = {
              artista: solicitudArtistaId,
              nombreProyecto: `Solicitud: ${serviceName}`,
              items: [{ servicio: serviceId, nombre: serviceName + (comments ? ` (${comments})` : ''), unidades: 1, precioUnitario: price }],
              total: price,
              descuento: 0,
              estatus: 'Solicitud', 
              metodoPago: 'Pendiente',
              fecha: finalDate.toISOString(),
              prioridad: 'Normal',
              proceso: 'Solicitud', 
              esAlbum: false
          };

          try {
              await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(nuevoProyecto) });
              showToast('¬°Solicitud enviada! Te contactaremos pronto.', 'success');
              cerrarModalSolicitud();
              const nombreHeader = document.getElementById('vista-artista-nombre').textContent;
              mostrarVistaArtista(solicitudArtistaId, nombreHeader, '', true);
          } catch(err) {
              showToast('Error al enviar solicitud.', 'error');
          }
      }

      async function irAVistaArtista(artistaId, artistaNombre, nombreArtistico) { if (!artistaId) { const artistas = await fetchAPI('/api/artistas'); const artista = artistas.find(a => a.nombre === artistaNombre); if (artista) artistaId = artista._id; else return; } mostrarVistaArtista(artistaId, artistaNombre, nombreArtistico); }
        
      function nuevoProyectoParaArtista(idArtista, nombreArtista) {
          preseleccionArtistaId = idArtista; 
          mostrarSeccion('registrar-proyecto');
          showToast(`Iniciando proyecto para: ${nombreArtista}`, 'info');
      }

      function abrirModalEditarArtista(id, nombre, artistico, tel, mail) {
          const m = document.getElementById('edit-artist-modal');
          document.getElementById('editArtistId').value = id;
          document.getElementById('editArtistNombre').value = nombre;
          document.getElementById('editArtistNombreArt√≠stico').value = artistico;
          document.getElementById('editArtistTelefono').value = tel;
          document.getElementById('editArtistCorreo').value = mail;
          m.style.display = 'flex';
      }

      async function guardarEdicionArtista(e) {
          e.preventDefault();
          const id = document.getElementById('editArtistId').value;
          const body = {
              nombre: document.getElementById('editArtistNombre').value,
              nombreArtistico: document.getElementById('editArtistNombreArt√≠stico').value,
              telefono: document.getElementById('editArtistTelefono').value,
              correo: document.getElementById('editArtistCorreo').value
          };
          
          try {
              await fetchAPI(`/api/artistas/${id}`, { method: 'PUT', body: JSON.stringify(body) });
              showToast('Datos actualizados.', 'success');
              document.getElementById('edit-artist-modal').style.display = 'none';
              mostrarVistaArtista(id, body.nombre, body.nombreArtistico);
              const idx = localCache.artistas.findIndex(a => a._id === id);
              if(idx !== -1) localCache.artistas[idx] = { ...localCache.artistas[idx], ...body };
          } catch(err) {
              showToast('Error al guardar.', 'error');
          }
      }

      function setupCustomization(payload) { if (payload.role === 'admin') { DOMElements.appLogo.addEventListener('click', () => DOMElements.logoInput.click()); DOMElements.logoInput.addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('logoFile', file); try { await fetchAPI('/api/configuracion/upload-logo', { method: 'POST', body: formData, isFormData: true }); showToast('Logo guardado!', 'success'); await loadPublicLogo(); } catch (e) { showToast(`Error`, 'error'); } }); } }
        
      async function cargarConfiguracion() { try { if (!configCache) await loadInitialConfig(); const firmaPreview = document.getElementById('firma-preview-img'); const draggablePreview = document.getElementById('firma-draggable-preview'); let firmaSrc = 'https://placehold.co/150x60?text=Subir+Firma'; if (configCache && configCache.firmaPath) { firmaSrc = configCache.firmaPath + `?t=${new Date().getTime()}`; } firmaPreview.src = draggablePreview.src = firmaSrc; 
      const db = configCache.datosBancarios || {};
      document.getElementById('banco').value = db.banco || ''; document.getElementById('titular').value = db.titular || ''; document.getElementById('tarjeta').value = db.tarjeta || ''; document.getElementById('clabe').value = db.clabe || '';
      document.getElementById('doc-type-selector').value = 'cotizacion'; cargarAjustesParaDocumento('cotizacion'); } catch (e) { showToast('Error config.', 'error'); } }
      function cargarAjustesParaDocumento(docType) { 
          if (!configCache || !configCache.firmaPos || !configCache.firmaPos[docType]) return; 
          const pos = configCache.firmaPos[docType]; 
          document.querySelector(`input[name="vAlign"][value="${pos.vAlign}"]`).checked = true;
          document.querySelector(`input[name="hAlign"][value="${pos.hAlign}"]`).checked = true;
          document.getElementById('slider-firma-w').value = pos.w; 
          document.getElementById('slider-firma-offsetX').value = pos.offsetX; 
          document.getElementById('slider-firma-offsetY').value = pos.offsetY; 
          actualizarPosicionFirma(); 
      }
      function actualizarPosicionFirma() {
          const docType = document.getElementById('doc-type-selector').value;
          const pos = configCache.firmaPos[docType];
          pos.vAlign = document.querySelector('input[name="vAlign"]:checked').value;
          pos.hAlign = document.querySelector('input[name="hAlign"]:checked').value;
          pos.w = parseInt(document.getElementById('slider-firma-w').value);
          pos.offsetX = parseInt(document.getElementById('slider-firma-offsetX').value);
          pos.offsetY = parseInt(document.getElementById('slider-firma-offsetY').value);
      }
      async function revertirADefecto() {
          const docType = document.getElementById('doc-type-selector').value;
          if (!confirm(`¬øResetear ajustes?`)) return;
          try {
              const defaultSettings = await fetchAPI('/api/configuracion/defaults');
              configCache.firmaPos[docType] = defaultSettings[docType];
              cargarAjustesParaDocumento(docType);
              showToast('Revertido.', 'info');
          } catch (e) { showToast('Error.', 'error'); }
      }
      async function guardarAjustesFirma() { if (!configCache) return; try { await fetchAPI('/api/configuracion/firma-pos', { method: 'PUT', body: JSON.stringify({ firmaPos: configCache.firmaPos }) }); showToast('¬°Ajustes PDF guardados!', 'success'); } catch (e) { showToast(`Error`, 'error'); } }
      async function subirFirma(event) { const file = event.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('firmaFile', file); try { const data = await fetchAPI('/api/configuracion/upload-firma', { method: 'POST', body: formData, isFormData: true }); showToast('¬°Firma subida!', 'success'); const newSrc = data.filePath + `?t=${new Date().getTime()}`; document.getElementById('firma-preview-img').src = newSrc; if(configCache) configCache.firmaPath = data.filePath; } catch (e) { showToast(`Error`, 'error'); } }
      async function guardarDatosBancarios() {
        const datosBancarios = { banco: document.getElementById('banco').value, titular: document.getElementById('titular').value, tarjeta: document.getElementById('tarjeta').value, clabe: document.getElementById('clabe').value };
        try { await fetchAPI('/api/configuracion/datos-bancarios', { method: 'PUT', body: JSON.stringify({ datosBancarios }) }); showToast('Guardado.', 'success'); configCache.datosBancarios = datosBancarios; } catch (e) { showToast(`Error`, 'error'); }
      }
      function openDeliveryModal(projectId, artistName, projectName) {
          const modal = document.getElementById('delivery-modal');
          modal.querySelector('#delivery-project-id').value = projectId;
          modal.querySelector('#delivery-artist-name').value = artistName;
          modal.querySelector('#delivery-project-name').value = projectName;
          const project = localCache.proyectos.find(p => p._id === projectId) || historialCacheados.find(p => p._id === projectId);
          modal.querySelector('#delivery-link-input').value = project ? project.enlaceEntrega : '';
          document.getElementById('drive-status').textContent = '';
          document.getElementById('drive-file-input').value = '';
          modal.style.display = 'flex';
      }
      function closeDeliveryModal() { document.getElementById('delivery-modal').style.display = 'none'; }
      async function saveDeliveryLink() {
          const projectId = document.getElementById('delivery-project-id').value;
          const enlace = document.getElementById('delivery-link-input').value;
          try { await fetchAPI(`/api/proyectos/${projectId}/enlace-entrega`, { method: 'PUT', body: JSON.stringify({ enlace }) }); showToast('Enlace guardado.', 'success'); closeDeliveryModal(); } catch(e) { showToast(`Error`, 'error'); }
      }
      function sendDeliveryByWhatsapp() {
          const link = document.getElementById('delivery-link-input').value;
          if (!link) return showToast('Falta el enlace.', 'error');
          const artistName = document.getElementById('delivery-artist-name').value;
          const projectName = document.getElementById('delivery-project-name').value;
          const mensaje = `¬°Hola ${artistName}! Archivos finales de "${projectName}":\n\n${link}\n\n¬°Gracias por confiar en FiaRecords!`;
          window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
      }
        
      async function editarInfoProyecto(id) {
          const proyecto = localCache.proyectos.find(p => p._id === id) || historialCacheados.find(p => p._id === id);
          if (!proyecto) return;
          
          const nuevoNombre = prompt('Editar Nombre del Proyecto/Canci√≥n:', proyecto.nombreProyecto || '');
          if (nuevoNombre === null) return;
          
          const nuevoTotalStr = prompt('Editar Precio Total ($):', proyecto.total || 0);
          if (nuevoTotalStr === null) return;
          const nuevoTotal = parseFloat(nuevoTotalStr);

          try { 
              if (nuevoNombre.trim() !== proyecto.nombreProyecto) {
                 await fetchAPI(`/api/proyectos/${id}/nombre`, { method: 'PUT', body: JSON.stringify({ nombreProyecto: nuevoNombre.trim() }) }); 
                 proyecto.nombreProyecto = nuevoNombre.trim(); 
              }
              if (!isNaN(nuevoTotal) && nuevoTotal !== proyecto.total) {
                  await fetchAPI(`/api/proyectos/${id}`, { method: 'PUT', body: JSON.stringify({ total: nuevoTotal }) });
                  proyecto.total = nuevoTotal;
              }
              
              showToast('Proyecto actualizado.', 'success'); 
              
              if(document.getElementById('flujo-trabajo').classList.contains('active')) {
                    const filtro = document.querySelector('#filtrosFlujo button.active').textContent.trim();
                    filtrarFlujo(filtro); 
              } else if (document.getElementById('vista-artista').classList.contains('active')) {
                    const nombreActual = document.getElementById('vista-artista-nombre').textContent;
                    
                    if (!Array.isArray(localCache.artistas)) {
                        localCache.artistas = await fetchAPI('/api/artistas');
                    }
                    
                    const art = localCache.artistas.find(a => a.nombre === nombreActual);
                    if(art) {
                        mostrarVistaArtista(art._id, nombreActual, '');
                    }
              }
          } catch (e) { showToast(`Error al editar`, 'error'); }
      }

      function setupMobileMenu() {
        const hamburger = document.getElementById('hamburger-menu');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const toggleMenu = () => { sidebar.classList.toggle('sidebar-visible'); overlay.classList.toggle('overlay-visible'); };
        hamburger.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
        document.querySelectorAll('.sidebar .nav-link').forEach(link => { link.addEventListener('click', () => { if (window.innerWidth <= 768 && sidebar.classList.contains('sidebar-visible')) toggleMenu(); }); });
      }

      function initAppEventListeners(payload) {
        flatpickr("#fechaProyecto", { defaultDate: "today", locale: "es" });
        window.addEventListener('hashchange', () => { const section = location.hash.replace('#', ''); if (section) mostrarSeccion(section, false); });
        
        const sidebarNav = document.getElementById('sidebar-nav-container');
        if(sidebarNav) {
            sidebarNav.addEventListener('click', (e) => {
                const link = e.target.closest('.nav-link');
                if (link && link.dataset.seccion) {
                    mostrarSeccion(link.dataset.seccion);
                }
            });
        }
        
        const btnNuevo = document.getElementById('btn-nuevo-proyecto-sidebar');
        if (btnNuevo) {
            btnNuevo.addEventListener('click', (e) => {
                e.preventDefault();
                mostrarSeccion('registrar-proyecto');
            });
        }

        document.getElementById('theme-switch').addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
        ['Servicios', 'Artistas', 'Usuarios'].forEach(type => { document.getElementById(`form${type}`).addEventListener('submit', (e) => saveItem(e, type.toLowerCase())); document.getElementById(`btnLimpiarForm${type}`).addEventListener('click', () => limpiarForm(`form${type}`)); });
        document.getElementById('btnAgregarAProyecto').addEventListener('click', agregarAProyecto); document.getElementById('btnGenerarCotizacion').addEventListener('click', generarCotizacion); document.getElementById('btnEnviarAFlujo').addEventListener('click', enviarAFlujoDirecto);
        document.getElementById('btnNuevoArtista').addEventListener('click', () => { document.getElementById('nuevoArtistaContainer').style.display = 'block'; });
        document.getElementById('btnGuardarNuevoArtista').addEventListener('click', () => registrarNuevoArtistaDesdeFormulario(''));
        document.getElementById('manualBtnNuevoArtista').addEventListener('click', () => { document.getElementById('manualNuevoArtistaContainer').style.display = 'block'; });
        document.getElementById('btnGuardarManualNuevoArtista').addEventListener('click', () => registrarNuevoArtistaDesdeFormulario('manual'));
        document.getElementById('firma-input').addEventListener('change', subirFirma);
        document.getElementById('proyectoDescuento').addEventListener('input', mostrarProyectoActual);
        
        document.getElementById('toggle-password').addEventListener('click', (e) => { const passwordInput = document.getElementById('password'); const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password'; passwordInput.setAttribute('type', type); e.target.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà'; });
        const toggleReg = document.getElementById('toggle-password-reg');
        if(toggleReg) toggleReg.addEventListener('click', (e) => { const passwordInput = document.getElementById('reg-password'); const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password'; passwordInput.setAttribute('type', type); e.target.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà'; });

        setupCustomization(payload);
        setupMobileMenu();

        const roleInput = document.getElementById('roleUsuario');
        if(roleInput) {
            roleInput.addEventListener('input', (e) => {
                const val = e.target.value.toLowerCase();
                const perms = document.querySelectorAll('input[name="user_permisos"]');
                
                let toCheck = [];
                if(val.includes('admin')) {
                    toCheck = ['dashboard', 'agenda', 'flujo-trabajo', 'finanzas', 'historial-proyectos', 'gestion-artistas', 'gestion-servicios', 'gestion-usuarios', 'configuracion'];
                } else if (val.includes('ingeniero')) {
                    toCheck = ['dashboard', 'agenda', 'flujo-trabajo', 'historial-proyectos', 'gestion-artistas', 'gestion-servicios'];
                } else if (val.includes('dise√±ador')) {
                    toCheck = ['dashboard', 'agenda', 'flujo-trabajo', 'gestion-artistas'];
                } else if (val.includes('cliente')) {
                    toCheck = ['dashboard', 'cotizaciones', 'pagos', 'historial-proyectos'];
                }

                if(toCheck.length > 0) {
                      perms.forEach(p => p.checked = false);
                      perms.forEach(p => {
                          if(toCheck.includes(p.value)) p.checked = true;
                      });
                }
            });
        }
      }

      function renderSidebar(user) {
          const navContainer = document.getElementById('sidebar-nav-container');
          
          let p = user.permisos || []; 
          const role = user.role ? user.role.toLowerCase() : '';

          if (role !== 'admin' && p.length === 0) {
              if (role.includes('ingeniero') || role.includes('productor')) {
                  p = ['dashboard', 'agenda', 'flujo-trabajo', 'historial-proyectos', 'gestion-artistas', 'gestion-servicios'];
              } else if (role.includes('dise√±ador') || role.includes('visual')) {
                  p = ['dashboard', 'agenda', 'flujo-trabajo', 'gestion-artistas'];
              } else if (role.includes('finanzas') || role.includes('contador')) {
                  p = ['dashboard', 'finanzas', 'cotizaciones', 'pagos', 'historial-proyectos'];
              } else {
                  p = ['dashboard'];
              }
          }
          
          const isSuperAdmin = role === 'admin';

          const canAccess = (permKey) => {
              if (isSuperAdmin) return true;
              return p.includes(permKey);
          };
          
          let html = `
            <details class="nav-group" open>
              <summary>Proyectos</summary>
              <ul>
                ${canAccess('dashboard') ? '<li><a class="nav-link" data-seccion="dashboard"><span>Dashboard</span></a></li>' : ''}
                ${canAccess('agenda') ? '<li><a class="nav-link" data-seccion="agenda"><span>Agenda</span></a></li>' : ''}
                ${canAccess('flujo-trabajo') ? '<li><a class="nav-link" data-seccion="flujo-trabajo"><span>Flujo de Trabajo</span></a></li>' : ''}
                ${canAccess('finanzas') || canAccess('cotizaciones') ? '<li><a class="nav-link" data-seccion="cotizaciones"><span>Cotizaciones</span></a></li>' : ''}
                ${canAccess('historial-proyectos') ? '<li><a class="nav-link" data-seccion="historial-proyectos"><span>Historial</span></a></li>' : ''}
                ${canAccess('finanzas') || canAccess('pagos') ? '<li><a class="nav-link" data-seccion="pagos"><span>Pagos</span></a></li>' : ''}
                ${canAccess('agenda') ? '<li><a class="nav-link" data-seccion="registro-manual"><span>Registro Manual</span></a></li>' : ''}
              </ul>
            </details>
            
            <details class="nav-group" open>
              <summary>Gesti√≥n</summary>
              <ul>
                ${canAccess('gestion-artistas') ? '<li><a class="nav-link" data-seccion="gestion-artistas"><span>Artistas</span></a></li>' : ''}
                ${canAccess('gestion-servicios') ? '<li><a class="nav-link" data-seccion="gestion-servicios"><span>Servicios</span></a></li>' : ''}
                ${canAccess('gestion-usuarios') ? '<li><a class="nav-link" data-seccion="gestion-usuarios"><span>Usuarios</span></a></li>' : ''}
              </ul>
            </details>
            
            ${canAccess('configuracion') ? `
            <details class="nav-group">
              <summary>Sistema</summary>
              <ul>
                <li><a class="nav-link" data-seccion="configuracion"><span>Configuraci√≥n</span></a></li>
                <li><a class="nav-link" data-seccion="papelera-reciclaje"><span>Papelera</span></a></li>
              </ul>
            </details>` : ''}
          `;
          navContainer.innerHTML = html;
          document.querySelectorAll('.nav-link[data-seccion]').forEach(link => {
              link.addEventListener('click', (e) => mostrarSeccion(e.currentTarget.dataset.seccion));
          });
      }

      window.app = { eliminarItem, editarItem, restaurarItem, vaciarPapelera, cambiarProceso, filtrarFlujo, eliminarProyecto, quitarDeProyecto, cambiarAtributo, aprobarCotizacion, generarCotizacionPDF, compartirPorWhatsApp, registrarPago, reimprimirRecibo, compartirPagoPorWhatsApp, eliminarPago, openDocumentsModal, closeDocumentsModal, showDocumentSection, saveAndGenerateContract, saveAndGenerateDistribution, addTrackField, mostrarVistaArtista, irAVistaArtista, calcularSaldoContrato, cargarAjustesParaDocumento, actualizarPosicionFirma, guardarAjustesFirma, revertirADefecto, guardarDatosBancarios, generarContratoPDF, openEventModal, closeEventModal, goToProjectInWorkflow, goToArtistFromModal, openDeliveryModal, closeDeliveryModal, saveDeliveryLink, sendDeliveryByWhatsapp, guardarProyectoManual, editarInfoProyecto, filtrarTablas, actualizarHorarioProyecto, cargarAgenda, cancelarCita, subirADrive, syncNow: OfflineManager.syncNow, mostrarSeccion, mostrarSeccionPagos, cargarPagosPendientes, cargarHistorialPagos, cargarPagos, nuevoProyectoParaArtista, abrirModalEditarArtista, guardarEdicionArtista, loadFlujo: () => cargarFlujoDeTrabajo(), abrirModalSolicitud, cerrarModalSolicitud, enviarSolicitud, toggleAuth, registerUser, recoverPassword, generarReciboPDF, showResetPasswordView, resetPassword };
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', function() {
        navigator.serviceWorker.register('sw.js').then(function(registration) {
          console.log('SW OK:', registration.scope);
        }, function(err) { console.log('SW Fail:', err); });
      });
    }
  </script>
</body>
</html>