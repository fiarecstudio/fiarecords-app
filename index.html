<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Fia Records Estudio de Grabaci√≥n</title>
    
    <meta name="theme-color" content="#6366f1">
    <link id="dynamic-favicon" rel="icon" type="image/png" href="https://placehold.co/32x32?text=Fia">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Poppins:wght@500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

    <style>
        /* =========================================
           RESET Y VARIABLES GLOBALES
           ========================================= */
        :root {
            /* Paleta de Colores Principal */
            --primary: #6366f1;
            --primary-dark: #4338ca;
            --primary-light: #818cf8;
            --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
            
            /* Estados */
            --success: #10b981;
            --success-bg: rgba(16, 185, 129, 0.1);
            --danger: #ef4444;
            --danger-bg: rgba(239, 68, 68, 0.1);
            --warning: #f59e0b;
            --warning-bg: rgba(245, 158, 11, 0.1);
            --info: #3b82f6;

            /* Modo Claro (Default) */
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --bg-sidebar: #ffffff;
            --bg-input: #f8fafc;
            --text-main: #0f172a;
            --text-muted: #64748b;
            --border: #e2e8f0;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.1);

            /* Kanban Colores */
            --col-agendado: #3b82f6;
            --col-grabacion: #8b5cf6;
            --col-edicion: #ec4899;
            --col-mezcla: #f59e0b;
            --col-mastering: #10b981;
            --col-completo: #64748b;
        }

        /* Modo Oscuro */
        body.dark-mode {
            --bg-body: #0f172a;
            --bg-card: #1e293b;
            --bg-sidebar: #1e293b;
            --bg-input: #0f172a;
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --border: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
            --shadow-hover: 0 10px 15px -3px rgba(0, 0, 0, 0.4);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            outline: none;
            -webkit-tap-highlight-color: transparent;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            font-size: 15px;
            line-height: 1.5;
            height: 100vh;
            display: flex;
            overflow: hidden;
            transition: background-color 0.3s, color 0.3s;
        }

        h1, h2, h3, h4, h5, h6 {
            font-family: 'Poppins', sans-serif;
            font-weight: 600;
            color: var(--text-main);
        }

        /* =========================================
           LAYOUT: SIDEBAR
           ========================================= */
        .sidebar {
            width: 280px;
            background-color: var(--bg-sidebar);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding: 1.5rem;
            z-index: 1000;
            transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-header {
            text-align: center;
            margin-bottom: 2rem;
        }

        .app-logo {
            max-width: 160px;
            height: auto;
            object-fit: contain;
            cursor: pointer;
        }
        
        body:not(.dark-mode) .app-logo {
            filter: invert(1) brightness(0.2);
        }

        .sidebar-content {
            flex: 1;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .nav-group {
            margin-bottom: 1rem;
        }

        .nav-label {
            font-size: 0.75rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-muted);
            font-weight: 700;
            margin-bottom: 0.5rem;
            padding-left: 0.75rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            padding: 0.75rem 1rem;
            border-radius: 10px;
            color: var(--text-muted);
            text-decoration: none;
            font-weight: 500;
            transition: all 0.2s;
            cursor: pointer;
        }

        .nav-link:hover {
            background-color: var(--bg-body);
            color: var(--text-main);
            transform: translateX(3px);
        }

        .nav-link.active {
            background-color: var(--primary-bg); /* Fallback */
            background: rgba(99, 102, 241, 0.1);
            color: var(--primary);
            font-weight: 600;
        }

        .sidebar-footer {
            border-top: 1px solid var(--border);
            padding-top: 1.5rem;
            margin-top: auto;
        }

        /* =========================================
           LAYOUT: MAIN CONTENT
           ========================================= */
        .main-wrapper {
            flex: 1;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            position: relative;
        }

        .top-header {
            height: 70px;
            background-color: var(--bg-card);
            border-bottom: 1px solid var(--border);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 2rem;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        /* BUSCADOR GLOBAL */
        .search-container {
            position: relative;
            width: 400px;
        }

        .search-input {
            width: 100%;
            padding: 0.6rem 1rem 0.6rem 2.5rem;
            border-radius: 50px;
            border: 1px solid var(--border);
            background-color: var(--bg-input);
            color: var(--text-main);
            font-size: 0.9rem;
            transition: all 0.3s;
        }

        .search-input:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2);
            background-color: var(--bg-card);
        }

        .search-icon {
            position: absolute;
            left: 10px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-muted);
            pointer-events: none;
        }

        .search-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: var(--bg-card);
            border: 1px solid var(--border);
            border-radius: 12px;
            margin-top: 5px;
            box-shadow: var(--shadow-hover);
            z-index: 5000;
            max-height: 400px;
            overflow-y: auto;
            display: none;
        }

        .search-section-title {
            padding: 0.5rem 1rem;
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--primary);
            background: var(--bg-input);
            border-bottom: 1px solid var(--border);
        }

        .search-item {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid var(--border);
            cursor: pointer;
            transition: background 0.2s;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .search-item:hover {
            background-color: var(--bg-input);
        }

        .search-item strong {
            display: block;
            color: var(--text-main);
        }

        .search-item span {
            font-size: 0.85rem;
            color: var(--text-muted);
        }

        /* CONTENIDO DINAMICO */
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow-y: auto;
            scroll-behavior: smooth;
        }

        section {
            display: none;
            animation: fadeIn 0.3s ease-out;
        }
        
        section.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* =========================================
           COMPONENTES: UI ELEMENTS
           ========================================= */
        .card {
            background-color: var(--bg-card);
            border-radius: 16px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            border: 1px solid var(--border);
            margin-bottom: 1.5rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--border);
        }

        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            padding: 0.6rem 1.2rem;
            border-radius: 8px;
            font-weight: 600;
            font-size: 0.9rem;
            border: none;
            cursor: pointer;
            transition: all 0.2s;
            gap: 0.5rem;
        }

        .btn:active { transform: scale(0.98); }

        .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 12px rgba(99, 102, 241, 0.3); }
        .btn-primary:hover { box-shadow: 0 6px 15px rgba(99, 102, 241, 0.4); }

        .btn-secondary { background: var(--bg-input); color: var(--text-muted); border: 1px solid var(--border); }
        .btn-secondary:hover { background: var(--border); color: var(--text-main); }
        .btn-secondary.active { background: var(--primary); color: white; border-color: var(--primary); }

        .btn-danger { background: var(--danger-bg); color: var(--danger); }
        .btn-danger:hover { background: var(--danger); color: white; }

        .btn-success { background: var(--success-bg); color: var(--success); }
        .btn-success:hover { background: var(--success); color: white; }

        .btn-icon { padding: 0.5rem; width: 36px; height: 36px; border-radius: 8px; display: flex; align-items: center; justify-content: center; }

        /* FORMULARIOS */
        .form-row { display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; }
        .form-group { flex: 1; min-width: 200px; display: flex; flex-direction: column; gap: 0.5rem; }
        
        label { font-size: 0.85rem; font-weight: 600; color: var(--text-muted); }
        
        input, select, textarea {
            width: 100%;
            padding: 0.7rem 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            background-color: var(--bg-input);
            color: var(--text-main);
            font-family: inherit;
            font-size: 0.95rem;
            transition: border-color 0.2s;
        }

        input:focus, select:focus, textarea:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        /* TABLAS RESPONSIVAS */
        .table-container {
            width: 100%;
            overflow-x: auto;
            border-radius: 12px;
            border: 1px solid var(--border);
        }

        table { width: 100%; border-collapse: collapse; min-width: 600px; }
        th { text-align: left; padding: 1rem; background-color: var(--bg-input); color: var(--text-muted); font-size: 0.75rem; text-transform: uppercase; letter-spacing: 0.5px; border-bottom: 1px solid var(--border); }
        td { padding: 1rem; border-bottom: 1px solid var(--border); color: var(--text-main); vertical-align: middle; }
        tr:last-child td { border-bottom: none; }
        tr:hover td { background-color: var(--bg-input); }

        /* KANBAN BOARD */
        .kanban-wrapper {
            display: flex;
            overflow-x: auto;
            gap: 1.5rem;
            padding-bottom: 1.5rem;
            align-items: flex-start;
        }

        .kanban-col {
            min-width: 320px;
            max-width: 320px;
            background: var(--bg-input);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid var(--border);
        }

        .kanban-header {
            font-size: 0.85rem;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-muted);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--border);
            text-align: center;
        }

        .kanban-card {
            background: var(--bg-card);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 0.8rem;
            box-shadow: var(--shadow);
            border-left: 4px solid var(--primary);
            cursor: grab;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .kanban-card:hover { transform: translateY(-3px); box-shadow: var(--shadow-hover); }

        .k-card-title { font-weight: 600; margin-bottom: 0.25rem; display: flex; justify-content: space-between; }
        .k-card-sub { font-size: 0.85rem; color: var(--text-muted); margin-bottom: 0.5rem; }
        .k-card-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 0.75rem; padding-top: 0.75rem; border-top: 1px solid var(--border); }

        /* LIST ITEMS (Papelera, etc) */
        .list-group { list-style: none; }
        .list-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            border: 1px solid var(--border);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            background: var(--bg-card);
        }
        .list-item:hover { border-color: var(--primary); }

        /* KPI DASHBOARD */
        .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(240px, 1fr)); gap: 1.5rem; margin-bottom: 2rem; }
        .kpi-box { background: var(--bg-card); padding: 1.5rem; border-radius: 16px; border: 1px solid var(--border); display: flex; align-items: center; justify-content: space-between; }
        .kpi-info h3 { font-size: 2rem; font-weight: 800; margin-bottom: 0.2rem; }
        .kpi-info p { font-size: 0.85rem; text-transform: uppercase; color: var(--text-muted); font-weight: 600; }
        .kpi-icon { font-size: 2.5rem; opacity: 0.2; }

        /* LOGIN OVERLAY */
        #login-overlay {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background-color: var(--bg-body);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        .login-box { width: 100%; max-width: 400px; padding: 2rem; text-align: center; }

        /* MODALS */
        .modal-backdrop {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(0,0,0,0.6);
            z-index: 3000;
            display: none;
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(4px);
        }
        .modal {
            background: var(--bg-card);
            width: 90%; max-width: 600px;
            max-height: 90vh;
            border-radius: 16px;
            padding: 2rem;
            overflow-y: auto;
            border: 1px solid var(--border);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            animation: slideInModal 0.3s cubic-bezier(0.16, 1, 0.3, 1);
        }
        @keyframes slideInModal { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        /* RESPONSIVE */
        @media (max-width: 768px) {
            .sidebar { position: fixed; height: 100%; left: -100%; box-shadow: 10px 0 20px rgba(0,0,0,0.2); }
            .sidebar.active { left: 0; }
            .search-container { display: none; } /* Ocultar buscador global en mobile o moverlo */
            .main-wrapper { width: 100%; }
            .kpi-grid { grid-template-columns: 1fr; }
            
            /* Mobile Tables */
            table, thead, tbody, th, td, tr { display: block; }
            thead { display: none; }
            tr { margin-bottom: 1rem; border: 1px solid var(--border); border-radius: 12px; background: var(--bg-card); }
            td { text-align: right; padding-left: 50%; position: relative; border-bottom: 1px solid var(--border); }
            td::before { content: attr(data-label); position: absolute; left: 1rem; font-weight: 700; color: var(--text-muted); }
        }
        
        /* THEME SWITCH */
        .theme-switch-wrapper { display: flex; align-items: center; justify-content: space-between; margin-bottom: 1rem; background: var(--bg-input); padding: 0.5rem 1rem; border-radius: 8px; }
        .theme-toggle { position: relative; width: 40px; height: 20px; }
        .theme-toggle input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 34px; transition: .4s; }
        .slider:before { position: absolute; content: ""; height: 16px; width: 16px; left: 2px; bottom: 2px; background-color: white; border-radius: 50%; transition: .4s; }
        input:checked + .slider { background-color: var(--primary); }
        input:checked + .slider:before { transform: translateX(20px); }

    </style>
</head>
<body>

    <div id="login-overlay">
        <div class="card login-box">
            <img src="https://placehold.co/180x80?text=FiaRecords" class="app-logo" id="login-logo-img">
            <h2 style="margin: 1.5rem 0;">Bienvenido al Estudio</h2>
            <form id="form-login" onsubmit="app.login(event)">
                <div class="form-group">
                    <input type="text" id="login-user" placeholder="Usuario" required>
                </div>
                <div class="form-group">
                    <input type="password" id="login-pass" placeholder="Contrase√±a" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; justify-content: center; padding: 1rem;">Iniciar Sesi√≥n</button>
            </form>
            <p style="margin-top: 1rem; font-size: 0.8rem; color: var(--text-muted);">v2.5 - Sistema Integral FiaRecords</p>
        </div>
    </div>

    <nav class="sidebar" id="sidebar">
        <div class="sidebar-header">
            <img src="https://placehold.co/180x80?text=FiaRecords" class="app-logo" id="sidebar-logo-img">
        </div>

        <div class="sidebar-content">
            <button class="btn btn-primary" onclick="app.nav('nuevo-proyecto')" style="width: 100%; justify-content: center; margin-bottom: 1.5rem;">
                + Nuevo Proyecto
            </button>

            <div class="nav-group">
                <div class="nav-label">Proyectos</div>
                <a class="nav-link active" onclick="app.nav('dashboard')">üìä Dashboard</a>
                <a class="nav-link" onclick="app.nav('agenda')">üìÖ Agenda</a>
                <a class="nav-link" onclick="app.nav('flujo')">üìã Flujo de Trabajo</a>
                <a class="nav-link" onclick="app.nav('cotizaciones')">üìÑ Cotizaciones</a>
                <a class="nav-link" onclick="app.nav('historial')">üìÅ Historial Completos</a>
            </div>

            <div class="nav-group">
                <div class="nav-label">Gesti√≥n</div>
                <a class="nav-link" onclick="app.nav('pagos')">üí∞ Control de Pagos</a>
                <a class="nav-link" onclick="app.nav('artistas')">üé§ Artistas</a>
                <a class="nav-link" onclick="app.nav('servicios')">üéöÔ∏è Servicios</a>
                <a class="nav-link" onclick="app.nav('usuarios')">üë• Usuarios</a>
            </div>

            <div class="nav-group">
                <div class="nav-label">Sistema</div>
                <a class="nav-link" onclick="app.nav('papelera')">üóëÔ∏è Papelera de Reciclaje</a>
                <a class="nav-link" onclick="app.nav('config')">‚öôÔ∏è Configuraci√≥n</a>
            </div>
        </div>

        <div class="sidebar-footer">
            <div class="theme-switch-wrapper">
                <span style="font-size: 0.8rem;">Modo Oscuro</span>
                <label class="theme-toggle">
                    <input type="checkbox" id="dark-mode-toggle">
                    <span class="slider"></span>
                </label>
            </div>
            <button class="btn btn-danger" onclick="app.logout()" style="width: 100%; justify-content: center;">Cerrar Sesi√≥n</button>
        </div>
    </nav>

    <div class="main-wrapper">
        <header class="top-header">
            <div class="header-left">
                <button class="btn btn-secondary btn-icon" onclick="document.getElementById('sidebar').classList.toggle('active')" style="display: none;">‚ò∞</button>
                <h3 id="page-title">Dashboard</h3>
            </div>
            
            <div class="search-container">
                <span class="search-icon">üîç</span>
                <input type="text" class="search-input" id="global-search" placeholder="Buscar proyecto, artista, pago..." onkeyup="app.globalSearch(this.value)">
                <div class="search-dropdown" id="search-results"></div>
            </div>

            <div class="header-right">
                <div style="text-align: right;">
                    <div style="font-weight: 700; font-size: 0.9rem;" id="user-display">Admin</div>
                    <div style="font-size: 0.75rem; color: var(--success);">‚óè En L√≠nea</div>
                </div>
            </div>
        </header>

        <div class="content-area">
            
            <section id="sec-dashboard" class="active">
                <div class="kpi-grid">
                    <div class="kpi-box" style="border-left: 5px solid var(--success);">
                        <div class="kpi-info">
                            <h3 id="kpi-income">$0.00</h3>
                            <p>Ingresos del Mes</p>
                        </div>
                        <div class="kpi-icon">üíµ</div>
                    </div>
                    <div class="kpi-box" style="border-left: 5px solid var(--primary);">
                        <div class="kpi-info">
                            <h3 id="kpi-projects">0</h3>
                            <p>Proyectos Activos</p>
                        </div>
                        <div class="kpi-icon">üéöÔ∏è</div>
                    </div>
                    <div class="kpi-box" style="border-left: 5px solid var(--warning);">
                        <div class="kpi-info">
                            <h3 id="kpi-debt">$0.00</h3>
                            <p>Por Cobrar</p>
                        </div>
                        <div class="kpi-icon">‚è≥</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2>Tendencia de Ingresos</h2>
                    </div>
                    <div style="height: 300px; position: relative;">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </section>

            <section id="sec-agenda">
                <div class="card">
                    <div id="calendar"></div>
                </div>
            </section>

            <section id="sec-nuevo-proyecto">
                <div class="card" style="max-width: 800px; margin: 0 auto;">
                    <div class="card-header">
                        <h2>Crear Nuevo Proyecto</h2>
                    </div>
                    
                    <form id="form-nuevo-proyecto" onsubmit="return false;">
                        <div class="form-group">
                            <label>Artista / Cliente</label>
                            <div style="display: flex; gap: 0.5rem;">
                                <select id="np-artista"></select>
                                <button class="btn btn-primary btn-icon" onclick="app.modalQuickArtist()">+</button>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Nombre del Proyecto</label>
                                <input type="text" id="np-nombre" placeholder="Ej: Grabaci√≥n Voz + Mezcla">
                            </div>
                            <div class="form-group" style="flex: 0 0 auto; display: flex; align-items: center; padding-top: 1.5rem;">
                                <input type="checkbox" id="np-album" style="width: auto; margin-right: 0.5rem;">
                                <label for="np-album" style="margin-bottom: 0;">Es un √Ålbum</label>
                            </div>
                        </div>

                        <hr style="margin: 1.5rem 0; border: 0; border-top: 1px dashed var(--border);">

                        <label>Servicios a Contratar</label>
                        <div class="form-row">
                            <div class="form-group" style="flex: 3;">
                                <select id="np-servicio"></select>
                            </div>
                            <div class="form-group">
                                <input type="number" id="np-cantidad" value="1" min="1">
                            </div>
                            <button class="btn btn-secondary" onclick="app.addServiceToProject()">Agregar</button>
                        </div>

                        <div style="background: var(--bg-input); border-radius: 8px; padding: 1rem; margin-bottom: 1rem;">
                            <ul id="np-lista-items" class="list-group"></ul>
                            <div style="text-align: right; margin-top: 1rem;">
                                <div style="display: inline-flex; align-items: center; gap: 1rem; margin-bottom: 0.5rem;">
                                    <label style="margin:0;">Descuento ($):</label>
                                    <input type="number" id="np-descuento" value="0" style="width: 100px; padding: 0.3rem;" onchange="app.calcTotalProject()">
                                </div>
                                <h3 id="np-total-display" style="color: var(--primary);">Total: $0.00</h3>
                            </div>
                        </div>

                        <div class="form-row">
                            <div class="form-group">
                                <label>Fecha de Inicio</label>
                                <input type="text" id="np-fecha">
                            </div>
                            <div class="form-group">
                                <label>Hora</label>
                                <input type="time" id="np-hora">
                            </div>
                        </div>

                        <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                            <button class="btn btn-secondary" style="flex: 1;" onclick="app.saveProject('Cotizacion')">Solo Generar Cotizaci√≥n PDF</button>
                            <button class="btn btn-primary" style="flex: 1;" onclick="app.saveProject('Agendado')">Guardar y Agendar</button>
                        </div>
                    </form>
                </div>
            </section>

            <section id="sec-flujo">
                <div class="card-header" style="background: var(--bg-card); border-radius: 12px; margin-bottom: 1rem; padding: 1rem;">
                    <h2>Flujo de Trabajo (Kanban)</h2>
                    <div style="display: flex; gap: 0.5rem;">
                        <button class="btn btn-secondary btn-icon" onclick="app.renderKanban()">üîÑ</button>
                    </div>
                </div>
                <div class="kanban-wrapper" id="kanban-board">
                    </div>
            </section>

            <section id="sec-cotizaciones">
                <div class="card">
                    <div class="card-header"><h2>Cotizaciones Pendientes</h2></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Cliente</th><th>Proyecto</th><th>Total</th><th>Fecha</th><th>Acciones</th></tr></thead>
                            <tbody id="table-cotizaciones"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-historial">
                <div class="card">
                    <div class="card-header"><h2>Historial de Proyectos Completados</h2></div>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Proyecto</th><th>Artista</th><th>Total</th><th>Pagado</th><th>Fecha</th><th>Acciones</th></tr></thead>
                            <tbody id="table-historial"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <section id="sec-pagos">
                <div class="card">
                    <div class="card-header">
                        <h2>Gesti√≥n de Pagos</h2>
                        <div>
                            <button class="btn btn-secondary active" onclick="document.getElementById('view-pagos-pend').style.display='block';document.getElementById('view-pagos-hist').style.display='none';this.classList.add('active');this.nextElementSibling.classList.remove('active')">Pendientes</button>
                            <button class="btn btn-secondary" onclick="document.getElementById('view-pagos-pend').style.display='none';document.getElementById('view-pagos-hist').style.display='block';this.classList.add('active');this.previousElementSibling.classList.remove('active')">Historial</button>
                        </div>
                    </div>
                    
                    <div id="view-pagos-pend">
                        <h3 style="color: var(--warning); margin-bottom: 1rem;">Saldos Pendientes por Cobrar</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Proyecto</th><th>Cliente</th><th>Total</th><th>Pagado</th><th>Restante</th><th>Acci√≥n</th></tr></thead>
                                <tbody id="table-pagos-pendientes"></tbody>
                            </table>
                        </div>
                    </div>

                    <div id="view-pagos-hist" style="display: none;">
                        <h3 style="margin-bottom: 1rem;">Historial de Transacciones</h3>
                        <div class="table-container">
                            <table>
                                <thead><tr><th>Fecha</th><th>Monto</th><th>Proyecto</th><th>Cliente</th><th>M√©todo</th><th>Acci√≥n</th></tr></thead>
                                <tbody id="table-pagos-historial"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-artistas">
                <div class="card">
                    <div class="card-header">
                        <h2>Directorio de Artistas</h2>
                        <button class="btn btn-primary" onclick="app.modalQuickArtist()">+ Nuevo Artista</button>
                    </div>
                    <div id="artistas-grid" class="kpi-grid"></div>
                </div>
            </section>

            <section id="sec-servicios">
                <div class="card">
                    <div class="card-header"><h2>Cat√°logo de Servicios</h2></div>
                    <form onsubmit="app.addService(event)" class="form-row" style="align-items: flex-end;">
                        <div class="form-group"><label>Nombre Servicio</label><input type="text" id="svc-nombre" required></div>
                        <div class="form-group"><label>Precio ($)</label><input type="number" id="svc-precio" required></div>
                        <button type="submit" class="btn btn-primary">Guardar</button>
                    </form>
                    <ul id="list-servicios" class="list-group" style="margin-top: 1rem;"></ul>
                </div>
            </section>

            <section id="sec-usuarios">
                <div class="card"><h2>Gesti√≥n de Usuarios</h2><p>Solo Admins</p><ul id="list-usuarios" class="list-group"></ul></div>
            </section>

            <section id="sec-papelera">
                <div class="card">
                    <div class="card-header">
                        <h2>Papelera de Reciclaje</h2>
                    </div>
                    
                    <div style="margin-bottom: 2rem;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                            <h3>Proyectos Eliminados</h3>
                            <button class="btn btn-danger" onclick="app.emptyTrash('proyectos')">Vaciar Proyectos</button>
                        </div>
                        <ul id="trash-proyectos" class="list-group" style="max-height: 250px; overflow-y: auto; background: var(--bg-input); padding: 1rem; border-radius: 8px;"></ul>
                    </div>

                    <div class="form-row">
                        <div class="form-group">
                            <h3>Artistas <button class="btn btn-danger btn-icon" style="float: right; width: auto; font-size: 0.7rem; height: 24px;" onclick="app.emptyTrash('artistas')">Vaciar</button></h3>
                            <ul id="trash-artistas" class="list-group"></ul>
                        </div>
                        <div class="form-group">
                            <h3>Servicios <button class="btn btn-danger btn-icon" style="float: right; width: auto; font-size: 0.7rem; height: 24px;" onclick="app.emptyTrash('servicios')">Vaciar</button></h3>
                            <ul id="trash-servicios" class="list-group"></ul>
                        </div>
                    </div>
                </div>
            </section>

            <section id="sec-config">
                <div class="card">
                    <h2>Configuraci√≥n General</h2>
                    
                    <div style="margin-top: 1.5rem;">
                        <h3>Identidad Visual</h3>
                        <div style="display: flex; gap: 2rem; align-items: center; margin-top: 1rem;">
                            <div style="text-align: center;">
                                <p style="font-size: 0.8rem;">Logo Actual</p>
                                <img src="" id="config-logo-preview" class="app-logo" style="background: #333; padding: 5px; border-radius: 4px;">
                                <input type="file" id="logo-upload" accept="image/*" style="display: none;" onchange="app.uploadLogo(this)">
                                <br>
                                <button class="btn btn-secondary" onclick="document.getElementById('logo-upload').click()" style="margin-top: 0.5rem;">Cambiar Logo</button>
                            </div>
                            
                            <div style="text-align: center;">
                                <p style="font-size: 0.8rem;">Firma PDF</p>
                                <img src="" id="config-firma-preview" class="app-logo" style="background: #fff; border: 1px dashed #ccc;">
                                <input type="file" id="firma-upload" accept="image/png" style="display: none;" onchange="app.uploadFirma(this)">
                                <br>
                                <button class="btn btn-secondary" onclick="document.getElementById('firma-upload').click()" style="margin-top: 0.5rem;">Subir Firma</button>
                            </div>
                        </div>
                    </div>

                    <hr style="margin: 2rem 0;">

                    <h3>Datos Bancarios (Para Recibos)</h3>
                    <div class="form-row">
                        <div class="form-group"><label>Banco</label><input type="text" id="cfg-banco"></div>
                        <div class="form-group"><label>Titular</label><input type="text" id="cfg-titular"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>CLABE / Cuenta</label><input type="text" id="cfg-clabe"></div>
                        <div class="form-group"><label>No. Tarjeta</label><input type="text" id="cfg-tarjeta"></div>
                    </div>
                    <button class="btn btn-primary" onclick="app.saveConfig()">Guardar Configuraci√≥n</button>
                </div>
            </section>

            <section id="sec-detalle-artista">
                <div class="card">
                    <div class="card-header">
                        <h2 id="det-art-nombre">Detalle Artista</h2>
                        <button class="btn btn-secondary" onclick="app.nav('artistas')">Volver</button>
                    </div>
                    
                    <div class="form-row">
                        <div class="kpi-box" style="flex:1; border-left: 5px solid var(--info);">
                            <div class="kpi-info"><h3>Proyectos</h3><p id="det-art-count">0</p></div>
                        </div>
                        <div class="kpi-box" style="flex:1; border-left: 5px solid var(--success);">
                            <div class="kpi-info"><h3>Gastado</h3><p id="det-art-spent">$0.00</p></div>
                        </div>
                    </div>

                    <h3 style="margin-top: 1.5rem; margin-bottom: 1rem;">Historial de Proyectos</h3>
                    <div class="table-container">
                        <table>
                            <thead><tr><th>Proyecto</th><th>Estado</th><th>Fecha</th><th>Total</th><th>Acciones</th></tr></thead>
                            <tbody id="det-art-projects"></tbody>
                        </table>
                    </div>
                </div>
            </section>

        </div>
    </div>

    <div class="modal-backdrop" id="modal-event">
        <div class="modal">
            <h3 id="evt-title" style="margin-bottom: 0.5rem;">Detalles del Proyecto</h3>
            <p id="evt-desc" style="color: var(--text-muted); margin-bottom: 1.5rem;"></p>
            
            <input type="hidden" id="evt-id">
            
            <div class="form-row">
                <div class="form-group"><label>Reprogramar Fecha</label><input type="text" id="evt-date"></div>
                <div class="form-group"><label>Hora</label><input type="time" id="evt-time"></div>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                <button class="btn btn-primary" style="flex: 1;" onclick="app.updateEventDate()">Guardar Cambio</button>
                <button class="btn btn-secondary" onclick="app.closeModals()">Cerrar</button>
            </div>
            <button class="btn btn-danger" style="width: 100%; margin-top: 1rem;" onclick="app.cancelEventFromModal()">Cancelar Cita (Liberar Fecha)</button>
        </div>
    </div>

    <script>
        // =========================================
        // LOGICA DE NEGOCIO "MASTER"
        // =========================================
        const app = {
            // "Base de Datos" Local
            db: {
                proyectos: [],
                artistas: [],
                servicios: [
                    { id: 1, nombre: 'Grabaci√≥n de Voz', precio: 500 },
                    { id: 2, nombre: 'Mezcla y Master', precio: 1200 },
                    { id: 3, nombre: 'Beat Personalizado', precio: 2000 }
                ],
                pagos: [],
                papelera: { proyectos: [], artistas: [], servicios: [] },
                config: {
                    logo: 'https://placehold.co/180x80?text=FiaRecords',
                    firma: null,
                    banco: '', titular: '', clabe: '', tarjeta: ''
                }
            },
            
            state: {
                currentUser: null,
                tempProjectItems: []
            },

            // --- INICIALIZACION ---
            init: () => {
                // Cargar datos persistentes
                app.loadDB();
                
                // Verificar Login
                const token = localStorage.getItem('fia_token');
                if (token) {
                    document.getElementById('login-overlay').style.display = 'none';
                    app.state.currentUser = 'Admin'; // Simulado
                    app.renderAll();
                }

                // Configurar Flatpickr
                flatpickr("#np-fecha", { locale: "es", minDate: "today" });
                flatpickr("#evt-date", { locale: "es" });

                // Listeners Globales
                document.getElementById('dark-mode-toggle').addEventListener('change', (e) => {
                    document.body.classList.toggle('dark-mode', e.target.checked);
                    localStorage.setItem('fia_theme', e.target.checked ? 'dark' : 'light');
                });
                
                // Restaurar Tema
                if(localStorage.getItem('fia_theme') === 'dark') {
                    document.body.classList.add('dark-mode');
                    document.getElementById('dark-mode-toggle').checked = true;
                }
            },

            // --- PERSISTENCIA ---
            loadDB: () => {
                const stored = localStorage.getItem('fia_db_v5');
                if (stored) {
                    const parsed = JSON.parse(stored);
                    app.db = { ...app.db, ...parsed };
                    // Asegurar estructura de papelera si venimos de version vieja
                    if(!app.db.papelera) app.db.papelera = { proyectos: [], artistas: [], servicios: [] };
                    if(!app.db.papelera.proyectos) app.db.papelera.proyectos = [];
                }
            },

            saveDB: () => {
                localStorage.setItem('fia_db_v5', JSON.stringify(app.db));
                app.updateUI();
            },

            // --- AUTENTICACION ---
            login: (e) => {
                e.preventDefault();
                // Login Simulado (acepta cualquier cosa por ahora para pruebas)
                localStorage.setItem('fia_token', 'logged_in');
                location.reload();
            },
            
            logout: () => {
                localStorage.removeItem('fia_token');
                location.reload();
            },

            // --- NAVEGACION ---
            nav: (screenId) => {
                document.querySelectorAll('section').forEach(s => s.classList.remove('active'));
                document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
                
                const section = document.getElementById('sec-' + screenId);
                if (section) section.classList.add('active');
                
                // Marcar Sidebar
                const links = document.querySelectorAll('.nav-link');
                links.forEach(l => {
                    if (l.innerText.toLowerCase().includes(screenId.replace('-',' '))) l.classList.add('active');
                });

                // T√≠tulo Pagina
                document.getElementById('page-title').innerText = screenId.charAt(0).toUpperCase() + screenId.slice(1).replace('-', ' ');

                app.renderAll(); // Refrescar datos al cambiar pantalla
                
                // Cerrar men√∫ m√≥vil si est√° abierto
                if(window.innerWidth < 768) document.getElementById('sidebar').classList.remove('active');
            },

            // --- RENDERIZADO GENERAL ---
            renderAll: () => {
                app.renderDashboard();
                app.renderCalendar();
                app.renderKanban();
                app.renderCotizaciones();
                app.renderHistorial();
                app.renderPagos();
                app.renderArtistas();
                app.renderServicios();
                app.renderPapelera();
                app.renderConfig();
                
                // Selects
                app.fillSelect('np-artista', app.db.artistas);
                app.fillSelectServices('np-servicio', app.db.servicios);
            },
            
            updateUI: () => {
                // Actualizaciones ligeras sin re-renderizar todo
                app.renderDashboard();
            },

            // --- DASHBOARD & KPIS ---
            renderDashboard: () => {
                const ingresos = app.db.pagos.reduce((acc, p) => acc + p.monto, 0);
                const activos = app.db.proyectos.filter(p => !p.deleted && p.estatus !== 'Completo' && p.estatus !== 'Cotizacion').length;
                let deuda = 0;
                app.db.proyectos.forEach(p => {
                   if (!p.deleted && p.estatus !== 'Cotizacion') {
                       deuda += (p.total - p.pagado);
                   } 
                });

                document.getElementById('kpi-income').innerText = `$${ingresos.toFixed(2)}`;
                document.getElementById('kpi-projects').innerText = activos;
                document.getElementById('kpi-debt').innerText = `$${deuda.toFixed(2)}`;

                // Grafica Dummy
                const ctx = document.getElementById('incomeChart');
                if(window.myChart) window.myChart.destroy();
                window.myChart = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun'],
                        datasets: [{
                            label: 'Ingresos',
                            data: [500, 1500, 1200, 2000, 3500, ingresos],
                            borderColor: '#6366f1',
                            tension: 0.4,
                            fill: true,
                            backgroundColor: 'rgba(99, 102, 241, 0.1)'
                        }]
                    },
                    options: { responsive: true, maintainAspectRatio: false }
                });
            },

            // --- PROYECTOS ---
            modalQuickArtist: () => {
                const name = prompt("Nombre del Nuevo Artista:");
                if (name) {
                    const newArtist = { id: Date.now(), nombre: name, telefono: '', email: '' };
                    app.db.artistas.push(newArtist);
                    app.saveDB();
                    app.fillSelect('np-artista', app.db.artistas);
                    // Seleccionarlo
                    document.getElementById('np-artista').value = newArtist.id;
                    Toastify({text: "Artista Creado", style: {background: "var(--success)"}}).showToast();
                }
            },

            addServiceToProject: () => {
                const select = document.getElementById('np-servicio');
                const qty = parseInt(document.getElementById('np-cantidad').value);
                const serviceId = select.value;
                const service = app.db.servicios.find(s => s.id == serviceId);
                
                if (service) {
                    app.state.tempProjectItems.push({
                        ...service,
                        qty: qty,
                        subtotal: service.precio * qty
                    });
                    app.renderTempItems();
                }
            },

            renderTempItems: () => {
                const list = document.getElementById('np-lista-items');
                list.innerHTML = app.state.tempProjectItems.map((item, index) => `
                    <li class="list-item" style="padding: 0.5rem;">
                        <span>${item.qty}x ${item.nombre}</span>
                        <span>$${item.subtotal.toFixed(2)} <button class="btn btn-danger btn-icon" style="width: 24px; height: 24px; font-size: 0.7rem;" onclick="app.removeTempItem(${index})">X</button></span>
                    </li>
                `).join('');
                app.calcTotalProject();
            },

            removeTempItem: (index) => {
                app.state.tempProjectItems.splice(index, 1);
                app.renderTempItems();
            },

            calcTotalProject: () => {
                const subtotal = app.state.tempProjectItems.reduce((sum, item) => sum + item.subtotal, 0);
                const discount = parseFloat(document.getElementById('np-descuento').value) || 0;
                const total = Math.max(0, subtotal - discount);
                document.getElementById('np-total-display').innerText = `Total: $${total.toFixed(2)}`;
                return total;
            },

            saveProject: (tipo) => {
                const artistId = document.getElementById('np-artista').value;
                if (!artistId || app.state.tempProjectItems.length === 0) {
                    return alert("Selecciona artista y agrega servicios");
                }
                
                const fecha = document.getElementById('np-fecha').value;
                const hora = document.getElementById('np-hora').value;
                const start = (fecha && hora) ? `${fecha}T${hora}` : new Date().toISOString();

                const total = app.calcTotalProject();
                const discount = parseFloat(document.getElementById('np-descuento').value) || 0;

                const newProj = {
                    id: Date.now().toString(),
                    nombre: document.getElementById('np-nombre').value || 'Proyecto Sin Nombre',
                    artistaId: artistId,
                    items: [...app.state.tempProjectItems],
                    descuento: discount,
                    total: total,
                    pagado: 0,
                    fecha: start,
                    estatus: tipo, // 'Cotizacion' o 'Agendado'
                    proceso: tipo === 'Cotizacion' ? '' : 'Agendado',
                    esAlbum: document.getElementById('np-album').checked,
                    deleted: false
                };

                app.db.proyectos.push(newProj);
                app.saveDB();

                // Limpiar form
                app.state.tempProjectItems = [];
                document.getElementById('form-nuevo-proyecto').reset();
                app.renderTempItems();

                if (tipo === 'Cotizacion') {
                    app.generatePDF(newProj.id, 'cotizacion');
                    app.nav('cotizaciones');
                    Toastify({text: "Cotizaci√≥n Creada", style: {background: "var(--info)"}}).showToast();
                } else {
                    app.nav('flujo');
                    Toastify({text: "Proyecto Agendado", style: {background: "var(--success)"}}).showToast();
                }
            },

            // --- KANBAN & FLUJO ---
            renderKanban: () => {
                const board = document.getElementById('kanban-board');
                const cols = ['Agendado', 'Grabacion', 'Edicion', 'Mezcla', 'Mastering'];
                
                board.innerHTML = cols.map(colName => `
                    <div class="kanban-col">
                        <div class="kanban-header">${colName}</div>
                        <div id="col-${colName}"></div>
                    </div>
                `).join('');

                const activeProjects = app.db.proyectos.filter(p => !p.deleted && p.estatus !== 'Cotizacion' && p.estatus !== 'Completo' && p.estatus !== 'Cancelado');

                activeProjects.forEach(p => {
                    const col = document.getElementById(`col-${p.proceso}`);
                    if (col) {
                        const artistName = app.getArtistName(p.artistaId);
                        const card = document.createElement('div');
                        card.className = 'kanban-card';
                        card.style.borderLeftColor = `var(--col-${p.proceso.toLowerCase()})`;
                        card.innerHTML = `
                            <div class="k-card-title">
                                <span onclick="app.editProjectName('${p.id}')">${p.nombre}</span>
                                <button class="btn btn-danger btn-icon" style="width:20px;height:20px;padding:0;" onclick="app.moveToTrash('${p.id}', 'proyectos')">üóëÔ∏è</button>
                            </div>
                            <div class="k-card-sub">üë§ ${artistName}</div>
                            <div class="k-card-sub">üìÖ ${new Date(p.fecha).toLocaleDateString()}</div>
                            <div class="k-card-footer">
                                <span style="font-weight:bold;">$${p.total}</span>
                                <select onchange="app.moveStage('${p.id}', this.value)" style="width:auto; padding:2px; font-size:0.8rem;">
                                    <option disabled selected>Mover ‚û°</option>
                                    ${cols.map(c => `<option value="${c}">${c}</option>`).join('')}
                                    <option value="Completo">‚úÖ Completar</option>
                                </select>
                            </div>
                            <div style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                                <button class="btn btn-success" style="padding:2px 8px; font-size:0.7rem; width:100%;" onclick="app.registerPayment('${p.id}')">Cobrar</button>
                            </div>
                        `;
                        col.appendChild(card);
                    }
                });
            },

            moveStage: (id, newStage) => {
                const p = app.db.proyectos.find(x => x.id == id);
                if (newStage === 'Completo') {
                    if (p.pagado < p.total && !confirm("El proyecto tiene saldo pendiente. ¬øMarcar como completado igual?")) return;
                    p.estatus = 'Completo';
                    p.proceso = 'Completo';
                    Toastify({text: "Proyecto Completado", style: {background: "var(--success)"}}).showToast();
                } else {
                    p.proceso = newStage;
                }
                app.saveDB();
                app.renderKanban();
            },
            
            editProjectName: (id) => {
                const p = app.db.proyectos.find(x => x.id == id);
                const newName = prompt("Editar nombre:", p.nombre);
                if(newName) { p.nombre = newName; app.saveDB(); app.renderKanban(); }
            },

            // --- PAPELERA Y BORRADO (HARDCORE LOGIC) ---
            moveToTrash: (id, type) => {
                if (!confirm("¬øMover a la papelera?")) return;
                
                if (type === 'proyectos') {
                    // Soft Delete
                    const p = app.db.proyectos.find(x => x.id == id);
                    if (p) {
                        p.deleted = true;
                        p.deletedAt = new Date();
                        // Agregar referencia a papelera para listado r√°pido (opcional, o filtrar por flag deleted)
                        app.db.papelera.proyectos.push({...p}); 
                    }
                } else {
                    // Mover entidad completa
                    const item = app.db[type].find(x => x.id == id);
                    if (item) {
                        app.db.papelera[type].push(item);
                        app.db[type] = app.db[type].filter(x => x.id != id);
                    }
                }
                app.saveDB();
                app.renderAll();
                Toastify({text: "Movido a Papelera", style: {background: "var(--warning)"}}).showToast();
            },

            restoreFromTrash: (id, type) => {
                if (type === 'proyectos') {
                    const p = app.db.proyectos.find(x => x.id == id); // Buscar en original
                    if(p) p.deleted = false;
                    
                    // Limpiar de array papelera
                    app.db.papelera.proyectos = app.db.papelera.proyectos.filter(x => x.id != id);
                } else {
                    const item = app.db.papelera[type].find(x => x.id == id);
                    if (item) {
                        app.db[type].push(item);
                        app.db.papelera[type] = app.db.papelera[type].filter(x => x.id != id);
                    }
                }
                app.saveDB();
                app.renderAll();
                Toastify({text: "Restaurado", style: {background: "var(--success)"}}).showToast();
            },

            emptyTrash: (type) => {
                if (!confirm(`¬øVaciar DEFINITIVAMENTE la papelera de ${type}?`)) return;
                
                if (type === 'proyectos') {
                    // Eliminar hard delete los marcados como deleted
                    const idsToDelete = app.db.papelera.proyectos.map(p => p.id);
                    app.db.proyectos = app.db.proyectos.filter(p => !idsToDelete.includes(p.id));
                    app.db.papelera.proyectos = [];
                } else {
                    app.db.papelera[type] = [];
                }
                app.saveDB();
                app.renderPapelera();
                Toastify({text: "Papelera Vaciada", style: {background: "var(--danger)"}}).showToast();
            },
            
            renderPapelera: () => {
                const listP = document.getElementById('trash-proyectos');
                // Sincronizar visualmente: usar app.db.papelera.proyectos
                listP.innerHTML = app.db.papelera.proyectos.map(p => `
                    <li class="list-item">
                        <span>${p.nombre} ($${p.total})</span>
                        <button class="btn btn-success btn-icon" style="width: auto; height: 28px; font-size:0.8rem; padding:0 8px;" onclick="app.restoreFromTrash('${p.id}', 'proyectos')">Restaurar</button>
                    </li>
                `).join('');
                
                ['artistas','servicios'].forEach(t => {
                    document.getElementById(`trash-${t}`).innerHTML = app.db.papelera[t].map(i => `
                         <li class="list-item">
                            <span>${i.nombre}</span>
                            <button class="btn btn-success btn-icon" style="width: auto; height: 28px; font-size:0.8rem; padding:0 8px;" onclick="app.restoreFromTrash('${i.id}', '${t}')">Restaurar</button>
                        </li>
                    `).join('');
                });
            },

            // --- PAGOS & PDF MATEM√ÅTICO ---
            registerPayment: (projId) => {
                const p = app.db.proyectos.find(x => x.id == projId);
                const restante = p.total - p.pagado;
                
                const monto = parseFloat(prompt(`Deuda: $${restante.toFixed(2)}. Ingrese Monto:`));
                if (!monto || isNaN(monto) || monto <= 0) return;

                p.pagado += monto;
                if (p.pagado >= p.total && p.estatus !== 'Cotizacion') {
                    // Opcional: autocompletar pago
                }

                // Registrar transacci√≥n
                app.db.pagos.push({
                    id: Date.now().toString(),
                    proyectoId: projId,
                    monto: monto,
                    fecha: new Date().toISOString(),
                    metodo: 'Efectivo'
                });

                app.saveDB();
                
                // Generar Recibo
                app.generatePDF(projId, 'recibo', monto);
                app.renderAll();
            },

            generatePDF: (id, tipo, montoAbono = 0) => {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                const p = app.db.proyectos.find(x => x.id == id);
                const artistName = app.getArtistName(p.artistaId);

                // --- HEADER ---
                // Rect√°ngulo negro para logo
                doc.setFillColor(0, 0, 0);
                doc.rect(14, 10, 50, 20, 'F');
                // Logo
                if (app.db.config.logo) {
                    try { doc.addImage(app.db.config.logo, 'PNG', 15, 12, 45, 15); } catch(e){}
                }

                doc.setFontSize(10);
                doc.text("Fia Records Estudio", 195, 20, {align: 'right'});
                doc.text("Ju√°rez, Nuevo Le√≥n", 195, 25, {align: 'right'});

                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.text(tipo === 'cotizacion' ? 'COTIZACI√ìN' : 'RECIBO DE PAGO', 105, 50, {align: 'center'});

                doc.setFontSize(11);
                doc.setFont(undefined, 'normal');
                doc.text(`Cliente: ${artistName}`, 14, 65);
                doc.text(`Fecha: ${new Date().toLocaleDateString()}`, 14, 71);
                doc.text(`Proyecto: ${p.nombre}`, 14, 77);

                // --- TABLA DETALLADA ---
                let body = [];
                const subtotalBase = p.items.reduce((sum, i) => sum + (i.precio * i.qty), 0);
                
                if (tipo === 'cotizacion') {
                    body = p.items.map(i => [`${i.qty}x ${i.nombre}`, `$${(i.precio * i.qty).toFixed(2)}`]);
                    body.push(['', '']);
                    body.push(['Subtotal', `$${subtotalBase.toFixed(2)}`]);
                    body.push(['Descuento', `-$${p.descuento.toFixed(2)}`]);
                    body.push(['TOTAL A PAGAR', `$${p.total.toFixed(2)}`]);
                } else {
                    // Recibo Matem√°tico
                    body.push(['Concepto', 'Monto']);
                    body.push(['Subtotal Servicios', `$${subtotalBase.toFixed(2)}`]);
                    body.push(['Descuento Aplicado', `-$${p.descuento.toFixed(2)}`]);
                    body.push(['VALOR TOTAL PROYECTO', `$${p.total.toFixed(2)}`]);
                    body.push(['------------------', '----------']);
                    body.push(['Total Pagado Anteriormente', `$${(p.pagado - montoAbono).toFixed(2)}`]);
                    body.push(['ABONO ACTUAL (HOY)', `$${montoAbono.toFixed(2)}`]);
                    body.push(['Saldo Restante', `$${(p.total - p.pagado).toFixed(2)}`]);
                }

                doc.autoTable({
                    startY: 85,
                    head: tipo === 'cotizacion' ? [['Descripci√≥n', 'Importe']] : [['Detalle', 'Valor']],
                    body: body,
                    theme: 'grid',
                    headStyles: { fillColor: [0, 0, 0] },
                    styles: { fontSize: 10 }
                });

                // --- FOOTER & FIRMA ---
                const finalY = doc.lastAutoTable.finalY + 20;

                if (tipo === 'cotizacion' && app.db.config.banco) {
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text("Datos para Anticipo:", 14, finalY);
                    doc.setFont(undefined, 'normal');
                    doc.text(`Banco: ${app.db.config.banco}`, 14, finalY + 6);
                    doc.text(`Titular: ${app.db.config.titular}`, 14, finalY + 12);
                    doc.text(`Cuenta: ${app.db.config.clabe || app.db.config.tarjeta}`, 14, finalY + 18);
                }

                if (tipo !== 'cotizacion' && app.db.config.firma) {
                    doc.text("Atentamente,", 150, finalY, {align:'center'});
                    try { doc.addImage(app.db.config.firma, 'PNG', 130, finalY + 5, 40, 20); } catch(e){}
                }

                doc.save(`${tipo}_${p.nombre}.pdf`);
            },

            // --- BUSCADOR GLOBAL (OMNIBOX) ---
            globalSearch: (query) => {
                const container = document.getElementById('search-results');
                if (query.length < 2) {
                    container.style.display = 'none';
                    return;
                }
                
                query = query.toLowerCase();
                let html = '';

                // Proyectos
                const pMatches = app.db.proyectos.filter(p => !p.deleted && (p.nombre.toLowerCase().includes(query) || app.getArtistName(p.artistaId).toLowerCase().includes(query)));
                if (pMatches.length) {
                    html += `<div class="search-section-title">Proyectos</div>`;
                    pMatches.forEach(p => {
                        html += `
                        <div class="search-item" onclick="app.goToSearch('${p.id}', 'project')">
                            <div><strong>${p.nombre}</strong><span>${p.estatus}</span></div>
                            <span style="font-weight:bold;">$${p.total}</span>
                        </div>`;
                    });
                }

                // Artistas
                const aMatches = app.db.artistas.filter(a => a.nombre.toLowerCase().includes(query));
                if (aMatches.length) {
                    html += `<div class="search-section-title">Artistas</div>`;
                    aMatches.forEach(a => {
                        html += `
                        <div class="search-item" onclick="app.goToSearch('${a.id}', 'artist')">
                            <strong>${a.nombre}</strong>
                        </div>`;
                    });
                }

                if (html) {
                    container.innerHTML = html;
                    container.style.display = 'block';
                } else {
                    container.style.display = 'none';
                }
            },

            goToSearch: (id, type) => {
                document.getElementById('search-results').style.display = 'none';
                document.getElementById('global-search').value = '';

                if (type === 'project') {
                    const p = app.db.proyectos.find(x => x.id == id);
                    if (p.estatus === 'Cotizacion') app.nav('cotizaciones');
                    else if (p.estatus === 'Completo') app.nav('historial');
                    else app.nav('flujo');
                    // Idealmente aqui haces scroll al elemento
                } else {
                    app.viewArtistDetail(id);
                }
            },

            // --- VISTA DETALLADA ARTISTA ---
            viewArtistDetail: (id) => {
                const a = app.db.artistas.find(x => x.id == id);
                document.getElementById('det-art-nombre').innerText = a.nombre;
                
                const projects = app.db.proyectos.filter(p => !p.deleted && p.artistaId == id);
                const spent = projects.reduce((sum, p) => sum + p.pagado, 0);
                
                document.getElementById('det-art-count').innerText = projects.length;
                document.getElementById('det-art-spent').innerText = `$${spent.toFixed(2)}`;
                
                const tbody = document.getElementById('det-art-projects');
                tbody.innerHTML = projects.map(p => `
                    <tr>
                        <td>${p.nombre}</td>
                        <td><span style="padding:2px 6px; border-radius:4px; font-size:0.8rem; background:var(--bg-input);">${p.estatus}</span></td>
                        <td>${new Date(p.fecha).toLocaleDateString()}</td>
                        <td>$${p.total}</td>
                        <td>
                            <button class="btn btn-secondary btn-icon" style="width:28px;height:28px;" onclick="app.editProjectName('${p.id}')">‚úèÔ∏è</button>
                            <button class="btn btn-danger btn-icon" style="width:28px;height:28px;" onclick="app.moveToTrash('${p.id}','proyectos'); app.viewArtistDetail('${id}')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
                
                app.nav('detalle-artista');
            },

            // --- HELPERS Y CONFIGURACION ---
            uploadLogo: (input) => {
                if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        app.db.config.logo = e.target.result;
                        app.saveDB();
                        // Refrescar imagenes
                        document.querySelectorAll('.app-logo').forEach(img => img.src = e.target.result);
                        document.getElementById('dynamic-favicon').href = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },
            
            uploadFirma: (input) => {
                 if (input.files && input.files[0]) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        app.db.config.firma = e.target.result;
                        app.saveDB();
                        document.getElementById('config-firma-preview').src = e.target.result;
                    };
                    reader.readAsDataURL(input.files[0]);
                }
            },

            saveConfig: () => {
                app.db.config.banco = document.getElementById('cfg-banco').value;
                app.db.config.titular = document.getElementById('cfg-titular').value;
                app.db.config.clabe = document.getElementById('cfg-clabe').value;
                app.db.config.tarjeta = document.getElementById('cfg-tarjeta').value;
                app.saveDB();
                Toastify({text: "Configuraci√≥n Guardada", style: {background: "var(--primary)"}}).showToast();
            },
            
            renderConfig: () => {
                if(app.db.config.logo) {
                    document.querySelectorAll('.app-logo').forEach(img => img.src = app.db.config.logo);
                    document.getElementById('config-logo-preview').src = app.db.config.logo;
                    document.getElementById('dynamic-favicon').href = app.db.config.logo;
                }
                if(app.db.config.firma) document.getElementById('config-firma-preview').src = app.db.config.firma;
                
                document.getElementById('cfg-banco').value = app.db.config.banco;
                document.getElementById('cfg-titular').value = app.db.config.titular;
                document.getElementById('cfg-clabe').value = app.db.config.clabe;
                document.getElementById('cfg-tarjeta').value = app.db.config.tarjeta;
            },

            // --- TABLAS COMUNES ---
            renderCotizaciones: () => {
                const list = app.db.proyectos.filter(p => !p.deleted && p.estatus === 'Cotizacion');
                document.getElementById('table-cotizaciones').innerHTML = list.map(p => `
                    <tr>
                        <td data-label="Cliente">${app.getArtistName(p.artistaId)}</td>
                        <td data-label="Proyecto">${p.nombre}</td>
                        <td data-label="Total">$${p.total}</td>
                        <td data-label="Fecha">${new Date(p.fecha).toLocaleDateString()}</td>
                        <td data-label="Acciones">
                            <button class="btn btn-success btn-icon" onclick="app.moveStage('${p.id}', 'Agendado'); app.nav('flujo')">‚úì</button>
                            <button class="btn btn-secondary btn-icon" onclick="app.generatePDF('${p.id}', 'cotizacion')">üìÑ</button>
                            <button class="btn btn-danger btn-icon" onclick="app.moveToTrash('${p.id}', 'proyectos')">üóëÔ∏è</button>
                        </td>
                    </tr>
                `).join('');
            },

            renderHistorial: () => {
                const list = app.db.proyectos.filter(p => !p.deleted && p.estatus === 'Completo');
                document.getElementById('table-historial').innerHTML = list.map(p => `
                    <tr>
                        <td data-label="Proyecto">${p.nombre}</td>
                        <td data-label="Artista">${app.getArtistName(p.artistaId)}</td>
                        <td data-label="Total">$${p.total}</td>
                        <td data-label="Pagado">$${p.pagado}</td>
                        <td data-label="Fecha">${new Date(p.fecha).toLocaleDateString()}</td>
                        <td data-label="Acciones">
                            <button class="btn btn-secondary btn-icon" onclick="app.generatePDF('${p.id}', 'recibo')">üìÑ</button>
                        </td>
                    </tr>
                `).join('');
            },
            
            renderPagos: () => {
                // Pendientes
                const pending = app.db.proyectos.filter(p => !p.deleted && p.estatus !== 'Cotizacion' && p.pagado < p.total);
                document.getElementById('table-pagos-pendientes').innerHTML = pending.map(p => `
                    <tr>
                        <td data-label="Proyecto">${p.nombre}</td>
                        <td data-label="Cliente">${app.getArtistName(p.artistaId)}</td>
                        <td data-label="Total">$${p.total}</td>
                        <td data-label="Pagado">$${p.pagado}</td>
                        <td data-label="Restante" style="color:var(--danger); font-weight:bold;">$${(p.total - p.pagado).toFixed(2)}</td>
                        <td data-label="Acci√≥n"><button class="btn btn-success" onclick="app.registerPayment('${p.id}')">Cobrar</button></td>
                    </tr>
                `).join('');
                
                // Historial
                document.getElementById('table-pagos-historial').innerHTML = app.db.pagos.map(pay => {
                    const p = app.db.proyectos.find(x => x.id == pay.proyectoId) || { nombre: 'Borrado', artistaId: null };
                    return `
                    <tr>
                        <td data-label="Fecha">${new Date(pay.fecha).toLocaleDateString()}</td>
                        <td data-label="Monto" style="font-weight:bold;">$${pay.monto.toFixed(2)}</td>
                        <td data-label="Proyecto">${p.nombre}</td>
                        <td data-label="Cliente">${app.getArtistName(p.artistaId)}</td>
                        <td data-label="M√©todo">${pay.metodo}</td>
                        <td data-label="Acci√≥n"><small>Ver Recibo</small></td>
                    </tr>`;
                }).join('');
            },

            renderCalendar: () => {
                const el = document.getElementById('calendar');
                if(!el) return;
                const events = app.db.proyectos.filter(p => !p.deleted && p.estatus !== 'Completo').map(p => ({
                   id: p.id,
                   title: p.nombre,
                   start: p.fecha,
                   backgroundColor: 'var(--primary)',
                   borderColor: 'var(--primary)'
                }));
                
                const calendar = new FullCalendar.Calendar(el, {
                    initialView: 'dayGridMonth',
                    locale: 'es',
                    height: 500,
                    headerToolbar: {
                        left: 'prev,next today',
                        center: 'title',
                        right: 'dayGridMonth,listWeek'
                    },
                    events: events,
                    eventClick: (info) => {
                        const p = app.db.proyectos.find(x => x.id == info.event.id);
                        document.getElementById('modal-event').style.display = 'flex';
                        document.getElementById('evt-title').innerText = p.nombre;
                        document.getElementById('evt-desc').innerText = `Cliente: ${app.getArtistName(p.artistaId)} - $${p.total}`;
                        document.getElementById('evt-id').value = p.id;
                        document.getElementById('evt-date').value = info.event.start.toISOString().split('T')[0];
                    }
                });
                calendar.render();
            },
            
            updateEventDate: () => {
                const id = document.getElementById('evt-id').value;
                const date = document.getElementById('evt-date').value;
                const time = document.getElementById('evt-time').value;
                if(date && id) {
                    const p = app.db.proyectos.find(x => x.id == id);
                    p.fecha = `${date}T${time || '10:00'}`;
                    app.saveDB();
                    app.closeModals();
                    app.renderCalendar();
                }
            },
            
            cancelEventFromModal: () => {
                const id = document.getElementById('evt-id').value;
                if(!confirm("¬øCancelar cita?")) return;
                const p = app.db.proyectos.find(x => x.id == id);
                p.estatus = "Cancelado";
                app.saveDB();
                app.closeModals();
                app.renderCalendar();
            },
            
            closeModals: () => {
                document.querySelectorAll('.modal-backdrop').forEach(m => m.style.display = 'none');
            },

            // --- GESTION CRUD (ARTISTAS, SERVICIOS) ---
            renderArtistas: () => {
                const grid = document.getElementById('artistas-grid');
                grid.innerHTML = app.db.artistas.map(a => `
                    <div class="kpi-box" style="flex-direction:column; align-items:flex-start; gap:0.5rem;">
                        <div style="width:100%; display:flex; justify-content:space-between;">
                            <h3>${a.nombre}</h3>
                            <button class="btn btn-secondary btn-icon" style="width:24px;height:24px;" onclick="app.moveToTrash('${a.id}','artistas')">X</button>
                        </div>
                        <button class="btn btn-secondary" style="width:100%;" onclick="app.viewArtistDetail('${a.id}')">Ver Perfil</button>
                    </div>
                `).join('');
            },

            renderServicios: () => {
                document.getElementById('list-servicios').innerHTML = app.db.servicios.map(s => `
                    <li class="list-item">
                        <span>${s.nombre} - $${s.precio}</span>
                        <button class="btn btn-danger btn-icon" onclick="app.moveToTrash('${s.id}', 'servicios')">üóëÔ∏è</button>
                    </li>
                `).join('');
            },
            
            addService: (e) => {
                e.preventDefault();
                const name = document.getElementById('svc-nombre').value;
                const price = document.getElementById('svc-precio').value;
                app.db.servicios.push({ id: Date.now(), nombre: name, precio: parseFloat(price) });
                app.saveDB();
                app.renderServicios();
                e.target.reset();
            },

            // --- UTILS ---
            getArtistName: (id) => {
                const a = app.db.artistas.find(x => x.id == id);
                return a ? a.nombre : 'General';
            },
            
            fillSelect: (id, data) => {
                const sel = document.getElementById(id);
                if(sel) sel.innerHTML = data.map(x => `<option value="${x.id}">${x.nombre}</option>`).join('');
            },
            
            fillSelectServices: (id, data) => {
                const sel = document.getElementById(id);
                if(sel) sel.innerHTML = data.map(x => `<option value="${x.id}">${x.nombre} ($${x.precio})</option>`).join('');
            }
        };

        // INICIAR
        window.onload = app.init;
    </script>
</body>
</html>