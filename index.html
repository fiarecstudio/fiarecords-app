<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
  <title>FiaRecords Studio - Gesti√≥n Pro</title>
  
  <!-- PWA -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#6366f1">
  <link rel="apple-touch-icon" href="icon-192.png">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>
    /* CORRECCI√ìN: Eliminado visibility hidden para evitar pantalla negra */
    
    :root {
      --primary-color: #6366f1; 
      --primary-hover: #4f46e5;
      --primary-gradient: linear-gradient(135deg, #6366f1 0%, #4f46e5 100%);
      --danger-color: #ef4444; 
      --danger-gradient: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
      --success-color: #10b981;
      --success-gradient: linear-gradient(135deg, #10b981 0%, #059669 100%);
      --warning-color: #f59e0b;
      --background-color: #f3f4f6;
      --card-background: #ffffff;
      --sidebar-background: #ffffff;
      --text-color-dark: #111827;
      --text-color-light: #6b7280;
      --border-color: #e5e7eb;
      --shadow-sm: 0 1px 3px rgba(0,0,0,0.1);
      --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --form-control-bg: #f9fafb;
      --secondary-button-bg: #f3f4f6; 
      --secondary-button-text: #374151; 
      --secondary-button-hover-bg: #e5e7eb;
      --proceso-Agendado: #3b82f6; 
      --proceso-Grabacion: #8b5cf6; 
      --proceso-Edicion: #ec4899; 
      --proceso-Mezcla: #f59e0b; 
      --proceso-Mastering: #10b981; 
      --proceso-Completo: #64748b;
    }

    body.dark-mode {
      --background-color: #000000; 
      --card-background: #121212; 
      --sidebar-background: #121212;
      --text-color-dark: #f3f4f6; 
      --text-color-light: #9ca3af;
      --border-color: #374151; 
      --form-control-bg: #1c1c1c;
      --secondary-button-bg: #2a2a2a; 
      --secondary-button-text: #ffffff; 
      --secondary-button-hover-bg: #3a3a3a;
      --shadow: 0 4px 6px -1px rgba(255, 255, 255, 0.05);
      --fc-button-bg-color: var(--secondary-button-bg); 
      --fc-button-text-color: var(--secondary-button-text);
      --fc-button-border-color: var(--border-color);
      --fc-today-bg-color: rgba(255, 255, 255, 0.1);
    }

    * { box-sizing: border-box; margin: 0; padding: 0; outline: none; -webkit-tap-highlight-color: transparent; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color-dark); line-height: 1.6; overflow-x: hidden; }

    #app-logo, #login-logo { max-width: 160px; max-height: 70px; object-fit: contain; }
    /* Invertir logo solo en modo claro para que se vea negro */
    body:not(.dark-mode) #app-logo, body:not(.dark-mode) #login-logo { filter: invert(1); }
    
    #loader-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 2000; display: none; justify-content: center; align-items: center; backdrop-filter: blur(5px); }
    .spinner { width: 45px; height: 45px; border: 4px solid rgba(255,255,255,0.3); border-top-color: var(--primary-color); border-radius: 50%; animation: spin 0.8s ease infinite; }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* Estado inicial */
    #app-wrapper { display: none; } 
    #login-container { display: none; }

    .connection-status { padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85em; font-weight: 600; display: flex; align-items: center; gap: 0.5rem; cursor: pointer; box-shadow: var(--shadow-sm); transition: all 0.3s; border: 1px solid transparent; }
    .status-online { background-color: rgba(34, 197, 94, 0.15); color: var(--success-color); border-color: var(--success-color); }
    .status-offline { background-color: rgba(239, 68, 68, 0.2) !important; color: var(--danger-color) !important; border-color: var(--danger-color) !important; }
    .status-syncing { background-color: rgba(245, 158, 11, 0.15); color: var(--warning-color); border-color: var(--warning-color); }
    .status-indicator-dot { width: 10px; height: 10px; border-radius: 50%; background-color: currentColor; }

    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; overflow-x: hidden; }
    .main-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 1.5rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); position: sticky; top: 0; z-index: 100; box-shadow: var(--shadow-sm); }
    .search-box { position: relative; margin: 0 1rem; flex: 1; max-width: 450px; }
    .search-box input { width: 100%; padding: 0.6rem 1.2rem; border-radius: 50px; border: 1px solid var(--border-color); background: var(--form-control-bg); color: var(--text-color-dark); margin-bottom: 0; transition: all 0.3s ease; }
    .search-box input:focus { border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.15); }

    main { padding: 1.5rem; flex: 1; width: 100%; max-width: 100%; box-sizing: border-box; }
    @media (min-width: 768px) { main { padding: 2rem; } }
    section { display: none; animation: fadeIn 0.3s ease; }
    section.active { display: block; }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .sidebar { width: 260px; background-color: var(--sidebar-background); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; height: 100vh; height: 100dvh; z-index: 1000; transition: transform 0.3s ease; }
    .sidebar-header { text-align: center; margin-bottom: 1.5rem; flex-shrink: 0; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; overflow-y: auto; padding-right: 5px; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; gap: 0.8rem; }
    #btn-nuevo-proyecto-sidebar { background: var(--primary-gradient); color: white; text-align: center; padding: 0.8rem; border-radius: 10px; margin-bottom: 1.5rem; font-weight: 600; cursor: pointer; box-shadow: 0 4px 10px rgba(99, 102, 241, 0.3); border: none; transition: transform 0.2s; }
    #btn-nuevo-proyecto-sidebar:hover { transform: scale(1.02); }
    .nav-group summary { list-style: none; padding: 0.75rem 0.5rem; font-weight: 700; color: var(--text-color-light); cursor: pointer; position: relative; font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1px; }
    .nav-group summary::before { content: '‚ñ∏'; display: inline-block; width: 15px; transition: transform 0.2s; color: var(--primary-color); }
    .nav-group[open] > summary::before { transform: rotate(90deg); }
    .nav-group ul { list-style: none; padding-left: 0.5rem; margin-top: 0.2rem; }
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem; border-radius: 8px; text-decoration: none; color: var(--text-color-light); font-weight: 500; cursor: pointer; transition: all 0.2s; font-size: 0.95rem; }
    .nav-link:hover { background-color: var(--secondary-button-bg); color: var(--primary-color); }
    .nav-link.active-link { background: rgba(99, 102, 241, 0.1); color: var(--primary-color); font-weight: 600; }

    #hamburger-menu, #btn-enviar-datos-bancarios { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; }
    #hamburger-menu svg, #btn-enviar-datos-bancarios svg { width: 26px; height: 26px; stroke: var(--text-color-dark); }
    .header-actions { display: flex; align-items: center; gap: 1rem; }
    #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 998; backdrop-filter: blur(2px); }

    @media (max-width: 768px) {
      #app-wrapper { display: block; }
      #hamburger-menu, #btn-enviar-datos-bancarios { display: block; }
      .main-header { padding: 0.75rem 1rem; flex-wrap: wrap; gap: 0.5rem; }
      .search-box { display: block; width: 100%; max-width: none; margin: 0.5rem 0 0 0; order: 99; }
      .sidebar { position: fixed; left: 0; top: 0; transform: translateX(-100%); width: 85%; max-width: 280px; box-shadow: 2px 0 15px rgba(0,0,0,0.5); }
      .sidebar.sidebar-visible { transform: translateX(0); }
      #sidebar-overlay.overlay-visible { display: block; }
      .connection-status span { display: none; } 
    }
    @media (min-width: 769px) {
      #app-wrapper { display: flex; height: 100vh; overflow: hidden; }
      #hamburger-menu { display: none; }
      #btn-enviar-datos-bancarios { display: block; }
    }
    
    .card { background-color: var(--card-background); border-radius: 16px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow-sm); border: 1px solid var(--border-color); }
    .card-header h2 { font-size: 1.25rem; font-weight: 700; color: var(--text-color-dark); margin-bottom: 0.5rem; }
    form label { display: block; margin-bottom: 0.4rem; font-weight: 500; font-size: 0.9rem; color: var(--text-color-light); }
    form input, form select, form textarea { width: 100%; padding: 0.75rem 1rem; border: 1px solid var(--border-color); border-radius: 10px; margin-bottom: 1rem; background-color: var(--form-control-bg); color: var(--text-color-dark); transition: border 0.3s; }
    form input:focus, form select:focus, form textarea:focus { outline: none; border-color: var(--primary-color); }
    .password-wrapper { position: relative; }
    #toggle-password { position: absolute; right: 1rem; top: 35%; cursor: pointer; opacity: 0.6; }
    
    button { cursor: pointer; border-radius: 10px; border: none; padding: 0.75rem 1.25rem; font-weight: 600; font-size: 0.9rem; transition: all 0.2s; display: inline-flex; align-items: center; justify-content: center; gap: 0.5rem; }
    button:active { transform: scale(0.98); }
    button[type="submit"], .btn-primary { background: var(--primary-gradient); color: white; box-shadow: 0 4px 6px -1px rgba(99, 102, 241, 0.4); }
    .btn-eliminar, .btn-vaciar { background: var(--danger-gradient); color: white !important; }
    .btn-secondary { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); border: 1px solid var(--border-color); }
    .btn-secondary:hover { background-color: var(--secondary-button-hover-bg); border-color: var(--text-color-light); }
    .btn-restaurar, .btn-aprobar { background: var(--success-gradient); color: white; }
    .table-actions { display: flex; align-items: center; gap: 0.5rem; justify-content: flex-start; flex-wrap: nowrap; }
    .table-actions button, .list-item-actions button { padding: 0.5rem 0.8rem; width: auto; min-width: 36px; height: 36px; font-size: 0.85rem; margin: 0; white-space: nowrap; }

    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
    .table-responsive { width: 100%; overflow-x: auto; }
    table { width: 100%; border-collapse: collapse; border-spacing: 0; margin-top: 1rem; }
    th { padding: 1rem; text-align: left; color: var(--text-color-light); font-weight: 600; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px; border-bottom: 2px solid var(--border-color); white-space: nowrap; }
    td { padding: 1rem; vertical-align: middle; border-bottom: 1px solid var(--border-color); color: var(--text-color-dark); background-color: transparent; }
    tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }
    body.dark-mode tbody tr:nth-child(even) { background-color: rgba(255,255,255,0.02); }
    tbody tr:hover { background-color: var(--secondary-button-bg); }

    @media (max-width: 768px) {
        .table-responsive table, .table-responsive thead, .table-responsive tbody, .table-responsive th, .table-responsive td, .table-responsive tr { display: block; width: 100%; }
        .table-responsive thead tr { position: absolute; top: -9999px; left: -9999px; }
        .table-responsive tr { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; background-color: var(--card-background); box-shadow: var(--shadow-sm); }
        .table-responsive td { border: none; border-bottom: 1px solid var(--border-color); position: relative; padding-left: 40% !important; padding-right: 0; padding-top: 0.75rem; padding-bottom: 0.75rem; text-align: right; white-space: normal; }
        .table-responsive td:last-child { border-bottom: none; padding-top: 1rem; display: flex; justify-content: flex-end; padding-left: 0 !important; flex-wrap: wrap; gap: 0.5rem; }
        .table-responsive td:before { position: absolute; top: 0.75rem; left: 0; width: 35%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: 700; color: var(--text-color-light); font-size: 0.85em; text-transform: uppercase; }
        #tablaCotizacionesBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaCotizacionesBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaCotizacionesBody td:nth-of-type(3):before { content: "Fecha:"; }
        #tablaPagosBody td:nth-of-type(1):before { content: "Fecha:"; }
        #tablaPagosBody td:nth-of-type(2):before { content: "Proyecto:"; }
        #tablaPagosBody td:nth-of-type(3):before { content: "Monto:"; }
        #tablaPagosBody td:nth-of-type(4):before { content: "M√©todo:"; }
        #tablaHistorialBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaHistorialBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaHistorialBody td:nth-of-type(3):before { content: "Pagado:"; }
        #tablaHistorialBody td:nth-of-type(4):before { content: "Fecha:"; }
        #tablaDeudasBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaDeudasBody td:nth-of-type(2):before { content: "Proyecto:"; }
        #tablaDeudasBody td:nth-of-type(3):before { content: "Deuda:"; }
        
        #vista-artista-contenido .table-responsive tr { display: flex; flex-direction: column; }
        #vista-artista-contenido .table-responsive td { padding-left: 0 !important; text-align: left; }
        #vista-artista-contenido .table-responsive td:before { display: none; } 
        #vista-artista-contenido .table-responsive td:nth-child(1) { font-weight: 800; color: var(--primary-color); border-bottom: 2px solid var(--border-color); margin-bottom: 0.5rem; }
    }

    .clickable-artist { cursor: pointer; font-weight: 600; color: var(--primary-color); }
    .clickable-artist:hover { text-decoration: underline; }
    #login-container { max-width: 400px; margin: 10vh auto; padding: 2.5rem; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 1rem; border-radius: 10px; margin-bottom: 0.8rem; background-color: var(--card-background); border: 1px solid var(--border-color); }
    .theme-toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; font-size: 0.9rem; }
    .theme-switch { position: relative; display: inline-block; width: 46px; height: 24px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #cbd5e1; border-radius: 34px; transition: .4s; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(22px); }
    .form-row { display: flex; gap: 1rem; flex-wrap: wrap; }
    .form-group { flex: 1; min-width: 200px; }
    .info-row { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; background: var(--secondary-button-bg); padding: 1rem; border-radius: 10px; margin-bottom: 1rem; }
    #totalAPagar { font-size: 1.4rem; font-weight: 700; color: var(--primary-color); }
    .kpi-card { text-align: center; border-bottom: 4px solid var(--primary-color); }
    .kpi-value { font-size: 2.2rem; font-weight: 700; color: var(--text-color-dark); }
    .kpi-label { font-size: 0.9rem; color: var(--text-color-light); text-transform: uppercase; letter-spacing: 0.5px; }
    .kanban-board { display: grid; grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); gap: 1.5rem; align-items: start; }
    .kanban-column { background-color: var(--secondary-button-bg); border-radius: 12px; padding: 1rem; display: none; animation: fadeIn 0.5s; border: 1px solid var(--border-color); }
    .kanban-column h3 { text-align: center; margin: 0; padding: 0.5rem; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; font-size: 1em; text-transform: uppercase; letter-spacing: 1px; color: var(--text-color-light); }
    .project-card { background: var(--card-background); padding: 1.25rem; border-radius: 12px; margin-bottom: 1rem; box-shadow: var(--shadow-sm); border-left: 5px solid; transition: transform 0.2s, box-shadow 0.2s; }
    .project-card:hover { box-shadow: var(--shadow); transform: translateY(-3px); }
    .project-card-header { font-weight: 600; font-size: 1.05em; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .project-card-header-main { display: flex; align-items: center; gap: 0.5rem; }
    .project-card-body ul { list-style: none; padding-left: 0; margin: 0.5rem 0; font-size: 0.9em; color: var(--text-color-light); }
    .project-card-footer { border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
    .status-badge { padding: 4px 10px; border-radius: 20px; font-size: 0.75em; color: white; font-weight: 600; }
    .filter-buttons { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .filter-buttons button { padding: 0.5rem 1rem; font-size: 0.9em; border-radius: 20px; background: var(--card-background); color: var(--text-color-light); border: 1px solid var(--border-color); box-shadow: none; }
    .filter-buttons button.active { background-color: var(--primary-color); color: white; border-color: var(--primary-color); }
    .proceso-tag { padding: 3px 10px; border-radius: 16px; color: white; font-size: 0.75em; display: inline-block; margin-top: 8px; }
    #artista-selector-container, #manual-artista-selector-container { display: flex; gap: 0.5rem; align-items: flex-start; }
    
    /* CALENDARIO */
    #calendario { --fc-border-color: transparent; --fc-event-border-color: transparent; padding: 0.5rem; }
    .fc-event { cursor: pointer; padding: 3px; font-size: 0.85em; border-radius: 6px; border: none !important; margin-bottom: 2px; }
    .fc .fc-toolbar-title { font-size: 1.25em; color: var(--primary-color); font-weight: 700; text-transform: capitalize; }
    .fc .fc-button { background-color: var(--card-background); color: var(--text-color-dark); border-color: var(--border-color); padding: 0.4em 0.8em; font-size: 0.9em; text-transform: capitalize; border-radius: 20px; box-shadow: none; }
    .fc .fc-button:hover { background-color: var(--secondary-button-hover-bg); color: var(--text-color-dark); }
    body.dark-mode .fc .fc-button:hover { background-color: var(--secondary-button-hover-bg); color: var(--text-color-dark); }
    .fc .fc-button-primary:not(:disabled).fc-button-active { background-color: var(--primary-color) !important; color: white !important; border-color: var(--primary-color) !important; }
    .fc-theme-standard .fc-list-day-cushion { background-color: var(--secondary-button-bg); }
    .fc-list-event:hover td { background-color: var(--secondary-button-bg) !important; }
    body.dark-mode .fc-list-event:hover td { background-color: rgba(255,255,255,0.05) !important; }
    .fc-daygrid-day-number { color: var(--text-color-dark); font-weight: 500; text-decoration: none; margin: 4px; }
    .fc-col-header-cell-cushion { color: var(--text-color-light); font-weight: 600; text-transform: uppercase; font-size: 0.8em; }
    .fc-view-harness { width: 100%; }
    
    @media (max-width: 768px) {
        .fc .fc-toolbar { display: flex; flex-wrap: wrap; justify-content: space-between; align-items: center; margin-bottom: 1rem !important; gap: 0; }
        .fc .fc-toolbar-title { font-size: 1.1em; order: 0; }
        .fc .fc-toolbar-chunk { display: flex; gap: 0.5rem; }
        .fc .fc-button { padding: 0.3rem 0.8rem; font-size: 0.8em; }
        .fc-view-harness { min-height: 400px; width: 100%; overflow: hidden; }
        .fc-scroller { overflow: hidden !important; }
        .fc-daygrid-event { display: block !important; width: 6px !important; height: 6px !important; border-radius: 50% !important; padding: 0 !important; margin: 0 !important; background-color: var(--primary-color); font-size: 0 !important; border: none !important; position: relative; }
        .fc-daygrid-event .fc-event-title, .fc-daygrid-event .fc-event-time { display: none !important; }
        .fc-list-event-title, .fc-list-event-time { display: block !important; font-size: 0.9em; }
        .fc-daygrid-day-frame { min-height: 60px !important; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; }
        .fc-daygrid-day-events { display: flex; justify-content: center; flex-wrap: wrap; gap: 3px; margin-top: 2px; min-height: 10px; }
        .fc-col-header-cell-cushion { font-size: 0.7rem; padding: 5px 0 !important; opacity: 0.7; }
        .fc-theme-standard td, .fc-theme-standard th { border: none; border-bottom: 1px solid rgba(128,128,128,0.1); }
        .fc-scrollgrid { border: none !important; }
    }

    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; backdrop-filter: blur(3px); }
    .modal-content { background: var(--card-background); padding: 2rem; border-radius: 16px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1); }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; border-bottom: 1px solid var(--border-color); padding-bottom: 1rem; }
    .modal-close { font-size: 1.8rem; cursor: pointer; background: none; border: none; color: var(--text-color-light); line-height: 1; padding: 0; }
    .form-actions { display: flex; gap: 1rem; margin-top: 1.5rem; }
    .form-actions button { flex: 1; }
    .alignment-group { margin-bottom: 1rem; padding: 1rem; border: 1px solid var(--border-color); border-radius: 12px; background: var(--secondary-button-bg); }
    .alignment-group legend { font-weight: 600; padding: 0 0.5rem; color: var(--primary-color); }
    .alignment-group div { display: flex; justify-content: space-around; flex-wrap: wrap; gap: 0.5rem; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 6px; background: var(--border-color); border-radius: 5px; outline: none; margin-top: 0.5rem; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 18px; height: 18px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
    #firma-preview-container { border: 2px dashed var(--border-color); background-color: #fff; transition: border-color 0.2s; }
    #firma-preview-container:hover { border-color: var(--primary-color); }
    .doc-template { color: #000; font-family: 'Times New Roman', serif; }
    .toastify { border-radius: 8px; font-family: 'Poppins', sans-serif; box-shadow: 0 4px 12px rgba(0,0,0,0.15); }
  </style>
</head>
<body>
  <div id="loader-overlay"><div class="spinner"></div></div>

  <div id="login-container" class="card"><div style="text-align: center; margin-bottom: 1.5rem;"><img id="login-logo" src="https://placehold.co/180x80?text=FiaRecords" alt="Logotipo"></div><form id="login-form"><div><label for="username">Usuario</label><input type="text" id="username" required></div><div><label for="password">Contrase√±a</label><div class="password-wrapper"><input type="password" id="password" required><span id="toggle-password">üëÅÔ∏è</span></div></div><button type="submit" style="width:100%;">Entrar</button><p id="login-error" style="color: var(--danger-color); text-align: center; margin-top: 1rem;"></p></form></div>
  
  <div id="app-wrapper">
    <div id="sidebar-overlay"></div>
    <nav class="sidebar">
      <div class="sidebar-header"><img id="app-logo" src="https://placehold.co/180x80?text=FiaRecords" alt="Logotipo"></div>
      
      <a id="btn-nuevo-proyecto-sidebar" class="nav-link" data-seccion="registrar-proyecto"><span>+ Nuevo Proyecto</span></a>
      
      <div class="sidebar-nav">
        <details class="nav-group" open>
          <summary>PROYECTOS</summary>
          <ul>
            <li><a class="nav-link" data-seccion="dashboard"><span>Dashboard</span></a></li>
            <li><a class="nav-link" data-seccion="agenda"><span>Agenda</span></a></li>
            <li><a class="nav-link" data-seccion="flujo-trabajo"><span>Flujo de Trabajo</span></a></li>
            <li><a class="nav-link" data-seccion="cotizaciones"><span>Cotizaciones</span></a></li>
            <li><a class="nav-link" data-seccion="historial-proyectos"><span>Historial</span></a></li>
            <li><a class="nav-link" data-seccion="pagos"><span>Pagos</span></a></li>
            <li><a class="nav-link" data-seccion="registro-manual"><span>Registro Manual</span></a></li>
          </ul>
        </details>
        
        <details class="nav-group">
          <summary>GESTI√ìN</summary>
          <ul>
            <li><a class="nav-link" data-seccion="gestion-artistas"><span>Artistas</span></a></li>
            <li><a class="nav-link" data-seccion="gestion-servicios"><span>Servicios</span></a></li>
            <li><a class="nav-link" data-seccion="gestion-usuarios"><span>Usuarios</span></a></li>
          </ul>
        </details>
        
        <details class="nav-group">
          <summary>SISTEMA</summary>
          <ul>
            <li><a class="nav-link" data-seccion="configuracion"><span>Configuraci√≥n</span></a></li>
            <li><a class="nav-link" data-seccion="papelera-reciclaje"><span>Papelera</span></a></li>
          </ul>
        </details>
      </div>
      
      <div class="sidebar-footer">
        <div id="customization-container" style="display: none;">
          <p style="font-size: 0.8em; text-align: center; margin-bottom: 1rem;">Haz clic en el logo para cambiarlo.</p>
          <input type="file" id="logo-input" accept="image/*" style="display: none;">
        </div>
        <div class="theme-toggle-container">
          <span>Modo Oscuro</span>
          <label class="theme-switch">
            <input type="checkbox" id="theme-switch" />
            <span class="slider"></span>
          </label>
        </div>
        <button id="logout-button" class="btn-eliminar">Cerrar Sesi√≥n</button>
      </div>
    </nav>

    <div class="main-content">
        <header class="main-header">
            <button id="hamburger-menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div id="welcome-user"></div>
            
            <div id="connection-status" class="connection-status status-online" onclick="app.syncNow()">
                <div class="status-indicator-dot"></div>
                <span id="connection-text">En L√≠nea</span>
            </div>

            <div class="search-box">
                <input type="text" id="globalSearch" placeholder="üîç Buscar en esta secci√≥n..." onkeyup="app.filtrarTablas(this.value)">
            </div>
            <div class="header-actions">
              <button id="btn-enviar-datos-bancarios" title="Enviar Datos Bancarios" class="btn-secondary" style="padding: 0.5rem; border-radius: 50%;">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                </svg>
              </button>
            </div>
        </header>
        <main>
            <section id="dashboard">
                <div class="grid-container">
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-ingresos-mes">$0.00</div><div class="kpi-label">Ingresos del Mes</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-proyectos-activos">0</div><div class="kpi-label">Proyectos Activos</div></div>
                    <div class="card kpi-card"><div class="kpi-value" id="kpi-proyectos-por-cobrar">0</div><div class="kpi-label">Proyectos por Cobrar</div></div>
                </div>
                <div class="card" style="margin-top: 1rem;">
                    <h3>Resumen de Ingresos</h3>
                    <div style="height: 300px; position: relative;">
                        <canvas id="incomeChart"></canvas>
                    </div>
                </div>
            </section>
            <section id="agenda"><div class="card"><div id="calendario"></div></div></section>
            <section id="cotizaciones"><div class="card"><div class="card-header"><h2>Cotizaciones Pendientes</h2></div><div class="table-responsive"><table><thead><tr><th>Artista</th><th>Total</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tablaCotizacionesBody"></tbody></table></div></div></section>
            <section id="flujo-trabajo"><div class="card" style="background: transparent; border: none; box-shadow: none; padding: 0;"><div class="card-header" style="background: var(--card-background); padding: 1.5rem; border-radius: 12px; margin-bottom: 1.5rem; box-shadow: var(--shadow);"><h2>Flujo de Trabajo</h2><div class="filter-buttons" id="filtrosFlujo" style="margin-top: 1rem; margin-bottom: 0;"></div></div><div class="kanban-board" id="kanbanBoard"></div></div></section>
            
            <section id="pagos">
              <!-- NUEVA TABLA: CUENTAS POR COBRAR -->
              <div class="card" style="border-left: 5px solid var(--warning-color);">
                <div class="card-header"><h2>Cuentas por Cobrar (Deudas)</h2></div>
                <div class="table-responsive">
                  <table>
                    <thead><tr><th>Artista / Cliente</th><th>Proyecto</th><th>Monto Pendiente</th><th>Acciones</th></tr></thead>
                    <tbody id="tablaDeudasBody"></tbody>
                  </table>
                </div>
              </div>
              
              <div class="card">
                <div class="card-header"><h2>Historial de Pagos</h2></div>
                <div class="table-responsive">
                  <table>
                    <thead><tr><th>Fecha</th><th>Artista / Proyecto</th><th>Monto</th><th>M√©todo</th><th>Acciones</th></tr></thead>
                    <tbody id="tablaPagosBody"></tbody>
                  </table>
                </div>
              </div>
            </section>

            <section id="registrar-proyecto"><div class="card" style="max-width: 800px; margin: auto;"><div class="card-header"><h2>Nuevo Proyecto o Cotizaci√≥n</h2></div><form id="formProyecto" onsubmit="return false;"><label for="proyectoArtista">Artista/Cliente</label><div id="artista-selector-container"><select id="proyectoArtista"><option value="publico_general">P√∫blico General</option></select><button type="button" id="btnNuevoArtista" title="Registrar nuevo artista" class="btn-primary" style="padding: 0.75rem 1rem;">+</button></div>
              <div id="nuevoArtistaContainer"><label>Nombre del Nuevo Artista</label><div class="form-row" style="align-items: center; gap: 0.5rem;"><input type="text" id="nombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;"><button type="button" id="btnGuardarNuevoArtista" class="btn-secondary" style="margin-bottom: 0; white-space: nowrap; flex-shrink: 0; padding: 0.75rem;">Guardar</button></div></div>
              <div><label for="nombreProyecto">Nombre del Proyecto (Opcional)</label><input type="text" id="nombreProyecto" /></div><div><input type="checkbox" id="esAlbum" name="esAlbum" style="width: auto; margin-right: 0.5rem;"><label for="esAlbum" style="display: inline;">Es un Disco/EP</label></div><hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);"><h3>A√±adir Servicios</h3><div class="form-row"><div class="form-group"><label for="proyectoServicio">Servicio</label><select id="proyectoServicio"></select></div><div class="form-group"><label for="proyectoUnidades">Unidades</label><input type="number" id="proyectoUnidades" min="1" value="1"></div></div><button type="button" id="btnAgregarAProyecto" style="width:100%;">Agregar Servicio</button><ul id="listaProyectoActual" style="list-style: none; padding: 0; margin-top: 1.5rem;"></ul>
              
              <!-- DESCUENTO -->
              <div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;">
                  <div class="form-row" style="justify-content: flex-end; align-items: center; margin-bottom: 0.5rem;">
                      <label style="margin-right: 1rem; margin-bottom: 0;">Descuento ($):</label>
                      <input type="number" id="proyectoDescuento" min="0" step="0.01" value="" placeholder="0.00" style="width: 150px; margin-bottom: 0;">
                  </div>
                  <div class="info-row"><label>Total a Pagar:</label><span id="totalAPagar">$0.00</span></div>
                  
                  <!-- FECHA Y HORA -->
                  <div class="form-row">
                      <div class="form-group"><label for="fechaProyecto">Fecha de Inicio</label><input type="text" id="fechaProyecto"></div>
                      <div class="form-group"><label for="horaProyecto">Hora</label><input type="time" id="horaProyecto"></div>
                  </div>
                  
                  <div class="form-actions"><button id="btnGenerarCotizacion" class="btn-primary">Generar Cotizaci√≥n y PDF</button><button id="btnEnviarAFlujo" class="btn-secondary">Guardar y Agendar</button></div></div></form></div></section>
            <section id="registro-manual"><div class="card" style="max-width: 800px; margin: auto;"><div class="card-header"><h2>Registro Manual de Proyecto</h2><p style="font-size: 0.9em; color: var(--text-color-light);">Usa este formulario para proyectos sin costo, antiguos o que no requieren cotizaci√≥n.</p></div><form id="formProyectoManual" onsubmit="return false;"><label for="manualProyectoArtista">Artista/Cliente</label><div id="manual-artista-selector-container"><select id="manualProyectoArtista" required></select><button type="button" id="manualBtnNuevoArtista" title="Registrar nuevo artista" class="btn-primary" style="padding: 0.75rem 1rem;">+</button></div>
              <div id="manualNuevoArtistaContainer"><label>Nombre del Nuevo Artista</label><div class="form-row" style="align-items: center; gap: 0.5rem;"><input type="text" id="manualNombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;"><button type="button" id="btnGuardarManualNuevoArtista" class="btn-secondary" style="margin-bottom: 0; white-space: nowrap; flex-shrink: 0; padding: 0.75rem;">Guardar</button></div></div>
              <label for="manualNombreProyecto">Nombre del Proyecto</label><input type="text" id="manualNombreProyecto" required /><label for="manualFechaProyecto">Fecha de Inicio</label><input type="text" id="manualFechaProyecto" required /><label for="manualDescripcion">Descripci√≥n (Servicios realizados)</label><textarea id="manualDescripcion" rows="3"></textarea><button type="button" onclick="app.guardarProyectoManual()">Guardar Proyecto</button></form></div></section>
            <section id="historial-proyectos"><div class="card"><div class="card-header"><h2>Historial de Proyectos Completados</h2></div><div class="table-responsive"><table><thead><tr><th>Artista</th><th>Total</th><th>Pagado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tablaHistorialBody"></tbody></table></div></div></section>
            <section id="vista-artista"><div class="card"><div class="card-header"><h2 id="vista-artista-nombre"></h2></div><div id="vista-artista-contenido"></div></div></section>
            <section id="gestion-servicios"><div class="card"><div class="card-header"><h2>Gesti√≥n de Servicios</h2></div><form id="formServicios"><input type="hidden" id="idServicio"><input type="text" id="nombreServicio" placeholder="Nombre" required /><input type="number" step="0.01" id="precioServicio" placeholder="Precio" required /><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormServicios" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Servicios Existentes</h3><ul id="listaServicios"></ul></div></section>
            <section id="gestion-artistas"><div class="card"><div class="card-header"><h2>Gesti√≥n de Artistas</h2></div><form id="formArtistas"><input type="hidden" id="idArtista"><div class="form-row"><div class="form-group"><label for="nombreArtista">Nombre Real</label><input type="text" id="nombreArtista" required /></div><div class="form-group"><label for="nombreArtisticoArtista">Nombre Art√≠stico</label><input type="text" id="nombreArtisticoArtista" /></div></div><div class="form-row"><div class="form-group"><label for="telefonoArtista">Tel√©fono</label><input type="tel" id="telefonoArtista" /></div><div class="form-group"><label for="correoArtista">Correo Electr√≥nico</label><input type="email" id="correoArtista" /></div></div><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormArtistas" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Artistas Registrados</h3><ul id="listaArtistas"></ul></div></section>
            <section id="gestion-usuarios"><div class="card"><div class="card-header"><h2>Gesti√≥n de Usuarios</h2></div><form id="formUsuarios"><input type="hidden" id="idUsuario"><input type="text" id="usernameUsuario" placeholder="Usuario" required /><input type="password" id="passwordUsuario" placeholder="Contrase√±a (dejar en blanco para no cambiar)" /><select id="roleUsuario" required><option value="">-- Rol --</option><option value="ingeniero">Ingeniero</option><option value="admin">Administrador</option></select><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormUsuarios" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Usuarios Existentes</h3><ul id="listaUsuarios"></ul></div></section>
            <section id="papelera-reciclaje"><div class="card"><h3>Servicios Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('servicios')">Vaciar</button></h3><ul id="papeleraServicios"></ul><h3>Artistas Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('artistas')">Vaciar</button></h3><ul id="papeleraArtistas"></ul><h3>Usuarios Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('usuarios')">Vaciar</button></h3><ul id="papeleraUsuarios"></ul></div></section>
            
            <section id="configuracion">
              <div class="card">
                <div class="card-header"><h2>Configuraci√≥n del Sistema</h2></div>
                <h3>Gesti√≥n de la Firma Digital</h3>
                <div class="form-row" style="align-items: center; gap: 2rem; margin-bottom: 2rem;">
                  <div class="form-group" style="flex: 0 0 150px;">
                    <label>Firma Actual</label>
                    <img id="firma-preview-img" src="https://placehold.co/150x60?text=Cargando..." alt="Firma" style="width: 150px; height: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <input type="file" id="firma-input" accept="image/png" style="display: none;">
                    <button onclick="document.getElementById('firma-input').click()" class="btn-secondary" style="width: 100%; margin-top: 0.5rem;">Cambiar Imagen</button>
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <p>Usa los presets de alineaci√≥n y los controles de ajuste fino para posicionar la firma. El sistema evitar√° que se salga de los m√°rgenes.</p>
                    <p style="font-size: 0.9em; color: var(--text-color-light);">La imagen se guarda al seleccionarla. Los ajustes de posici√≥n se guardan con el bot√≥n de abajo.</p>
                  </div>
                </div>
                <hr style="margin: 2rem 0;">
                <h3>Ajuste de Posici√≥n y Tama√±o de la Firma</h3>
                <div id="config-layout">
                  <div id="config-controls">
                    <label for="doc-type-selector">Selecciona el tipo de documento a configurar:</label>
                    <select id="doc-type-selector" onchange="app.cargarAjustesParaDocumento(this.value)" style="margin-bottom: 1rem;">
                      <option value="cotizacion">Cotizaci√≥n</option>
                      <option value="recibo">Recibo de Pago</option>
                      <option value="contrato">Contrato de Grabaci√≥n</option>
                      <option value="distribucion">Hoja de Distribuci√≥n</option>
                    </select>
                    <fieldset class="alignment-group">
                        <legend>Alineaci√≥n Vertical</legend>
                        <div id="v-align-group">
                            <label><input type="radio" name="vAlign" value="top" onchange="app.actualizarPosicionFirma()"> Encabezado</label>
                            <label><input type="radio" name="vAlign" value="middle" onchange="app.actualizarPosicionFirma()"> Cuerpo</label>
                            <label><input type="radio" name="vAlign" value="bottom" onchange="app.actualizarPosicionFirma()"> Pie de p√°gina</label>
                        </div>
                    </fieldset>
                    <fieldset class="alignment-group">
                        <legend>Alineaci√≥n Horizontal</legend>
                        <div id="h-align-group">
                            <label><input type="radio" name="hAlign" value="left" onchange="app.actualizarPosicionFirma()"> Izquierda</label>
                            <label><input type="radio" name="hAlign" value="center" onchange="app.actualizarPosicionFirma()"> Centro</label>
                            <label><input type="radio" name="hAlign" value="right" onchange="app.actualizarPosicionFirma()"> Derecha</label>
                        </div>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-group"><label>Ancho (W): <span id="val-firma-w">0</span></label><input type="range" id="slider-firma-w" min="10" max="150" value="50" oninput="app.actualizarPosicionFirma()"></div>
                        <div class="form-group"><label>Alto (H): <span id="val-firma-h">0</span></label><input type="range" id="slider-firma-h" min="10" max="80" value="20" oninput="app.actualizarPosicionFirma()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ajuste Fino Horizontal (X): <span id="val-firma-offsetX">0</span></label><input type="range" id="slider-firma-offsetX" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()"></div>
                        <div class="form-group"><label>Ajuste Fino Vertical (Y): <span id="val-firma-offsetY">0</span></label><input type="range" id="slider-firma-offsetY" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()"></div>
                    </div>
                    <div class="form-actions">
                      <button onclick="app.guardarAjustesFirma()" style="flex: 2;">Guardar Ajustes</button>
                      <button onclick="app.revertirADefecto()" class="btn-secondary" style="flex: 1;">Revertir a Predeterminado</button>
                    </div>
                  </div>
                  <div id="config-preview">
                    <label>Previsualizaci√≥n en Vivo</label>
                    <div id="firma-preview-container">
                      <div id="template-cotizacion" class="doc-template"><h4>Cotizaci√≥n FIA Records</h4><p>Cliente: Nombre del Cliente</p><div class="line"></div><p>...</p><br><p>Total: $XXXX.XX</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <div id="template-recibo" class="doc-template"><h4>Recibo de Pago</h4><p>Recib√≠ de: Nombre del Cliente</p><p>Concepto: ...</p><div class="line"></div><p>Saldo Restante: $XXXX.XX</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <div id="template-contrato" class="doc-template">
                          <p style="font-weight: bold;">T√©rminos y Condiciones:</p>
                          <ol>
                              <li>Duraci√≥n del Contrato: ...</li><li>...</li><li>Propiedad Intelectual: Los derechos de autor permanecer√°n con El Cliente...</li><li>Responsabilidad: El Cliente es responsable de proporcionar el material...</li><li>Modificaciones: Cualquier modificaci√≥n a este contrato deber√° ser por escrito...</li><li>Ley Aplicable: Este contrato se regir√° por las leyes de Nuevo Le√≥n, M√©xico.</li>
                          </ol>
                          <div id="contract-signature-block">
                            <div class="signature-area-client"><div class="line signature-line-small"></div><p>Firma del Cliente</p></div>
                            <div class="signature-area-rep"></div>
                          </div>
                      </div>
                      <div id="template-distribucion" class="doc-template"><h4>Hoja de Distribuci√≥n</h4><p>Artista: Nombre del Artista</p><p>Lanzamiento: Nombre del Album</p><div class="line"></div><p>...</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <img id="firma-draggable-preview" src="https://placehold.co/150x60?text=Firma" alt="Previsualizaci√≥n de Firma">
                    </div>
                  </div>
                </div>
                <hr style="margin: 2rem 0;">
                <h3>Datos Bancarios</h3>
                <form id="form-datos-bancarios">
                  <div class="form-row"><div class="form-group"><label for="banco">Banco</label><input type="text" id="banco" /></div><div class="form-group"><label for="titular">Titular de la Cuenta</label><input type="text" id="titular" /></div></div>
                  <div class="form-row"><div class="form-group"><label for="tarjeta">N√∫mero de Tarjeta</label><input type="text" id="tarjeta" /></div><div class="form-group"><label for="clabe">CLABE Interbancaria</label><input type="text" id="clabe" /></div></div>
                  <button type="button" onclick="app.guardarDatosBancarios()">Guardar Datos Bancarios</button>
                </form>
              </div>
            </section>

        </main>
    </div>
  </div>

  <div id="document-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Generar Documentos</h2>
        <button class="modal-close" onclick="app.closeDocumentsModal()">√ó</button>
      </div>
      <input type="hidden" id="modal-project-id">
      <div class="filter-buttons">
          <button id="btn-show-contrato" class="active" onclick="app.showDocumentSection('contrato')">Contrato de Grabaci√≥n</button>
          <button id="btn-show-distribucion" onclick="app.showDocumentSection('distribucion')">Distribuci√≥n Digital</button>
      </div>
      <div id="section-contrato" class="document-section active">
        <h3>Detalles del Contrato</h3>
        <label for="contrato-nombre-album">Nombre del √Ålbum/EP</label>
        <input type="text" id="contrato-nombre-album">
        <label for="contrato-canciones">Cantidad de Canciones</label>
        <input type="number" id="contrato-canciones">
        <label for="contrato-duracion">Duraci√≥n del Contrato (incluir unidad, ej: 3 Semanas, 1 Mes)</label>
        <input type="text" id="contrato-duracion">
        <label for="contrato-pago-inicial">Pago Inicial ($)</label>
        <input type="number" id="contrato-pago-inicial" oninput="app.calcularSaldoContrato()">
        <label for="contrato-pago-final">Saldo Restante ($)</label>
        <input type="number" id="contrato-pago-final" readonly>
        <button onclick="app.saveAndGenerateContract()" style="width: 100%; margin-top: 1rem;">Guardar y Generar Contrato PDF</button>
      </div>
      <div id="section-distribucion" class="document-section">
        <h3>Detalles de Distribuci√≥n</h3>
        <label for="dist-titulo">T√≠tulo del Lanzamiento (√Ålbum/Sencillo)</label>
        <input type="text" id="dist-titulo">
        <label for="dist-fecha">Fecha de Lanzamiento</label>
        <input type="text" id="dist-fecha">
        <label for="dist-upc">C√≥digo UPC/EAN</label>
        <input type="text" id="dist-upc" placeholder="C√≥digo de barras del √°lbum">
        <hr style="margin: 1.5rem 0;">
        <h4>Tracks y C√≥digos ISRC</h4>
        <div id="dist-tracks-container"></div>
        <button onclick="app.addTrackField()" class="btn-secondary" style="width: 100%; margin-bottom: 1rem;">+ A√±adir Track</button>
        <button onclick="app.saveAndGenerateDistribution()" style="width: 100%;">Guardar y Generar Documento PDF</button>
      </div>
    </div>
  </div>
  
  <div id="event-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-event-title">Detalles del Proyecto</h2>
            <button class="modal-close" onclick="app.closeEventModal()">√ó</button>
        </div>
        <input type="hidden" id="modal-event-id">
        <p><strong>Fecha:</strong> <span id="modal-event-date"></span></p>
        <p><strong>Total:</strong> <span id="modal-event-total"></span></p>
        <p><strong>Estado:</strong> <span id="modal-event-status"></span></p>
        <p><strong>Proceso:</strong> <span id="modal-event-process"></span></p>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Servicios:</h4>
        <ul id="modal-event-services" style="list-style-position: inside; padding-left: 0;"></ul>
        
        <!-- SECCI√ìN PARA EDITAR FECHA Y HORA -->
        <div style="margin-top: 1.5rem; padding: 1rem; background: var(--secondary-button-bg); border-radius: 12px;">
            <h4 style="margin-bottom: 0.5rem; margin-top: 0;">Reprogramar Cita</h4>
            <div class="form-row">
                <div class="form-group" style="margin-bottom:0;">
                    <label style="font-size: 0.8em;">Nueva Fecha</label>
                    <input type="text" id="edit-event-date" style="margin-bottom: 0.5rem;">
                </div>
                <div class="form-group" style="margin-bottom:0;">
                    <label style="font-size: 0.8em;">Nueva Hora</label>
                    <input type="time" id="edit-event-time" style="margin-bottom: 0.5rem;">
                </div>
            </div>
            <button onclick="app.actualizarHorarioProyecto()" style="width: 100%; padding: 0.5rem; font-size: 0.9em; margin-top: 0.5rem;">Actualizar Fecha/Hora</button>
        </div>

        <div class="form-actions" style="margin-top: 1.5rem;">
            <button id="btn-go-to-workflow" class="btn-secondary" onclick="">Ir al Flujo de Trabajo</button>
            <button id="btn-go-to-artist" onclick="">Ver Historial del Artista</button>
        </div>
    </div>
  </div>
  
  <div id="delivery-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Gestionar Entrega de Proyecto</h2>
        <button class="modal-close" onclick="app.closeDeliveryModal()">√ó</button>
      </div>
      <input type="hidden" id="delivery-project-id">
      <input type="hidden" id="delivery-artist-name">
      <input type="hidden" id="delivery-project-name">
      <div class="form-group">
        <label for="delivery-link-input">Enlace de Descarga (Google Drive, WeTransfer, etc.)</label>
        <input type="url" id="delivery-link-input" placeholder="Pega el enlace aqu√≠">
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="app.saveDeliveryLink()">Guardar Enlace</button>
        <button onclick="app.sendDeliveryByWhatsapp()">Enviar por WhatsApp</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let isInitialized = false; 
      let proyectoActual = {}; 
      let logoBase64 = null; // Para PDFs offline

      // 1. INICIALIZAR CACH√â (Memoria + LocalStorage)
      let localCache = {
          artistas: JSON.parse(localStorage.getItem('cache_artistas') || '[]'),
          servicios: JSON.parse(localStorage.getItem('cache_servicios') || '[]'),
          proyectos: JSON.parse(localStorage.getItem('cache_proyectos') || '[]'),
          cotizaciones: [], 
          historial: [],
          pagos: JSON.parse(localStorage.getItem('cache_pagos') || '[]'),
          usuarios: []
      };
      
      let currentCalendar = null; let configCache = null; let chartInstance = null; const API_URL = '';
      const DOMElements = { loginContainer: document.getElementById('login-container'), appWrapper: document.getElementById('app-wrapper'), logoutButton: document.getElementById('logout-button'), welcomeUser: document.getElementById('welcome-user'), appLogo: document.getElementById('app-logo'), loginLogo: document.getElementById('login-logo'), customizationContainer: document.getElementById('customization-container'), logoInput: document.getElementById('logo-input'), connectionStatus: document.getElementById('connection-status'), connectionText: document.getElementById('connection-text') };
      
      const PDF_DIMENSIONS = { WIDTH: 210, HEIGHT: 297, MARGIN: 14 };

      function showToast(message, type = 'success') { const options = { text: message, duration: 3000, gravity: "top", position: "right", className: `toast-${type}` }; Toastify(options).showToast(); }
      function escapeHTML(str) { if (!str) return ''; return str.replace(/[&<>'"]/g, tag => ({'&': '&amp;','<': '&lt;','>': '&gt;',"'": '&#39;','"': '&quot;'}[tag])); }
      function showLoader() { document.getElementById('loader-overlay').style.display = 'flex'; }
      function hideLoader() { document.getElementById('loader-overlay').style.display = 'none'; }
      async function imageExists(url) { try { const response = await fetch(url, { method: 'HEAD' }); return response.ok; } catch (e) { return false; } }

      // OFFLINE MANAGER FIXED & PERSISTENT
      const OfflineManager = {
          QUEUE_KEY: 'fia_offline_queue',
          getQueue: () => JSON.parse(localStorage.getItem(OfflineManager.QUEUE_KEY) || '[]'),
          addToQueue: (url, options, tempId = null) => {
              const queue = OfflineManager.getQueue();
              queue.push({ url, options, timestamp: Date.now(), tempId });
              localStorage.setItem(OfflineManager.QUEUE_KEY, JSON.stringify(queue));
              OfflineManager.updateIndicator();
          },
          clearQueue: () => {
            localStorage.removeItem(OfflineManager.QUEUE_KEY);
            OfflineManager.updateIndicator();
          },
          updateIndicator: () => {
              const queue = OfflineManager.getQueue();
              // Doble verificaci√≥n de online
              const isOnline = navigator.onLine;
              
              if (isOnline) {
                  if (queue.length > 0) {
                      DOMElements.connectionStatus.className = 'connection-status status-syncing';
                      DOMElements.connectionText.textContent = `Sincronizando (${queue.length})`;
                      OfflineManager.sync(); 
                  } else {
                      DOMElements.connectionStatus.className = 'connection-status status-online';
                      DOMElements.connectionText.textContent = 'En L√≠nea';
                  }
              } else {
                  DOMElements.connectionStatus.className = 'connection-status status-offline';
                  DOMElements.connectionText.textContent = queue.length > 0 ? `Offline (${queue.length} ptes)` : 'Modo Offline';
              }
          },
          sync: async () => {
              const queue = OfflineManager.getQueue();
              if (queue.length === 0) return;
              
              const token = localStorage.getItem('token');
              const headers = { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' };
              let mapping = {};
              let newQueue = [];
              
              for (const req of queue) {
                  try {
                      let bodyStr = req.options.body;
                      if(bodyStr) {
                          Object.keys(mapping).forEach(tempId => {
                              bodyStr = bodyStr.replace(new RegExp(tempId, 'g'), mapping[tempId]);
                          });
                      }
                      const reqOptions = { ...req.options, body: bodyStr, headers: { ...req.options.headers, ...headers } };
                      const res = await fetch(req.url, reqOptions);
                      if(res.ok && req.tempId) {
                          const data = await res.json();
                          if(data._id) mapping[req.tempId] = data._id;
                      }
                      if(!res.ok) throw new Error('Failed');
                  } catch (e) {
                      newQueue.push(req);
                  }
              }
              localStorage.setItem(OfflineManager.QUEUE_KEY, JSON.stringify(newQueue));
              if(newQueue.length === 0) { showToast('Sincronizaci√≥n completada', 'success'); }
              OfflineManager.updateIndicator();
              const currentHash = location.hash.replace('#', '');
              if (currentHash) window.app.mostrarSeccion(currentHash, false);
          },
          syncNow: () => { if(navigator.onLine) OfflineManager.sync(); }
      };

      window.app = { syncNow: OfflineManager.syncNow };

      // FETCH API ROBUSTA
      async function fetchAPI(url, options = {}) { 
        const token = localStorage.getItem('token'); 
        if (!token) { showLogin(); throw new Error('No autenticado'); } 
        const headers = { 'Authorization': `Bearer ${token}` }; 
        if (!options.isFormData) { headers['Content-Type'] = 'application/json'; } 
        
        // 1. INTENTO DE LECTURA (GET) OFFLINE FIRST
        if ((!options.method || options.method === 'GET') && !navigator.onLine) {
             if(url.includes('/artistas')) return localCache.artistas;
             if(url.includes('/servicios')) return localCache.servicios;
             if(url.includes('/proyectos')) {
                 // Filtrar la cach√© local para devolver lo que se pide
                 if(url.includes('cotizaciones')) return localCache.proyectos.filter(p => p.estatus === 'Cotizacion');
                 else if(url.includes('completos')) return localCache.proyectos.filter(p => p.proceso === 'Completo' && p.estatus !== 'Cancelado');
                 else if(url.includes('agenda')) return localCache.proyectos.filter(p => p.estatus !== 'Cancelado').map(p => ({ id: p._id, title: p.nombreProyecto || (p.artista ? p.artista.nombre : 'Proyecto'), start: p.fecha, allDay: false, extendedProps: { ...p, servicios: p.items.map(i=>i.nombre).join('\n') } }));
                 else return localCache.proyectos;
             }
             if(url.includes('/pagos')) return localCache.pagos;
        }

        // 2. INTENTO DE ESCRITURA (POST/PUT) OFFLINE
        if (!navigator.onLine && options.method && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
            const tempId = `temp_${Date.now()}`;
            let mockResponse = { ok: true, offline: true, _id: tempId };
            let body = {};
            if (options.body) body = JSON.parse(options.body);

            // Simulaci√≥n b√°sica de √©xito para la UI
            if (url.includes('/artistas')) {
                const newArtist = { ...body, _id: tempId };
                localCache.artistas.push(newArtist);
                localStorage.setItem('cache_artistas', JSON.stringify(localCache.artistas));
                mockResponse = { ...newArtist, offline: true };
            } 
            else if (url.includes('/proyectos')) {
                 if(options.method === 'POST') {
                    const newProject = { ...body, _id: tempId, createdAt: new Date().toISOString(), montoPagado: 0, pagos: [] };
                    // Intentar vincular artista
                    if(typeof newProject.artista === 'string') {
                        const art = localCache.artistas.find(a => a._id === newProject.artista);
                        if(art) newProject.artista = art;
                    }
                    localCache.proyectos.push(newProject);
                    localStorage.setItem('cache_proyectos', JSON.stringify(localCache.proyectos));
                    mockResponse = { ...newProject, offline: true };
                 }
            }
            
            OfflineManager.addToQueue(`${API_URL}${url}`, { ...options, headers }, tempId);
            return mockResponse;
        }

        // 3. ONLINE REQUEST
        showLoader();
        try {
            const res = await fetch(`${API_URL}${url}`, { ...options, headers }); 
            if (res.status === 401) { showLogin(); throw new Error('Sesi√≥n expirada.'); } 
            if (res.status === 204 || (options.method === 'DELETE' && res.ok)) return {ok: true}; 
            const data = await res.json(); 
            if (!res.ok) throw new Error(data.error || 'Error del servidor'); 
            
            // ACTUALIZAR CACH√â PERSISTENTE
            if (!options.method || options.method === 'GET') {
                if(url.includes('/artistas')) {
                    localCache.artistas = data;
                    localStorage.setItem('cache_artistas', JSON.stringify(data));
                }
                if(url.includes('/servicios')) {
                    localCache.servicios = data;
                    localStorage.setItem('cache_servicios', JSON.stringify(data));
                }
                if(url.includes('/proyectos') && !url.includes('agenda')) {
                    if(Array.isArray(data) && url === '/api/proyectos') {
                        localCache.proyectos = data;
                        localStorage.setItem('cache_proyectos', JSON.stringify(data));
                    }
                }
                if(url.includes('/pagos/todos')) {
                    localCache.pagos = data;
                    localStorage.setItem('cache_pagos', JSON.stringify(data));
                }
            }
            return data; 
        } catch(e) {
            // FALLBACK A OFFLINE SI FALLA LA RED
            if (!navigator.onLine || e.message.includes('Failed to fetch') || e.message.includes('NetworkError')) {
                OfflineManager.updateIndicator(); 
                if (options.method && ['POST', 'PUT', 'DELETE'].includes(options.method)) {
                     const tempId = `temp_${Date.now()}`;
                     OfflineManager.addToQueue(`${API_URL}${url}`, { ...options, headers }, tempId);
                     return { ok: true, offline: true, _id: tempId };
                }
                // Si falla un GET, intentar devolver cach√© viejo
                if(url.includes('/artistas')) return localCache.artistas;
                if(url.includes('/servicios')) return localCache.servicios;
                if(url.includes('/proyectos')) {
                    // Mismo filtrado que arriba
                    if(url.includes('cotizaciones')) return localCache.proyectos.filter(p => p.estatus === 'Cotizacion');
                    else if(url.includes('completos')) return localCache.proyectos.filter(p => p.proceso === 'Completo' && p.estatus !== 'Cancelado');
                    else if(url.includes('agenda')) return localCache.proyectos.filter(p => p.estatus !== 'Cancelado').map(p => ({ id: p._id, title: p.nombreProyecto || (p.artista ? p.artista.nombre : 'Proyecto'), start: p.fecha, allDay: false, extendedProps: { ...p, servicios: p.items.map(i=>i.nombre).join('\n') } }));
                    else return localCache.proyectos;
                }
                if(url.includes('/pagos')) return localCache.pagos;
            }
            throw e;
        } finally {
            hideLoader(); 
        }
      }

      function filtrarTablas(query) {
          query = query.toLowerCase();
          document.querySelectorAll('section.active tbody tr').forEach(row => { const text = row.innerText.toLowerCase(); row.style.display = text.includes(query) ? '' : 'none'; });
          document.querySelectorAll('section.active .project-card').forEach(card => { const text = card.innerText.toLowerCase(); card.style.display = text.includes(query) ? 'block' : 'none'; });
          document.querySelectorAll('section.active ul li').forEach(li => { const text = li.innerText.toLowerCase(); li.style.display = text.includes(query) ? 'flex' : 'none'; });
      }

      // PRECARGAR LOGO A BASE64 PARA PDF OFFLINE
      async function preloadLogoForPDF() {
          const imgUrl = DOMElements.appLogo.src;
          try {
              const response = await fetch(imgUrl);
              const blob = await response.blob();
              const reader = new FileReader();
              reader.onloadend = () => { logoBase64 = reader.result; };
              reader.readAsDataURL(blob);
          } catch(e) { console.warn("No se pudo precargar logo para PDF offline"); }
      }
      // HELPER: Invertir color logo para PDF (Canvas)
      async function getInvertedLogoDataUrl(logoBase64) {
          return new Promise((resolve) => {
              const img = new Image();
              img.src = logoBase64;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  canvas.width = img.width;
                  canvas.height = img.height;
                  const ctx = canvas.getContext('2d');
                  ctx.filter = 'invert(1)'; // Invertir negro a blanco o viceversa
                  ctx.drawImage(img, 0, 0);
                  resolve(canvas.toDataURL('image/png'));
              };
              img.onerror = () => resolve(null);
          });
      }

      async function loadPublicLogo() {
          try {
              const res = await fetch(`${API_URL}/api/configuracion/public/logo`);
              if (!res.ok) return;
              const data = await res.json();
              if (data && data.filePath) {
                  const cacheBuster = `?t=${new Date().getTime()}`;
                  const logoSrc = data.filePath + cacheBuster;
                  DOMElements.loginLogo.src = logoSrc;
                  DOMElements.appLogo.src = logoSrc;
                  // Iniciar precarga despues de cargar URL
                  setTimeout(preloadLogoForPDF, 1000);
              }
          } catch (e) { console.error("Logo error:", e); }
      }

      async function loadInitialConfig() { try { const config = await fetchAPI('/api/configuracion'); configCache = config; if (config.logoPath) { DOMElements.appLogo.src = config.logoPath + `?t=${new Date().getTime()}`; } } catch (e) { console.error("Config error:", e); } }
      function applyTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); document.getElementById('theme-switch').checked = (theme === 'dark'); localStorage.setItem('theme', theme); }
      
      (async function init() { 
        await loadPublicLogo();
        applyTheme(localStorage.getItem('theme') || 'light'); 
        const token = localStorage.getItem('token'); 
        if (token) { 
            try { 
                const payload = JSON.parse(atob(token.split('.')[1])); 
                // Relajar validacion expiracion si offline
                if (navigator.onLine && payload.exp * 1000 < Date.now()) return showLogin(); 
                await showApp(payload); 
            } catch (e) { showLogin(); } 
        } else { showLogin(); } 
      })();

      async function showApp(payload) { 
        if (!configCache) await loadInitialConfig();
        DOMElements.welcomeUser.textContent = `Hola, ${escapeHTML(payload.username)}`; 
        const esAdmin = payload.role === 'admin'; 
        document.querySelector('[data-seccion="gestion-usuarios"]').style.display = esAdmin ? 'flex' : 'none'; 
        document.querySelector('[data-seccion="papelera-reciclaje"]').style.display = esAdmin ? 'flex' : 'none'; 
        document.querySelector('[data-seccion="configuracion"]').style.display = esAdmin ? 'flex' : 'none'; 
        DOMElements.customizationContainer.style.display = esAdmin ? 'block' : 'none'; 
        DOMElements.loginContainer.style.display = 'none'; 
        DOMElements.appWrapper.style.display = window.innerWidth <= 768 ? 'block' : 'flex'; 
        if (!isInitialized) { initAppEventListeners(payload); isInitialized = true; } 
        
        const hashSection = location.hash.replace('#', '');
        mostrarSeccion(hashSection || 'dashboard', false);
        
        // Listeners for Offline Mode
        OfflineManager.updateIndicator();
        window.addEventListener('online', () => { OfflineManager.updateIndicator(); });
        window.addEventListener('offline', () => { OfflineManager.updateIndicator(); });
      }
      function showLogin() { localStorage.removeItem('token'); DOMElements.loginContainer.style.display = 'block'; DOMElements.appWrapper.style.display = 'none'; }
      
      document.getElementById('login-form').addEventListener('submit', async (e) => { 
        e.preventDefault(); 
        if (!navigator.onLine) { return showToast('Necesitas internet para iniciar sesi√≥n.', 'error'); }
        showLoader();
        try { 
            const res = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username.value, password: password.value }) }); 
            const data = await res.json(); 
            if (!res.ok) throw new Error(data.error); 
            localStorage.setItem('token', data.token); 
            await showApp(JSON.parse(atob(data.token.split('.')[1]))); 
        } catch (error) { 
            document.getElementById('login-error').textContent = error.message; 
        } finally {
            hideLoader();
        }
      });
      
      DOMElements.logoutButton.addEventListener('click', showLogin);
      
      async function mostrarSeccion(id, updateHistory = true) { 
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active')); 
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link')); 
        
        const seccionActiva = document.getElementById(id); 
        const linkActivo = document.querySelector(`.nav-link[data-seccion="${id}"]`); 
        
        if (seccionActiva) { 
            seccionActiva.classList.add('active'); 
            if(linkActivo) {
                linkActivo.classList.add('active-link');
                document.querySelectorAll('.nav-group').forEach(group => group.removeAttribute('open'));
                const parentGroup = linkActivo.closest('.nav-group');
                if (parentGroup) parentGroup.setAttribute('open', '');
            }
            if(updateHistory) history.pushState(null, null, `#${id}`);
            
            const searchInput = document.getElementById('globalSearch');
            if(searchInput) { searchInput.value = ''; }

            // Usamos await para asegurar carga de datos
            const loadDataActions = { 'dashboard': cargarDashboard, 'agenda': cargarAgenda, 'cotizaciones': cargarCotizaciones, 'flujo-trabajo': cargarFlujoDeTrabajo, 'pagos': cargarPagos, 'registrar-proyecto': cargarOpcionesParaProyecto, 'registro-manual': cargarOpcionesParaProyectoManual, 'historial-proyectos': cargarHistorial, 'gestion-servicios': () => renderList('servicios'), 'gestion-artistas': () => renderList('artistas', true), 'gestion-usuarios': () => renderList('usuarios'), 'papelera-reciclaje': cargarPapelera, 'configuracion': cargarConfiguracion, }; 
            await loadDataActions[id]?.(); 
        } 
      }

      async function renderList(endpoint, makeClickable = false) { 
          const listId = `lista${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; 
          try { 
              const data = await fetchAPI(`/api/${endpoint}`); 
              document.getElementById(listId).innerHTML = data.length ? data.map(item => { 
                  let displayName; 
                  if (endpoint === 'artistas') {
                      displayName = `${item.nombreArtistico || item.nombre} ${item.nombreArtistico ? `(${item.nombre})` : ''}`;
                  } else if (endpoint === 'usuarios') {
                      displayName = `${item.username || 'Usuario'} (${item.role})`;
                  } else {
                      displayName = `${item.nombre || 'Sin Nombre'} - $${item.precio.toFixed(2)}`;
                  }
                  const clickHandler = makeClickable ? `ondblclick="app.irAVistaArtista('${item._id}', '${escapeHTML(item.nombre)}', '${escapeHTML(item.nombreArtistico || '')}')"` : '';
                  return `<li class="list-item" ${clickHandler} style="${makeClickable ? 'cursor:pointer;' : ''}"><span>${escapeHTML(displayName)}</span><div class="list-item-actions"><button class="btn-secondary" onclick="event.stopPropagation(); app.editarItem('${item._id}', '${endpoint}')">‚úèÔ∏è</button><button class="btn-eliminar" onclick="event.stopPropagation(); app.eliminarItem('${item._id}', '${endpoint}')">üóëÔ∏è</button></div></li>`; 
              }).join('') : `<li>No hay elementos.</li>`; 
          } catch (e) { document.getElementById(listId).innerHTML = `<li>Error al cargar.</li>`; } 
      }
      async function cargarPapelera() { const endpoints = ['servicios', 'artistas', 'usuarios']; for (const endpoint of endpoints) { const listId = `papelera${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; try { const data = await fetchAPI(`/api/${endpoint}/papelera/all`); document.getElementById(listId).innerHTML = data.length ? data.map(item => `<li class="list-item"><span>${escapeHTML(item.nombre || item.username)}</span><div class="list-item-actions"><button class="btn-restaurar" onclick="app.restaurarItem('${item._id}', '${endpoint}')">‚Ü©Ô∏è</button><button class="btn-eliminar" onclick="app.eliminarPermanente('${item._id}', '${endpoint}')">‚ùå</button></div></li>`).join('') : `<li>Papelera vac√≠a.</li>`; } catch (e) { document.getElementById(listId).innerHTML = `<li>Error al cargar.</li>`; } } }
      function limpiarForm(formId) { const form = document.getElementById(formId); form.reset(); const idInput = form.querySelector('input[type="hidden"]'); if(idInput) idInput.value = ''; form.querySelector('button[type="submit"]').textContent = 'Guardar'; }
      async function saveItem(e, type) { 
          e.preventDefault(); 
          const form = e.target; 
          const id = form.querySelector('input[type="hidden"]')?.value; 
          let body; 
          if (type === 'servicios') { 
              body = { nombre: form.nombreServicio.value, precio: parseFloat(form.precioServicio.value) }; 
          } else if (type === 'artistas') {
              body = { nombre: form.nombreArtista.value, nombreArtistico: form.nombreArtisticoArtista.value, telefono: form.telefonoArtista.value, correo: form.correoArtista.value };
          } else if (type === 'usuarios') { 
              body = { username: form.usernameUsuario.value, role: form.roleUsuario.value }; 
              const password = form.passwordUsuario.value; 
              if (!id && !password) { showToast('La contrase√±a es obligatoria para nuevos usuarios.', 'error'); return; } 
              if (password) body.password = password; 
          } 
          const method = id ? 'PUT' : 'POST'; 
          const url = `/api/${type}/${id || ''}`; 
          try { 
              const res = await fetchAPI(url, { method, body: JSON.stringify(body) }); 
              if (res.offline) { 
                 showToast('Guardado en cola (Offline). Se sincronizar√° al conectar.', 'warning');
                 mostrarSeccion(`gestion-${type}`); // Refrescar localmente
              } else {
                 showToast(`Elemento ${id ? 'actualizado' : 'guardado'} con √©xito.`, 'success'); 
                 limpiarForm(form.id); 
                 mostrarSeccion(`gestion-${type}`); 
              }
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }
      async function eliminarItem(id, endpoint) { if (!confirm(`¬øMover a la papelera?`)) return; try { await fetchAPI(`/api/${endpoint}/${id}`, { method: 'DELETE' }); showToast('Movido a la papelera.', 'info'); mostrarSeccion(`gestion-${endpoint}`); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function editarItem(id, endpoint) { 
          try { 
              let item;
              if (endpoint === 'artistas') item = localCache.artistas.find(i => i._id === id);
              else if (endpoint === 'servicios') item = localCache.servicios.find(i => i._id === id);
              
              if(!item) item = await fetchAPI(`/api/${endpoint}/${id}`); 
              
              const form = document.getElementById(`form${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`); 
              if (endpoint === 'servicios') { 
                  form.idServicio.value = item._id; 
                  form.nombreServicio.value = item.nombre; 
                  form.precioServicio.value = item.precio; 
              } else if (endpoint === 'artistas') { 
                  form.idArtista.value = item._id; 
                  form.nombreArtista.value = item.nombre;
                  form.nombreArtisticoArtista.value = item.nombreArtistico || '';
                  form.telefonoArtista.value = item.telefono || '';
                  form.correoArtista.value = item.correo || '';
              } else if (endpoint === 'usuarios') { 
                  form.idUsuario.value = item._id; 
                  form.usernameUsuario.value = item.username; 
                  form.roleUsuario.value = item.role; 
              } 
              form.querySelector('button[type="submit"]').textContent = 'Actualizar'; 
          } catch (error) { showToast(`Error al cargar: ${error.message}`, 'error'); } 
      }
      async function restaurarItem(id, endpoint) { try { await fetchAPI(`/api/${endpoint}/${id}/restaurar`, { method: 'PUT' }); showToast('Elemento restaurado.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function eliminarPermanente(id, endpoint) { if (!confirm('¬°ADVERTENCIA! Esta acci√≥n es irreversible. ¬øEliminar permanentemente?')) return; try { await fetchAPI(`/api/${endpoint}/${id}/permanente`, { method: 'DELETE' }); showToast('Eliminado permanentemente.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function vaciarPapelera(endpoint) { if (!confirm(`¬øVaciar PERMANENTEMENTE la papelera de ${endpoint}?`)) return; try { await fetchAPI(`/api/${endpoint}/papelera/vaciar`, { method: 'DELETE' }); showToast(`Papelera de ${endpoint} vaciada.`, 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      
      async function cargarDashboard() { 
        try { 
            // Si estamos offline, calcular KPI con datos locales
            if (!navigator.onLine) {
                 const activos = localCache.proyectos.filter(p => p.proceso !== 'Completo' && p.estatus !== 'Cancelado').length;
                 const porCobrar = localCache.proyectos.filter(p => (p.total - (p.montoPagado||0)) > 0 && p.estatus !== 'Cancelado').length;
                 document.getElementById('kpi-proyectos-activos').textContent = activos; 
                 document.getElementById('kpi-proyectos-por-cobrar').textContent = porCobrar; 
                 return;
            }

            const stats = await fetchAPI('/api/dashboard/stats'); 
            document.getElementById('kpi-ingresos-mes').textContent = `$${(stats.ingresosMes||0).toFixed(2)}`; 
            document.getElementById('kpi-proyectos-activos').textContent = stats.proyectosActivos || 0; 
            document.getElementById('kpi-proyectos-por-cobrar').textContent = stats.proyectosPorCobrar || 0; 

            const ctx = document.getElementById('incomeChart').getContext('2d');
            if (chartInstance) chartInstance.destroy();
            
            const labels = ['Ene', 'Feb', 'Mar', 'Abr', 'May', 'Jun', 'Jul', 'Ago', 'Sep', 'Oct', 'Nov', 'Dic'];
            const dataValues = stats.monthlyIncome || [0,0,0,0,0,0,0,0,0,0,0,0];

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Ingresos ($)',
                        data: dataValues,
                        borderColor: '#6366f1',
                        backgroundColor: 'rgba(99, 102, 241, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });
        } catch(e) { console.error("Error cargando dashboard:", e); } 
      }

      async function cargarCotizaciones() { const tablaBody = document.getElementById('tablaCotizacionesBody'); tablaBody.innerHTML = `<tr><td colspan="4">Cargando...</td></tr>`; try { const cotizaciones = await fetchAPI('/api/proyectos/cotizaciones'); tablaBody.innerHTML = cotizaciones.length ? cotizaciones.map(c => { const esArtistaRegistrado = c.artista && c.artista._id; const nombreArtista = esArtistaRegistrado ? c.artista.nombre : 'P√∫blico General'; const claseTd = esArtistaRegistrado ? 'clickable-artist' : ''; const eventoDblClick = esArtistaRegistrado ? `ondblclick="app.irAVistaArtista('${c.artista._id}', '${escapeHTML(c.artista.nombre)}', '')"` : ''; return `<tr><td class="${claseTd}" ${eventoDblClick}>${escapeHTML(nombreArtista)}</td><td>$${c.total.toFixed(2)}</td><td>${new Date(c.createdAt).toLocaleDateString()}</td><td class="table-actions"><button class="btn-aprobar" onclick="app.aprobarCotizacion('${c._id}')">Aprobar</button><button class="btn-secondary" title="Regenerar PDF" onclick="app.generarCotizacionPDF('${c._id}')">üìÑ</button><button class="btn-secondary" title="Compartir por WhatsApp" onclick="app.compartirPorWhatsApp('${c._id}')">üí¨</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${c._id}', true)">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="4">No hay cotizaciones pendientes.</td></tr>`; } catch(e) { tablaBody.innerHTML = `<tr><td colspan="4">No se pueden cargar datos offline.</td></tr>`; } }
      const procesos = ['Agendado', 'Grabacion', 'Edicion', 'Mezcla', 'Mastering', 'Completo'];
      async function cargarFlujoDeTrabajo(filtroActivo = 'Todos') { const board = document.getElementById('kanbanBoard'); const filtros = document.getElementById('filtrosFlujo'); if(!filtros.innerHTML) { filtros.innerHTML = `<button class="active" onclick="app.filtrarFlujo('Todos')">Todos</button>` + procesos.filter(p=>p!=='Completo').map(p => `<button onclick="app.filtrarFlujo('${p}')">${p}</button>`).join(''); } board.innerHTML = procesos.filter(p => p !== 'Completo').map(p => `<div class="kanban-column" data-columna="${p}"><h3>${p}</h3><div id="columna-${p}"></div></div>`).join(''); try { localCache.proyectos = await fetchAPI('/api/proyectos'); filtrarFlujo(filtroActivo); } catch(e) { console.error("Error cargando flujo:", e); } }
      function filtrarFlujo(filtro) { 
          document.querySelectorAll('#filtrosFlujo button').forEach(b => b.classList.remove('active')); 
          document.querySelector(`#filtrosFlujo button[onclick="app.filtrarFlujo('${filtro}')"]`).classList.add('active'); 
          document.querySelectorAll('.kanban-column').forEach(c => c.style.display = (filtro === 'Todos' || c.dataset.columna === filtro) ? 'block' : 'none'); 
          procesos.forEach(col => { if(document.getElementById(`columna-${col}`)) document.getElementById(`columna-${col}`).innerHTML = '' }); 
          
          if(localCache.proyectos) {
            // FILTRAR CANCELADOS
            localCache.proyectos.filter(p => p.proceso !== 'Completo' && p.estatus !== 'Cancelado').forEach(p => { 
                const card = document.createElement('div'); 
                card.className = `project-card`; 
                card.dataset.id = p._id;
                card.style.borderColor = `var(--proceso-${p.proceso})`; 
                const serviciosHtml = p.items.length > 0 ? p.items.map(i => `<li>- ${escapeHTML(i.nombre)}</li>`).join('') : `<li>- ${escapeHTML(p.nombreProyecto || 'Proyecto sin servicios')}</li>`;
                const estatusNormalizado = p.estatus.replace(/ /g, '-'); 
                const estatusColor = `var(--estatus-${estatusNormalizado}, var(--warning-color))`; 
                const artistaNombre = p.artista ? (p.artista.nombreArtistico || p.artista.nombre) : 'P√∫blico General'; 
                const eventoDblClick = p.artista ? `ondblclick="app.irAVistaArtista('${p.artista._id}', '${escapeHTML(p.artista.nombre)}', '${escapeHTML(p.artista.nombreArtistico||'')}')"` : ''; 
                const claseArtista = p.artista ? 'clickable-artist' : ''; 
                card.innerHTML = `<div class="project-card-header">
                                    <div class="project-card-header-main">
                                        <span class="${claseArtista}" ${eventoDblClick}>${escapeHTML(p.nombreProyecto || artistaNombre)}</span>
                                        <button class="btn-secondary" style="width: 24px; height: 24px; padding: 0; font-size: 0.7em;" onclick="app.editarNombreProyecto('${p._id}')">‚úèÔ∏è</button>
                                    </div>
                                    <span class="status-badge" style="background-color:${estatusColor}">${escapeHTML(p.estatus)}</span>
                                </div>
                                <div class="project-card-body">
                                    <div style="font-weight: bold; margin-bottom: 8px;">üóìÔ∏è ${new Date(p.fecha).toLocaleDateString()}</div>
                                    <ul>${serviciosHtml}</ul>
                                    <span class="proceso-tag" style="background-color: var(--proceso-${p.proceso})">${p.proceso}</span>
                                </div>
                                <div class="project-card-footer">
                                    <strong>$${p.total.toFixed(2)}</strong>
                                    <div>
                                        <button class="btn-secondary" onclick="app.openDocumentsModal('${p._id}')">Docs üìÑ</button>
                                        <button class="btn-secondary" onclick="app.registrarPago('${p._id}')">Pagos üíµ</button>
                                        <select onchange="app.cambiarProceso('${p._id}', this.value)" style="margin-left: 0.5rem;">${procesos.map(proc => `<option value="${proc}" ${p.proceso === proc ? 'selected' : ''}>${proc}</option>`).join('')}</select>
                                        <!-- NUEVO BOT√ìN CANCELAR -->
                                        <button class="btn-eliminar" style="margin-left:0.5rem; padding: 0.3rem 0.6rem;" title="Cancelar Cita" onclick="app.cancelarCita('${p._id}')">‚úï</button>
                                    </div>
                                </div>`; 
                document.getElementById(`columna-${p.proceso}`)?.appendChild(card); 
            });
          }
      }
      async function cambiarProceso(id, proceso) { try { const data = { proceso }; if (proceso === 'Completo') { const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto.estatus !== 'Pagado') { if (!confirm('Este proyecto no est√° completamente pagado. ¬øDeseas marcarlo como completo de todas formas?')) return; } } await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify(data) }); const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto) proyecto.proceso = proceso; const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); if(proceso === 'Completo') { localCache.proyectos = localCache.proyectos.filter(p => p._id !== id); showToast('¬°Proyecto completado! Se ha movido al historial.', 'success'); } filtrarFlujo(filtroActual); } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function cargarHistorial() { const tablaBody = document.getElementById('tablaHistorialBody'); tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; try { historialCacheados = await fetchAPI('/api/proyectos/completos'); tablaBody.innerHTML = historialCacheados.length ? historialCacheados.map(p => { const artistaNombre = p.artista ? p.artista.nombre : 'P√∫blico General'; const eventoDblClick = p.artista ? `ondblclick="app.irAVistaArtista('${p.artista._id}', '${escapeHTML(p.artista.nombre)}', '')"` : ''; const claseArtista = p.artista ? 'clickable-artist' : ''; return `<tr><td class="${claseArtista}" ${eventoDblClick}>${escapeHTML(artistaNombre)}</td><td>$${p.total.toFixed(2)}</td><td>$${(p.montoPagado || 0).toFixed(2)}</td><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="table-actions"><button class="btn-secondary" onclick="app.openDocumentsModal('${p._id}')">Docs üìÑ</button><button class="btn-secondary" onclick="app.registrarPago('${p._id}', true)">Pagos üíµ</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${p._id}')">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="5">No hay proyectos completados.</td></tr>`; } catch(error) { tablaBody.innerHTML = `<tr><td colspan="5">Error al cargar historial o sin conexi√≥n.</td></tr>`; } }
      async function eliminarProyecto(id, desdeCotizaciones = false) { if (!confirm('¬øMover este proyecto a la papelera?')) return; try { await fetchAPI(`/api/proyectos/${id}`, { method: 'DELETE' }); showToast('Proyecto movido a la papelera.', 'info'); if (desdeCotizaciones) cargarCotizaciones(); else cargarHistorial(); } catch (error) { showToast(`Error al eliminar: ${error.message}`, 'error'); } }
      async function cargarOpcionesParaSelect(url, selectId, valueField, textFieldFn, addPublicoGeneral = false, currentValue = null) { const select = document.getElementById(selectId); try { const data = await fetchAPI(url); select.innerHTML = ''; if (addPublicoGeneral) { const op = document.createElement('option'); op.value = 'publico_general'; op.textContent = 'P√∫blico General'; select.appendChild(op); } data.forEach(item => { const option = document.createElement('option'); option.value = item[valueField]; option.textContent = textFieldFn(item); option.dataset.precio = item.precio || 0; select.appendChild(option); }); if (currentValue) select.value = currentValue; } catch (error) { select.innerHTML = `<option value="">Error o Offline</option>`; } }
      const cargarOpcionesParaProyecto = () => { cargarOpcionesParaSelect('/api/artistas', 'proyectoArtista', '_id', item => item.nombreArtistico || item.nombre, true); cargarOpcionesParaSelect('/api/servicios', 'proyectoServicio', '_id', item => `${item.nombre} - $${item.precio.toFixed(2)}`); }
      const cargarOpcionesParaProyectoManual = () => { cargarOpcionesParaSelect('/api/artistas', 'manualProyectoArtista', '_id', item => item.nombreArtistico || item.nombre, false); flatpickr("#manualFechaProyecto", { defaultDate: "today", locale: "es" }); };
      function agregarAProyecto() { const select = document.getElementById('proyectoServicio'); if (!select.value) return; const id = `item-${select.value}-${Date.now()}`; proyectoActual[id] = { id, servicioId: select.value, nombre: select.options[select.selectedIndex].text.split(' - ')[0], unidades: parseInt(document.getElementById('proyectoUnidades').value) || 1, precioUnitario: parseFloat(select.options[select.selectedIndex].dataset.precio) }; mostrarProyectoActual(); }
      function quitarDeProyecto(id) { delete proyectoActual[id]; mostrarProyectoActual(); }
      function mostrarProyectoActual() { const lista = document.getElementById('listaProyectoActual'); let total = 0; lista.innerHTML = Object.values(proyectoActual).map(item => { const subtotal = item.precioUnitario * item.unidades; total += subtotal; return `<li class="list-item"><span>${item.unidades}x ${escapeHTML(item.nombre)}</span><span>$${subtotal.toFixed(2)} <button class="btn-quitar-servicio" onclick="app.quitarDeProyecto('${item.id}')">X</button></span></li>`; }).join(''); document.getElementById('totalAPagar').textContent = `$${total.toFixed(2)}`; }
      async function guardarProyecto(procesoDestino) { 
          const artistaSelect = document.getElementById('proyectoArtista'); 
          const artistaId = artistaSelect.value; 
          // COMBINAR FECHA Y HORA
          const fechaInput = document.getElementById('fechaProyecto')._flatpickr.selectedDates[0];
          const horaInput = document.getElementById('horaProyecto').value;
          
          let fechaFinal = new Date();
          if(fechaInput) {
              fechaFinal = fechaInput;
              if(horaInput) {
                  const [hours, minutes] = horaInput.split(':');
                  fechaFinal.setHours(hours);
                  fechaFinal.setMinutes(minutes);
              }
          }

          if (Object.keys(proyectoActual).length === 0) { showToast('Agrega al menos un servicio.', 'error'); return null; } 
          
          const items = Object.values(proyectoActual).map(i => ({ servicio: i.servicioId, nombre: i.nombre, unidades: i.unidades, precioUnitario: i.precioUnitario }));
          const subtotal = items.reduce((sum, item) => sum + (item.precioUnitario * item.unidades), 0);
          
          // Capturar descuento
          const descuento = parseFloat(document.getElementById('proyectoDescuento').value) || 0;
          const total = Math.max(0, subtotal - descuento);

          const body = { 
              artista: artistaId === 'publico_general' ? null : artistaId, 
              nombreProyecto: document.getElementById('nombreProyecto').value, 
              items: items, 
              total: total, 
              descuento: descuento, 
              estatus: procesoDestino === 'Cotizacion' ? 'Cotizacion' : 'Pendiente de Pago', 
              metodoPago: 'Pendiente', 
              fecha: fechaFinal.toISOString(), // FECHA CON HORA
              prioridad: 'Normal', 
              proceso: procesoDestino, 
              esAlbum: document.getElementById('esAlbum').checked 
          }; 
          
          try { 
              const nuevoProyecto = await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) });
              return nuevoProyecto;
          } catch (error) { 
              showToast(`Error al registrar: ${error.message}`, 'error'); return null; 
          } 
      }

      async function guardarProyectoManual() {
        const artistaId = document.getElementById('manualProyectoArtista').value;
        const nombreProyecto = document.getElementById('manualNombreProyecto').value;
        const fecha = document.getElementById('manualFechaProyecto')._flatpickr.selectedDates[0];
        const descripcion = document.getElementById('manualDescripcion').value;
        if (!artistaId || !nombreProyecto || !fecha) {
            return showToast('Artista, Nombre del Proyecto y Fecha son obligatorios.', 'error');
        }
        const body = {
            artista: artistaId,
            nombreProyecto: nombreProyecto,
            items: [{ nombre: descripcion, unidades: 1, precioUnitario: 0 }],
            total: 0,
            estatus: 'Pagado',
            proceso: 'Agendado',
            fecha: fecha.toISOString(),
        };
        try {
            await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) });
            showToast('Proyecto guardado con √©xito.', 'success');
            document.getElementById('formProyectoManual').reset();
            mostrarSeccion('flujo-trabajo');
        } catch(e) {
            showToast(`Error al guardar: ${e.message}`, 'error');
        }
      }
      async function generarCotizacion() { 
          const nuevoProyecto = await guardarProyecto('Cotizacion'); 
          if (nuevoProyecto) { 
              if(nuevoProyecto.offline) {
                  showToast('Cotizaci√≥n guardada (Offline). El PDF se generar√° al reconectar.', 'info');
              } else {
                  showToast('Cotizaci√≥n guardada.', 'success'); 
                  await generarCotizacionPDF(nuevoProyecto._id || nuevoProyecto); 
              }
              proyectoActual = {}; 
              document.getElementById('proyectoDescuento').value = ''; // Limpiar descuento
              document.getElementById('horaProyecto').value = '';
              mostrarProyectoActual(); 
              document.getElementById('formProyecto').reset(); 
              mostrarSeccion('cotizaciones'); 
          } 
      }
      async function enviarAFlujoDirecto() { 
          const nuevoProyecto = await guardarProyecto('Agendado'); 
          if (nuevoProyecto) { 
              showToast('Proyecto guardado y agendado.', 'success'); 
              proyectoActual = {}; 
              document.getElementById('proyectoDescuento').value = ''; // Limpiar descuento
              document.getElementById('horaProyecto').value = '';
              mostrarProyectoActual(); 
              document.getElementById('formProyecto').reset(); 
              mostrarSeccion('flujo-trabajo'); 
          } 
      }
      
      async function registrarNuevoArtistaDesdeFormulario(formPrefix) {
          const inputId = formPrefix ? `${formPrefix}NombreNuevoArtista` : 'nombreNuevoArtista';
          const containerId = formPrefix ? `${formPrefix}NuevoArtistaContainer` : 'nuevoArtistaContainer';
          
          const nombreInput = document.getElementById(inputId);
          const nombre = nombreInput.value.trim();
          
          if (!nombre) {
              showToast('Por favor, introduce un nombre para el artista.', 'error');
              return;
          }
          
          try {
              // El fetchAPI maneja la creacion optimista
              await fetchAPI('/api/artistas', { method: 'POST', body: JSON.stringify({ nombre }) });
              
              const selectId = formPrefix === 'manual' ? 'manualProyectoArtista' : 'proyectoArtista';
              const addPublico = formPrefix !== 'manual';
              
              // Recargar selects desde el cach√© actualizado
              await cargarOpcionesParaSelect('/api/artistas', selectId, '_id', item => item.nombreArtistico || item.nombre, addPublico);
              
              // Seleccionar el ultimo creado (el que acabamos de meter al cache)
              const select = document.getElementById(selectId);
              select.selectedIndex = select.options.length - 1;

              document.getElementById(containerId).style.display = 'none';
              nombreInput.value = '';
          } catch (error) {
              showToast(`Error: ${error.message}`, 'error');
          }
      }

      function openEventModal(info) { 
        const props = info.event.extendedProps; 
        document.getElementById('modal-event-id').value = info.event.id;
        
        document.getElementById('modal-event-title').textContent = info.event.title; 
        document.getElementById('modal-event-date').textContent = info.event.start.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit' }); 
        document.getElementById('modal-event-total').textContent = `$${(props.total||0).toFixed(2)}`; 
        document.getElementById('modal-event-status').textContent = props.estatus; 
        document.getElementById('modal-event-process').textContent = props.proceso; 
        document.getElementById('modal-event-services').innerHTML = (props.servicios || '').split('\n').map(s => `<li>${escapeHTML(s)}</li>`).join(''); 
        
        // PRE-LLENAR INPUTS DE EDICI√ìN
        const eventDate = info.event.start;
        flatpickr("#edit-event-date", { defaultDate: eventDate, locale: "es" });
        const hours = String(eventDate.getHours()).padStart(2, '0');
        const minutes = String(eventDate.getMinutes()).padStart(2, '0');
        document.getElementById('edit-event-time').value = `${hours}:${minutes}`;

        const btnWorkflow = document.getElementById('btn-go-to-workflow'); 
        btnWorkflow.onclick = () => app.goToProjectInWorkflow(info.event.id); 
        const btnArtist = document.getElementById('btn-go-to-artist'); 
        if (props.artistaId || props.artista) { 
            btnArtist.style.display = 'block'; 
            btnArtist.onclick = () => app.goToArtistFromModal(props.artistaId || props.artista._id, props.artistaNombre || (props.artista ? props.artista.nombre : '')); 
        } else { btnArtist.style.display = 'none'; } 
        
        // NUEVO: Agregar bot√≥n cancelar en modal
        const existingCancel = document.getElementById('btn-cancelar-modal');
        if(existingCancel) existingCancel.remove();
        
        if (props.estatus !== 'Cancelado') {
            const btn = document.createElement('button');
            btn.id = 'btn-cancelar-modal';
            btn.className = 'btn-eliminar';
            btn.textContent = 'Cancelar Cita';
            btn.style.width = '100%';
            btn.style.marginTop = '1rem';
            btn.onclick = () => app.cancelarCita(info.event.id);
            document.querySelector('#event-modal .modal-content').appendChild(btn);
        }

        document.getElementById('event-modal').style.display = 'flex'; 
      }
      
      // NUEVO: CANCELAR CITA
      async function cancelarCita(id) {
          if (!confirm('¬øEst√°s seguro de cancelar esta cita?')) return;
          try {
              await fetchAPI(`/api/proyectos/${id}/estatus`, { method: 'PUT', body: JSON.stringify({ estatus: 'Cancelado' }) });
              showToast('Cita cancelada.', 'info');
              
              // Si estamos en modal, cerrarlo
              const modal = document.getElementById('event-modal');
              if (modal && modal.style.display === 'flex') closeEventModal();
              
              app.cargarAgenda();
              if (document.getElementById('flujo-trabajo').classList.contains('active')) {
                  app.filtrarFlujo(document.querySelector('#filtrosFlujo button.active')?.textContent.trim() || 'Todos');
              }
          } catch(e) {
              showToast(`Error al cancelar: ${e.message}`, 'error');
          }
      }

      async function actualizarHorarioProyecto() {
          const id = document.getElementById('modal-event-id').value;
          const newDateInput = document.getElementById('edit-event-date')._flatpickr.selectedDates[0];
          const newTimeInput = document.getElementById('edit-event-time').value;
          
          if (!newDateInput) return showToast("Selecciona una fecha v√°lida", "error");
          
          let finalDate = new Date(newDateInput);
          if (newTimeInput) {
              const [h, m] = newTimeInput.split(':');
              finalDate.setHours(h);
              finalDate.setMinutes(m);
          }
          
          try {
              await app.cambiarAtributo(id, 'fecha', finalDate.toISOString());
              showToast("Fecha y hora actualizadas correctamente", "success");
              closeEventModal();
              app.cargarAgenda(); 
          } catch(e) {
              showToast("Error al actualizar: " + e.message, "error");
          }
      }

      function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
      function goToProjectInWorkflow(projectId) { closeEventModal(); mostrarSeccion('flujo-trabajo'); setTimeout(() => { const card = document.querySelector(`.project-card[data-id="${projectId}"]`); if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); }
      function goToArtistFromModal(artistId, artistName) { closeEventModal(); irAVistaArtista(artistId, artistName, ''); }
      
      async function cargarAgenda() {
        const calendarEl = document.getElementById('calendario');
        if (currentCalendar) { currentCalendar.destroy(); }
        try {
            const eventos = await fetchAPI('/api/proyectos/agenda');
            const isMobile = window.innerWidth < 768;
            currentCalendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth,listMonth' : 'dayGridMonth,timeGridWeek,listWeek'
                },
                height: 'auto', 
                dayMaxEvents: isMobile ? false : true, 
                buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', list: 'Lista' },
                navLinks: true, editable: true, events: eventos,
                dateClick: (info) => { if (info.view.type.includes('Grid')) { mostrarSeccion('registrar-proyecto'); document.getElementById('fechaProyecto')._flatpickr.setDate(info.date); showToast(`Creando nuevo proyecto para el ${info.date.toLocaleDateString()}`, 'info'); } },
                eventClick: openEventModal,
                eventDrop: async (info) => {
                    if (!confirm(`¬øMover el proyecto de "${info.event.title}" al ${info.event.start.toLocaleDateString()}?`)) { info.revert(); return; }
                    try { await app.cambiarAtributo(info.event.id, 'fecha', info.event.start.toISOString()); showToast('Fecha actualizada.', 'success'); cargarFlujoDeTrabajo(document.querySelector('#filtrosFlujo button.active')?.textContent.trim() || 'Todos'); } catch (error) { showToast(`Error al actualizar: ${error.message}`, 'error'); info.revert(); }
                },
                eventContent: (arg) => { 
                    if(isMobile && !arg.view.type.includes('list')) {
                        return { html: '' }; 
                    } else {
                        let innerHtml = `<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title">${escapeHTML(arg.event.title)}</div></div><div class="proceso-tag-event" style="background-color: var(--proceso-${arg.event.extendedProps.proceso}, #808080)">${arg.event.extendedProps.proceso}</div></div>`; return { html: innerHtml }; 
                    }
                },
                eventDidMount: function(info) {
                    if(isMobile && !info.view.type.includes('list')) {
                        let colorVar = `var(--proceso-${info.event.extendedProps.proceso}, var(--primary-color))`;
                        info.el.style.backgroundColor = colorVar;
                    }
                }
            });
            currentCalendar.render();
        } catch (error) { calendarEl.innerHTML = '<p>Error al cargar agenda. Por favor, recarga la p√°gina o verifica tu conexi√≥n.</p>'; console.error(error); }
      }

      async function cambiarAtributo(id, campo, valor) { try { await fetchAPI(`/api/proyectos/${id}/${campo}`, { method: 'PUT', body: JSON.stringify({ [campo]: valor }) }); const proyecto = localCache.proyectos.find(p => p._id === id); if (proyecto) proyecto[campo] = valor; if (document.getElementById('flujo-trabajo').classList.contains('active')) { const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); filtrarFlujo(filtroActual); } } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function aprobarCotizacion(id) { if (!confirm('¬øAprobar esta cotizaci√≥n y moverla al Flujo de Trabajo?')) return; try { await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify({ proceso: 'Agendado' }) }); showToast('¬°Cotizaci√≥n Aprobada!', 'success'); mostrarSeccion('flujo-trabajo'); } catch(error) { showToast(`Error al aprobar: ${error.message}`, 'error'); } }
      async function compartirPorWhatsApp(proyectoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const nombreCliente = proyecto.artista ? proyecto.artista.nombre : 'cliente'; const mensaje = `¬°Hola ${nombreCliente}! Te enviamos un resumen de tu cotizaci√≥n de FiaRecords Studio.\n\nServicios:\n${proyecto.items.map(i => `- ${i.unidades}x ${i.nombre}`).join('\n')}\n\n*Total: $${proyecto.total.toFixed(2)} MXN*\n\nPara confirmar o si tienes alguna duda, cont√°ctanos. ¬°Gracias!`; const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`; window.open(url, '_blank'); } catch (error) { showToast('No se pudo cargar la informaci√≥n para compartir.', 'error'); } }
      async function registrarPago(proyectoId, desdeHistorial = false) { 
          const cache = desdeHistorial ? historialCacheados : localCache.proyectos; 
          let proyecto = cache.find(p => p._id === proyectoId); 
          if (!proyecto) { try { proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); } catch(e) { return showToast('No se pudo encontrar el proyecto.', 'error'); }} 
          
          const restante = proyecto.total - (proyecto.montoPagado || 0); 
          const montoStr = prompt(`Registrar pago para ${proyecto.artista ? (proyecto.artista.nombre || proyecto.artista) : 'P√∫blico General'}\n\nTotal del Proyecto: $${proyecto.total.toFixed(2)}\nPagado: $${(proyecto.montoPagado || 0).toFixed(2)}\nSaldo: $${restante.toFixed(2)}\n\n¬øMonto a registrar?`, restante > 0 ? restante.toFixed(2) : '0.00'); 
          if (montoStr === null) return; 
          const monto = parseFloat(montoStr); 
          if (isNaN(monto) || monto <= 0) { return showToast('Por favor, introduce un monto v√°lido.', 'error'); } 
          const metodo = prompt('M√©todo de pago (Ej: Efectivo, Transferencia):', 'Efectivo'); if (!metodo) return; 
          
          try { 
              const proyectoActualizado = await fetchAPI(`/api/proyectos/${proyectoId}/pagos`, { method: 'POST', body: JSON.stringify({ monto, metodo }) }); 
              // En offline, fetchAPI devuelve un objeto simulado, lo usamos para el recibo
              
              if(proyectoActualizado.offline) {
                  showToast('Pago registrado localmente. Recibo generado offline.', 'info');
                  // Necesitamos construir el objeto proyecto + el pago reciente para el PDF
                  const ultimoPago = proyectoActualizado.pagos[proyectoActualizado.pagos.length - 1];
                  await generarReciboPDF(proyectoActualizado, ultimoPago); 
              } else {
                  showToast('¬°Pago registrado con √©xito!', 'success'); 
                  await generarReciboPDF(proyectoActualizado, proyectoActualizado.pagos[proyectoActualizado.pagos.length - 1]); 
              }
              // Refrescar pagos si estamos en esa secci√≥n
              cargarPagos();
              if (desdeHistorial) { cargarHistorial(); } else { cargarFlujoDeTrabajo(); } 
          } catch (error) { console.error('Error registrando pago:', error); showToast(`Error al registrar el pago: ${error.message}`, 'error'); } 
      }
      async function cargarPagos() { 
          // 1. CARGAR TABLA DE DEUDAS (FILTRADO LOCAL)
          const deudaBody = document.getElementById('tablaDeudasBody');
          deudaBody.innerHTML = '';
          const deudores = localCache.proyectos.filter(p => (p.total - (p.montoPagado || 0)) > 0 && p.estatus !== 'Cancelado' && p.estatus !== 'Cotizacion');
          
          if(deudores.length) {
              deudaBody.innerHTML = deudores.map(p => `<tr>
                <td>${p.artista ? (p.artista.nombre || p.artista) : 'General'}</td>
                <td>${escapeHTML(p.nombreProyecto || 'Sin nombre')}</td>
                <td style="color:var(--danger-color); font-weight:bold;">$${(p.total - (p.montoPagado||0)).toFixed(2)}</td>
                <td class="table-actions"><button class="btn-secondary" onclick="app.registrarPago('${p._id}')">Cobrar</button></td>
              </tr>`).join('');
          } else {
              deudaBody.innerHTML = `<tr><td colspan="4">No hay cuentas por cobrar.</td></tr>`;
          }

          // 2. CARGAR HISTORIAL DE PAGOS
          const tablaBody = document.getElementById('tablaPagosBody'); 
          tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; 
          try { 
              const pagos = await fetchAPI('/api/proyectos/pagos/todos'); 
              tablaBody.innerHTML = pagos.length ? pagos.map(p => `<tr><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="clickable-artist" ondblclick="app.irAVistaArtista(null, '${escapeHTML(p.artista)}', '')">${escapeHTML(p.artista)}</td><td>$${p.monto.toFixed(2)}</td><td>${escapeHTML(p.metodo)}</td><td class="table-actions"><button class="btn-secondary" title="Reimprimir Recibo" onclick="app.reimprimirRecibo('${p.proyectoId}', '${p.pagoId}')">üìÑ</button><button class="btn-secondary" title="Compartir por WhatsApp" onclick="app.compartirPagoPorWhatsApp(JSON.stringify(${JSON.stringify(p).replace(/"/g, '&quot;')}))">üí¨</button><button class="btn-eliminar" title="Eliminar Pago" onclick="app.eliminarPago('${p.proyectoId}', '${p.pagoId}')">üóëÔ∏è</button></td></tr>`).join('') : `<tr><td colspan="5">No hay pagos registrados.</td></tr>`; 
          } catch (e) { 
              tablaBody.innerHTML = `<tr><td colspan="5">No se pueden cargar datos offline.</td></tr>`; 
          } 
      }
      async function reimprimirRecibo(proyectoId, pagoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const pago = proyecto.pagos.find(p => p._id === pagoId); if (!pago) return showToast('No se encontr√≥ el pago espec√≠fico.', 'error'); await generarReciboPDF(proyecto, pago); } catch(e) { showToast('Error al reimprimir el recibo.', 'error'); } }
      function compartirPagoPorWhatsApp(pagoString) { const pago = JSON.parse(pagoString); const mensaje = `Hola, te confirmamos tu pago a FiaRecords Studio:\n\n*Fecha:* ${new Date(pago.fecha).toLocaleDateString()}\n*Monto:* $${pago.monto.toFixed(2)} MXN\n*M√©todo:* ${pago.metodo}\n\n¬°Gracias por tu pago!`; const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`; window.open(url, '_blank'); }
      async function eliminarPago(proyectoId, pagoId) { if (!confirm('¬øEst√°s seguro de que quieres eliminar este pago? Esta acci√≥n es irreversible y afectar√° el saldo del proyecto.')) return; try { await fetchAPI(`/api/proyectos/${proyectoId}/pagos/${pagoId}`, { method: 'DELETE' }); showToast('Pago eliminado correctamente.', 'success'); cargarPagos(); } catch (error) { showToast(`Error al eliminar el pago: ${error.message}`, 'error'); } }
      async function openDocumentsModal(proyectoId) { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); if (!proyecto) return showToast('Proyecto no encontrado.', 'error'); document.getElementById('modal-project-id').value = proyectoId; document.getElementById('modal-project-id').dataset.total = proyecto.total; showDocumentSection('contrato'); const contrato = proyecto.detallesContrato || {}; document.getElementById('contrato-nombre-album').value = contrato.nombreAlbum || ''; document.getElementById('contrato-canciones').value = contrato.cantidadCanciones || ''; document.getElementById('contrato-duracion').value = contrato.duracion || ''; document.getElementById('contrato-pago-inicial').value = contrato.pagoInicial || ''; document.getElementById('contrato-pago-final').value = contrato.pagoFinal || ''; calcularSaldoContrato(); const dist = proyecto.detallesDistribucion || {}; document.getElementById('dist-titulo').value = dist.tituloLanzamiento || ''; document.getElementById('dist-fecha').value = dist.fechaLanzamiento ? new Date(dist.fechaLanzamiento).toISOString().split('T')[0] : ''; document.getElementById('dist-upc').value = dist.upc || ''; const tracksContainer = document.getElementById('dist-tracks-container'); tracksContainer.innerHTML = ''; (dist.tracks && dist.tracks.length > 0 ? dist.tracks : [{titulo: '', isrc: ''}]).forEach(track => addTrackField(track.titulo, track.isrc)); document.getElementById('document-modal').style.display = 'flex'; }
      function closeDocumentsModal() { document.getElementById('document-modal').style.display = 'none'; }
      function showDocumentSection(sectionName) { document.querySelectorAll('.document-section').forEach(s => s.classList.remove('active')); document.querySelectorAll('#document-modal .filter-buttons button').forEach(b => b.classList.remove('active')); document.getElementById(`section-${sectionName}`).classList.add('active'); document.getElementById(`btn-show-${sectionName}`).classList.add('active'); }
      function addTrackField(titulo = '', isrc = '') { const container = document.getElementById('dist-tracks-container'); const trackDiv = document.createElement('div'); trackDiv.className = 'form-row'; trackDiv.innerHTML = `<div class="form-group"><input type="text" class="dist-track-titulo" placeholder="T√≠tulo del Track" value="${escapeHTML(titulo)}"></div><div class="form-group"><input type="text" class="dist-track-isrc" placeholder="C√≥digo ISRC" value="${escapeHTML(isrc)}"></div>`; container.appendChild(trackDiv); }
      function calcularSaldoContrato() { const total = parseFloat(document.getElementById('modal-project-id').dataset.total) || 0; const inicial = parseFloat(document.getElementById('contrato-pago-inicial').value) || 0; const final = total - inicial; document.getElementById('contrato-pago-final').value = final > 0 ? final.toFixed(2) : '0.00'; }
      async function saveAndGenerateContract() { const proyectoId = document.getElementById('modal-project-id').value; const data = { nombreAlbum: document.getElementById('contrato-nombre-album').value, cantidadCanciones: parseInt(document.getElementById('contrato-canciones').value), duracion: document.getElementById('contrato-duracion').value, pagoInicial: parseFloat(document.getElementById('contrato-pago-inicial').value), pagoFinal: parseFloat(document.getElementById('contrato-pago-final').value) }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'contrato', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarContratoPDF(proyectoCompleto); closeDocumentsModal(); }
      async function saveAndGenerateDistribution() { const proyectoId = document.getElementById('modal-project-id').value; const tracks = []; document.querySelectorAll('#dist-tracks-container .form-row').forEach(row => { const titulo = row.querySelector('.dist-track-titulo').value; const isrc = row.querySelector('.dist-track-isrc').value; if (titulo) tracks.push({ titulo, isrc }); }); const data = { tituloLanzamiento: document.getElementById('dist-titulo').value, fechaLanzamiento: document.getElementById('dist-fecha').value, upc: document.getElementById('dist-upc').value, tracks }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'distribucion', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarDistribucionPDF(proyectoCompleto); closeDocumentsModal(); }
      
      // --- NUEVO: FUNCION PARA INVERTIR COLOR DE LOGO (CANVAS) ---
      async function getInvertedLogoDataUrl(logoBase64) {
          return new Promise((resolve) => {
              const img = new Image();
              img.src = logoBase64;
              img.onload = () => {
                  const canvas = document.createElement('canvas');
                  canvas.width = img.width;
                  canvas.height = img.height;
                  const ctx = canvas.getContext('2d');
                  // Invertir colores: negro -> blanco, blanco -> negro
                  ctx.filter = 'invert(1)';
                  ctx.drawImage(img, 0, 0);
                  resolve(canvas.toDataURL('image/png'));
              };
              img.onerror = () => resolve(null);
          });
      }

      function getFinalCoordinates(pos) { let baseX, baseY; switch(pos.vAlign) { case 'top': baseY = PDF_DIMENSIONS.MARGIN; break; case 'middle': baseY = (PDF_DIMENSIONS.HEIGHT / 2) - (pos.h / 2); break; default: baseY = PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN; } switch(pos.hAlign) { case 'left': baseX = PDF_DIMENSIONS.MARGIN; break; case 'center': baseX = (PDF_DIMENSIONS.WIDTH / 2) - (pos.w / 2); break; default: baseX = PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN; } let finalX = baseX + pos.offsetX; let finalY = baseY + pos.offsetY; finalX = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalX, PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN)); finalY = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalY, PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN)); return { x: finalX, y: finalY, w: pos.w, h: pos.h }; }
      async function addFirmaToPdf(pdf, docType, finalFileName, proyecto) { const firmaPath = (configCache && configCache.firmaPath) ? configCache.firmaPath : '/uploads/firma.png'; try { const response = await fetch(firmaPath); if (!response.ok) throw new Error('Imagen de firma no encontrada.'); const firmaImg = await response.blob(); const reader = new FileReader(); reader.readAsDataURL(firmaImg); reader.onloadend = function() { try { const base64data = reader.result; const pos = getFinalCoordinates(configCache.firmaPos[docType]); if (docType === 'contrato') { pdf.line(PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 2, PDF_DIMENSIONS.MARGIN + 70, pos.y + pos.h + 2); pdf.text(proyecto.artista.nombre, PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 7); pdf.text('Firma del Cliente', PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 12); } pdf.addImage(base64data, 'PNG', pos.x, pos.y, pos.w, pos.h); pdf.line(pos.x, pos.y + pos.h + 2, pos.x + pos.w, pos.y + pos.h + 2); pdf.text("Erick Resendiz", pos.x, pos.y + pos.h + 7); pdf.text("Representante de FIA Records", pos.x, pos.y + pos.h + 12); } catch (e) { console.error("Error al procesar firma:", e); } finally { pdf.save(finalFileName); } } } catch(e) { console.warn(e.message); pdf.save(finalFileName); } }
      
      async function generarCotizacionPDF(proyectoIdOrObject) { 
          try { 
              const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; 
              const { jsPDF } = window.jspdf; const pdf = new jsPDF(); 
              
              // --- INVERTIR LOGO PARA QUE SE VEA NEGRO EN PDF ---
              if (logoBase64) {
                  // Si tienes un logo blanco (para modo oscuro), necesitamos invertirlo a negro para el PDF
                  const blackLogo = await getInvertedLogoDataUrl(logoBase64);
                  pdf.addImage(blackLogo, 'PNG', 14, 15, 40, 15);
              } 
              
              pdf.setFontSize(9); pdf.text("Monte Everest #318 Col. Monte Verde 5to sector Ju√°rez N.L.", 200, 20, { align: 'right' }); pdf.text("Tel. 8132520539", 200, 25, { align: 'right' }); pdf.text("fiarec.studio@gmail.com", 200, 30, { align: 'right' }); pdf.setFontSize(11); pdf.text(`Cliente: ${proyecto.artista ? (proyecto.artista.nombre || proyecto.artista) : 'P√∫blico General'}`, 14, 50); pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).toUpperCase()}`, 200, 50, { align: 'right' }); pdf.text("Descripci√≥n del Servicio:", 14, 65); const body = proyecto.items.map(item => [`${item.unidades}x ${item.nombre}`, `$${(item.precioUnitario * item.unidades).toFixed(2)}`]); 
              if (proyecto.descuento && proyecto.descuento > 0) { body.push(['Descuento', `-$${proyecto.descuento.toFixed(2)}`]); }
              pdf.autoTable({ startY: 70, head: [['Servicio', 'Subtotal']], body: body, theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255] } }); let finalY = pdf.lastAutoTable.finalY + 10; pdf.setFontSize(12); pdf.setFont(undefined, 'bold'); pdf.text("Precio del Servicio:", 14, finalY); pdf.text(`$${proyecto.total.toFixed(2)} MXN`, 200, finalY, { align: 'right' }); finalY += 15; pdf.setFont(undefined, 'normal'); pdf.text("Condiciones:", 14, finalY); pdf.setFontSize(9); pdf.text("1. La cotizaci√≥n es v√°lida por 30 d√≠as.", 14, finalY + 5); pdf.text("2. Se requiere un dep√≥sito del 50% para reservar la fecha.", 14, finalY + 10); pdf.text("3. El saldo restante debe pagarse antes de la entrega final del material.", 14, finalY + 15); finalY += 30; pdf.setFontSize(10); pdf.text("Agradecemos tu confianza y esperamos trabajar juntos en tu proyecto.", 105, finalY, { align: 'center' }); const fileName = `Cotizacion-${proyecto.artista ? (proyecto.artista.nombre || proyecto.artista).replace(/\s/g, '_') : 'General'}.pdf`; await addFirmaToPdf(pdf, 'cotizacion', fileName, proyecto); 
          } catch (error) { showToast("Error al generar el PDF.", 'error'); console.error(error); } 
      }
      async function generarReciboPDF(proyecto, pagoEspecifico) { try { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const pago = pagoEspecifico || proyecto.pagos[proyecto.pagos.length - 1]; if (!pago) return showToast('No hay pago para generar recibo.', 'error'); const esPagoFinal = proyecto.montoPagado >= proyecto.total; const saldoRestante = proyecto.total - proyecto.montoPagado; if (logoBase64) { const blackLogo = await getInvertedLogoDataUrl(logoBase64); pdf.addImage(blackLogo, 'PNG', 14, 15, 40, 15); } pdf.setFontSize(9); pdf.text("Monte Everest #318 Col. Monte Verde 5to sector Ju√°rez N.L.", 200, 20, { align: 'right' }); pdf.text("Tel. 8132520539", 200, 25, { align: 'right' }); pdf.text("fiarec.studio@gmail.com", 200, 30, { align: 'right' }); pdf.setFontSize(11); pdf.text(new Date(pago.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).toUpperCase(), 14, 45); pdf.line(14, 47, 200, 47); pdf.setFontSize(16); pdf.setFont(undefined, 'bold').text(`RECIBO DE PAGO ${esPagoFinal && saldoRestante <= 0 ? 'FINAL' : 'PARCIAL'}`, 105, 55, { align: 'center' }); pdf.setFontSize(11); pdf.setFont(undefined, 'normal'); pdf.text(`Recib√≠ de: ${proyecto.artista ? (proyecto.artista.nombre || proyecto.artista) : 'P√∫blico General'}`, 14, 70); pdf.text("Concepto:", 14, 85); const conceptos = proyecto.items.map(item => `- ${item.nombre || 'Servicio'}`); conceptos.forEach((line, i) => pdf.text(line, 16, 92 + (i * 7))); let finalY = 92 + (conceptos.length * 7) + 5; pdf.autoTable({ startY: finalY, theme: 'plain', styles: { fontSize: 11 }, body: [['Total del Proyecto:', `$${proyecto.total.toFixed(2)} MXN`], ['Este Pago:', `$${pago.monto.toFixed(2)} MXN`], ['Saldo Restante:', `$${saldoRestante.toFixed(2)} MXN`]], columnStyles: { 0: { fontStyle: 'bold', halign: 'left' }, 1: { halign: 'right' } } }); finalY = pdf.lastAutoTable.finalY + 7; pdf.text("M√©todo de Pago:", 14, finalY); pdf.text(pago.metodo, 200, finalY, { align: 'right' }); finalY += 15; pdf.line(14, finalY, 200, finalY); finalY += 10; pdf.setFontSize(9); pdf.text("Notas: Este recibo es prueba del pago recibido por los servicios mencionados.", 14, finalY); finalY += 10; pdf.text("T√©rminos y Condiciones:", 14, finalY); pdf.text("1. Los anticipos no son reembolsables.", 14, finalY + 5); pdf.text("2. Si el saldo pendiente no se liquida, no se entregar√° el material grabado.", 14, finalY + 10); const fileName = `Recibo-${proyecto.artista ? (proyecto.artista.nombre || proyecto.artista).replace(/\s/g, '_') : 'General'}.pdf`; await addFirmaToPdf(pdf, 'recibo', fileName, proyecto); } catch (error) { showToast('Error al generar el recibo.', 'error'); console.error(error); }}
      async function generarContratoPDF(proyectoIdOrObject) { try { const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const c = proyecto.detallesContrato; if (logoBase64) { const blackLogo = await getInvertedLogoDataUrl(logoBase64); pdf.addImage(blackLogo, 'PNG', 14, 15, 40, 15); } pdf.setFontSize(18).setFont(undefined, 'bold').text('CONTRATO DE SERVICIOS DE GRABACI√ìN DE AUDIO', 105, 40, { align: 'center', maxWidth: 180 }); pdf.setFontSize(10).setFont(undefined, 'normal'); pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 14, 55); pdf.text('Entre:', 14, 65); pdf.setFont(undefined, 'bold').text('FIA RECORDS (en adelante, "El Estudio")', 20, 72); pdf.text(`EL CLIENTE: ${proyecto.artista.nombre} (en adelante, "El Cliente")`, 20, 79); pdf.setFont(undefined, 'normal').text('Ambas partes acuerdan lo siguiente:', 14, 89); pdf.autoTable({ startY: 95, theme: 'grid', styles: { fontSize: 10, cellPadding: 2 }, headStyles: { fillColor: [0,0,0], textColor: [255,255,255] }, head: [['Objeto del Contrato']], body: [[`El Estudio se compromete a proporcionar servicios de grabaci√≥n para el √°lbum "${c.nombreAlbum || 'N/A'}" de ${c.cantidadCanciones || 'varias'} canciones, bajo los t√©rminos descritos.`]]}); pdf.autoTable({ startY: pdf.lastAutoTable.finalY + 5, headStyles: { fillColor: [0,0,0], textColor: [255,255,255] }, head: [['Servicios Incluidos']], body: [proyecto.items.map(i => `- ${i.nombre}`)] }); let finalY = pdf.lastAutoTable.finalY; pdf.setFont(undefined, 'bold').text('T√©rminos y Condiciones:', 14, finalY += 10); const terminos = `1. Duraci√≥n del Contrato: Este contrato tiene una duraci√≥n de ${c.duracion || '[sin especificar]'}, comenzando a partir de la primera sesi√≥n de grabaci√≥n.\n2. Sesiones de Grabaci√≥n: La grabaci√≥n se realizar√° seg√∫n lo acordado. Las sesiones deben ser programadas con anticipaci√≥n.\n3. Tarifa y Forma de Pago: El Cliente pagar√° un total de $${proyecto.total.toFixed(2)}. El pago se realizar√° de la siguiente manera: un pago inicial de $${(c.pagoInicial || 0).toFixed(2)} y el saldo de $${(c.pagoFinal || 0).toFixed(2)} antes de la √∫ltima sesi√≥n.\n4. Pol√≠tica de Cancelaci√≥n: Si El Cliente necesita cancelar o reprogramar, deber√° notificar con al menos 24 horas de anticipaci√≥n. Cancelaciones tard√≠as pueden incurrir en una tarifa de $200.\n5. Entrega del Trabajo: El Estudio entregar√° las versiones mezcladas y masterizadas dentro de 10 d√≠as despu√©s de la grabaci√≥n final de cada pista, en formato digital (WAV, MP3).\n6. Propiedad Intelectual: Los derechos de autor permanecer√°n con El Cliente, siempre que se cumplan todos los pagos. El Estudio se reserva el derecho de usar fragmentos para su portafolio.\n7. Responsabilidad: El Cliente es responsable de proporcionar el material necesario (letras, etc.).\n8. Modificaciones: Cualquier modificaci√≥n a este contrato deber√° ser por escrito y firmada por ambas partes.\n9. Ley Aplicable: Este contrato se regir√° por las leyes de Nuevo Le√≥n, M√©xico.`; pdf.setFontSize(9).setFont(undefined, 'normal').text(terminos, 14, finalY + 5, { maxWidth: 180, lineHeightFactor: 1.5 }); const fileName = `Contrato-${proyecto.artista.nombre.replace(/\s/g, '_')}.pdf`; await addFirmaToPdf(pdf, 'contrato', fileName, proyecto); } catch (e) { showToast("Error al generar Contrato PDF", 'error'); console.error(e); }}
      async function generarDistribucionPDF(proyecto) { try { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const d = proyecto.detallesDistribucion; pdf.setFontSize(16).setFont(undefined, 'bold').text('ENTREGA PARA DISTRIBUCI√ìN DIGITAL', 105, 20, { align: 'center' }); pdf.setFontSize(10).setFont(undefined, 'normal'); pdf.text(`Fecha de Entrega: ${new Date().toLocaleDateString('es-ES')}`, 14, 35); pdf.autoTable({ startY: 40, theme: 'plain', styles: { fontSize: 10 }, body: [ ['Artista:', proyecto.artista.nombre], ['T√≠tulo del Lanzamiento:', d.tituloLanzamiento], ['Fecha de Lanzamiento:', new Date(d.fechaLanzamiento).toLocaleDateString('es-ES')], ['UPC/EAN:', d.upc] ] }); pdf.autoTable({ startY: pdf.lastAutoTable.finalY + 5, head: [['Listado de Pistas (Tracklist)']], body: d.tracks.map((t, i) => [`Pista ${i+1}: ${t.titulo}\n    C√≥digo ISRC: ${t.isrc || 'N/A'}`]) }); let finalY = pdf.lastAutoTable.finalY + 10; const confirmacion = 'Por medio de este documento, Fia Records confirma la recepci√≥n de los c√≥digos de identificaci√≥n y la metadata final para el lanzamiento mencionado. El material de audio masterizado ha sido entregado y aprobado por el artista.'; pdf.text(confirmacion, 14, finalY, { maxWidth: 180, align: 'justify' }); const fileName = `Distribucion-${d.tituloLanzamiento.replace(/\s/g, '_')}.pdf`; await addFirmaToPdf(pdf, 'distribucion', fileName, proyecto); } catch (e) { showToast("Error al generar PDF de Distribuci√≥n", 'error'); console.error(e); }}

      window.app = { eliminarItem, editarItem, restaurarItem, vaciarPapelera, cambiarProceso, filtrarFlujo, eliminarProyecto, quitarDeProyecto, cambiarAtributo, aprobarCotizacion, generarCotizacionPDF, compartirPorWhatsApp, registrarPago, reimprimirRecibo, compartirPagoPorWhatsApp, eliminarPago, openDocumentsModal, closeDocumentsModal, showDocumentSection, saveAndGenerateContract, saveAndGenerateDistribution, addTrackField, mostrarVistaArtista, irAVistaArtista, calcularSaldoContrato, cargarAjustesParaDocumento, actualizarPosicionFirma, guardarAjustesFirma, revertirADefecto, guardarDatosBancarios, generarContratoPDF, openEventModal, closeEventModal, goToProjectInWorkflow, goToArtistFromModal, openDeliveryModal, closeDeliveryModal, saveDeliveryLink, sendDeliveryByWhatsapp, guardarProyectoManual, editarNombreProyecto, filtrarTablas, actualizarHorarioProyecto, cargarAgenda, cancelarCita, cargarPagos };
    });
  </script>
</body>
</html>