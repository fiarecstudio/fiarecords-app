<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>FiaRecords Studio - Gesti√≥n</title>
  
  <link rel="preconnect" href="https://fonts.googleapis.com"><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script><script src="https://npmcdn.com/flatpickr/dist/l10n/es.js"></script>
  <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.plugin.autotable.min.js"></script>
  
  <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
  <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>

  <style>
    body { visibility: hidden; }
    :root {
      --primary-color: #4f46e5; --primary-hover: #4338ca; --danger-color: #ef4444; --success-color: #22c55e; --warning-color: #f59e0b;
      --background-color: #f8fafc; --card-background: #ffffff; --text-color-dark: #1e293b; --text-color-light: #64748b;
      --border-color: #e2e8f0; --shadow: 0 4px 6px -1px rgb(0 0 0 / 0.1); --form-control-bg: #ffffff;
      --secondary-button-bg: #f1f5f9; --secondary-button-text: #1e293b; --secondary-button-hover-bg: #e2e8f0;
    }
    body.dark-mode {
      --background-color: #1e293b; --card-background: #334155; --text-color-dark: #f1f5f9; --text-color-light: #94a3b8;
      --border-color: #475569; --form-control-bg: #475569;
      --secondary-button-bg: #475569; --secondary-button-text: #f1f5f9; --secondary-button-hover-bg: #525f75;
      --fc-button-bg-color: var(--secondary-button-bg); --fc-button-text-color: var(--secondary-button-text);
      --fc-button-border-color: var(--border-color); --fc-button-hover-bg-color: var(--secondary-button-hover-bg);
      --fc-button-active-bg-color: var(--primary-color); --fc-today-bg-color: rgba(255, 255, 255, 0.05);
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Poppins', sans-serif; background-color: var(--background-color); color: var(--text-color-dark); }
    #app-logo, #login-logo { max-width: 180px; max-height: 80px; object-fit: contain; }
    body:not(.dark-mode) #app-logo, body:not(.dark-mode) #login-logo { filter: invert(1); }
    .main-content { flex: 1; display: flex; flex-direction: column; height: 100vh; overflow-y: auto; }
    .main-header { display: flex; align-items: center; justify-content: space-between; padding: 1rem 2rem; background-color: var(--card-background); border-bottom: 1px solid var(--border-color); flex-shrink: 0; }
    main { padding: 1rem; flex: 1; }
    @media (min-width: 768px) { main { padding: 2rem; } }
    section { display: none; }
    section.active { display: block; }

    .sidebar { width: 260px; background-color: var(--card-background); border-right: 1px solid var(--border-color); display: flex; flex-direction: column; padding: 1.5rem 1rem; height: 100vh; height: 100dvh; }
    .sidebar-header { text-align: center; margin-bottom: 1rem; flex-shrink: 0; }
    #app-logo { cursor: pointer; }
    .sidebar-nav { display: flex; flex-direction: column; gap: 0.5rem; flex: 1; overflow-y: auto; padding-right: 5px; }
    .sidebar-footer { margin-top: auto; padding-top: 1rem; border-top: 1px solid var(--border-color); flex-shrink: 0; display: flex; flex-direction: column; gap: 1rem; background-color: var(--card-background); }
    #btn-nuevo-proyecto-sidebar { background-color: var(--primary-color); color: white; text-align: center; padding: 0.75rem; border-radius: 8px; margin-bottom: 1.5rem; font-weight: 600; cursor: pointer; transition: background-color 0.2s; flex-shrink: 0; }
    #btn-nuevo-proyecto-sidebar:hover { background-color: var(--primary-hover); }
    .nav-group summary { list-style: none; padding: 0.75rem 1rem; font-weight: 700; color: var(--text-color-dark); cursor: pointer; position: relative; }
    .nav-group summary::before { content: '‚ñ∫'; position: absolute; left: 0; font-size: 0.6em; transition: transform 0.2s; }
    .nav-group[open] > summary::before { transform: rotate(90deg); }
    .nav-group ul { list-style: none; padding-left: 1.5rem; }
    .nav-link { display: flex; align-items: center; gap: 0.75rem; padding: 0.6rem 1rem; border-radius: 8px; text-decoration: none; color: var(--text-color-light); font-weight: 500; cursor: pointer; }
    .nav-link.active-link { background-color: var(--primary-color); color: white; }

    #hamburger-menu, #btn-enviar-datos-bancarios { display: none; background: none; border: none; cursor: pointer; padding: 0.5rem; }
    #hamburger-menu svg, #btn-enviar-datos-bancarios svg { width: 24px; height: 24px; stroke: var(--text-color-dark); }
    .header-actions { display: flex; align-items: center; gap: 1rem;}
    #sidebar-overlay { display: none; position: fixed; inset: 0; background-color: rgba(0,0,0,0.5); z-index: 998; }

    @media (max-width: 768px) {
      #app-wrapper { display: block; }
      #hamburger-menu, #btn-enviar-datos-bancarios { display: block; }
      .main-header { padding: 0.5rem 1rem; }
      .sidebar { position: fixed; left: 0; top: 0; z-index: 999; transform: translateX(-100%); transition: transform 0.3s ease-in-out; width: 85%; max-width: 300px; }
      .sidebar.sidebar-visible { transform: translateX(0); }
      #sidebar-overlay.overlay-visible { display: block; }
    }
    @media (min-width: 769px) {
      #app-wrapper { display: flex; height: 100vh; overflow: hidden; }
      #hamburger-menu { display: none; }
      #btn-enviar-datos-bancarios { display: block; }
    }
    
    .card { background-color: var(--card-background); border-radius: 12px; padding: 1.5rem; margin-bottom: 2rem; box-shadow: var(--shadow); }
    .card-header h2 { font-size: 1.25rem; font-weight: 600; }
    .card h3 { display: flex; justify-content: space-between; align-items: center; margin-top: 1.5rem; margin-bottom: 1rem; font-weight: 600; border-bottom: 1px solid var(--border-color); padding-bottom: 0.5rem; }
    form label { display: block; margin-bottom: 0.5rem; font-weight: 500; }
    form input, form select, form textarea { width: 100%; padding: 0.75rem; border: 1px solid var(--border-color); border-radius: 8px; margin-bottom: 1rem; background-color: var(--form-control-bg); color: var(--text-color-dark); }
    .password-wrapper { position: relative; }
    #toggle-password { position: absolute; right: 1rem; top: 50%; transform: translateY(-50%); cursor: pointer; }
    button { cursor: pointer; border-radius: 8px; border: none; padding: 0.75rem 1.25rem; font-weight: 600; }
    button[type="submit"] { background-color: var(--primary-color); color: white; }
    .btn-eliminar, .btn-vaciar { background-color: var(--danger-color); color: white !important; }
    .btn-secondary { background-color: var(--secondary-button-bg); color: var(--secondary-button-text); }
    .btn-restaurar { background-color: var(--success-color); color: white; }
    .btn-vaciar { padding: 0.4rem 0.8rem; font-size: 0.8em; }
    .btn-aprobar { background-color: var(--success-color); color: white; padding: 0.4rem 0.8rem; font-size: 0.9em; white-space: nowrap; }
    #logout-button { width: 100%; }
    
    .list-item-actions button, .table-actions button { display: inline-flex; align-items: center; justify-content: center; padding: 0.5rem; font-size: 1em; line-height: 1; width: 36px; height: 36px; margin-left: 0.5rem; }
    .table-actions .btn-aprobar { width: auto; height: auto; padding: 0.4rem 0.8rem; }
    .project-card-footer button { padding: 0.4rem 0.8rem; font-size: 0.85em; }
    .btn-quitar-servicio { width: 24px; height: 24px; font-size: 0.8em; line-height: 1; border-radius: 50%; padding: 0; }
    
    .grid-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1.5rem; }
    
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 0.75rem; text-align: left; border-bottom: 1px solid var(--border-color); vertical-align: middle; }
    
    @media (max-width: 768px) {
        .table-responsive table, .table-responsive thead, .table-responsive tbody, .table-responsive th, .table-responsive td, .table-responsive tr { display: block; }
        .table-responsive thead tr { position: absolute; top: -9999px; left: -9999px; }
        .table-responsive tr { margin-bottom: 1.5rem; border: 1px solid var(--border-color); border-radius: 12px; padding: 1rem; background-color: var(--card-background); box-shadow: var(--shadow); }
        .table-responsive td { border: none; border-bottom: 1px solid var(--border-color); position: relative; padding-left: 40% !important; padding-top: 0.5rem; padding-bottom: 0.5rem; text-align: right; white-space: normal; }
        .table-responsive td:last-child { border-bottom: none; padding-top: 1rem; display: flex; justify-content: flex-end; padding-left: 0 !important; }
        .table-responsive td:before { position: absolute; top: 0.5rem; left: 0.5rem; width: 35%; padding-right: 10px; white-space: nowrap; text-align: left; font-weight: 700; color: var(--text-color-light); }
        #tablaCotizacionesBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaCotizacionesBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaCotizacionesBody td:nth-of-type(3):before { content: "Fecha:"; }
        #tablaCotizacionesBody td:nth-of-type(4):before { content: ""; display: none; }
        #tablaPagosBody td:nth-of-type(1):before { content: "Fecha:"; }
        #tablaPagosBody td:nth-of-type(2):before { content: "Proyecto:"; }
        #tablaPagosBody td:nth-of-type(3):before { content: "Monto:"; }
        #tablaPagosBody td:nth-of-type(4):before { content: "M√©todo:"; }
        #tablaPagosBody td:nth-of-type(5):before { content: ""; display: none; }
        #tablaHistorialBody td:nth-of-type(1):before { content: "Artista:"; }
        #tablaHistorialBody td:nth-of-type(2):before { content: "Total:"; }
        #tablaHistorialBody td:nth-of-type(3):before { content: "Pagado:"; }
        #tablaHistorialBody td:nth-of-type(4):before { content: "Fecha:"; }
        #tablaHistorialBody td:nth-of-type(5):before { content: ""; display: none; }
        #vista-artista-contenido .table-responsive tr { display: flex; flex-direction: column; }
        #vista-artista-contenido .table-responsive td { padding-left: 0 !important; text-align: left; }
        #vista-artista-contenido .table-responsive td:before { display: none; } 
        #vista-artista-contenido .table-responsive td:nth-child(1) { font-weight: bold; color: var(--primary-color); }
    }

    .clickable-artist { cursor: pointer; text-decoration: underline; color: var(--text-color-dark); }
    body.dark-mode .clickable-artist { color: var(--text-color-dark); }
    #login-container { max-width: 400px; margin: 15vh auto; }
    .list-item { display: flex; justify-content: space-between; align-items: center; padding: 0.75rem; border-radius: 8px; margin-bottom: 0.5rem; border: 1px solid var(--border-color); }
    .table-actions { display: flex; align-items: center; flex-wrap: nowrap; }
    .theme-toggle-container { display: flex; justify-content: space-between; align-items: center; padding: 0.5rem 0; }
    .theme-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
    .theme-switch input { opacity: 0; width: 0; height: 0; }
    .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; }
    .slider:before { position: absolute; content: ""; height: 18px; width: 18px; left: 4px; bottom: 4px; background-color: white; border-radius: 50%; transition: .4s; }
    input:checked + .slider { background-color: var(--primary-color); }
    input:checked + .slider:before { transform: translateX(24px); }
    .form-row { display: flex; gap: 1rem; }
    .form-group { flex: 1; }
    .info-row { display: flex; justify-content: space-between; align-items: center; font-size: 1.1rem; }
    #totalAPagar { font-size: 1.3rem; font-weight: 700; }
    .kpi-card { text-align: center; }
    .kpi-value { font-size: 2.5rem; font-weight: 700; color: var(--primary-color); }
    .kpi-label { font-size: 1rem; color: var(--text-color-light); }
    .kanban-board { display: grid; grid-template-columns: repeat(auto-fill, minmax(320px, 1fr)); gap: 1.5rem; }
    .kanban-column { background-color: var(--secondary-button-bg); border-radius: 12px; padding: 1rem; display: none; }
    .kanban-column h3 { text-align: center; margin: 0; padding: 0.5rem; border-bottom: 2px solid var(--border-color); margin-bottom: 1rem; font-size: 1.1em; }
    .project-card { background: var(--card-background); padding: 1rem; border-radius: 8px; margin-bottom: 1rem; box-shadow: var(--shadow); border-left: 5px solid; transition: box-shadow 0.2s ease; }
    .project-card:hover { box-shadow: 0 8px 16px -4px rgba(0,0,0,0.2); }
    .project-card-header { font-weight: 600; font-size: 1.1em; margin-bottom: 0.5rem; display: flex; justify-content: space-between; align-items: center; }
    .project-card-header-main { display: flex; align-items: center; gap: 0.5rem; }
    .project-card-body ul { list-style: none; padding-left: 0; margin: 0.5rem 0; font-size: 0.9em; color: var(--text-color-light); }
    .project-card-footer { border-top: 1px solid var(--border-color); margin-top: 1rem; padding-top: 0.75rem; display: flex; justify-content: space-between; align-items: center; }
    .status-badge { padding: 3px 10px; border-radius: 16px; font-size: 0.75em; color: white; }
    .filter-buttons { display: flex; gap: 0.5rem; margin-bottom: 1.5rem; flex-wrap: wrap; }
    .filter-buttons button { padding: 0.5rem 1rem; font-size: 0.9em; }
    .filter-buttons button.active { background-color: var(--primary-color); color: white; }
    .proceso-tag { padding: 3px 10px; border-radius: 16px; color: white; font-size: 0.75em; display: inline-block; margin-top: 8px; }
    #artista-selector-container, #manual-artista-selector-container { display: flex; gap: 0.5rem; align-items: flex-start; }
    #nuevoArtistaContainer, #manualNuevoArtistaContainer { display: none; }
    .status-tag { padding: 0.25rem 0.75rem; border-radius: 16px; font-size: 0.8em; font-weight: 600; color: white; text-align: center; display: inline-block; }
    td select { padding: 0.4rem; margin: 0; font-size: 0.9em; border-radius: 6px; }
    
    #calendario { --fc-border-color: var(--border-color); --fc-event-border-color: transparent; min-height: 550px; }
    .fc-event { cursor: pointer; padding: 4px; font-size: 0.85em; }
    .fc-daygrid-event-dot { display: none; }
    .fc-event-time { font-weight: bold; }
    .fc-event-title { white-space: normal; }
    .fc .fc-daygrid-day-frame { cursor: pointer; }
    .fc-event-main-frame { display: flex; flex-direction: column; }
    .proceso-tag-event { font-size: 0.75em; padding: 2px 6px; border-radius: 10px; color: white; align-self: flex-start; margin-top: 4px; }
    .fc .fc-daygrid-day-number { text-decoration: none; color: var(--text-color-light); }
    .fc .fc-toolbar-title { font-size: 1.25em; }
    .fc .fc-button { background-color: var(--fc-button-bg-color, var(--secondary-button-bg)); color: var(--fc-button-text-color, var(--secondary-button-text)); border-color: var(--fc-button-border-color, var(--border-color)); }
    .fc .fc-button:hover { background-color: var(--fc-button-hover-bg-color, var(--secondary-button-hover-bg)); }
    .fc .fc-button-primary:not(:disabled).fc-button-active { background-color: var(--fc-button-active-bg-color, var(--primary-color)); }
    .fc .fc-day-today { background-color: var(--fc-today-bg-color, rgba(79, 70, 229, 0.05)); }
    
    .fc .fc-col-header-cell-cushion { text-decoration: none; color: var(--text-color-light); }
    body.dark-mode .fc-col-header-cell-cushion { color: var(--text-color-dark); }
    body.dark-mode .fc th { background-color: transparent; }

    body.dark-mode .fc-list-day-cushion { background-color: var(--card-background); }
    body.dark-mode .fc-list-day-text, body.dark-mode .fc-list-day-side-text, body.dark-mode .fc-list-event-title a { color: var(--text-color-dark) !important; }
    body.dark-mode .fc-list-table td { border-color: var(--border-color); }
    body.dark-mode .fc-list-event-time, body.dark-mode .fc .fc-list-empty { color: var(--text-color-light); }

    #agenda .card { padding: 0.5rem; }
    @media (min-width: 768px) { #agenda .card { padding: 1.5rem; } }
    
    @media (max-width: 768px) {
        .fc .fc-toolbar { flex-wrap: wrap; justify-content: center; gap: 0.5rem; }
        .fc .fc-toolbar-title { font-size: 1.1em; order: -1; width: 100%; text-align: center; }
        .fc .fc-button { padding: 0.4rem 0.6rem; font-size: 0.8em; }
        .fc-view-harness { min-height: 400px; }
        .fc-list-event { display: flex; flex-direction: column; align-items: flex-start; gap: 0.25rem; padding: 0.5rem; }
        .fc-list-event-title { font-weight: 600; font-size: 0.9em; }
        .fc-list-event-time { font-size: 0.8em; color: var(--text-color-light); }
    }
    .fc { max-width: 100%; margin: 0 auto; }
    
    .form-actions { display: flex; gap: 1rem; margin-top: 1rem; }
    .form-actions button { flex: 1; }
    .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 1000; }
    .modal-content { background: var(--card-background); padding: 2rem; border-radius: 12px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; }
    .modal-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem; }
    .modal-header h2 { margin: 0; }
    .modal-close { font-size: 1.5rem; cursor: pointer; background: none; border: none; color: var(--text-color-dark); }
    .document-section { display: none; }
    .document-section.active { display: block; }
    #dist-tracks-container .form-row { margin-bottom: 0.5rem; }
    
    .alignment-group { margin-bottom: 1rem; padding: 0.5rem; border: 1px solid var(--border-color); border-radius: 8px; }
    .alignment-group legend { font-weight: 600; padding: 0 0.5rem; }
    .alignment-group div { display: flex; justify-content: space-around; }
    .alignment-group label { cursor: pointer; }
    input[type="range"] { -webkit-appearance: none; appearance: none; width: 100%; height: 8px; background: var(--secondary-button-hover-bg); border-radius: 5px; outline: none; margin-top: 0.5rem; }
    input[type="range"]::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; }
    input[type="range"]::-moz-range-thumb { width: 20px; height: 20px; background: var(--primary-color); cursor: pointer; border-radius: 50%; border: none; }
    #config-layout { display: flex; flex-wrap: wrap; gap: 2rem; }
    #config-controls { flex: 1 1 400px; }
    #config-preview { flex: 1 1 350px; min-width: 350px; }
    #firma-preview-container { position: relative; width: 100%; aspect-ratio: 210 / 297; max-height: 500px; border: 2px dashed var(--border-color); background-color: var(--background-color); box-shadow: var(--shadow); overflow: hidden; }
    #firma-draggable-preview { position: absolute; top: 0; left: 0; transform-origin: top left; transition: all 0.1s linear; pointer-events: none; border: 1px solid rgba(0,0,0,0.2); object-fit: contain; }
    .doc-template { display: none; width: 100%; height: 100%; padding: 20px; font-family: 'Times New Roman', Times, serif; font-size: 8px; color: var(--text-color-light); line-height: 1.4; }
    .doc-template.template-visible { display: block; }
    .doc-template h4 { font-size: 12px; text-align: center; margin-bottom: 20px; font-weight: bold; }
    .doc-template .line { border-top: 0.5px solid var(--text-color-light); margin: 5px 0; }
    .doc-template .signature-area { position: absolute; bottom: 30px; transform: translateY(0); }
    .doc-template .signature-line { width: 80px; }
    #contract-signature-block { position: absolute; bottom: 30px; left: 20px; right: 20px; display: flex; justify-content: space-between; transform: translateY(0); transition: transform 0.1s linear; }
    .doc-template .signature-line-small { width: 70px; }
    #template-contrato .signature-area-rep { position: relative; width: 45%; }
    #template-contrato .signature-area-client { width: 45%; }
    .doc-template p { margin: 2px 0; }
    .doc-template ol { padding-left: 15px; margin: 0;}
    .doc-template li { margin-bottom: 3px; }

    .toastify.toast-success { background: var(--success-color); }
    .toastify.toast-error { background: var(--danger-color); }
    .toastify.toast-info { background: var(--primary-color); }
  </style>
</head>
<body>
  <div id="login-container" class="card"><div style="text-align: center; margin-bottom: 1.5rem;"><img id="login-logo" src="https://via.placeholder.com/180x80?text=FiaRecords" alt="Logotipo"></div><form id="login-form"><div><label for="username">Usuario</label><input type="text" id="username" required></div><div><label for="password">Contrase√±a</label><div class="password-wrapper"><input type="password" id="password" required><span id="toggle-password">üëÅÔ∏è</span></div></div><button type="submit" style="width:100%;">Entrar</button><p id="login-error" style="color: var(--danger-color); text-align: center; margin-top: 1rem;"></p></form></div>
  
  <div id="app-wrapper">
    <div id="sidebar-overlay"></div>
    <nav class="sidebar">
      <div class="sidebar-header"><img id="app-logo" src="https://via.placeholder.com/180x80?text=FiaRecords" alt="Logotipo"></div>
      
      <a id="btn-nuevo-proyecto-sidebar" class="nav-link" data-seccion="registrar-proyecto"><span>+ Nuevo Proyecto</span></a>
      
      <div class="sidebar-nav">
        <details class="nav-group" open>
          <summary>PROYECTOS</summary>
          <ul>
            <li><a class="nav-link" data-seccion="dashboard"><span>Dashboard</span></a></li>
            <li><a class="nav-link" data-seccion="agenda"><span>Agenda</span></a></li>
            <li><a class="nav-link" data-seccion="flujo-trabajo"><span>Flujo de Trabajo</span></a></li>
            <li><a class="nav-link" data-seccion="cotizaciones"><span>Cotizaciones</span></a></li>
            <li><a class="nav-link" data-seccion="historial-proyectos"><span>Historial</span></a></li>
            <li><a class="nav-link" data-seccion="pagos"><span>Pagos</span></a></li>
            <li><a class="nav-link" data-seccion="registro-manual"><span>Registro Manual</span></a></li>
          </ul>
        </details>
        
        <details class="nav-group">
          <summary>GESTI√ìN</summary>
          <ul>
            <li><a class="nav-link" data-seccion="gestion-artistas"><span>Artistas</span></a></li>
            <li><a class="nav-link" data-seccion="gestion-servicios"><span>Servicios</span></a></li>
            <li><a class="nav-link" data-seccion="gestion-usuarios"><span>Usuarios</span></a></li>
          </ul>
        </details>
        
        <details class="nav-group">
          <summary>SISTEMA</summary>
          <ul>
            <li><a class="nav-link" data-seccion="configuracion"><span>Configuraci√≥n</span></a></li>
            <li><a class="nav-link" data-seccion="papelera-reciclaje"><span>Papelera</span></a></li>
          </ul>
        </details>
      </div>
      
      <div class="sidebar-footer">
        <div id="customization-container" style="display: none;">
          <p style="font-size: 0.8em; text-align: center; margin-bottom: 1rem;">Haz clic en el logo para cambiarlo.</p>
          <input type="file" id="logo-input" accept="image/*" style="display: none;">
        </div>
        <div class="theme-toggle-container">
          <span>Modo Oscuro</span>
          <label class="theme-switch">
            <input type="checkbox" id="theme-switch" />
            <span class="slider"></span>
          </label>
        </div>
        <button id="logout-button" class="btn-eliminar">Cerrar Sesi√≥n</button>
      </div>
    </nav>

    <div class="main-content">
        <header class="main-header">
            <button id="hamburger-menu">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2.5" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
                </svg>
            </button>
            <div id="welcome-user"></div>
            <div class="header-actions">
              <button id="btn-enviar-datos-bancarios" title="Enviar Datos Bancarios">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 8.25h19.5M2.25 9h19.5m-16.5 5.25h6m-6 2.25h3m-3.75 3h15a2.25 2.25 0 002.25-2.25V6.75A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25v10.5A2.25 2.25 0 004.5 19.5z" />
                </svg>
              </button>
            </div>
        </header>
        <main>
            <section id="dashboard"><div class="grid-container"><div class="card kpi-card"><div class="kpi-value" id="kpi-ingresos-mes">$0.00</div><div class="kpi-label">Ingresos del Mes</div></div><div class="card kpi-card"><div class="kpi-value" id="kpi-proyectos-activos">0</div><div class="kpi-label">Proyectos Activos</div></div><div class="card kpi-card"><div class="kpi-value" id="kpi-proyectos-por-cobrar">0</div><div class="kpi-label">Proyectos por Cobrar</div></div></div></section>
            <section id="agenda"><div class="card"><div id="calendario"></div></div></section>
            <section id="cotizaciones"><div class="card"><div class="card-header"><h2>Cotizaciones Pendientes</h2></div><div class="table-responsive"><table><thead><tr><th>Artista</th><th>Total</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tablaCotizacionesBody"></tbody></table></div></div></section>
            <section id="flujo-trabajo"><div class="card"><div class="card-header"><h2>Flujo de Trabajo</h2></div><div class="filter-buttons" id="filtrosFlujo"></div><div class="kanban-board" id="kanbanBoard"></div></div></section>
            <section id="pagos"><div class="card"><div class="card-header"><h2>Historial de Pagos</h2></div><div class="table-responsive"><table><thead><tr><th>Fecha</th><th>Artista / Proyecto</th><th>Monto</th><th>M√©todo</th><th>Acciones</th></tr></thead><tbody id="tablaPagosBody"></tbody></table></div></div></section>
            <section id="registrar-proyecto"><div class="card" style="max-width: 800px; margin: auto;"><div class="card-header"><h2>Nuevo Proyecto o Cotizaci√≥n</h2></div><form id="formProyecto" onsubmit="return false;"><label for="proyectoArtista">Artista/Cliente</label><div id="artista-selector-container"><select id="proyectoArtista"><option value="publico_general">P√∫blico General</option></select><button type="button" id="btnNuevoArtista" title="Registrar nuevo artista">+</button></div>
              <div id="nuevoArtistaContainer"><label>Nombre del Nuevo Artista</label><div class="form-row" style="align-items: center; gap: 0.5rem;"><input type="text" id="nombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;"><button type="button" id="btnGuardarNuevoArtista" class="btn-secondary" style="margin-bottom: 0; white-space: nowrap; flex-shrink: 0; padding: 0.75rem;">Guardar</button></div></div>
              <div><label for="nombreProyecto">Nombre del Proyecto (Opcional)</label><input type="text" id="nombreProyecto" /></div><div><input type="checkbox" id="esAlbum" name="esAlbum" style="width: auto; margin-right: 0.5rem;"><label for="esAlbum" style="display: inline;">Es un Disco/EP</label></div><hr style="margin: 1.5rem 0; border: none; border-top: 1px solid var(--border-color);"><h3>A√±adir Servicios</h3><div class="form-row"><div class="form-group"><label for="proyectoServicio">Servicio</label><select id="proyectoServicio"></select></div><div class="form-group"><label for="proyectoUnidades">Unidades</label><input type="number" id="proyectoUnidades" min="1" value="1"></div></div><button type="button" id="btnAgregarAProyecto" style="width:100%;">Agregar Servicio</button><ul id="listaProyectoActual" style="list-style: none; padding: 0; margin-top: 1.5rem;"></ul><div style="margin-top: 2rem; border-top: 1px solid var(--border-color); padding-top: 1.5rem;"><div class="info-row"><label>Total:</label><span id="totalAPagar">$0.00</span></div><div class="form-row"><div class="form-group"><label for="fechaProyecto">Fecha de Inicio</label><input type="text" id="fechaProyecto"></div></div><div class="form-actions"><button id="btnGenerarCotizacion" style="background-color: var(--primary-color); color: white;">Generar Cotizaci√≥n y PDF</button><button id="btnEnviarAFlujo" class="btn-secondary">Guardar y Agendar</button></div></div></form></div></section>
            <section id="registro-manual"><div class="card" style="max-width: 800px; margin: auto;"><div class="card-header"><h2>Registro Manual de Proyecto</h2><p style="font-size: 0.9em; color: var(--text-color-light);">Usa este formulario para proyectos sin costo, antiguos o que no requieren cotizaci√≥n.</p></div><form id="formProyectoManual" onsubmit="return false;"><label for="manualProyectoArtista">Artista/Cliente</label><div id="manual-artista-selector-container"><select id="manualProyectoArtista" required></select><button type="button" id="manualBtnNuevoArtista" title="Registrar nuevo artista">+</button></div>
              <div id="manualNuevoArtistaContainer"><label>Nombre del Nuevo Artista</label><div class="form-row" style="align-items: center; gap: 0.5rem;"><input type="text" id="manualNombreNuevoArtista" placeholder="Nombre del artista" style="margin-bottom: 0;"><button type="button" id="btnGuardarManualNuevoArtista" class="btn-secondary" style="margin-bottom: 0; white-space: nowrap; flex-shrink: 0; padding: 0.75rem;">Guardar</button></div></div>
              <label for="manualNombreProyecto">Nombre del Proyecto</label><input type="text" id="manualNombreProyecto" required /><label for="manualFechaProyecto">Fecha de Inicio</label><input type="text" id="manualFechaProyecto" required /><label for="manualDescripcion">Descripci√≥n (Servicios realizados)</label><textarea id="manualDescripcion" rows="3"></textarea><button type="button" onclick="app.guardarProyectoManual()">Guardar Proyecto</button></form></div></section>
            <section id="historial-proyectos"><div class="card"><div class="card-header"><h2>Historial de Proyectos Completados</h2></div><div class="table-responsive"><table><thead><tr><th>Artista</th><th>Total</th><th>Pagado</th><th>Fecha</th><th>Acciones</th></tr></thead><tbody id="tablaHistorialBody"></tbody></table></div></div></section>
            <section id="vista-artista"><div class="card"><div class="card-header"><h2 id="vista-artista-nombre"></h2></div><div id="vista-artista-contenido"></div></div></section>
            <section id="gestion-servicios"><div class="card"><div class="card-header"><h2>Gesti√≥n de Servicios</h2></div><form id="formServicios"><input type="hidden" id="idServicio"><input type="text" id="nombreServicio" placeholder="Nombre" required /><input type="number" step="0.01" id="precioServicio" placeholder="Precio" required /><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormServicios" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Servicios Existentes</h3><ul id="listaServicios"></ul></div></section>
            <section id="gestion-artistas"><div class="card"><div class="card-header"><h2>Gesti√≥n de Artistas</h2></div><form id="formArtistas"><input type="hidden" id="idArtista"><div class="form-row"><div class="form-group"><label for="nombreArtista">Nombre Real</label><input type="text" id="nombreArtista" required /></div><div class="form-group"><label for="nombreArtisticoArtista">Nombre Art√≠stico</label><input type="text" id="nombreArtisticoArtista" /></div></div><div class="form-row"><div class="form-group"><label for="telefonoArtista">Tel√©fono</label><input type="tel" id="telefonoArtista" /></div><div class="form-group"><label for="correoArtista">Correo Electr√≥nico</label><input type="email" id="correoArtista" /></div></div><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormArtistas" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Artistas Registrados</h3><ul id="listaArtistas"></ul></div></section>
            <section id="gestion-usuarios"><div class="card"><div class="card-header"><h2>Gesti√≥n de Usuarios</h2></div><form id="formUsuarios"><input type="hidden" id="idUsuario"><input type="text" id="usernameUsuario" placeholder="Usuario" required /><input type="password" id="passwordUsuario" placeholder="Contrase√±a (dejar en blanco para no cambiar)" /><select id="roleUsuario" required><option value="">-- Rol --</option><option value="ingeniero">Ingeniero</option><option value="admin">Administrador</option></select><button type="submit">Guardar</button><button type="button" class="btn-secondary" id="btnLimpiarFormUsuarios" style="margin-left: 1rem;">Limpiar</button></form><h3 style="margin-top: 2rem;">Usuarios Existentes</h3><ul id="listaUsuarios"></ul></div></section>
            <section id="papelera-reciclaje"><div class="card"><h3>Servicios Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('servicios')">Vaciar</button></h3><ul id="papeleraServicios"></ul><h3>Artistas Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('artistas')">Vaciar</button></h3><ul id="papeleraArtistas"></ul><h3>Usuarios Eliminados<button class="btn-vaciar" onclick="app.vaciarPapelera('usuarios')">Vaciar</button></h3><ul id="papeleraUsuarios"></ul></div></section>
            
            <section id="configuracion">
              <div class="card">
                <div class="card-header"><h2>Configuraci√≥n del Sistema</h2></div>
                <h3>Gesti√≥n de la Firma Digital</h3>
                <div class="form-row" style="align-items: center; gap: 2rem; margin-bottom: 2rem;">
                  <div class="form-group" style="flex: 0 0 150px;">
                    <label>Firma Actual</label>
                    <img id="firma-preview-img" src="https://via.placeholder.com/150x60?text=Cargando..." alt="Firma" style="width: 150px; height: auto; border: 1px solid var(--border-color); border-radius: 8px;">
                    <input type="file" id="firma-input" accept="image/png" style="display: none;">
                    <button onclick="document.getElementById('firma-input').click()" class="btn-secondary" style="width: 100%; margin-top: 0.5rem;">Cambiar Imagen</button>
                  </div>
                  <div class="form-group" style="flex: 1;">
                    <p>Usa los presets de alineaci√≥n y los controles de ajuste fino para posicionar la firma. El sistema evitar√° que se salga de los m√°rgenes.</p>
                    <p style="font-size: 0.9em; color: var(--text-color-light);">La imagen se guarda al seleccionarla. Los ajustes de posici√≥n se guardan con el bot√≥n de abajo.</p>
                  </div>
                </div>
                <hr style="margin: 2rem 0;">
                <h3>Ajuste de Posici√≥n y Tama√±o de la Firma</h3>
                <div id="config-layout">
                  <div id="config-controls">
                    <label for="doc-type-selector">Selecciona el tipo de documento a configurar:</label>
                    <select id="doc-type-selector" onchange="app.cargarAjustesParaDocumento(this.value)" style="margin-bottom: 1rem;">
                      <option value="cotizacion">Cotizaci√≥n</option>
                      <option value="recibo">Recibo de Pago</option>
                      <option value="contrato">Contrato de Grabaci√≥n</option>
                      <option value="distribucion">Hoja de Distribuci√≥n</option>
                    </select>
                    <fieldset class="alignment-group">
                        <legend>Alineaci√≥n Vertical</legend>
                        <div id="v-align-group">
                            <label><input type="radio" name="vAlign" value="top" onchange="app.actualizarPosicionFirma()"> Encabezado</label>
                            <label><input type="radio" name="vAlign" value="middle" onchange="app.actualizarPosicionFirma()"> Cuerpo</label>
                            <label><input type="radio" name="vAlign" value="bottom" onchange="app.actualizarPosicionFirma()"> Pie de p√°gina</label>
                        </div>
                    </fieldset>
                    <fieldset class="alignment-group">
                        <legend>Alineaci√≥n Horizontal</legend>
                        <div id="h-align-group">
                            <label><input type="radio" name="hAlign" value="left" onchange="app.actualizarPosicionFirma()"> Izquierda</label>
                            <label><input type="radio" name="hAlign" value="center" onchange="app.actualizarPosicionFirma()"> Centro</label>
                            <label><input type="radio" name="hAlign" value="right" onchange="app.actualizarPosicionFirma()"> Derecha</label>
                        </div>
                    </fieldset>
                    <div class="form-row">
                        <div class="form-group"><label>Ancho (W): <span id="val-firma-w">0</span></label><input type="range" id="slider-firma-w" min="10" max="150" value="50" oninput="app.actualizarPosicionFirma()"></div>
                        <div class="form-group"><label>Alto (H): <span id="val-firma-h">0</span></label><input type="range" id="slider-firma-h" min="10" max="80" value="20" oninput="app.actualizarPosicionFirma()"></div>
                    </div>
                    <div class="form-row">
                        <div class="form-group"><label>Ajuste Fino Horizontal (X): <span id="val-firma-offsetX">0</span></label><input type="range" id="slider-firma-offsetX" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()"></div>
                        <div class="form-group"><label>Ajuste Fino Vertical (Y): <span id="val-firma-offsetY">0</span></label><input type="range" id="slider-firma-offsetY" min="-50" max="50" value="0" oninput="app.actualizarPosicionFirma()"></div>
                    </div>
                    <div class="form-actions">
                      <button onclick="app.guardarAjustesFirma()" style="flex: 2;">Guardar Ajustes</button>
                      <button onclick="app.revertirADefecto()" class="btn-secondary" style="flex: 1;">Revertir a Predeterminado</button>
                    </div>
                  </div>
                  <div id="config-preview">
                    <label>Previsualizaci√≥n en Vivo</label>
                    <div id="firma-preview-container">
                      <div id="template-cotizacion" class="doc-template"><h4>Cotizaci√≥n FIA Records</h4><p>Cliente: Nombre del Cliente</p><div class="line"></div><p>...</p><br><p>Total: $XXXX.XX</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <div id="template-recibo" class="doc-template"><h4>Recibo de Pago</h4><p>Recib√≠ de: Nombre del Cliente</p><p>Concepto: ...</p><div class="line"></div><p>Saldo Restante: $XXXX.XX</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <div id="template-contrato" class="doc-template">
                          <p style="font-weight: bold;">T√©rminos y Condiciones:</p>
                          <ol>
                              <li>Duraci√≥n del Contrato: ...</li><li>...</li><li>Propiedad Intelectual: Los derechos de autor permanecer√°n con El Cliente...</li><li>Responsabilidad: El Cliente es responsable de proporcionar el material...</li><li>Modificaciones: Cualquier modificaci√≥n a este contrato deber√° ser por escrito...</li><li>Ley Aplicable: Este contrato se regir√° por las leyes de Nuevo Le√≥n, M√©xico.</li>
                          </ol>
                          <div id="contract-signature-block">
                            <div class="signature-area-client"><div class="line signature-line-small"></div><p>Firma del Cliente</p></div>
                            <div class="signature-area-rep"></div>
                          </div>
                      </div>
                      <div id="template-distribucion" class="doc-template"><h4>Hoja de Distribuci√≥n</h4><p>Artista: Nombre del Artista</p><p>Lanzamiento: Nombre del Album</p><div class="line"></div><p>...</p><div class="signature-area"><div class="line signature-line"></div><p>Erick Resendiz</p><p>Representante FIA Records</p></div></div>
                      <img id="firma-draggable-preview" src="https://via.placeholder.com/150x60?text=Firma" alt="Previsualizaci√≥n de Firma">
                    </div>
                  </div>
                </div>
                <hr style="margin: 2rem 0;">
                <h3>Datos Bancarios</h3>
                <form id="form-datos-bancarios">
                  <div class="form-row"><div class="form-group"><label for="banco">Banco</label><input type="text" id="banco" /></div><div class="form-group"><label for="titular">Titular de la Cuenta</label><input type="text" id="titular" /></div></div>
                  <div class="form-row"><div class="form-group"><label for="tarjeta">N√∫mero de Tarjeta</label><input type="text" id="tarjeta" /></div><div class="form-group"><label for="clabe">CLABE Interbancaria</label><input type="text" id="clabe" /></div></div>
                  <button type="button" onclick="app.guardarDatosBancarios()">Guardar Datos Bancarios</button>
                </form>
              </div>
            </section>

        </main>
    </div>
  </div>

  <div id="document-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="modal-title">Generar Documentos</h2>
        <button class="modal-close" onclick="app.closeDocumentsModal()">√ó</button>
      </div>
      <input type="hidden" id="modal-project-id">
      <div class="filter-buttons">
          <button id="btn-show-contrato" class="active" onclick="app.showDocumentSection('contrato')">Contrato de Grabaci√≥n</button>
          <button id="btn-show-distribucion" onclick="app.showDocumentSection('distribucion')">Distribuci√≥n Digital</button>
      </div>
      <div id="section-contrato" class="document-section active">
        <h3>Detalles del Contrato</h3>
        <label for="contrato-nombre-album">Nombre del √Ålbum/EP</label>
        <input type="text" id="contrato-nombre-album">
        <label for="contrato-canciones">Cantidad de Canciones</label>
        <input type="number" id="contrato-canciones">
        <label for="contrato-duracion">Duraci√≥n del Contrato (incluir unidad, ej: 3 Semanas, 1 Mes)</label>
        <input type="text" id="contrato-duracion">
        <label for="contrato-pago-inicial">Pago Inicial ($)</label>
        <input type="number" id="contrato-pago-inicial" oninput="app.calcularSaldoContrato()">
        <label for="contrato-pago-final">Saldo Restante ($)</label>
        <input type="number" id="contrato-pago-final" readonly>
        <button onclick="app.saveAndGenerateContract()" style="width: 100%; margin-top: 1rem;">Guardar y Generar Contrato PDF</button>
      </div>
      <div id="section-distribucion" class="document-section">
        <h3>Detalles de Distribuci√≥n</h3>
        <label for="dist-titulo">T√≠tulo del Lanzamiento (√Ålbum/Sencillo)</label>
        <input type="text" id="dist-titulo">
        <label for="dist-fecha">Fecha de Lanzamiento</label>
        <input type="text" id="dist-fecha">
        <label for="dist-upc">C√≥digo UPC/EAN</label>
        <input type="text" id="dist-upc" placeholder="C√≥digo de barras del √°lbum">
        <hr style="margin: 1.5rem 0;">
        <h4>Tracks y C√≥digos ISRC</h4>
        <div id="dist-tracks-container"></div>
        <button onclick="app.addTrackField()" class="btn-secondary" style="width: 100%; margin-bottom: 1rem;">+ A√±adir Track</button>
        <button onclick="app.saveAndGenerateDistribution()" style="width: 100%;">Guardar y Generar Documento PDF</button>
      </div>
    </div>
  </div>
  
  <div id="event-modal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h2 id="modal-event-title">Detalles del Proyecto</h2>
            <button class="modal-close" onclick="app.closeEventModal()">√ó</button>
        </div>
        <p><strong>Fecha:</strong> <span id="modal-event-date"></span></p>
        <p><strong>Total:</strong> <span id="modal-event-total"></span></p>
        <p><strong>Estado:</strong> <span id="modal-event-status"></span></p>
        <p><strong>Proceso:</strong> <span id="modal-event-process"></span></p>
        <h4 style="margin-top: 1rem; margin-bottom: 0.5rem;">Servicios:</h4>
        <ul id="modal-event-services" style="list-style-position: inside; padding-left: 0;"></ul>
        <div class="form-actions" style="margin-top: 1.5rem;">
            <button id="btn-go-to-workflow" class="btn-secondary" onclick="">Ir al Flujo de Trabajo</button>
            <button id="btn-go-to-artist" onclick="">Ver Historial del Artista</button>
        </div>
    </div>
  </div>
  
  <div id="delivery-modal" class="modal-overlay">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Gestionar Entrega de Proyecto</h2>
        <button class="modal-close" onclick="app.closeDeliveryModal()">√ó</button>
      </div>
      <input type="hidden" id="delivery-project-id">
      <input type="hidden" id="delivery-artist-name">
      <input type="hidden" id="delivery-project-name">
      <div class="form-group">
        <label for="delivery-link-input">Enlace de Descarga (Google Drive, WeTransfer, etc.)</label>
        <input type="url" id="delivery-link-input" placeholder="Pega el enlace aqu√≠">
      </div>
      <div class="form-actions">
        <button class="btn-secondary" onclick="app.saveDeliveryLink()">Guardar Enlace</button>
        <button onclick="app.sendDeliveryByWhatsapp()">Enviar por WhatsApp</button>
      </div>
    </div>
  </div>
  
  <script>
    document.addEventListener('DOMContentLoaded', () => {
      let isInitialized = false; let proyectoActual = {}; let proyectosCacheados = []; let historialCacheados = []; let currentCalendar = null; let configCache = null; const API_URL = '';
      const DOMElements = { loginContainer: document.getElementById('login-container'), appWrapper: document.getElementById('app-wrapper'), logoutButton: document.getElementById('logout-button'), welcomeUser: document.getElementById('welcome-user'), appLogo: document.getElementById('app-logo'), loginLogo: document.getElementById('login-logo'), customizationContainer: document.getElementById('customization-container'), logoInput: document.getElementById('logo-input'), };
      
      const PDF_DIMENSIONS = { WIDTH: 210, HEIGHT: 297, MARGIN: 14 };

      function showToast(message, type = 'success') {
          const options = { text: message, duration: 3000, gravity: "top", position: "right", className: `toast-${type}` };
          Toastify(options).showToast();
      }

      async function imageExists(url) { try { const response = await fetch(url, { method: 'HEAD' }); return response.ok; } catch (e) { return false; } }
      
      async function loadPublicLogo() {
          try {
              const res = await fetch(`${API_URL}/api/configuracion/public/logo`);
              if (!res.ok) return;
              const data = await res.json();
              if (data && data.filePath) {
                  const cacheBuster = `?t=${new Date().getTime()}`;
                  const logoSrc = data.filePath + cacheBuster;
                  DOMElements.loginLogo.src = logoSrc;
                  DOMElements.appLogo.src = logoSrc;
              }
          } catch (e) {
              console.error("No se pudo precargar el logo:", e);
          }
      }

      async function loadInitialConfig() { try { const config = await fetchAPI('/api/configuracion'); configCache = config; if (config.logoPath) { DOMElements.appLogo.src = config.logoPath + `?t=${new Date().getTime()}`; } } catch (e) { console.error("Error cargando configuraci√≥n inicial:", e); } }
      function applyTheme(theme) { document.body.classList.toggle('dark-mode', theme === 'dark'); document.getElementById('theme-switch').checked = (theme === 'dark'); localStorage.setItem('theme', theme); }
      
      (async function init() { 
        await loadPublicLogo();
        applyTheme(localStorage.getItem('theme') || 'light'); 
        const token = localStorage.getItem('token'); 
        if (token) { 
            try { 
                const payload = JSON.parse(atob(token.split('.')[1])); 
                if (payload.exp * 1000 < Date.now()) return showLogin(); 
                await showApp(payload); 
            } catch (e) { showLogin(); } 
        } else { 
            showLogin(); 
        } 
      })();

      async function showApp(payload) { 
        if (!configCache) await loadInitialConfig();
        DOMElements.welcomeUser.textContent = `Bienvenido, ${payload.username}`; 
        const esAdmin = payload.role === 'admin'; 
        document.querySelector('[data-seccion="gestion-usuarios"]').style.display = esAdmin ? 'flex' : 'none'; 
        document.querySelector('[data-seccion="papelera-reciclaje"]').style.display = esAdmin ? 'flex' : 'none'; 
        document.querySelector('[data-seccion="configuracion"]').style.display = esAdmin ? 'flex' : 'none'; 
        DOMElements.customizationContainer.style.display = esAdmin ? 'block' : 'none'; 
        DOMElements.loginContainer.style.display = 'none'; 
        DOMElements.appWrapper.style.display = window.innerWidth <= 768 ? 'block' : 'flex'; 
        if (!isInitialized) { initAppEventListeners(payload); isInitialized = true; } 
        const lastSection = sessionStorage.getItem('lastActiveSection'); 
        mostrarSeccion(lastSection || 'dashboard'); 
        document.body.style.visibility = 'visible'; 
      }
      function showLogin() { localStorage.removeItem('token'); DOMElements.loginContainer.style.display = 'block'; DOMElements.appWrapper.style.display = 'none'; document.body.style.visibility = 'visible'; }
      document.getElementById('login-form').addEventListener('submit', async (e) => { e.preventDefault(); try { const res = await fetch(`${API_URL}/auth/login`, { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ username: username.value, password: password.value }) }); const data = await res.json(); if (!res.ok) throw new Error(data.error); localStorage.setItem('token', data.token); sessionStorage.removeItem('lastActiveSection'); await showApp(JSON.parse(atob(data.token.split('.')[1]))); } catch (error) { document.getElementById('login-error').textContent = error.message; } });
      DOMElements.logoutButton.addEventListener('click', showLogin);
      async function fetchAPI(url, options = {}) { const token = localStorage.getItem('token'); if (!token) { showLogin(); throw new Error('No autenticado'); } const headers = { 'Authorization': `Bearer ${token}` }; if (!options.isFormData) { headers['Content-Type'] = 'application/json'; } const res = await fetch(`${API_URL}${url}`, { ...options, headers }); if (res.status === 401) { showLogin(); throw new Error('Sesi√≥n expirada.'); } if (res.status === 204 || (options.method === 'DELETE' && res.ok)) return {ok: true}; const data = await res.json(); if (!res.ok) throw new Error(data.error || 'Error del servidor'); return data; }
      function mostrarSeccion(id) { 
        document.querySelectorAll('section').forEach(sec => sec.classList.remove('active')); 
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active-link')); 
        const seccionActiva = document.getElementById(id); 
        const linkActivo = document.querySelector(`.nav-link[data-seccion="${id}"]`); 
        if (seccionActiva) { 
            seccionActiva.classList.add('active'); 
            if(linkActivo) {
                linkActivo.classList.add('active-link');
                document.querySelectorAll('.nav-group').forEach(group => group.removeAttribute('open'));
                const parentGroup = linkActivo.closest('.nav-group');
                if (parentGroup) parentGroup.setAttribute('open', '');
            }
            sessionStorage.setItem('lastActiveSection', id); 
            const loadDataActions = { 'dashboard': cargarDashboard, 'agenda': cargarAgenda, 'cotizaciones': cargarCotizaciones, 'flujo-trabajo': cargarFlujoDeTrabajo, 'pagos': cargarPagos, 'registrar-proyecto': cargarOpcionesParaProyecto, 'registro-manual': cargarOpcionesParaProyectoManual, 'historial-proyectos': cargarHistorial, 'gestion-servicios': () => renderList('servicios'), 'gestion-artistas': () => renderList('artistas', true), 'gestion-usuarios': () => renderList('usuarios'), 'papelera-reciclaje': cargarPapelera, 'configuracion': cargarConfiguracion, }; 
            loadDataActions[id]?.(); 
        } 
      }
      async function renderList(endpoint, makeClickable = false) { 
          const listId = `lista${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; 
          try { 
              const data = await fetchAPI(`/api/${endpoint}`); 
              document.getElementById(listId).innerHTML = data.length ? data.map(item => { 
                  let displayName; 
                  if (endpoint === 'artistas') {
                      displayName = `${item.nombreArtistico || item.nombre} ${item.nombreArtistico ? `(${item.nombre})` : ''}`;
                  } else if (endpoint === 'usuarios') {
                      displayName = `${item.username || 'Usuario'} (${item.role})`;
                  } else {
                      displayName = `${item.nombre || 'Sin Nombre'} - $${item.precio.toFixed(2)}`;
                  }
                  const clickHandler = makeClickable ? `ondblclick="app.irAVistaArtista('${item._id}', '${item.nombre}')"` : '';
                  return `<li class="list-item" ${clickHandler} style="${makeClickable ? 'cursor:pointer;' : ''}"><span>${displayName}</span><div class="list-item-actions"><button class="btn-secondary" onclick="event.stopPropagation(); app.editarItem('${item._id}', '${endpoint}')">‚úèÔ∏è</button><button class="btn-eliminar" onclick="event.stopPropagation(); app.eliminarItem('${item._id}', '${endpoint}')">üóëÔ∏è</button></div></li>`; 
              }).join('') : `<li>No hay elementos.</li>`; 
          } catch (e) { document.getElementById(listId).innerHTML = `<li>Error al cargar.</li>`; } 
      }
      async function cargarPapelera() { const endpoints = ['servicios', 'artistas', 'usuarios']; for (const endpoint of endpoints) { const listId = `papelera${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`; try { const data = await fetchAPI(`/api/${endpoint}/papelera/all`); document.getElementById(listId).innerHTML = data.length ? data.map(item => `<li class="list-item"><span>${item.nombre || item.username}</span><div class="list-item-actions"><button class="btn-restaurar" onclick="app.restaurarItem('${item._id}', '${endpoint}')">‚Ü©Ô∏è</button><button class="btn-eliminar" onclick="app.eliminarPermanente('${item._id}', '${endpoint}')">‚ùå</button></div></li>`).join('') : `<li>Papelera vac√≠a.</li>`; } catch (e) { document.getElementById(listId).innerHTML = `<li>Error al cargar.</li>`; } } }
      function limpiarForm(formId) { const form = document.getElementById(formId); form.reset(); const idInput = form.querySelector('input[type="hidden"]'); if(idInput) idInput.value = ''; form.querySelector('button[type="submit"]').textContent = 'Guardar'; }
      async function saveItem(e, type) { 
          e.preventDefault(); 
          const form = e.target; 
          const id = form.querySelector('input[type="hidden"]')?.value; 
          let body; 
          if (type === 'servicios') { 
              body = { nombre: form.nombreServicio.value, precio: parseFloat(form.precioServicio.value) }; 
          } else if (type === 'artistas') {
              body = { nombre: form.nombreArtista.value, nombreArtistico: form.nombreArtisticoArtista.value, telefono: form.telefonoArtista.value, correo: form.correoArtista.value };
          } else if (type === 'usuarios') { 
              body = { username: form.usernameUsuario.value, role: form.roleUsuario.value }; 
              const password = form.passwordUsuario.value; 
              if (!id && !password) { showToast('La contrase√±a es obligatoria para nuevos usuarios.', 'error'); return; } 
              if (password) body.password = password; 
          } 
          const method = id ? 'PUT' : 'POST'; 
          const url = `/api/${type}/${id || ''}`; 
          try { 
              await fetchAPI(url, { method, body: JSON.stringify(body) }); 
              showToast(`Elemento ${id ? 'actualizado' : 'guardado'} con √©xito.`, 'success'); 
              limpiarForm(form.id); 
              mostrarSeccion(`gestion-${type}`); 
          } catch (error) { showToast(`Error: ${error.message}`, 'error'); } 
      }
      async function eliminarItem(id, endpoint) { if (!confirm(`¬øMover a la papelera?`)) return; try { await fetchAPI(`/api/${endpoint}/${id}`, { method: 'DELETE' }); showToast('Movido a la papelera.', 'info'); mostrarSeccion(`gestion-${endpoint}`); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function editarItem(id, endpoint) { 
          try { 
              const item = await fetchAPI(`/api/${endpoint}/${id}`); 
              const form = document.getElementById(`form${endpoint.charAt(0).toUpperCase() + endpoint.slice(1)}`); 
              if (endpoint === 'servicios') { 
                  form.idServicio.value = item._id; 
                  form.nombreServicio.value = item.nombre; 
                  form.precioServicio.value = item.precio; 
              } else if (endpoint === 'artistas') { 
                  form.idArtista.value = item._id; 
                  form.nombreArtista.value = item.nombre;
                  form.nombreArtisticoArtista.value = item.nombreArtistico || '';
                  form.telefonoArtista.value = item.telefono || '';
                  form.correoArtista.value = item.correo || '';
              } else if (endpoint === 'usuarios') { 
                  form.idUsuario.value = item._id; 
                  form.usernameUsuario.value = item.username; 
                  form.roleUsuario.value = item.role; 
              } 
              form.querySelector('button[type="submit"]').textContent = 'Actualizar'; 
          } catch (error) { showToast(`Error al cargar: ${error.message}`, 'error'); } 
      }
      async function restaurarItem(id, endpoint) { try { await fetchAPI(`/api/${endpoint}/${id}/restaurar`, { method: 'PUT' }); showToast('Elemento restaurado.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function eliminarPermanente(id, endpoint) { if (!confirm('¬°ADVERTENCIA! Esta acci√≥n es irreversible. ¬øEliminar permanentemente?')) return; try { await fetchAPI(`/api/${endpoint}/${id}/permanente`, { method: 'DELETE' }); showToast('Eliminado permanentemente.', 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function vaciarPapelera(endpoint) { if (!confirm(`¬øVaciar PERMANENTEMENTE la papelera de ${endpoint}?`)) return; try { await fetchAPI(`/api/${endpoint}/papelera/vaciar`, { method: 'DELETE' }); showToast(`Papelera de ${endpoint} vaciada.`, 'success'); cargarPapelera(); } catch (error) { showToast(`Error: ${error.message}`, 'error'); } }
      async function cargarDashboard() { try { const stats = await fetchAPI('/api/dashboard/stats'); document.getElementById('kpi-ingresos-mes').textContent = `$${stats.ingresosMes.toFixed(2)}`; document.getElementById('kpi-proyectos-activos').textContent = stats.proyectosActivos; document.getElementById('kpi-proyectos-por-cobrar').textContent = stats.proyectosPorCobrar; } catch(e) { console.error("Error cargando dashboard:", e); } }
      async function cargarCotizaciones() { const tablaBody = document.getElementById('tablaCotizacionesBody'); tablaBody.innerHTML = `<tr><td colspan="4">Cargando...</td></tr>`; try { const cotizaciones = await fetchAPI('/api/proyectos/cotizaciones'); tablaBody.innerHTML = cotizaciones.length ? cotizaciones.map(c => { const esArtistaRegistrado = c.artista && c.artista._id; const nombreArtista = esArtistaRegistrado ? c.artista.nombre : 'P√∫blico General'; const claseTd = esArtistaRegistrado ? 'clickable-artist' : ''; const eventoDblClick = esArtistaRegistrado ? `ondblclick="app.irAVistaArtista('${c.artista._id}', '${c.artista.nombre}')"` : ''; return `<tr><td class="${claseTd}" ${eventoDblClick}>${nombreArtista}</td><td>$${c.total.toFixed(2)}</td><td>${new Date(c.createdAt).toLocaleDateString()}</td><td class="table-actions"><button class="btn-aprobar" onclick="app.aprobarCotizacion('${c._id}')">Aprobar</button><button class="btn-secondary" title="Regenerar PDF" onclick="app.generarCotizacionPDF('${c._id}')">üìÑ</button><button class="btn-secondary" title="Compartir por WhatsApp" onclick="app.compartirPorWhatsApp('${c._id}')">üí¨</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${c._id}', true)">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="4">No hay cotizaciones pendientes.</td></tr>`; } catch(e) { tablaBody.innerHTML = `<tr><td colspan="4">Error al cargar.</td></tr>`; } }
      const procesos = ['Agendado', 'Grabacion', 'Edicion', 'Mezcla', 'Mastering', 'Completo'];
      async function cargarFlujoDeTrabajo(filtroActivo = 'Todos') { const board = document.getElementById('kanbanBoard'); const filtros = document.getElementById('filtrosFlujo'); if(!filtros.innerHTML) { filtros.innerHTML = `<button class="active" onclick="app.filtrarFlujo('Todos')">Todos</button>` + procesos.filter(p=>p!=='Completo').map(p => `<button onclick="app.filtrarFlujo('${p}')">${p}</button>`).join(''); } board.innerHTML = procesos.filter(p => p !== 'Completo').map(p => `<div class="kanban-column" data-columna="${p}"><h3>${p}</h3><div id="columna-${p}"></div></div>`).join(''); try { proyectosCacheados = await fetchAPI('/api/proyectos'); filtrarFlujo(filtroActivo); } catch(e) { console.error("Error cargando flujo:", e); } }
      function filtrarFlujo(filtro) { 
          document.querySelectorAll('#filtrosFlujo button').forEach(b => b.classList.remove('active')); 
          document.querySelector(`#filtrosFlujo button[onclick="app.filtrarFlujo('${filtro}')"]`).classList.add('active'); 
          document.querySelectorAll('.kanban-column').forEach(c => c.style.display = (filtro === 'Todos' || c.dataset.columna === filtro) ? 'block' : 'none'); 
          procesos.forEach(col => { if(document.getElementById(`columna-${col}`)) document.getElementById(`columna-${col}`).innerHTML = '' }); 
          proyectosCacheados.filter(p => p.proceso !== 'Completo').forEach(p => { 
              const card = document.createElement('div'); 
              card.className = `project-card`; 
              card.dataset.id = p._id;
              card.style.borderColor = `var(--proceso-${p.proceso})`; 
              const serviciosHtml = p.items.length > 0 ? p.items.map(i => `<li>- ${i.nombre}</li>`).join('') : `<li>- ${p.nombreProyecto || 'Proyecto sin servicios'}</li>`;
              const estatusNormalizado = p.estatus.replace(/ /g, '-'); 
              const estatusColor = `var(--estatus-${estatusNormalizado}, var(--warning-color))`; 
              const artistaNombre = p.artista ? (p.artista.nombreArtistico || p.artista.nombre) : 'P√∫blico General'; 
              const eventoDblClick = p.artista ? `ondblclick="app.irAVistaArtista('${p.artista._id}', '${p.artista.nombre}')"` : ''; 
              const claseArtista = p.artista ? 'clickable-artist' : ''; 
              card.innerHTML = `<div class="project-card-header">
                                  <div class="project-card-header-main">
                                      <span class="${claseArtista}" ${eventoDblClick}>${p.nombreProyecto || artistaNombre}</span>
                                      <button class="btn-secondary" style="width: 24px; height: 24px; padding: 0; font-size: 0.7em;" onclick="app.editarNombreProyecto('${p._id}')">‚úèÔ∏è</button>
                                  </div>
                                  <span class="status-badge" style="background-color:${estatusColor}">${p.estatus}</span>
                              </div>
                              <div class="project-card-body">
                                  <div style="font-weight: bold; margin-bottom: 8px;">üóìÔ∏è ${new Date(p.fecha).toLocaleDateString()}</div>
                                  <ul>${serviciosHtml}</ul>
                                  <span class="proceso-tag" style="background-color: var(--proceso-${p.proceso})">${p.proceso}</span>
                              </div>
                              <div class="project-card-footer">
                                  <strong>$${p.total.toFixed(2)}</strong>
                                  <div>
                                      <button class="btn-secondary" onclick="app.openDocumentsModal('${p._id}')">Docs üìÑ</button>
                                      <button class="btn-secondary" onclick="app.registrarPago('${p._id}')">Pagos üíµ</button>
                                      <select onchange="app.cambiarProceso('${p._id}', this.value)" style="margin-left: 0.5rem;">${procesos.map(proc => `<option value="${proc}" ${p.proceso === proc ? 'selected' : ''}>${proc}</option>`).join('')}</select>
                                  </div>
                              </div>`; 
              document.getElementById(`columna-${p.proceso}`)?.appendChild(card); 
          }); 
      }
      async function cambiarProceso(id, proceso) { try { const data = { proceso }; if (proceso === 'Completo') { const proyecto = proyectosCacheados.find(p => p._id === id); if (proyecto.estatus !== 'Pagado') { if (!confirm('Este proyecto no est√° completamente pagado. ¬øDeseas marcarlo como completo de todas formas?')) return; } } await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify(data) }); const proyecto = proyectosCacheados.find(p => p._id === id); if (proyecto) proyecto.proceso = proceso; const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); if(proceso === 'Completo') { proyectosCacheados = proyectosCacheados.filter(p => p._id !== id); showToast('¬°Proyecto completado! Se ha movido al historial.', 'success'); } filtrarFlujo(filtroActual); } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function cargarHistorial() { const tablaBody = document.getElementById('tablaHistorialBody'); tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; try { historialCacheados = await fetchAPI('/api/proyectos/completos'); tablaBody.innerHTML = historialCacheados.length ? historialCacheados.map(p => { const artistaNombre = p.artista ? p.artista.nombre : 'P√∫blico General'; const eventoDblClick = p.artista ? `ondblclick="app.irAVistaArtista('${p.artista._id}', '${p.artista.nombre}')"` : ''; const claseArtista = p.artista ? 'clickable-artist' : ''; return `<tr><td class="${claseArtista}" ${eventoDblClick}>${artistaNombre}</td><td>$${p.total.toFixed(2)}</td><td>$${(p.montoPagado || 0).toFixed(2)}</td><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="table-actions"><button class="btn-secondary" onclick="app.openDocumentsModal('${p._id}')">Docs üìÑ</button><button class="btn-secondary" onclick="app.registrarPago('${p._id}', true)">Pagos üíµ</button><button class="btn-eliminar" onclick="app.eliminarProyecto('${p._id}')">üóëÔ∏è</button></td></tr>`; }).join('') : `<tr><td colspan="5">No hay proyectos completados.</td></tr>`; } catch(error) { tablaBody.innerHTML = `<tr><td colspan="5">Error al cargar historial.</td></tr>`; } }
      async function eliminarProyecto(id, desdeCotizaciones = false) { if (!confirm('¬øMover este proyecto a la papelera?')) return; try { await fetchAPI(`/api/proyectos/${id}`, { method: 'DELETE' }); showToast('Proyecto movido a la papelera.', 'info'); if (desdeCotizaciones) cargarCotizaciones(); else cargarHistorial(); } catch (error) { showToast(`Error al eliminar: ${error.message}`, 'error'); } }
      async function cargarOpcionesParaSelect(url, selectId, valueField, textFieldFn, addPublicoGeneral = false, currentValue = null) { const select = document.getElementById(selectId); try { const data = await fetchAPI(url); select.innerHTML = ''; if (addPublicoGeneral) { const op = document.createElement('option'); op.value = 'publico_general'; op.textContent = 'P√∫blico General'; select.appendChild(op); } data.forEach(item => { const option = document.createElement('option'); option.value = item[valueField]; option.textContent = textFieldFn(item); option.dataset.precio = item.precio || 0; select.appendChild(option); }); if (currentValue) select.value = currentValue; } catch (error) { select.innerHTML = `<option value="">Error</option>`; } }
      const cargarOpcionesParaProyecto = () => { cargarOpcionesParaSelect('/api/artistas', 'proyectoArtista', '_id', item => item.nombreArtistico || item.nombre, true); cargarOpcionesParaSelect('/api/servicios', 'proyectoServicio', '_id', item => `${item.nombre} - $${item.precio.toFixed(2)}`); }
      const cargarOpcionesParaProyectoManual = () => { cargarOpcionesParaSelect('/api/artistas', 'manualProyectoArtista', '_id', item => item.nombreArtistico || item.nombre, false); flatpickr("#manualFechaProyecto", { defaultDate: "today", locale: "es" }); };
      function agregarAProyecto() { const select = document.getElementById('proyectoServicio'); if (!select.value) return; const id = `item-${select.value}-${Date.now()}`; proyectoActual[id] = { id, servicioId: select.value, nombre: select.options[select.selectedIndex].text.split(' - ')[0], unidades: parseInt(document.getElementById('proyectoUnidades').value) || 1, precioUnitario: parseFloat(select.options[select.selectedIndex].dataset.precio) }; mostrarProyectoActual(); }
      function quitarDeProyecto(id) { delete proyectoActual[id]; mostrarProyectoActual(); }
      function mostrarProyectoActual() { const lista = document.getElementById('listaProyectoActual'); let total = 0; lista.innerHTML = Object.values(proyectoActual).map(item => { const subtotal = item.precioUnitario * item.unidades; total += subtotal; return `<li class="list-item"><span>${item.unidades}x ${item.nombre}</span><span>$${subtotal.toFixed(2)} <button class="btn-quitar-servicio" onclick="app.quitarDeProyecto('${item.id}')">X</button></span></li>`; }).join(''); document.getElementById('totalAPagar').textContent = `$${total.toFixed(2)}`; }
      async function guardarProyecto(procesoDestino) { const artistaSelect = document.getElementById('proyectoArtista'); const artistaId = artistaSelect.value; const fecha = document.getElementById('fechaProyecto')._flatpickr.selectedDates[0] || new Date(); if (Object.keys(proyectoActual).length === 0) { showToast('Agrega al menos un servicio.', 'error'); return null; } const total = Object.values(proyectoActual).reduce((sum, item) => sum + (item.precioUnitario * item.unidades), 0); const body = { artista: artistaId === 'publico_general' ? null : artistaId, nombreProyecto: document.getElementById('nombreProyecto').value, items: Object.values(proyectoActual).map(i => ({ servicio: i.servicioId, nombre: i.nombre, unidades: i.unidades, precioUnitario: i.precioUnitario })), total, estatus: procesoDestino === 'Cotizacion' ? 'Cotizacion' : 'Pendiente de Pago', metodoPago: 'Pendiente', fecha: fecha.toISOString(), prioridad: 'Normal', proceso: procesoDestino, esAlbum: document.getElementById('esAlbum').checked }; try { return await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) }); } catch (error) { showToast(`Error al registrar: ${error.message}`, 'error'); return null; } }
      async function guardarProyectoManual() {
        const artistaId = document.getElementById('manualProyectoArtista').value;
        const nombreProyecto = document.getElementById('manualNombreProyecto').value;
        const fecha = document.getElementById('manualFechaProyecto')._flatpickr.selectedDates[0];
        const descripcion = document.getElementById('manualDescripcion').value;
        if (!artistaId || !nombreProyecto || !fecha) {
            return showToast('Artista, Nombre del Proyecto y Fecha son obligatorios.', 'error');
        }
        const body = {
            artista: artistaId,
            nombreProyecto: nombreProyecto,
            items: [{ nombre: descripcion, unidades: 1, precioUnitario: 0 }],
            total: 0,
            estatus: 'Pagado',
            proceso: 'Agendado',
            fecha: fecha.toISOString(),
        };
        try {
            await fetchAPI('/api/proyectos', { method: 'POST', body: JSON.stringify(body) });
            showToast('Proyecto manual guardado con √©xito.', 'success');
            document.getElementById('formProyectoManual').reset();
            mostrarSeccion('flujo-trabajo');
        } catch(e) {
            showToast(`Error al guardar: ${e.message}`, 'error');
        }
      }
      async function generarCotizacion() { const nuevoProyecto = await guardarProyecto('Cotizacion'); if (nuevoProyecto) { showToast('Cotizaci√≥n guardada.', 'success'); await generarCotizacionPDF(nuevoProyecto._id); proyectoActual = {}; mostrarProyectoActual(); document.getElementById('formProyecto').reset(); mostrarSeccion('cotizaciones'); } }
      async function enviarAFlujoDirecto() { const nuevoProyecto = await guardarProyecto('Agendado'); if (nuevoProyecto) { showToast('Proyecto guardado y agendado.', 'success'); proyectoActual = {}; mostrarProyectoActual(); document.getElementById('formProyecto').reset(); mostrarSeccion('flujo-trabajo'); } }
      
      async function registrarNuevoArtistaDesdeFormulario(formPrefix) {
          const inputId = formPrefix ? `${formPrefix}NombreNuevoArtista` : 'nombreNuevoArtista';
          const containerId = formPrefix ? `${formPrefix}NuevoArtistaContainer` : 'nuevoArtistaContainer';
          
          const nombreInput = document.getElementById(inputId);
          const nombre = nombreInput.value.trim();
          
          if (!nombre) {
              showToast('Por favor, introduce un nombre para el artista.', 'error');
              return;
          }
          
          try {
              const nuevoArtista = await fetchAPI('/api/artistas', { method: 'POST', body: JSON.stringify({ nombre }) });
              
              const selectId = formPrefix === 'manual' ? 'manualProyectoArtista' : 'proyectoArtista';
              const addPublico = formPrefix !== 'manual';
              
              await cargarOpcionesParaSelect('/api/artistas', selectId, '_id', item => item.nombreArtistico || item.nombre, addPublico, nuevoArtista._id);
              
              document.getElementById(containerId).style.display = 'none';
              nombreInput.value = '';
              showToast('Artista registrado y seleccionado.', 'success');
          } catch (error) {
              showToast(`Error: ${error.message}`, 'error');
          }
      }

      function openEventModal(info) { const props = info.event.extendedProps; document.getElementById('modal-event-title').textContent = info.event.title; document.getElementById('modal-event-date').textContent = info.event.start.toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); document.getElementById('modal-event-total').textContent = `$${props.total.toFixed(2)}`; document.getElementById('modal-event-status').textContent = props.estatus; document.getElementById('modal-event-process').textContent = props.proceso; document.getElementById('modal-event-services').innerHTML = props.servicios.split('\n').map(s => `<li>${s}</li>`).join(''); const btnWorkflow = document.getElementById('btn-go-to-workflow'); btnWorkflow.onclick = () => app.goToProjectInWorkflow(info.event.id); const btnArtist = document.getElementById('btn-go-to-artist'); if (props.artistaId) { btnArtist.style.display = 'block'; btnArtist.onclick = () => app.goToArtistFromModal(props.artistaId, props.artistaNombre); } else { btnArtist.style.display = 'none'; } document.getElementById('event-modal').style.display = 'flex'; }
      function closeEventModal() { document.getElementById('event-modal').style.display = 'none'; }
      function goToProjectInWorkflow(projectId) { closeEventModal(); mostrarSeccion('flujo-trabajo'); setTimeout(() => { const card = document.querySelector(`.project-card[data-id="${projectId}"]`); if (card) card.scrollIntoView({ behavior: 'smooth', block: 'center' }); }, 200); }
      function goToArtistFromModal(artistId, artistName) { closeEventModal(); irAVistaArtista(artistId, artistName); }
      async function cargarAgenda() {
        const calendarEl = document.getElementById('calendario');
        if (currentCalendar) { currentCalendar.destroy(); }
        try {
            const eventos = await fetchAPI('/api/proyectos/agenda');
            const isMobile = window.innerWidth < 768;
            currentCalendar = new FullCalendar.Calendar(calendarEl, {
                locale: 'es',
                initialView: 'dayGridMonth',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: isMobile ? 'dayGridMonth,timeGridWeek,listMonth' : 'dayGridMonth,timeGridWeek,listWeek'
                },
                height: isMobile ? 'auto' : 'auto',
                aspectRatio: isMobile ? 1.2 : 1.8,
                dayMaxEventRows: isMobile ? 2 : true,
                buttonText: { today: 'Hoy', month: 'Mes', week: 'Semana', list: 'Lista' },
                navLinks: true, editable: true, events: eventos,
                dateClick: (info) => { if (info.view.type.includes('Grid')) { mostrarSeccion('registrar-proyecto'); document.getElementById('fechaProyecto')._flatpickr.setDate(info.date); showToast(`Creando nuevo proyecto para el ${info.date.toLocaleDateString()}`, 'info'); } },
                eventClick: openEventModal,
                eventDrop: async (info) => {
                    if (!confirm(`¬øMover el proyecto de "${info.event.title}" al ${info.event.start.toLocaleDateString()}?`)) { info.revert(); return; }
                    try { await app.cambiarAtributo(info.event.id, 'fecha', info.event.start.toISOString()); showToast('Fecha actualizada.', 'success'); cargarFlujoDeTrabajo(document.querySelector('#filtrosFlujo button.active')?.textContent.trim() || 'Todos'); } catch (error) { showToast(`Error al actualizar: ${error.message}`, 'error'); info.revert(); }
                },
                eventContent: (arg) => { let innerHtml = `<div class="fc-event-main-frame"><div class="fc-event-title-container"><div class="fc-event-title">${arg.event.title}</div></div><div class="proceso-tag-event" style="background-color: var(--proceso-${arg.event.extendedProps.proceso}, #808080)">${arg.event.extendedProps.proceso}</div></div>`; return { html: innerHtml }; }
            });
            currentCalendar.render();
        } catch (error) { calendarEl.innerHTML = '<p>Error al cargar agenda. Por favor, recarga la p√°gina.</p>'; console.error(error); }
      }
      async function cambiarAtributo(id, campo, valor) { try { await fetchAPI(`/api/proyectos/${id}/${campo}`, { method: 'PUT', body: JSON.stringify({ [campo]: valor }) }); const proyecto = proyectosCacheados.find(p => p._id === id); if (proyecto) proyecto[campo] = valor; if (document.getElementById('flujo-trabajo').classList.contains('active')) { const filtroActual = document.querySelector('#filtrosFlujo button.active').textContent.trim(); filtrarFlujo(filtroActual); } } catch (e) { showToast(`Error: ${e.message}`, 'error'); } }
      async function aprobarCotizacion(id) { if (!confirm('¬øAprobar esta cotizaci√≥n y moverla al Flujo de Trabajo?')) return; try { await fetchAPI(`/api/proyectos/${id}/proceso`, { method: 'PUT', body: JSON.stringify({ proceso: 'Agendado' }) }); showToast('¬°Cotizaci√≥n Aprobada!', 'success'); mostrarSeccion('flujo-trabajo'); } catch(error) { showToast(`Error al aprobar: ${error.message}`, 'error'); } }
      async function compartirPorWhatsApp(proyectoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const nombreCliente = proyecto.artista ? proyecto.artista.nombre : 'cliente'; const mensaje = `¬°Hola ${nombreCliente}! Te enviamos un resumen de tu cotizaci√≥n de FiaRecords Studio.\n\nServicios:\n${proyecto.items.map(i => `- ${i.unidades}x ${i.nombre}`).join('\n')}\n\n*Total: $${proyecto.total.toFixed(2)} MXN*\n\nPara confirmar o si tienes alguna duda, cont√°ctanos. ¬°Gracias!`; const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`; window.open(url, '_blank'); } catch (error) { showToast('No se pudo cargar la informaci√≥n para compartir.', 'error'); } }
      async function registrarPago(proyectoId, desdeHistorial = false) { const cache = desdeHistorial ? historialCacheados : proyectosCacheados; let proyecto = cache.find(p => p._id === proyectoId); if (!proyecto) { try { proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); } catch(e) { return showToast('No se pudo encontrar el proyecto.', 'error'); }} const restante = proyecto.total - (proyecto.montoPagado || 0); const montoStr = prompt(`Registrar pago para ${proyecto.artista ? proyecto.artista.nombre : 'P√∫blico General'}\n\nTotal del Proyecto: $${proyecto.total.toFixed(2)}\nPagado: $${(proyecto.montoPagado || 0).toFixed(2)}\nSaldo: $${restante.toFixed(2)}\n\n¬øMonto a registrar?`, restante > 0 ? restante.toFixed(2) : '0.00'); if (montoStr === null) return; const monto = parseFloat(montoStr); if (isNaN(monto) || monto <= 0) { return showToast('Por favor, introduce un monto v√°lido.', 'error'); } const metodo = prompt('M√©todo de pago (Ej: Efectivo, Transferencia):', 'Efectivo'); if (!metodo) return; try { const proyectoActualizado = await fetchAPI(`/api/proyectos/${proyectoId}/pagos`, { method: 'POST', body: JSON.stringify({ monto, metodo }) }); showToast('¬°Pago registrado con √©xito!', 'success'); await generarReciboPDF(proyectoActualizado, proyectoActualizado.pagos[proyectoActualizado.pagos.length - 1]); if (desdeHistorial) { cargarHistorial(); } else { cargarFlujoDeTrabajo(); } } catch (error) { console.error('Error registrando pago:', error); showToast(`Error al registrar el pago: ${error.message}`, 'error'); } }
      async function cargarPagos() { const tablaBody = document.getElementById('tablaPagosBody'); tablaBody.innerHTML = `<tr><td colspan="5">Cargando...</td></tr>`; try { const pagos = await fetchAPI('/api/proyectos/pagos/todos'); tablaBody.innerHTML = pagos.length ? pagos.map(p => `<tr><td>${new Date(p.fecha).toLocaleDateString()}</td><td class="clickable-artist" ondblclick="app.irAVistaArtista(null, '${p.artista}')">${p.artista}</td><td>$${p.monto.toFixed(2)}</td><td>${p.metodo}</td><td class="table-actions"><button class="btn-secondary" title="Reimprimir Recibo" onclick="app.reimprimirRecibo('${p.proyectoId}', '${p.pagoId}')">üìÑ</button><button class="btn-secondary" title="Compartir por WhatsApp" onclick="app.compartirPagoPorWhatsApp(JSON.stringify(${JSON.stringify(p)}))">üí¨</button><button class="btn-eliminar" title="Eliminar Pago" onclick="app.eliminarPago('${p.proyectoId}', '${p.pagoId}')">üóëÔ∏è</button></td></tr>`).join('') : `<tr><td colspan="5">No hay pagos registrados.</td></tr>`; } catch (e) { tablaBody.innerHTML = `<tr><td colspan="5">Error al cargar los pagos.</td></tr>`; } }
      async function reimprimirRecibo(proyectoId, pagoId) { try { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); const pago = proyecto.pagos.find(p => p._id === pagoId); if (!pago) return showToast('No se encontr√≥ el pago espec√≠fico.', 'error'); await generarReciboPDF(proyecto, pago); } catch(e) { showToast('Error al reimprimir el recibo.', 'error'); } }
      function compartirPagoPorWhatsApp(pagoString) { const pago = JSON.parse(pagoString); const mensaje = `Hola, te confirmamos tu pago a FiaRecords Studio:\n\n*Fecha:* ${new Date(pago.fecha).toLocaleDateString()}\n*Monto:* $${pago.monto.toFixed(2)} MXN\n*M√©todo:* ${pago.metodo}\n\n¬°Gracias por tu pago!`; const url = `https://wa.me/?text=${encodeURIComponent(mensaje)}`; window.open(url, '_blank'); }
      async function eliminarPago(proyectoId, pagoId) { if (!confirm('¬øEst√°s seguro de que quieres eliminar este pago? Esta acci√≥n es irreversible y afectar√° el saldo del proyecto.')) return; try { await fetchAPI(`/api/proyectos/${proyectoId}/pagos/${pagoId}`, { method: 'DELETE' }); showToast('Pago eliminado correctamente.', 'success'); cargarPagos(); } catch (error) { showToast(`Error al eliminar el pago: ${error.message}`, 'error'); } }
      async function openDocumentsModal(proyectoId) { const proyecto = await fetchAPI(`/api/proyectos/${proyectoId}`); if (!proyecto) return showToast('Proyecto no encontrado.', 'error'); document.getElementById('modal-project-id').value = proyectoId; document.getElementById('modal-project-id').dataset.total = proyecto.total; showDocumentSection('contrato'); const contrato = proyecto.detallesContrato || {}; document.getElementById('contrato-nombre-album').value = contrato.nombreAlbum || ''; document.getElementById('contrato-canciones').value = contrato.cantidadCanciones || ''; document.getElementById('contrato-duracion').value = contrato.duracion || ''; document.getElementById('contrato-pago-inicial').value = contrato.pagoInicial || ''; document.getElementById('contrato-pago-final').value = contrato.pagoFinal || ''; calcularSaldoContrato(); const dist = proyecto.detallesDistribucion || {}; document.getElementById('dist-titulo').value = dist.tituloLanzamiento || ''; document.getElementById('dist-fecha').value = dist.fechaLanzamiento ? new Date(dist.fechaLanzamiento).toISOString().split('T')[0] : ''; document.getElementById('dist-upc').value = dist.upc || ''; const tracksContainer = document.getElementById('dist-tracks-container'); tracksContainer.innerHTML = ''; (dist.tracks && dist.tracks.length > 0 ? dist.tracks : [{titulo: '', isrc: ''}]).forEach(track => addTrackField(track.titulo, track.isrc)); document.getElementById('document-modal').style.display = 'flex'; }
      function closeDocumentsModal() { document.getElementById('document-modal').style.display = 'none'; }
      function showDocumentSection(sectionName) { document.querySelectorAll('.document-section').forEach(s => s.classList.remove('active')); document.querySelectorAll('#document-modal .filter-buttons button').forEach(b => b.classList.remove('active')); document.getElementById(`section-${sectionName}`).classList.add('active'); document.getElementById(`btn-show-${sectionName}`).classList.add('active'); }
      function addTrackField(titulo = '', isrc = '') { const container = document.getElementById('dist-tracks-container'); const trackDiv = document.createElement('div'); trackDiv.className = 'form-row'; trackDiv.innerHTML = `<div class="form-group"><input type="text" class="dist-track-titulo" placeholder="T√≠tulo del Track" value="${titulo}"></div><div class="form-group"><input type="text" class="dist-track-isrc" placeholder="C√≥digo ISRC" value="${isrc}"></div>`; container.appendChild(trackDiv); }
      function calcularSaldoContrato() { const total = parseFloat(document.getElementById('modal-project-id').dataset.total) || 0; const inicial = parseFloat(document.getElementById('contrato-pago-inicial').value) || 0; const final = total - inicial; document.getElementById('contrato-pago-final').value = final > 0 ? final.toFixed(2) : '0.00'; }
      async function saveAndGenerateContract() { const proyectoId = document.getElementById('modal-project-id').value; const data = { nombreAlbum: document.getElementById('contrato-nombre-album').value, cantidadCanciones: parseInt(document.getElementById('contrato-canciones').value), duracion: document.getElementById('contrato-duracion').value, pagoInicial: parseFloat(document.getElementById('contrato-pago-inicial').value), pagoFinal: parseFloat(document.getElementById('contrato-pago-final').value) }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'contrato', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarContratoPDF(proyectoCompleto); closeDocumentsModal(); }
      async function saveAndGenerateDistribution() { const proyectoId = document.getElementById('modal-project-id').value; const tracks = []; document.querySelectorAll('#dist-tracks-container .form-row').forEach(row => { const titulo = row.querySelector('.dist-track-titulo').value; const isrc = row.querySelector('.dist-track-isrc').value; if (titulo) tracks.push({ titulo, isrc }); }); const data = { tituloLanzamiento: document.getElementById('dist-titulo').value, fechaLanzamiento: document.getElementById('dist-fecha').value, upc: document.getElementById('dist-upc').value, tracks }; await fetchAPI(`/api/proyectos/${proyectoId}/documentos`, { method: 'PUT', body: JSON.stringify({ tipo: 'distribucion', data }) }); const proyectoCompleto = await fetchAPI(`/api/proyectos/${proyectoId}`); await generarDistribucionPDF(proyectoCompleto); closeDocumentsModal(); }
      
      function getFinalCoordinates(pos) { let baseX, baseY; switch(pos.vAlign) { case 'top': baseY = PDF_DIMENSIONS.MARGIN; break; case 'middle': baseY = (PDF_DIMENSIONS.HEIGHT / 2) - (pos.h / 2); break; default: baseY = PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN; } switch(pos.hAlign) { case 'left': baseX = PDF_DIMENSIONS.MARGIN; break; case 'center': baseX = (PDF_DIMENSIONS.WIDTH / 2) - (pos.w / 2); break; default: baseX = PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN; } let finalX = baseX + pos.offsetX; let finalY = baseY + pos.offsetY; finalX = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalX, PDF_DIMENSIONS.WIDTH - pos.w - PDF_DIMENSIONS.MARGIN)); finalY = Math.max(PDF_DIMENSIONS.MARGIN, Math.min(finalY, PDF_DIMENSIONS.HEIGHT - pos.h - PDF_DIMENSIONS.MARGIN)); return { x: finalX, y: finalY, w: pos.w, h: pos.h }; }
      async function addFirmaToPdf(pdf, docType, finalFileName, proyecto) { const firmaPath = (configCache && configCache.firmaPath) ? configCache.firmaPath : '/uploads/firma.png'; try { const response = await fetch(firmaPath); if (!response.ok) throw new Error('Imagen de firma no encontrada.'); const firmaImg = await response.blob(); const reader = new FileReader(); reader.readAsDataURL(firmaImg); reader.onloadend = function() { try { const base64data = reader.result; const pos = getFinalCoordinates(configCache.firmaPos[docType]); if (docType === 'contrato') { pdf.line(PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 2, PDF_DIMENSIONS.MARGIN + 70, pos.y + pos.h + 2); pdf.text(proyecto.artista.nombre, PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 7); pdf.text('Firma del Cliente', PDF_DIMENSIONS.MARGIN, pos.y + pos.h + 12); } pdf.addImage(base64data, 'PNG', pos.x, pos.y, pos.w, pos.h); pdf.line(pos.x, pos.y + pos.h + 2, pos.x + pos.w, pos.y + pos.h + 2); pdf.text("Erick Resendiz", pos.x, pos.y + pos.h + 7); pdf.text("Representante de FIA Records", pos.x, pos.y + pos.h + 12); } catch (e) { console.error("Error al procesar firma:", e); } finally { pdf.save(finalFileName); } } } catch(e) { console.warn(e.message); pdf.save(finalFileName); } }
      async function generarCotizacionPDF(proyectoIdOrObject) { try { const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; const { jsPDF } = window.jspdf; const pdf = new jsPDF(); if (DOMElements.appLogo.src && !DOMElements.appLogo.src.includes('via.placeholder.com')) { const logoImg = DOMElements.appLogo; const canvas = document.createElement('canvas'); canvas.width = logoImg.naturalWidth; canvas.height = logoImg.naturalHeight; const ctx = canvas.getContext('2d'); ctx.filter = 'invert(1)'; ctx.drawImage(logoImg, 0, 0); const invertedLogoDataUrl = canvas.toDataURL('image/png'); pdf.addImage(invertedLogoDataUrl, 'PNG', 14, 15, 40, 15); } pdf.setFontSize(9); pdf.text("Monte Everest #318 Col. Monte Verde 5to sector Ju√°rez N.L.", 200, 20, { align: 'right' }); pdf.text("Tel. 8132520539", 200, 25, { align: 'right' }); pdf.text("fiarec.studio@gmail.com", 200, 30, { align: 'right' }); pdf.setFontSize(11); pdf.text(`Cliente: ${proyecto.artista ? proyecto.artista.nombre : 'P√∫blico General'}`, 14, 50); pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).toUpperCase()}`, 200, 50, { align: 'right' }); pdf.text("Descripci√≥n del Servicio:", 14, 65); const body = proyecto.items.map(item => [`${item.unidades}x ${item.nombre}`, `$${(item.precioUnitario * item.unidades).toFixed(2)}`]); pdf.autoTable({ startY: 70, head: [['Servicio', 'Subtotal']], body: body, theme: 'grid', styles: { fontSize: 10 }, headStyles: { fillColor: [0, 0, 0], textColor: [255, 255, 255] } }); let finalY = pdf.lastAutoTable.finalY + 10; pdf.setFontSize(12); pdf.setFont(undefined, 'bold'); pdf.text("Precio del Servicio:", 14, finalY); pdf.text(`$${proyecto.total.toFixed(2)} MXN`, 200, finalY, { align: 'right' }); finalY += 15; pdf.setFont(undefined, 'normal'); pdf.text("Condiciones:", 14, finalY); pdf.setFontSize(9); pdf.text("1. La cotizaci√≥n es v√°lida por 30 d√≠as.", 14, finalY + 5); pdf.text("2. Se requiere un dep√≥sito del 50% para reservar la fecha.", 14, finalY + 10); pdf.text("3. El saldo restante debe pagarse antes de la entrega final del material.", 14, finalY + 15); finalY += 30; pdf.setFontSize(10); pdf.text("Agradecemos tu confianza y esperamos trabajar juntos en tu proyecto.", 105, finalY, { align: 'center' }); const fileName = `Cotizacion-${proyecto.artista ? proyecto.artista.nombre.replace(/\s/g, '_') : 'General'}.pdf`; await addFirmaToPdf(pdf, 'cotizacion', fileName, proyecto); } catch (error) { showToast("Error al generar el PDF.", 'error'); console.error(error); } }
      async function generarReciboPDF(proyecto, pagoEspecifico) { try { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const pago = pagoEspecifico || proyecto.pagos[proyecto.pagos.length - 1]; if (!pago) return showToast('No hay pago para generar recibo.', 'error'); const esPagoFinal = proyecto.montoPagado >= proyecto.total; const saldoRestante = proyecto.total - proyecto.montoPagado; if (DOMElements.appLogo.src && !DOMElements.appLogo.src.includes('via.placeholder.com')) { const logoImg=DOMElements.appLogo;const canvas=document.createElement('canvas');canvas.width=logoImg.naturalWidth;canvas.height=logoImg.naturalHeight;const ctx=canvas.getContext('2d');ctx.filter='invert(1)';ctx.drawImage(logoImg,0,0);pdf.addImage(canvas.toDataURL('image/png'),'PNG',14,15,40,15); } pdf.setFontSize(9); pdf.text("Monte Everest #318 Col. Monte Verde 5to sector Ju√°rez N.L.", 200, 20, { align: 'right' }); pdf.text("Tel. 8132520539", 200, 25, { align: 'right' }); pdf.text("fiarec.studio@gmail.com", 200, 30, { align: 'right' }); pdf.setFontSize(11); pdf.text(new Date(pago.fecha).toLocaleDateString('es-ES', { day: '2-digit', month: 'short', year: '2-digit' }).toUpperCase(), 14, 45); pdf.line(14, 47, 200, 47); pdf.setFontSize(16); pdf.setFont(undefined, 'bold').text(`RECIBO DE PAGO ${esPagoFinal && saldoRestante <= 0 ? 'FINAL' : 'PARCIAL'}`, 105, 55, { align: 'center' }); pdf.setFontSize(11); pdf.setFont(undefined, 'normal'); pdf.text(`Recib√≠ de: ${proyecto.artista ? proyecto.artista.nombre : 'P√∫blico General'}`, 14, 70); pdf.text("Concepto:", 14, 85); const conceptos = proyecto.items.map(item => `- ${item.nombre || 'Servicio'}`); conceptos.forEach((line, i) => pdf.text(line, 16, 92 + (i * 7))); let finalY = 92 + (conceptos.length * 7) + 5; pdf.autoTable({ startY: finalY, theme: 'plain', styles: { fontSize: 11 }, body: [['Total del Proyecto:', `$${proyecto.total.toFixed(2)} MXN`], ['Este Pago:', `$${pago.monto.toFixed(2)} MXN`], ['Saldo Restante:', `$${saldoRestante.toFixed(2)} MXN`]], columnStyles: { 0: { fontStyle: 'bold', halign: 'left' }, 1: { halign: 'right' } } }); finalY = pdf.lastAutoTable.finalY + 7; pdf.text("M√©todo de Pago:", 14, finalY); pdf.text(pago.metodo, 200, finalY, { align: 'right' }); finalY += 15; pdf.line(14, finalY, 200, finalY); finalY += 10; pdf.setFontSize(9); pdf.text("Notas: Este recibo es prueba del pago recibido por los servicios mencionados.", 14, finalY); finalY += 10; pdf.text("T√©rminos y Condiciones:", 14, finalY); pdf.text("1. Los anticipos no son reembolsables.", 14, finalY + 5); pdf.text("2. Si el saldo pendiente no se liquida, no se entregar√° el material grabado.", 14, finalY + 10); const fileName = `Recibo-${proyecto.artista ? proyecto.artista.nombre.replace(/\s/g, '_') : 'General'}.pdf`; await addFirmaToPdf(pdf, 'recibo', fileName, proyecto); } catch (error) { showToast('Error al generar el recibo.', 'error'); console.error(error); }}
      async function generarContratoPDF(proyectoIdOrObject) { try { const proyecto = typeof proyectoIdOrObject === 'string' ? await fetchAPI(`/api/proyectos/${proyectoIdOrObject}`) : proyectoIdOrObject; const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const c = proyecto.detallesContrato; if (DOMElements.appLogo.src && !DOMElements.appLogo.src.includes('via.placeholder.com')) { const logoImg=DOMElements.appLogo;const canvas=document.createElement('canvas');canvas.width=logoImg.naturalWidth;canvas.height=logoImg.naturalHeight;const ctx=canvas.getContext('2d');ctx.filter='invert(1)';ctx.drawImage(logoImg,0,0);pdf.addImage(canvas.toDataURL('image/png'),'PNG',14,15,40,15); } pdf.setFontSize(18).setFont(undefined, 'bold').text('CONTRATO DE SERVICIOS DE GRABACI√ìN DE AUDIO', 105, 40, { align: 'center', maxWidth: 180 }); pdf.setFontSize(10).setFont(undefined, 'normal'); pdf.text(`Fecha: ${new Date().toLocaleDateString('es-ES')}`, 14, 55); pdf.text('Entre:', 14, 65); pdf.setFont(undefined, 'bold').text('FIA RECORDS (en adelante, "El Estudio")', 20, 72); pdf.text(`EL CLIENTE: ${proyecto.artista.nombre} (en adelante, "El Cliente")`, 20, 79); pdf.setFont(undefined, 'normal').text('Ambas partes acuerdan lo siguiente:', 14, 89); pdf.autoTable({ startY: 95, theme: 'grid', styles: { fontSize: 10, cellPadding: 2 }, headStyles: { fillColor: [0,0,0], textColor: [255,255,255] }, head: [['Objeto del Contrato']], body: [[`El Estudio se compromete a proporcionar servicios de grabaci√≥n para el √°lbum "${c.nombreAlbum || 'N/A'}" de ${c.cantidadCanciones || 'varias'} canciones, bajo los t√©rminos descritos.`]]}); pdf.autoTable({ startY: pdf.lastAutoTable.finalY + 5, headStyles: { fillColor: [0,0,0], textColor: [255,255,255] }, head: [['Servicios Incluidos']], body: [proyecto.items.map(i => `- ${i.nombre}`)] }); let finalY = pdf.lastAutoTable.finalY; pdf.setFont(undefined, 'bold').text('T√©rminos y Condiciones:', 14, finalY += 10); const terminos = `1. Duraci√≥n del Contrato: Este contrato tiene una duraci√≥n de ${c.duracion || '[sin especificar]'}, comenzando a partir de la primera sesi√≥n de grabaci√≥n.\n2. Sesiones de Grabaci√≥n: La grabaci√≥n se realizar√° seg√∫n lo acordado. Las sesiones deben ser programadas con anticipaci√≥n.\n3. Tarifa y Forma de Pago: El Cliente pagar√° un total de $${proyecto.total.toFixed(2)}. El pago se realizar√° de la siguiente manera: un pago inicial de $${(c.pagoInicial || 0).toFixed(2)} y el saldo de $${(c.pagoFinal || 0).toFixed(2)} antes de la √∫ltima sesi√≥n.\n4. Pol√≠tica de Cancelaci√≥n: Si El Cliente necesita cancelar o reprogramar, deber√° notificar con al menos 24 horas de anticipaci√≥n. Cancelaciones tard√≠as pueden incurrir en una tarifa de $200.\n5. Entrega del Trabajo: El Estudio entregar√° las versiones mezcladas y masterizadas dentro de 10 d√≠as despu√©s de la grabaci√≥n final de cada pista, en formato digital (WAV, MP3).\n6. Propiedad Intelectual: Los derechos de autor permanecer√°n con El Cliente, siempre que se cumplan todos los pagos. El Estudio se reserva el derecho de usar fragmentos para su portafolio.\n7. Responsabilidad: El Cliente es responsable de proporcionar el material necesario (letras, etc.).\n8. Modificaciones: Cualquier modificaci√≥n a este contrato deber√° ser por escrito y firmada por ambas partes.\n9. Ley Aplicable: Este contrato se regir√° por las leyes de Nuevo Le√≥n, M√©xico.`; pdf.setFontSize(9).setFont(undefined, 'normal').text(terminos, 14, finalY + 5, { maxWidth: 180, lineHeightFactor: 1.5 }); const fileName = `Contrato-${proyecto.artista.nombre.replace(/\s/g, '_')}.pdf`; await addFirmaToPdf(pdf, 'contrato', fileName, proyecto); } catch (e) { showToast("Error al generar Contrato PDF", 'error'); console.error(e); }}
      async function generarDistribucionPDF(proyecto) { try { const { jsPDF } = window.jspdf; const pdf = new jsPDF(); const d = proyecto.detallesDistribucion; pdf.setFontSize(16).setFont(undefined, 'bold').text('ENTREGA PARA DISTRIBUCI√ìN DIGITAL', 105, 20, { align: 'center' }); pdf.setFontSize(10).setFont(undefined, 'normal'); pdf.text(`Fecha de Entrega: ${new Date().toLocaleDateString('es-ES')}`, 14, 35); pdf.autoTable({ startY: 40, theme: 'plain', styles: { fontSize: 10 }, body: [ ['Artista:', proyecto.artista.nombre], ['T√≠tulo del Lanzamiento:', d.tituloLanzamiento], ['Fecha de Lanzamiento:', new Date(d.fechaLanzamiento).toLocaleDateString('es-ES')], ['UPC/EAN:', d.upc] ] }); pdf.autoTable({ startY: pdf.lastAutoTable.finalY + 5, head: [['Listado de Pistas (Tracklist)']], body: d.tracks.map((t, i) => [`Pista ${i+1}: ${t.titulo}\n    C√≥digo ISRC: ${t.isrc || 'N/A'}`]) }); let finalY = pdf.lastAutoTable.finalY + 10; const confirmacion = 'Por medio de este documento, Fia Records confirma la recepci√≥n de los c√≥digos de identificaci√≥n y la metadata final para el lanzamiento mencionado. El material de audio masterizado ha sido entregado y aprobado por el artista.'; pdf.text(confirmacion, 14, finalY, { maxWidth: 180, align: 'justify' }); const fileName = `Distribucion-${d.tituloLanzamiento.replace(/\s/g, '_')}.pdf`; await addFirmaToPdf(pdf, 'distribucion', fileName, proyecto); } catch (e) { showToast("Error al generar PDF de Distribuci√≥n", 'error'); console.error(e); }}

      async function mostrarVistaArtista(artistaId, nombre) {
          document.getElementById('vista-artista-nombre').textContent = `Historial de: ${nombre}`; 
          const contenido = document.getElementById('vista-artista-contenido'); 
          contenido.innerHTML = '<p>Cargando...</p>'; 
          try { 
              const [proyectos, todosPagos, artistaInfo] = await Promise.all([
                  fetchAPI(`/api/proyectos/por-artista/${artistaId}`),
                  fetchAPI('/api/proyectos/pagos/todos'),
                  fetchAPI(`/api/artistas/${artistaId}`)
              ]);
              let html = `<div class="card"><p><strong>Nombre Real:</strong> ${artistaInfo.nombre}</p><p><strong>Nombre Art√≠stico:</strong> ${artistaInfo.nombreArtistico || 'N/A'}</p><p><strong>Tel√©fono:</strong> ${artistaInfo.telefono || 'N/A'}</p><p><strong>Correo:</strong> ${artistaInfo.correo || 'N/A'}</p></div>`;
              
              html += '<h3>Proyectos del Artista</h3>'; 
              if(proyectos.length) { 
                  html += '<div class="table-responsive"><table style="margin-bottom: 2rem; width: 100%;"><thead><tr><th>Fecha</th><th>Nombre Proyecto / Servicios</th><th>Total</th><th>Pagado</th><th>Estado</th><th>Acciones</th></tr></thead><tbody>'; 
                  proyectos.forEach(p => { 
                      const nombreProyecto = p.nombreProyecto || p.items.map(i=>i.nombre).join(', ');
                      html += `<tr>
                          <td>${new Date(p.fecha).toLocaleDateString()}</td>
                          <td>${nombreProyecto} <button class="btn-secondary" style="width: 24px; height: 24px; padding: 0; font-size: 0.7em;" onclick="app.editarNombreProyecto('${p._id}')">‚úèÔ∏è</button></td>
                          <td>$${p.total.toFixed(2)}</td>
                          <td>$${(p.montoPagado||0).toFixed(2)}</td>
                          <td>${p.proceso} / ${p.estatus}</td>
                          <td class="table-actions">
                              <button class="btn-secondary" title="Reimprimir Cotizaci√≥n" onclick="app.generarCotizacionPDF('${p._id}')">üìÑ</button>
                              ${p.detallesContrato && p.detallesContrato.nombreAlbum ? `<button class="btn-secondary" title="Reimprimir Contrato" onclick="app.generarContratoPDF('${p._id}')">üìú</button>` : ''}
                              <button class="btn-secondary" title="Gestionar Entrega" onclick="app.openDeliveryModal('${p._id}', '${p.artista.nombreArtistico || p.artista.nombre}', '${nombreProyecto}')">üîó</button>
                          </td>
                      </tr>`; 
                  }); 
                  html += '</tbody></table></div>'; 
              } else { html += '<p>No hay proyectos para este artista.</p>'; } 
              
              html += '<h3>Pagos del Artista</h3>'; 
              const pagosArtista = todosPagos.filter(p => p.artista === nombre); 
              if (pagosArtista.length) { 
                  html += '<div class="table-responsive"><table style="width: 100%;"><thead><tr><th>Fecha</th><th>Monto</th><th>M√©todo</th><th>Acciones</th></tr></thead><tbody>'; 
                  pagosArtista.forEach(p => { 
                      html += `<tr>
                          <td>${new Date(p.fecha).toLocaleDateString()}</td>
                          <td>$${p.monto.toFixed(2)}</td>
                          <td>${p.metodo}</td>
                          <td class="table-actions">
                              <button class="btn-secondary" title="Reimprimir Recibo" onclick="app.reimprimirRecibo('${p.proyectoId}', '${p.pagoId}')">üßæ</button>
                          </td>
                      </tr>`; 
                  }); 
                  html += '</tbody></table></div>'; 
              } else { html += '<p>No hay pagos registrados para este artista.</p>'; } 
              contenido.innerHTML = html; 
              mostrarSeccion('vista-artista'); 
          } catch(e) { contenido.innerHTML = '<p>Error al cargar el historial del artista.</p>'; } 
      }
      async function irAVistaArtista(artistaId, artistaNombre) { if (!artistaId) { const artistas = await fetchAPI('/api/artistas'); const artista = artistas.find(a => a.nombre === artistaNombre); if (artista) artistaId = artista._id; else return; } mostrarVistaArtista(artistaId, artistaNombre); }
      function setupCustomization(payload) { if (payload.role === 'admin') { DOMElements.appLogo.addEventListener('click', () => DOMElements.logoInput.click()); DOMElements.logoInput.addEventListener('change', async (event) => { const file = event.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('logoFile', file); try { await fetchAPI('/api/configuracion/upload-logo', { method: 'POST', body: formData, isFormData: true }); showToast('¬°Logo guardado!', 'success'); await loadPublicLogo(); } catch (e) { showToast(`No se pudo guardar: ${e.message}`, 'error'); } }); } }
      
      async function cargarConfiguracion() { try { if (!configCache) await loadInitialConfig(); const firmaPreview = document.getElementById('firma-preview-img'); const draggablePreview = document.getElementById('firma-draggable-preview'); let firmaSrc = 'https://via.placeholder.com/150x60?text=Subir+Firma'; if (configCache && configCache.firmaPath) { firmaSrc = configCache.firmaPath + `?t=${new Date().getTime()}`; } else if (await imageExists('/uploads/firma.png')) { firmaSrc = '/uploads/firma.png'; } firmaPreview.src = draggablePreview.src = firmaSrc; 
      
      const db = configCache.datosBancarios || {};
      document.getElementById('banco').value = db.banco || '';
      document.getElementById('titular').value = db.titular || '';
      document.getElementById('tarjeta').value = db.tarjeta || '';
      document.getElementById('clabe').value = db.clabe || '';

      document.getElementById('doc-type-selector').value = 'cotizacion'; cargarAjustesParaDocumento('cotizacion'); } catch (e) { showToast('No se pudo cargar la configuraci√≥n.', 'error'); console.error(e); } }
      function cargarAjustesParaDocumento(docType) { 
          document.querySelectorAll('.doc-template').forEach(t => t.classList.remove('template-visible'));
          const template = document.getElementById(`template-${docType}`);
          if(template) template.classList.add('template-visible');

          if (!configCache || !configCache.firmaPos || !configCache.firmaPos[docType]) { console.error(`Ajustes para ${docType} no encontrados.`); return; } 
          const pos = configCache.firmaPos[docType]; 
          document.querySelector(`input[name="vAlign"][value="${pos.vAlign}"]`).checked = true;
          document.querySelector(`input[name="hAlign"][value="${pos.hAlign}"]`).checked = true;
          document.getElementById('slider-firma-w').value = pos.w; 
          document.getElementById('slider-firma-h').value = pos.h;
          document.getElementById('slider-firma-offsetX').value = pos.offsetX; 
          document.getElementById('slider-firma-offsetY').value = pos.offsetY; 
          actualizarPosicionFirma(); 
      }
      function actualizarPosicionFirma() {
          const docType = document.getElementById('doc-type-selector').value;
          const pos = configCache.firmaPos[docType];
          pos.vAlign = document.querySelector('input[name="vAlign"]:checked').value;
          pos.hAlign = document.querySelector('input[name="hAlign"]:checked').value;
          pos.w = parseInt(document.getElementById('slider-firma-w').value);
          pos.h = parseInt(document.getElementById('slider-firma-h').value);
          pos.offsetX = parseInt(document.getElementById('slider-firma-offsetX').value);
          pos.offsetY = parseInt(document.getElementById('slider-firma-offsetY').value);
          
          const finalCoords = getFinalCoordinates(pos);
          
          document.getElementById('val-firma-w').textContent = pos.w;
          document.getElementById('val-firma-h').textContent = pos.h;
          document.getElementById('val-firma-offsetX').textContent = pos.offsetX;
          document.getElementById('val-firma-offsetY').textContent = pos.offsetY;
          
          const previewImg = document.getElementById('firma-draggable-preview');
          previewImg.style.width = `${(finalCoords.w / PDF_DIMENSIONS.WIDTH) * 100}%`;
          previewImg.style.height = `${(finalCoords.h / PDF_DIMENSIONS.HEIGHT) * 100}%`;
          previewImg.style.left = `${(finalCoords.x / PDF_DIMENSIONS.WIDTH) * 100}%`;
          previewImg.style.top = `${(finalCoords.y / PDF_DIMENSIONS.HEIGHT) * 100}%`;
          
          const contractBlock = document.getElementById('contract-signature-block');
          if (docType === 'contrato' && contractBlock) {
             const yPercent = (finalCoords.y / PDF_DIMENSIONS.HEIGHT) * 100;
             contractBlock.style.transform = `translateY(calc(${yPercent}% - 100%))`;
             document.querySelector('#template-contrato .signature-area-rep').appendChild(previewImg);
             previewImg.style.position = 'relative';
             previewImg.style.left = 'auto';
             previewImg.style.top = 'auto';
             previewImg.style.width = '100%'; 
             previewImg.style.height = 'auto';
          } else {
             document.getElementById('firma-preview-container').appendChild(previewImg);
             previewImg.style.position = 'absolute';
          }
      }
      async function revertirADefecto() {
          const docType = document.getElementById('doc-type-selector').value;
          if (!confirm(`¬øRevertir los ajustes para '${docType}' a sus valores predeterminados? Los cambios no guardados se perder√°n.`)) return;
          try {
              const defaultSettings = await fetchAPI('/api/configuracion/defaults');
              configCache.firmaPos[docType] = defaultSettings[docType];
              cargarAjustesParaDocumento(docType);
              showToast('Valores revertidos. Haz clic en "Guardar Ajustes" para hacer el cambio permanente.', 'info');
          } catch (e) {
              showToast('No se pudieron cargar los valores predeterminados.', 'error');
          }
      }
      async function guardarAjustesFirma() { if (!configCache) return showToast('La configuraci√≥n no est√° cargada.', 'error'); try { await fetchAPI('/api/configuracion/firma-pos', { method: 'PUT', body: JSON.stringify({ firmaPos: configCache.firmaPos }) }); showToast('¬°Ajustes de la firma guardados!', 'success'); } catch (e) { showToast(`Error al guardar: ${e.message}`, 'error'); } }
      async function subirFirma(event) { const file = event.target.files[0]; if (!file) return; const formData = new FormData(); formData.append('firmaFile', file); try { const data = await fetchAPI('/api/configuracion/upload-firma', { method: 'POST', body: formData, isFormData: true }); showToast('¬°Firma subida!', 'success'); const newSrc = data.filePath + `?t=${new Date().getTime()}`; document.getElementById('firma-preview-img').src = newSrc; document.getElementById('firma-draggable-preview').src = newSrc; if(configCache) configCache.firmaPath = data.filePath; } catch (e) { showToast(`No se pudo subir la firma: ${e.message}`, 'error'); } }
      async function guardarDatosBancarios() {
        const datosBancarios = {
          banco: document.getElementById('banco').value,
          titular: document.getElementById('titular').value,
          tarjeta: document.getElementById('tarjeta').value,
          clabe: document.getElementById('clabe').value,
        };
        try {
          await fetchAPI('/api/configuracion/datos-bancarios', { method: 'PUT', body: JSON.stringify({ datosBancarios }) });
          showToast('¬°Datos bancarios guardados con √©xito!', 'success');
          configCache.datosBancarios = datosBancarios;
        } catch (e) {
          showToast(`Error al guardar los datos: ${e.message}`, 'error');
        }
      }
      function enviarDatosBancarios() {
        if (!configCache || !configCache.datosBancarios || !configCache.datosBancarios.banco) {
          return showToast('No has configurado los datos bancarios. Ve a Configuraci√≥n para a√±adirlos.', 'error');
        }
        const db = configCache.datosBancarios;
        const mensaje = `¬°Hola! Te comparto los datos para realizar la transferencia:\n\n*Banco:* ${db.banco}\n*Titular:* ${db.titular}\n*No. de Tarjeta:* ${db.tarjeta}\n*CLABE Interbancaria:* ${db.clabe}\n\nQuedo al pendiente. ¬°Gracias!`;
        const accion = prompt('¬øC√≥mo deseas enviar los datos?\n1. WhatsApp\n2. Generar PDF');
        if (accion === '1') {
            window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
        } else if (accion === '2') {
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            if (DOMElements.appLogo.src && !DOMElements.appLogo.src.includes('via.placeholder.com')) { const logoImg = DOMElements.appLogo; const canvas = document.createElement('canvas'); canvas.width = logoImg.naturalWidth; canvas.height = logoImg.naturalHeight; const ctx = canvas.getContext('2d'); ctx.filter = 'invert(1)'; ctx.drawImage(logoImg, 0, 0); pdf.addImage(canvas.toDataURL('image/png'), 'PNG', 14, 15, 40, 15); }
            pdf.setFontSize(16).text('Datos para Transferencia Bancaria', 105, 20, { align: 'center' });
            pdf.autoTable({ startY: 40, theme: 'grid', headStyles: { fillColor: [0,0,0] }, head: [['Concepto', 'Informaci√≥n']], body: [ ['Banco', db.banco], ['Titular de la Cuenta', db.titular], ['N√∫mero de Tarjeta', db.tarjeta], ['CLABE Interbancaria', db.clabe] ]});
            pdf.save('Datos-Bancarios-FiaRecords.pdf');
        }
      }
      function openDeliveryModal(projectId, artistName, projectName) {
          const modal = document.getElementById('delivery-modal');
          modal.querySelector('#delivery-project-id').value = projectId;
          modal.querySelector('#delivery-artist-name').value = artistName;
          modal.querySelector('#delivery-project-name').value = projectName;
          const project = proyectosCacheados.find(p => p._id === projectId) || historialCacheados.find(p => p._id === projectId);
          modal.querySelector('#delivery-link-input').value = project ? project.enlaceEntrega : '';
          modal.style.display = 'flex';
      }
      function closeDeliveryModal() { document.getElementById('delivery-modal').style.display = 'none'; }
      async function saveDeliveryLink() {
          const projectId = document.getElementById('delivery-project-id').value;
          const enlace = document.getElementById('delivery-link-input').value;
          try {
              await fetchAPI(`/api/proyectos/${projectId}/enlace-entrega`, { method: 'PUT', body: JSON.stringify({ enlace }) });
              showToast('Enlace de entrega guardado.', 'success');
              let project = proyectosCacheados.find(p => p._id === projectId);
              if (!project) project = historialCacheados.find(p => p._id === projectId);
              if (project) project.enlaceEntrega = enlace;
              closeDeliveryModal();
          } catch(e) {
              showToast(`Error al guardar el enlace: ${e.message}`, 'error');
          }
      }
      function sendDeliveryByWhatsapp() {
          const link = document.getElementById('delivery-link-input').value;
          if (!link) {
              return showToast('Por favor, guarda un enlace antes de enviarlo.', 'error');
          }
          const artistName = document.getElementById('delivery-artist-name').value;
          const projectName = document.getElementById('delivery-project-name').value;
          const mensaje = `¬°Hola ${artistName}! Te compartimos el enlace a los archivos finales de tu proyecto "${projectName}".\n\nEnlace de Descarga:\n${link}\n\nHa sido un placer trabajar contigo. ¬°Gracias por confiar en FiaRecords Studio!`;
          window.open(`https://wa.me/?text=${encodeURIComponent(mensaje)}`, '_blank');
      }
      async function editarNombreProyecto(id) {
          const proyecto = proyectosCacheados.find(p => p._id === id) || historialCacheados.find(p => p._id === id);
          if (!proyecto) return showToast('Proyecto no encontrado.', 'error');
          const nuevoNombre = prompt('Introduce el nuevo nombre para el proyecto:', proyecto.nombreProyecto || '');
          if (nuevoNombre === null || nuevoNombre.trim() === proyecto.nombreProyecto) return;
          try {
              await fetchAPI(`/api/proyectos/${id}/nombre`, { method: 'PUT', body: JSON.stringify({ nombreProyecto: nuevoNombre.trim() }) });
              proyecto.nombreProyecto = nuevoNombre.trim();
              if (document.getElementById('flujo-trabajo').classList.contains('active')) {
                  filtrarFlujo(document.querySelector('#filtrosFlujo button.active').textContent.trim());
              }
              if (document.getElementById('vista-artista').classList.contains('active') && proyecto.artista) {
                  mostrarVistaArtista(proyecto.artista._id, proyecto.artista.nombre);
              }
              showToast('Nombre del proyecto actualizado.', 'success');
          } catch (e) {
              showToast(`Error al actualizar: ${e.message}`, 'error');
          }
      }

      function setupMobileMenu() {
        const hamburger = document.getElementById('hamburger-menu');
        const sidebar = document.querySelector('.sidebar');
        const overlay = document.getElementById('sidebar-overlay');
        const navLinks = document.querySelectorAll('.sidebar .nav-link, .sidebar .nav-group summary');

        const toggleMenu = () => {
            sidebar.classList.toggle('sidebar-visible');
            overlay.classList.toggle('overlay-visible');
        };

        hamburger.addEventListener('click', toggleMenu);
        overlay.addEventListener('click', toggleMenu);
        navLinks.forEach(link => {
            link.addEventListener('click', () => {
                if (window.innerWidth <= 768 && sidebar.classList.contains('sidebar-visible') && link.matches('.nav-link')) {
                    toggleMenu();
                }
            });
        });
      }

      function initAppEventListeners(payload) {
        flatpickr("#fechaProyecto", { defaultDate: "today", locale: "es" });
        document.querySelectorAll('.nav-link').forEach(link => link.addEventListener('click', (e) => mostrarSeccion(e.currentTarget.dataset.seccion)));
        document.getElementById('theme-switch').addEventListener('change', (e) => applyTheme(e.target.checked ? 'dark' : 'light'));
        ['Servicios', 'Artistas', 'Usuarios'].forEach(type => { document.getElementById(`form${type}`).addEventListener('submit', (e) => saveItem(e, type.toLowerCase())); document.getElementById(`btnLimpiarForm${type}`).addEventListener('click', () => limpiarForm(`form${type}`)); });
        document.getElementById('btnAgregarAProyecto').addEventListener('click', agregarAProyecto); document.getElementById('btnGenerarCotizacion').addEventListener('click', generarCotizacion); document.getElementById('btnEnviarAFlujo').addEventListener('click', enviarAFlujoDirecto);
        document.getElementById('btnNuevoArtista').addEventListener('click', () => { document.getElementById('nuevoArtistaContainer').style.display = 'block'; });
        
        document.getElementById('btnGuardarNuevoArtista').addEventListener('click', () => registrarNuevoArtistaDesdeFormulario(''));
        document.getElementById('nombreNuevoArtista').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); registrarNuevoArtistaDesdeFormulario(''); } });
        
        document.getElementById('manualBtnNuevoArtista').addEventListener('click', () => { document.getElementById('manualNuevoArtistaContainer').style.display = 'block'; });
        document.getElementById('btnGuardarManualNuevoArtista').addEventListener('click', () => registrarNuevoArtistaDesdeFormulario('manual'));
        document.getElementById('manualNombreNuevoArtista').addEventListener('keydown', (e) => { if (e.key === 'Enter') { e.preventDefault(); registrarNuevoArtistaDesdeFormulario('manual'); } });

        document.getElementById('firma-input').addEventListener('change', subirFirma);
        document.getElementById('btn-enviar-datos-bancarios').addEventListener('click', enviarDatosBancarios);
        document.getElementById('toggle-password').addEventListener('click', (e) => {
            const passwordInput = document.getElementById('password');
            const type = passwordInput.getAttribute('type') === 'password' ? 'text' : 'password';
            passwordInput.setAttribute('type', type);
            e.target.textContent = type === 'password' ? 'üëÅÔ∏è' : 'üôà';
        });
        setupCustomization(payload);
        setupMobileMenu();
      }

      window.app = { eliminarItem, editarItem, restaurarItem, vaciarPapelera, cambiarProceso, filtrarFlujo, eliminarProyecto, quitarDeProyecto, cambiarAtributo, aprobarCotizacion, generarCotizacionPDF, compartirPorWhatsApp, registrarPago, reimprimirRecibo, compartirPagoPorWhatsApp, eliminarPago, openDocumentsModal, closeDocumentsModal, showDocumentSection, saveAndGenerateContract, saveAndGenerateDistribution, addTrackField, mostrarVistaArtista, irAVistaArtista, calcularSaldoContrato, cargarAjustesParaDocumento, actualizarPosicionFirma, guardarAjustesFirma, revertirADefecto, guardarDatosBancarios, generarContratoPDF, openEventModal, closeEventModal, goToProjectInWorkflow, goToArtistFromModal, openDeliveryModal, closeDeliveryModal, saveDeliveryLink, sendDeliveryByWhatsapp, guardarProyectoManual, editarNombreProyecto };
    });
  </script>
</body>
</html>